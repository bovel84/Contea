<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Il Conte â€“ Simulatore Medievale Completo</title>

    <!-- ===================== STILI BASE + ESPANSIONI ===================== -->
    <style>
        :root {
            --bg-main: #050505;
            --bg-panel: #0f0f0f;
            --bg-panel-alt: #171717;
            --border-soft: #2a2a2a;
            --border-strong: #3a3a3a;
            --accent: #d4af37;
            --accent-muted: #b68a1f;
            --text: #f2f2f2;
            --text-soft: #b3b3b3;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Georgia', serif;
            background: radial-gradient(circle at top, #171717, var(--bg-main));
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 0;
        }

        .screen {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: clamp(16px, 4vw, 28px);
            background: linear-gradient(145deg, rgba(15,15,15,0.95), rgba(8,8,8,0.9));
        }
        .screen.active { display: flex; flex-direction: column; }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            background: #121212;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            color: var(--text);
            margin-bottom: 15px;
        }

        .btn-main {
            width: 100%;
            padding: 14px;
            background: linear-gradient(120deg, var(--accent), #a7720d);
            color: black;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.45);
        }

        .btn-sec {
            padding: 8px 12px;
            background: var(--bg-panel-alt);
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            color: var(--text-soft);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .btn-sec:hover { border-color: var(--accent-muted); }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
        }

        #screen-start {
            background: radial-gradient(circle at top, #101010, #030303);
        }

        .start-hero {
            text-align: center;
            margin-bottom: 24px;
        }

        .start-hero h1 {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            margin-bottom: 6px;
        }

        .start-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
        }

        .start-card {
            background: rgba(8,8,8,0.92);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.45);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .start-card h3 {
            margin: 0;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        /* ===================== ENHANCED START SCREEN ===================== */
        .start-hero-enhanced {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(212,175,55,0.05), rgba(0,0,0,0.3));
            border: 1px solid var(--border-soft);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .start-hero-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .hero-crown {
            font-size: 4em;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .hero-title {
            font-size: clamp(2.5rem, 6vw, 4rem);
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, var(--accent), #f4e4c1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }

        .hero-subtitle {
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            color: var(--text-soft);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 20px;
        }

        .hero-divider {
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            margin: 20px auto;
        }

        .hero-description {
            max-width: 600px;
            margin: 0 auto;
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--text);
        }

        .start-main-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 50px;
        }

        .action-card {
            background: linear-gradient(135deg, rgba(15,15,15,0.95), rgba(8,8,8,0.9));
            border: 2px solid var(--border-soft);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.1), transparent);
            transition: left 0.5s ease;
        }

        .action-card:hover::before {
            left: 100%;
        }

        .action-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(212,175,55,0.2);
        }

        .action-card-primary {
            border-color: var(--accent-muted);
        }

        .action-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .action-card h3 {
            font-size: 1.5em;
            color: var(--accent);
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .action-card p {
            color: var(--text-soft);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .action-cta {
            display: inline-block;
            color: var(--accent);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
            border-top: 1px solid var(--border-soft);
            padding-top: 15px;
            width: 100%;
        }

        .save-preview {
            min-height: 60px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.85em;
            color: var(--text-soft);
        }

        .features-section {
            margin-bottom: 50px;
            padding: 30px;
            background: rgba(8,8,8,0.6);
            border: 1px solid var(--border-soft);
            border-radius: 20px;
        }

        .features-title {
            text-align: center;
            font-size: 1.8em;
            color: var(--accent);
            margin: 0 0 30px 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .feature-item {
            text-align: center;
            padding: 20px;
            background: rgba(15,15,15,0.8);
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .feature-item:hover {
            border-color: var(--accent-muted);
            transform: translateY(-3px);
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .feature-name {
            font-size: 1em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .feature-desc {
            font-size: 0.85em;
            color: var(--text-soft);
            line-height: 1.4;
        }

        .settings-card {
            background: linear-gradient(135deg, rgba(12,12,12,0.95), rgba(5,5,5,0.9));
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 1.8em;
        }

        .card-description {
            font-size: 0.9em;
            color: var(--text-soft);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .api-status {
            display: block;
            margin-top: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 0.85em;
            text-align: center;
        }

        .start-footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            border-top: 1px solid var(--border-soft);
            font-size: 0.9em;
            color: var(--text-soft);
        }

        /* ===================== ENHANCED EDITOR SCREEN ===================== */
        .editor-header {
            margin-bottom: 30px;
        }

        .btn-back {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            color: var(--text);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .btn-back:hover {
            border-color: var(--accent);
            background: var(--bg-panel-alt);
        }

        .editor-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .editor-title h2 {
            margin: 0 0 10px 0;
            font-size: clamp(1.8rem, 4vw, 2.5rem);
        }

        .editor-title p {
            color: var(--text-soft);
            font-size: 1em;
        }

        .editor-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 30px;
        }

        .editor-section {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            padding: 25px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-soft);
        }

        .section-icon {
            font-size: 2em;
        }

        .section-header h3 {
            margin: 0;
            color: var(--accent);
            font-size: 1.3em;
        }

        .editor-section label {
            display: block;
            margin: 15px 0 8px 0;
            color: var(--text);
            font-size: 0.95em;
            font-weight: bold;
        }

        .editor-section input,
        .editor-section textarea,
        .editor-section select {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            color: var(--text);
            font-size: 1em;
            transition: all 0.2s ease;
        }

        .editor-section input:focus,
        .editor-section textarea:focus,
        .editor-section select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(0,0,0,0.6);
        }

        .editor-section textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Georgia', serif;
            line-height: 1.6;
        }

        .btn-start-game {
            font-size: 1.2em;
            padding: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            z-index: 10;
        }

        .btn-icon {
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .start-hero-enhanced {
                padding: 30px 15px;
                margin-bottom: 30px;
            }

            .hero-crown {
                font-size: 3em;
            }

            .start-main-actions {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }

            .action-card {
                padding: 20px;
            }

            .features-section {
                padding: 20px;
                margin-bottom: 30px;
            }

            .features-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .feature-item {
                padding: 15px;
            }

            .editor-section {
                padding: 18px;
            }

            /* Assicura che il pulsante sia visibile su mobile */
            .btn-start-game {
                font-size: 1.1em;
                padding: 16px;
                margin-bottom: 20px;
                position: sticky;
                bottom: 20px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.5), 0 4px 20px rgba(212,175,55,0.4);
            }

            #screen-editor {
                padding-bottom: 30px;
            }
        }

        /* Small transient delta indicators for stats (pop, gold, food, health) */
        .stat-delta {
            font-size: 0.8em;
            color: var(--text-soft);
            margin-top: 6px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.35s cubic-bezier(.2,.9,.2,1), transform 0.35s cubic-bezier(.2,.9,.2,1);
            opacity: 0;
            transform: translateY(0) scale(1);
            will-change: opacity, transform;
        }
        .stat-delta.active { opacity: 1; transform: translateY(-4px) scale(1.04); }
        .stat-delta.up { color: #7be36a; }
        .stat-delta.down { color: #ff7c7c; }
        .stat-delta svg { width: 12px; height: 12px; vertical-align: middle; }
        /* Backwards-compatible alias for old pop-delta */
        .pop-delta { all: unset; }

        .save-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: rgba(6,6,6,0.9);
            gap: 10px;
        }

        .save-entry-details {
            display: flex;
            flex-direction: column;
            font-size: 0.8em;
            color: var(--text-soft);
        }

        .save-entry-actions {
            display: flex;
            gap: 6px;
        }

        .save-empty {
            font-size: 0.85em;
            color: var(--text-soft);
        }

        .game-toolbar {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .toolbar-status {
            font-size: 0.75em;
            color: var(--text-soft);
        }

        .season-banner {
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 8px 14px;
            margin-bottom: 18px;
            background: rgba(12,12,12,0.85);
            display: flex;
            justify-content: space-between;
            gap: 10px;
            font-size: 0.85em;
            color: var(--text);
        }

        .season-highlight {
            color: var(--accent);
            font-weight: 600;
        }

        .resource-grid .stat-card {
            position: relative;
        }

        .res-delta {
            position: absolute;
            right: 10px;
            bottom: 8px;
            font-size: 0.75em;
            color: var(--text-soft);
        }

        .res-delta.positive { color: #6ada91; }
        .res-delta.negative { color: #ff7c7c; }

        .faction-effects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .faction-effect-card {
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 12px;
            background: rgba(10,10,10,0.85);
            font-size: 0.85em;
        }

        .faction-effect-card strong {
            color: var(--accent);
            display: block;
            margin-bottom: 4px;
        }

        .tax-panel {
            border: 1px solid var(--border-soft);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 20px;
            background: rgba(6,6,6,0.9);
        }

        .tax-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .tax-card {
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 10px;
            background: rgba(12,12,12,0.85);
        }

        .tax-card label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            text-transform: uppercase;
            color: var(--text-soft);
        }

        .tax-card input[type=range] {
            width: 100%;
        }

        .tax-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 0.85em;
            color: var(--text);
        }

        .law-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
            gap: 12px;
        }

        .law-card {
            border: 1px solid var(--border-soft);
            border-radius: 14px;
            padding: 12px;
            background: rgba(10,10,10,0.88);
        }

        .law-card h4 {
            margin: 0 0 6px 0;
            color: var(--accent);
        }

        .law-card p {
            margin: 0 0 10px 0;
            font-size: 0.85em;
            color: var(--text-soft);
        }

        .section-toggle {
            width: 100%;
            margin: 12px 0 6px;
            padding: 10px 14px;
            text-align: left;
            background: rgba(12,12,12,0.85);
            color: var(--text);
            border: 1px solid var(--border-soft);
            border-radius: 10px;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-toggle span {
            font-size: 0.85em;
            color: var(--text-soft);
        }

        .section-panel {
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 14px;
            padding: 12px;
            background: rgba(5,5,5,0.85);
            margin-bottom: 10px;
        }

        .section-panel.collapsed {
            display: none;
        }

        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .asset-card {
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 12px;
            background: rgba(8,8,8,0.9);
            font-size: 0.85em;
        }

        .asset-card h4 {
            margin: 0 0 6px 0;
            color: var(--accent);
        }

        .asset-flow {
            font-size: 0.8em;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .law-creator {
            border-top: 1px dashed rgba(255,255,255,0.08);
            margin-top: 12px;
            padding-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 10px;
        }

        .law-creator textarea,
        .law-creator input,
        .law-creator select {
            margin: 0;
        }

        .law-creator button {
            grid-column: 1 / -1;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 100;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            width: min(520px, 92vw);
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 30px 70px rgba(0,0,0,0.65);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2em;
            cursor: pointer;
        }

        .personality-form label {
            font-size: 0.85em;
            color: var(--text-soft);
        }

        .personality-form textarea { min-height: 80px; }

        /* ===================== NAVIGAZIONE ===================== */
        .bottom-nav {
            display: flex;
            height: 60px;
            background: rgba(5,5,5,0.95);
            border-top: 1px solid var(--border-soft);
            align-items: center;
            justify-content: space-around;
            position: sticky;
            bottom: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-soft);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.77em;
            gap: 3px;
        }
        .nav-btn.active { color: #d4af37; }

        .nav-icon { font-size: 1.4em; }

        /* ===================== TAB VIEW ===================== */
        .tab-view {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: clamp(16px, 4vw, 26px);
            background: linear-gradient(135deg, rgba(12,12,12,0.95), rgba(5,5,5,0.92));
            border: 1px solid var(--border-soft);
            border-radius: 20px;
            margin-bottom: 70px;
            box-shadow: 0 20px 45px rgba(0,0,0,0.4);
        }
        .tab-view.active-tab { display: flex; flex-direction: column; gap: 16px; }

        /* ===================== STATISTICHE ===================== */
        .grid-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .resource-grid {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .stat-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            padding: 14px;
            border-radius: 14px;
            text-align: center;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
        }

        .stat-val { font-size: 1.3em; font-weight: bold; }

        /* ===================== BARS ===================== */
        .need-row { margin-bottom: 15px; }
        .need-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        /* ===================== MAGAZZINO ===================== */
        .warehouse-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .warehouse-stat {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .warehouse-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .warehouse-stat-label {
            font-size: 0.85em;
            color: var(--text-soft);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .warehouse-section {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .resource-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .resource-item {
            background: rgba(8,8,8,0.6);
            border: 2px solid var(--border-soft);
            border-radius: 10px;
            padding: 14px;
            transition: all 0.3s ease;
        }

        .resource-item.critical {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.08);
        }

        .resource-item.warning {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.08);
        }

        .resource-item.healthy {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.08);
        }

        .resource-header-w {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .resource-name-w {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--accent);
        }

        .resource-icon-w {
            font-size: 1.5em;
            margin-right: 8px;
        }

        .resource-quantity {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .resource-item.critical .resource-quantity {
            color: #f44336;
        }

        .resource-item.warning .resource-quantity {
            color: #ff9800;
        }

        .resource-item.healthy .resource-quantity {
            color: #4caf50;
        }

        .resource-details-w {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85em;
            color: var(--text-soft);
            margin-bottom: 10px;
        }

        .resource-row-w {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .resource-row-w.positive {
            color: #4caf50;
        }

        .resource-row-w.negative {
            color: #f44336;
        }

        .resource-autonomy {
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--accent-muted);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            margin-top: 8px;
        }

        .resource-autonomy.critical {
            background: rgba(244, 67, 54, 0.15);
            border-color: #f44336;
            color: #f44336;
        }

        .resource-autonomy.warning {
            background: rgba(255, 152, 0, 0.15);
            border-color: #ff9800;
            color: #ff9800;
        }

        .resource-autonomy.infinite {
            background: rgba(76, 175, 80, 0.15);
            border-color: #4caf50;
            color: #4caf50;
        }

        .population-needs {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: 14px;
            padding: 20px;
            margin-top: 20px;
        }

        .needs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .need-card {
            background: rgba(8,8,8,0.6);
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            padding: 12px;
        }

        .need-title {
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .need-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text);
        }

        .need-desc {
            font-size: 0.8em;
            color: var(--text-soft);
            margin-top: 4px;
        }

        .need-bar-bg {
            background: #333;
            height: 8px;
            border-radius: 4px;
            width: 100%;
        }
        .need-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .fill-food { background: #e6bf00; }
        .fill-health { background: #4caf50; }
        .fill-happy { background: #2196f3; }
        .fill-stability { background: #9c27b0; }

        /* ===================== DIPLOMAZIA ===================== */
        .diplomacy-card {
            background: linear-gradient(140deg, rgba(22,22,22,0.95), rgba(12,12,12,0.9));
            border: 1px solid var(--border-soft);
            padding: 14px 16px;
            border-radius: 14px;
            margin-bottom: 14px;
            box-shadow: 0 12px 26px rgba(0,0,0,0.4);
        }

        .relation-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed rgba(255,255,255,0.05);
            padding: 6px 0;
            font-size: 0.92em;
        }

        .relation-row span:first-child { color: var(--text-soft); }

        /* ===================== SALA DEL TRONO (CHAT) - VERSIONE LEGGIBILE ===================== */
        .chat-panel {
            /* Sfondo migliorato */
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 1px solid #444;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            height: 75vh; 
            min-height: 600px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            position: relative;
            overflow: hidden;
        }

        /* Texture sfondo elegante */
        .chat-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 30%, rgba(212,175,55,0.03), rgba(0,0,0,0.4));
            pointer-events: none;
            z-index: 0;
        }

        .chat-header {
            z-index: 2;
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border-bottom: 2px solid var(--accent);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--accent);
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .chat-log {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding: 28px;
            scroll-behavior: smooth;
            z-index: 1;
            color: #e8e8e8;
            font-size: 1.1em;
            line-height: 1.7;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
        }

        /* Scrollbar personalizzata per la chat */
        .chat-log::-webkit-scrollbar {
            width: 8px;
        }

        .chat-log::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .chat-log::-webkit-scrollbar-thumb {
            background: var(--accent-muted);
            border-radius: 10px;
        }

        .chat-log::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Chips Fazioni */
        .faction-chips {
            z-index: 2;
            padding: 12px 18px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .faction-chip {
            background: linear-gradient(135deg, #2a2a2a, #1f1f1f);
            border: 1px solid #555;
            color: #ddd;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .faction-chip:hover {
            background: linear-gradient(135deg, #3a3a3a, #2f2f2f);
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212,175,55,0.3);
        }

        /* Area Input migliorata */
        .input-area {
            z-index: 2;
            background: linear-gradient(135deg, #252525, #1a1a1a);
            padding: 18px 20px;
            border-top: 2px solid var(--border-soft);
            display: flex;
            gap: 12px;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
        }

        .input-area input {
            flex: 1;
            background: #0d0d0d;
            border: 2px solid #444;
            color: #fff;
            padding: 14px 16px;
            border-radius: 10px;
            font-size: 1.05em;
            transition: all 0.3s ease;
        }
        
        .input-area input:focus {
            outline: none;
            border-color: var(--accent);
            background: #111;
            box-shadow: 0 0 15px rgba(212,175,55,0.2);
        }
        
        .input-area input::placeholder {
            color: #888;
        }

        .send-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-muted));
            border: none;
            color: #000;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(212,175,55,0.3);
        }
        
        .send-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(212,175,55,0.5);
        }
        
        .send-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* Pulsante "Avanza Stagione" migliorato */
        .season-advance-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #2c2c2c, #1f1f1f);
            border: 2px solid var(--border-soft);
            color: #e8e8e8;
            font-weight: bold;
            font-size: 1.05em;
            cursor: pointer;
            border-radius: 0 0 16px 16px;
            transition: all 0.3s ease;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        
        .season-advance-btn:hover {
            background: linear-gradient(135deg, var(--accent-muted), var(--accent));
            border-color: var(--accent);
            color: #000;
            box-shadow: 0 -2px 20px rgba(212,175,55,0.4);
        }

        /* Messaggi Chat migliorati */
        .msg {
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(30,30,30,0.8);
            border: 1px solid #333;
            line-height: 1.7;
            font-size: 1.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .msg:hover {
            background: rgba(35,35,35,0.9);
            border-color: #444;
            transform: translateX(4px);
        }

        .msg-system {
            background: transparent;
            border: none;
            border-top: 2px solid #333;
            border-bottom: 2px solid #333;
            color: #999;
            font-style: italic;
            text-align: left;
            padding: 14px 0;
            margin: 20px 0;
            font-size: 1em;
        }

        .msg-faction {
            background: linear-gradient(135deg, rgba(30,30,30,0.9), rgba(20,20,20,0.9));
            border: 2px solid rgba(212,175,55,0.3);
            color: #eee;
        }
        
        .msg-faction .msg-text {
            color: #e8e8e8;
        }
        
        .faction-title {
            font-weight: bold;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
            color: var(--accent);
            font-size: 0.95em;
        }

        .msg-meta {
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
            font-style: italic;
        }

        /* Stili aggiuntivi per diversi tipi di messaggi */
        .msg-user {
            background: linear-gradient(135deg, rgba(41,128,185,0.15), rgba(52,73,94,0.15));
            border-left: 4px solid rgba(52,152,219,0.6);
            margin-left: 10px;
        }

        .msg-ai, .msg-advisor {
            background: linear-gradient(135deg, rgba(212,175,55,0.08), rgba(180,138,31,0.08));
            border-left: 4px solid var(--accent);
        }

        .msg-narrative, .msg-scene {
            background: rgba(20,20,25,0.5);
            border-left: 4px solid #666;
            font-style: italic;
            color: #bbb;
        }

        .msg-character, .msg-npc {
            background: linear-gradient(135deg, rgba(155,89,182,0.1), rgba(142,68,173,0.1));
            border-left: 4px solid rgba(155,89,182,0.5);
        }

        .msg-event {
            background: linear-gradient(135deg, rgba(230,126,34,0.1), rgba(211,84,0,0.1));
            border-left: 4px solid rgba(230,126,34,0.5);
        }

        .msg-warning {
            background: linear-gradient(135deg, rgba(231,76,60,0.12), rgba(192,57,43,0.12));
            border-left: 4px solid rgba(231,76,60,0.6);
            animation: pulse-warning 2s ease-in-out infinite;
        }

        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 4px 12px rgba(231,76,60,0.2); }
            50% { box-shadow: 0 4px 20px rgba(231,76,60,0.4); }
        }

        .msg-success {
            background: linear-gradient(135deg, rgba(46,204,113,0.1), rgba(39,174,96,0.1));
            border-left: 4px solid rgba(46,204,113,0.6);
        }

        /* Animazione fade-in per nuovi messaggi */
        .msg.new-message {
            animation: fadeInMessage 0.5s ease-out;
        }

        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Miglioramento testo messaggi */
        .msg-text {
            line-height: 1.7;
            color: #e8e8e8;
        }

        .msg-text strong {
            color: var(--accent);
            font-weight: bold;
        }

        .msg-text em {
            color: #b8b8b8;
            font-style: italic;
        }

        /* ===================== EVENTI & AZIONI ===================== */
        .panel-title {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .event-panel,
        .action-panel,
        .advice-panel {
            background: linear-gradient(135deg, rgba(16,16,16,0.92), rgba(8,8,8,0.9));
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        .event-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .event-card {
            background: linear-gradient(135deg, rgba(212,175,55,0.12), rgba(255,255,255,0.03));
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
        }

        .event-time {
            font-size: 0.7em;
            color: var(--text-soft);
            text-align: right;
            margin-bottom: 6px;
        }

        .event-empty,
        .action-empty {
            color: var(--text-soft);
            font-size: 0.85em;
            margin: 0;
        }

        .action-panel { margin-top: 16px; }

        .action-prompt {
            margin: 0 0 8px 0;
            font-size: 0.85em;
            color: #ccc;
        }

        .action-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-card {
            border: 1px solid rgba(52,152,219,0.35);
            background: rgba(36,75,95,0.35);
            color: #e4f4ff;
            border-radius: 12px;
            padding: 12px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.15s ease, border-color 0.15s ease;
        }

        .legend-circle {
            background: #f4d88b;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.4);
        }

        .legend-diamond {
            background: #c27b26;
            transform: rotate(45deg);
        }

        .legend-triangle {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 16px solid #5ba86c;
            border-radius: 2px;
        }

        .legend-square {
            background: #cfcfcf;
        }

        .legend-cross {
            position: relative;
            width: 18px;
            height: 18px;
        }

        .legend-cross::before,
        .legend-cross::after {
            content: "";
            position: absolute;
            background: #f5f0d0;
            border-radius: 2px;
        }

        .legend-cross::before {
            width: 6px;
            height: 18px;
            left: 6px;
        }

        .legend-cross::after {
            width: 18px;
            height: 6px;
            top: 6px;
        }

        /* ===================== POPOLAZIONE ===================== */
        .pop-grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 10px;
        }

        .pop-card {
            background: linear-gradient(135deg, rgba(28,28,28,0.95), rgba(14,14,14,0.92));
            border: 1px solid var(--border-soft);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.35);
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
            font-size: 0.95em;
        }

        .pop-card strong { color: var(--accent); }
        .pop-card span { color: var(--text); }

        /* ===================== PERSONAGGI (FAZIONI) ===================== */
        .person-card {
            background: linear-gradient(120deg, rgba(20,20,20,0.95), rgba(10,10,10,0.92));
            border: 1px solid var(--border-soft);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 14px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }
        .person-name {
            color: #d4af37;
            font-size: 1.1em;
            margin-bottom: 6px;
        }

        .private-selector {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: rgba(8,8,8,0.85);
            border: 1px solid var(--border-soft);
            border-radius: 18px;
            padding: 14px;
        }

/* === STILE CARTE COSTRUZIONE V3 (Grafica Avanzata) === */

/* Griglia principale */
#building-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
    padding: 10px;
}

// Estensione icone per i nuovi beni di mercato (fallback al set originale)
const __origGetResourceIcon = getResourceIcon;
getResourceIcon = function(key) {
    const ext = {
        spices: "ðŸ§‚",
        parchment: "ðŸ“œ",
        candles: "ðŸ•¯ï¸",
        incense: "ðŸŒ«ï¸",
        crystals: "ðŸ”®",
        parade_horses: "ðŸŽ",
        seeds: "ðŸŒ±",
        pottery: "ðŸº"
    };
    if (ext[key]) return ext[key];
    return __origGetResourceIcon ? __origGetResourceIcon(key) : "âœ¨";
};

/* La Carta */
.building-card-v3 {
    background-color: #1a1a1a;
    border: 1px solid #444;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
}

.building-card-v3:hover {
    transform: translateY(-5px);
    border-color: var(--accent); /* Oro */
    box-shadow: 0 15px 30px rgba(212, 175, 55, 0.15);
}

.building-card-v3.disabled {
    opacity: 0.6;
    filter: grayscale(80%);
    border-color: #333;
}

/* Immagine in alto */
.card-img-top {
    height: 130px;
    width: 100%;
    background-size: cover;
    background-position: center;
    background-color: #222;
    position: relative;
    border-bottom: 2px solid var(--accent);
}

/* Badge del tempo sopra l'immagine */
.card-time-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    border: 1px solid #555;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Corpo della carta */
.card-body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    gap: 8px;
}

.card-title {
    font-family: 'Georgia', serif;
    color: var(--accent);
    font-size: 1.1em;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid #333;
    padding-bottom: 6px;
}

.card-desc {
    font-size: 0.85em;
    color: #aaa;
    font-style: italic;
    line-height: 1.3;
    margin-bottom: 4px;
}

/* Sezione Produzione (Input -> Output) */
.card-production-box {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 8px;
    font-size: 0.85em;
    border: 1px dashed #555;
}

.prod-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #eee;
}

.prod-arrow { color: var(--accent); font-weight: bold; font-size: 1.2em; }

/* Sezione Manodopera */
.card-labor {
    font-size: 0.8em;
    background: rgba(255, 255, 255, 0.05);
    padding: 4px;
    border-radius: 4px;
    text-align: center;
}

.card-labor.available {
    color: #6ada91;
    background: rgba(106, 218, 145, 0.1);
    border: 1px solid rgba(106, 218, 145, 0.3);
}

.card-labor.missing {
    color: #ff7c7c;
    background: rgba(255, 124, 124, 0.1);
    border: 1px solid rgba(255, 124, 124, 0.3);
}

/* Footer con Costi e Bottone */
.card-footer {
    background: #111;
    padding: 12px;
    border-top: 1px solid #333;
    margin-top: auto;
}

.cost-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
}

.cost-badge {
    font-size: 0.8em;
    background: #222;
    border: 1px solid #444;
    padding: 3px 6px;
    border-radius: 4px;
    color: #ccc;
    display: flex;
    align-items: center;
    gap: 4px;
}

.cost-badge.missing {
    border-color: #ff4444;
    color: #ff7c7c;
    background: rgba(255, 0, 0, 0.1);
}

.btn-build-v3 {
    width: 100%;
    padding: 10px;
    background: linear-gradient(135deg, var(--accent), #8a6e22);
    color: #000;
    font-weight: bold;
    text-transform: uppercase;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-build-v3:hover { filter: brightness(1.2); }
.btn-build-v3:disabled {
    background: #444;
    color: #888;
    cursor: not-allowed;
    filter: none;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .building-card-v2 {
        padding: 16px;
    }
    
    .building-card-v2 .card-image {
        height: 100px;
    }
    
    .building-grid-v2 {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px;
    }
}

/* Stile per il pannello cantieri */
.const-card {
    background: linear-gradient(90deg, rgba(20,20,20,0.9), rgba(30,30,30,0.9));
    border: 1px solid var(--border-soft);
    border-left: 3px solid var(--accent);
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.const-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: var(--text);
}

.const-meta {
    font-size: 0.75em;
    color: var(--text-soft);
    display: flex;
    justify-content: space-between;
}

.const-progress-bg {
    background: #333;
    height: 6px;
    width: 100%;
    border-radius: 3px;
    overflow: hidden;
}

.const-progress-fill {
    background: var(--accent);
    height: 100%;
    width: 0%;
    transition: width 0.4s ease;
    box-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
}

/* ===================== MEDIA QUERIES PER MOBILE ===================== */
@media (max-width: 768px) {
    body {
        font-size: 14px;
    }

    .screen {
        padding: clamp(8px, 2vw, 16px);
    }

    .screen.active {
        display: flex;
        flex-direction: column;
    }

    #screen-game {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
    }

    .start-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .start-card {
        padding: 12px;
    }

    .game-toolbar {
        flex-wrap: wrap;
        gap: 6px;
        font-size: 0.8em;
    }

    .toolbar-status {
        font-size: 0.7em;
    }

    .season-banner {
        padding: 6px 10px;
        font-size: 0.8em;
        flex-direction: column;
        gap: 4px;
        align-items: flex-start;
    }

    .tab-view {
        padding: clamp(12px, 3vw, 20px);
        margin-bottom: 60px;
    }

    .grid-stats {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .resource-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }

    .stat-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .stat-val {
        font-size: 1.1em;
    }

    .need-row {
        margin-bottom: 12px;
    }

    .need-header {
        font-size: 0.8em;
    }

    .diplomacy-card {
        padding: 10px 12px;
        margin-bottom: 10px;
    }

    .relation-row {
        font-size: 0.85em;
        padding: 4px 0;
    }

    .chat-panel {
        height: calc(100vh - 120px);
        min-height: auto;
        border-radius: 12px;
    }

    .chat-header {
        padding: 14px 16px;
        font-size: 1em;
    }

    .chat-log {
        padding: 20px 16px;
        gap: 16px;
        font-size: 1.05em;
    }

    .msg {
        padding: 14px 16px;
        max-width: 95%;
        font-size: 1.05em;
        line-height: 1.6;
    }

    .faction-chip {
        padding: 6px 12px;
        font-size: 0.85em;
    }

    .input-area {
        padding: 14px 16px;
        gap: 10px;
    }

    .input-area input {
        padding: 12px 14px;
        font-size: 1em;
    }

    .send-btn {
        width: 48px;
        height: 48px;
        font-size: 1.2em;
    }

    .season-advance-btn {
        padding: 14px;
        font-size: 1em;
    }

    .event-feed {
        max-height: 250px;
    }

    .event-card {
        padding: 10px 12px;
        font-size: 0.9em;
    }

    .action-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .pop-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .pop-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .person-card {
        padding: 8px;
        margin-bottom: 6px;
        font-size: 0.9em;
    }

    .representatives-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .person-name {
        font-size: 1em;
    }

    .private-selector {
        padding: 10px;
        gap: 8px;
    }

    .private-selector button {
        font-size: 0.8em;
        padding: 6px 8px;
    }

    .faction-effects {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .faction-effect-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .tax-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .tax-card {
        padding: 8px;
    }

    .law-list {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .law-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .law-creator {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .asset-grid {
        grid-template-columns: 1fr;
        gap: 8px;
    }

    .asset-card {
        padding: 10px;
        font-size: 0.9em;
    }

    .modal-content {
        width: 95vw;
        max-height: 85vh;
        padding: 16px;
    }

    .modal-header {
        margin-bottom: 4px;
    }

    .close-btn {
        font-size: 1.1em;
    }

    .bottom-nav {
        height: 50px;
        font-size: 0.75em;
    }

    .nav-btn {
        font-size: 0.7em;
    }

    .nav-icon {
        font-size: 1.2em;
    }

    canvas {
        max-width: 100%;
        height: auto;
    }

    .map-legend {
        font-size: 0.9em;
    }

    .legend-item {
        margin-bottom: 6px;
    }

    .building-card-v2 {
        padding: 12px;
        font-size: 0.9em;
    }

    .b-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }

    .b-title {
        font-size: 0.95em;
    }

    .b-time {
        font-size: 0.75em;
    }

    .b-desc {
        font-size: 0.85em;
    }

    .b-cost {
        font-size: 0.75em;
        padding: 6px;
    }

    .const-card {
        padding: 8px 10px;
        font-size: 0.9em;
    }

    .const-header {
        font-size: 0.9em;
    }

    .const-meta {
        font-size: 0.75em;
    }

    .save-entry {
        padding: 8px 10px;
        font-size: 0.85em;
    }

    .save-entry-details {
        font-size: 0.8em;
    }

    .save-entry-actions {
        gap: 4px;
    }

    .panel {
        border-radius: 12px;
    }

    .btn-main {
        padding: 12px;
        font-size: 0.9em;
    }

    .btn-sec {
        padding: 6px 10px;
        font-size: 0.85em;
    }

    h1, h2, h3 {
        font-size: clamp(1.4rem, 4vw, 2.2rem);
        margin-bottom: 12px;
    }

    .section-toggle {
        padding: 8px 12px;
        font-size: 0.9em;
    }

    .section-panel {
        padding: 10px;
    }

    .faction-chips {
        padding: 8px 15px 0;
    }

    .faction-chip {
        font-size: 0.7em;
        padding: 3px 8px;
    }

    .msg-system {
        font-size: 0.65em;
    }

    .msg-meta {
        font-size: 0.65em;
    }

    .panel-title {
        font-size: 0.8em;
    }

    .event-empty,
    .action-empty {
        font-size: 0.8em;
    }

    .action-prompt {
        font-size: 0.8em;
    }

    .toolbar-status {
        font-size: 0.7em;
    }

    .season-highlight {
        font-size: 0.9em;
    }

    .res-delta {
        font-size: 0.7em;
    }

    .need-bar-bg {
        height: 6px;
    }

    .need-bar-fill {
        height: 100%;
    }

    .legend-circle,
    .legend-diamond,
    .legend-square,
    .legend-cross {
        width: 16px;
        height: 16px;
    }

    .legend-triangle {
        border-left-width: 8px;
        border-right-width: 8px;
        border-bottom-width: 14px;
    }

    .legend-cross::before,
    .legend-cross::after {
        width: 5px;
        height: 16px;
        left: 5.5px;
    }

    .legend-cross::after {
        width: 16px;
        height: 5px;
        top: 5.5px;
    }

    .const-progress-bg {
        height: 5px;
    }

    .const-progress-fill {
        height: 100%;
    }

    .court-layout {
        flex-direction: column;
    }

    .court-main, .court-sidebar {
        flex: none;
        width: 100%;
    }
}

@media (max-width: 480px) {
    body {
        font-size: 13px;
    }

    .screen {
        padding: clamp(6px, 2vw, 12px);
    }

    .tab-view {
        padding: clamp(10px, 3vw, 16px);
        margin-bottom: 55px;
    }

    .chat-panel {
        height: calc(100vh - 100px);
        border-radius: 10px;
    }

    .chat-header {
        padding: 12px 14px;
        font-size: 0.95em;
    }

    .chat-log {
        padding: 16px 12px;
        gap: 14px;
        font-size: 1em;
    }

    .msg {
        padding: 12px 14px;
        max-width: 98%;
        font-size: 1em;
        line-height: 1.6;
    }

    .msg-system {
        padding: 12px 0;
        margin: 16px 0;
        font-size: 0.95em;
    }

    .faction-chip {
        padding: 5px 10px;
        font-size: 0.8em;
    }

    .input-area {
        padding: 12px 14px;
        gap: 8px;
    }

    .input-area input {
        padding: 12px;
        font-size: 0.95em;
    }

    .send-btn {
        width: 44px;
        height: 44px;
        font-size: 1.1em;
    }

    .season-advance-btn {
        padding: 12px;
        font-size: 0.95em;
    }

    .bottom-nav {
        height: 45px;
        font-size: 0.7em;
    }

    .nav-btn {
        font-size: 0.65em;
    }

    .nav-icon {
        font-size: 1.1em;
    }

    .modal-content {
        width: 98vw;
        padding: 12px;
    }

    .btn-main {
        padding: 10px;
        font-size: 0.85em;
    }

    .btn-sec {
        padding: 5px 8px;
        font-size: 0.8em;
    }

    h1, h2, h3 {
        font-size: clamp(1.3rem, 4vw, 2rem);
        margin-bottom: 10px;
    }

    .stat-card {
        padding: 8px;
    }

    .stat-val {
        font-size: 1em;
    }

    .pop-card {
        padding: 8px;
    }

    .person-card {
        padding: 10px;
    }

    .diplomacy-card {
        padding: 8px 10px;
    }

    .law-card {
        padding: 8px;
    }

    .asset-card {
        padding: 8px;
    }

    .faction-effect-card {
        padding: 8px;
    }

    .tax-card {
        padding: 6px;
    }

    .event-card {
        padding: 8px 10px;
    }

    .action-card {
        padding: 8px;
    }

    .building-card-v2 {
        padding: 10px;
    }

    .save-entry {
        padding: 6px 8px;
    }

    .section-toggle {
        padding: 6px 10px;
    }

    .section-panel {
        padding: 8px;
    }

    .private-selector button {
        font-size: 0.75em;
        padding: 5px 6px;
    }

    .faction-chip {
        font-size: 0.65em;
        padding: 2px 6px;
    }

    .panel-title {
        font-size: 0.75em;
    }

    .event-empty,
    .action-empty {
        font-size: 0.75em;
    }

    .action-prompt {
        font-size: 0.75em;
    }

    .toolbar-status {
        font-size: 0.65em;
    }

    .season-highlight {
        font-size: 0.85em;
    }

    .res-delta {
        font-size: 0.65em;
    }

    .need-header {
        font-size: 0.75em;
    }

    .relation-row {
        font-size: 0.8em;
    }

    .const-card {
        padding: 6px 8px;
    }

    .const-header {
        font-size: 0.85em;
    }

    .const-meta {
        font-size: 0.7em;
    }

    .map-legend {
        font-size: 0.85em;
    }

    .legend-item {
        margin-bottom: 4px;
    }

    .legend-circle,
    .legend-diamond,
    .legend-square,
    .legend-cross {
        width: 14px;
        height: 14px;
    }

    .legend-triangle {
        border-left-width: 7px;
        border-right-width: 7px;
        border-bottom-width: 12px;
    }

    .legend-cross::before,
    .legend-cross::after {
        width: 4px;
        height: 14px;
        left: 5px;
    }

    .legend-cross::after {
        width: 14px;
        height: 4px;
        top: 5px;
    }

    .const-progress-bg {
        height: 4px;
    }

    .const-progress-fill {
        height: 100%;
    }

    /* Editor screen - assicura che il pulsante sia visibile */
    .btn-start-game {
        font-size: 1em;
        padding: 14px;
        margin-bottom: 20px;
        position: sticky;
        bottom: 15px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.6), 0 4px 20px rgba(212,175,55,0.5);
    }

    #screen-editor {
        padding-bottom: 30px;
    }

    .editor-section {
        padding: 16px;
    }

    .editor-header {
        margin-bottom: 20px;
    }

    .btn-back {
        padding: 8px 16px;
        font-size: 0.9em;
    }
}

.court-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
    align-items: start;
}

.court-main {
    min-width: 0;
}

.court-sidebar {
    min-width: 0;
}

.sidebar-panel {
    background: #161616;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
}

.event-feed.compact {
    max-height: 200px;
    overflow-y: auto;
}

.panel-title {
    font-size: 0.9em;
    font-weight: bold;
    margin-bottom: 6px;
}

.faction-chips-inline {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    align-items: center;
}

.faction-chip {
    font-size: 0.75em;
    padding: 2px 6px;
    border-radius: 4px;
    background: var(--accent);
    color: #000;
}

@media (max-width: 900px) {
    .court-layout {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .court-sidebar {
        order: -1;
    }
}

/* ===================== MODALE BILANCIO (TESORERIA) ===================== */
.budget-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.budget-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 600px) {
    .budget-columns { grid-template-columns: 1fr; }
}

.budget-col h4 {
    border-bottom: 1px solid var(--border-soft);
    padding-bottom: 8px;
    margin-bottom: 10px;
    color: var(--text-soft);
    text-transform: uppercase;
    font-size: 0.85em;
}

.budget-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px dashed rgba(255,255,255,0.05);
    font-size: 0.9em;
}

.budget-row.total {
    border-top: 1px solid var(--border-soft);
    border-bottom: none;
    margin-top: 10px;
    padding-top: 10px;
    font-weight: bold;
    font-size: 1.1em;
}

.money-plus { color: #6ada91; }
.money-minus { color: #ff7c7c; }

.net-balance-card {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    margin-top: 10px;
}

.net-balance-val {
    font-size: 1.8em;
    font-weight: bold;
    margin: 5px 0;
}

#modal-budget {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

#modal-budget.active {
    display: flex;
}

#budget-content {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.budget-section {
    margin-bottom: 20px;
}

.budget-section h3 {
    margin-bottom: 10px;
    color: var(--accent);
}

.budget-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid var(--border-soft);
}

.budget-total {
    font-weight: bold;
    margin-top: 10px;
}

.money-plus {
    color: #4caf50;
}

.money-minus {
    color: #f44336;
}

.budget-net {
    text-align: center;
    font-size: 1.2em;
    margin-top: 20px;
    padding: 10px;
    border-radius: 8px;
    background: var(--bg-hover);
}

/* Stile per il nome del personaggio */
.chat-name {
    display: block;
    font-size: 0.85em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--accent); /* Oro */
    margin-bottom: 4px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 2px;
    width: fit-content;
}

/* Stile per il testo del messaggio */
.chat-content {
    color: #e0e0e0;
    font-size: 1em;
    line-height: 1.5;
}

/* Stile specifico per la Narrazione (SCENA) */
.msg-narrative {
    background: rgba(0, 0, 0, 0.4);
    border-left: 3px solid #555;
    color: #aaa;
    font-style: italic;
    padding: 10px 15px;
    margin: 10px 0;
    border-radius: 0 8px 8px 0;
}

/* ===================== NUOVI STILI MESSAGGI ===================== */

/* 1. LA SCENA (Narrativa) - Sfondo scuro, corsivo, centrato o largo */
.msg-scene {
    background: rgba(20, 20, 25, 0.6);
    border-left: 4px solid #666;
    color: #aaa; /* Grigio chiaro */
    font-family: 'Georgia', serif;
    font-style: italic;
    padding: 12px 16px;
    margin: 15px 0; /* Spazio sopra e sotto */
    border-radius: 4px;
    font-size: 0.95em;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
}

/* 2. IL DIALOGO (Personaggi) - Bolle separate */
.msg-char {
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 10px; /* Separazione tra messaggi */
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    max-width: 90%; /* Non prende tutta la larghezza */
}

/* Nome del personaggio sopra il messaggio */
.char-name {
    color: var(--accent); /* Oro */
    font-size: 0.75em;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: bold;
    margin-bottom: 4px;
    display: block;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 4px;
}

.char-text {
    color: #eee;
    line-height: 1.5;
    font-size: 1em;
}

/* 3. LE AZIONI (Proposte) - Contenitore dedicato */
.msg-actions {
    margin-top: 15px;
    padding: 10px;
    background: rgba(44, 62, 80, 0.3); /* Bluastro scuro */
    border: 1px dashed var(--accent);
    border-radius: 12px;
    text-align: center;
}

.action-header {
    font-size: 0.8em;
    text-transform: uppercase;
    color: #888;
    margin-bottom: 8px;
}

.market-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
}

.market-item {
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg-panel);
}

.market-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 8px;
}

.market-prices {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.market-stats {
    font-size: 0.8em;
    color: var(--text-soft);
}

.resource-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
}

.resource-stat-item {
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    padding: 8px;
    background: var(--bg-panel);
}

.resource-stat-header {
    font-weight: bold;
    margin-bottom: 4px;
}

.resource-stat-values {
    display: flex;
    justify-content: space-between;
    font-size: 0.8em;
}

.resource-stat-values .positive { color: #6ada91; }
.resource-stat-values .negative { color: #ff7c7c; }

.market-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 12px;
}

.market-item {
    border: 1px solid var(--border-soft);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg-panel);
}

.market-item.special {
    border-color: var(--accent);
    background: rgba(212, 175, 55, 0.1);
}

.market-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    margin-bottom: 8px;
}

.market-prices {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}

.market-stats {
    font-size: 0.8em;
    color: var(--text-soft);
}

.market-desc {
    font-size: 0.8em;
    color: var(--text-soft);
    margin-top: 4px;
}

.diplomacy-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.market-section {
    margin-bottom: 20px;
}

.market-section h5 {
    color: var(--accent);
    margin-bottom: 8px;
    font-size: 0.9em;
}

.market-item.surplus {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.1);
}

.market-item.deficit {
    border-color: #f44336;
    background: rgba(244, 67, 54, 0.1);
}

.market-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    background: var(--bg-panel);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    overflow: hidden;
}

.market-table th {
    background: var(--bg-panel-alt);
    color: var(--accent);
    padding: 12px 8px;
    text-align: left;
    font-weight: bold;
    border-bottom: 1px solid var(--border-soft);
}

.market-table td {
    padding: 10px 8px;
    border-bottom: 1px solid var(--border-soft);
    vertical-align: middle;
}

.market-table tr:hover {
    background: rgba(212, 175, 55, 0.05);
}

.market-table .btn-sec {
    margin: 0 2px;
    padding: 4px 8px;
    font-size: 0.8em;
}

/* ===================== CLASSI SOCIALI ===================== */
/* ===================== NUOVE CARD CATEGORIE SOCIALI ===================== */
.social-classes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 16px;
}

.social-class-card {
    background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-panel-alt) 100%);
    border: 2px solid var(--border-soft);
    border-radius: 20px;
    padding: 0;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
    position: relative;
}

.social-class-card:hover {
    border-color: var(--accent);
    box-shadow: 0 8px 25px rgba(212,175,55,0.3);
    transform: translateY(-5px);
}

.social-class-card.expanded {
    grid-column: 1 / -1;
    max-width: 100%;
}

.social-class-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 30px 20px;
    background: linear-gradient(135deg, rgba(212,175,55,0.05), transparent);
    border-bottom: 1px solid var(--border-soft);
}

.social-class-icon {
    font-size: 5em;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
    transition: all 0.3s ease;
}

.social-class-card:hover .social-class-icon {
    transform: scale(1.1);
}

.social-class-name {
    color: var(--accent);
    font-size: 1.4em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.social-class-stats {
    display: flex;
    justify-content: space-around;
    padding: 20px;
    gap: 15px;
}

.social-class-stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.social-class-count {
    font-size: 1.8em;
    font-weight: bold;
    color: var(--text);
}

.social-class-wealth {
    font-size: 1.1em;
    color: var(--accent-muted);
}

.social-class-label {
    font-size: 0.8em;
    color: var(--text-soft);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Dettagli espansi della card */
.social-class-details {
    display: none;
    padding: 25px;
    background: rgba(0,0,0,0.3);
    border-top: 1px solid var(--border-soft);
    text-align: left;
}

.social-class-card.expanded .social-class-details {
    display: block;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h4 {
    color: var(--accent);
    font-size: 1.1em;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.detail-section p {
    color: var(--text-soft);
    line-height: 1.6;
    margin: 5px 0;
}

.detail-section ul {
    list-style: none;
    padding: 0;
}

.detail-section li {
    color: var(--text-soft);
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.detail-section li:before {
    content: "â–¸ ";
    color: var(--accent);
    font-weight: bold;
}

.chat-link-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(120deg, var(--accent), var(--accent-muted));
    color: black;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.chat-link-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(212,175,55,0.5);
}

/* ===================== POPUP DETTAGLI CLASSE ===================== */
#class-modal {
    z-index: 7000;
}

#class-modal .modal-content {
    width: min(760px, 94vw);
    background: linear-gradient(140deg, rgba(18,18,18,0.98), rgba(10,10,10,0.95));
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 20px 60px rgba(0,0,0,0.65);
    padding: 18px 20px 22px;
}

.class-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 14px;
}

.class-title {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.class-title h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    letter-spacing: 1px;
}

.class-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--text-soft);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.85em;
}

.class-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 12px;
    margin: 16px 0;
}

.class-meta-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 10px 12px;
}

.class-meta-card .label {
    color: var(--text-soft);
    font-size: 0.8em;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.class-meta-card .value {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--accent);
}

.class-columns {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    margin: 10px 0 18px;
}

.class-box {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 12px;
    padding: 12px;
}

.class-box h4 {
    margin: 0 0 8px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent);
    font-size: 0.9em;
}

.class-box ul {
    margin: 0;
    padding-left: 18px;
    color: var(--text);
    line-height: 1.5;
}

.class-box .pill-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 0;
    list-style: none;
}

.class-box .pill-list li {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 6px 10px;
    color: var(--text);
    font-size: 0.9em;
}

.class-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

.btn-ghost {
    background: transparent;
    border: 1px solid var(--border-soft);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-ghost:hover {
    border-color: var(--accent);
    color: var(--accent);
}

/* Override generale per i modali: assicurati che stiano sopra i tab */
.modal {
    z-index: 7000 !important;
}
.modal .modal-content {
    position: relative;
}

/* Sintesi Economia / Sviluppo */
.eco-summary-grid,
.dev-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin: 12px 0 18px;
}

.eco-card,
.dev-card {
    background: linear-gradient(160deg, rgba(255,255,255,0.03), rgba(0,0,0,0.1));
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 6px 22px rgba(0,0,0,0.35);
}

.eco-card .label,
.dev-card .label {
    color: var(--text-soft);
    font-size: 0.8em;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.eco-card .value,
.dev-card .value {
    font-size: 1.3em;
    font-weight: 700;
    color: var(--accent);
}

.eco-card small,
.dev-card small {
    color: var(--text-soft);
}

/* ===================== MENU LATERALE STATISTICHE ===================== */
.domain-stats-sidebar {
    position: fixed;
    right: -350px;
    top: 0;
    width: 350px;
    height: 100vh;
    background: linear-gradient(135deg, var(--bg-panel) 0%, var(--bg-main) 100%);
    border-left: 2px solid var(--accent);
    box-shadow: -5px 0 25px rgba(0,0,0,0.5);
    z-index: 1000;
    transition: right 0.3s ease;
    overflow-y: auto;
    padding: 20px;
}

.domain-stats-sidebar.open {
    right: 0;
}

.sidebar-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: none;
    color: var(--accent);
    font-size: 1.5em;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.sidebar-close-btn:hover {
    transform: rotate(90deg);
}

.sidebar-header {
    color: var(--accent);
    font-size: 1.3em;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--accent);
}

.sidebar-stat-group {
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    border: 1px solid var(--border-soft);
}

.sidebar-stat-group h4 {
    color: var(--accent-muted);
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
}

.sidebar-stat-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.sidebar-stat-item:last-child {
    border-bottom: none;
}

.sidebar-stat-label {
    color: var(--text-soft);
    font-size: 0.9em;
}

.sidebar-stat-value {
    color: var(--text);
    font-weight: bold;
}

.sidebar-toggle-btn {
    position: fixed;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, var(--accent), var(--accent-muted));
    border: none;
    color: black;
    padding: 15px 8px;
    border-radius: 8px 0 0 8px;
    cursor: pointer;
    font-size: 1.2em;
    z-index: 3000;
    box-shadow: -3px 0 15px rgba(212,175,55,0.4);
    transition: all 0.3s ease;
}

.sidebar-toggle-btn:hover {
    padding-right: 12px;
    box-shadow: -5px 0 25px rgba(212,175,55,0.6);
}

/* Popup modale per statistiche dettagliate */
.stats-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    justify-content: center;
    align-items: center;
}

.stats-popup.active {
    display: flex;
}

.stats-popup-content {
    background: linear-gradient(135deg, var(--bg-panel), var(--bg-panel-alt));
    border: 2px solid var(--accent);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 50px rgba(212,175,55,0.3);
}

.stats-popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--accent);
}

.stats-popup-title {
    color: var(--accent);
    font-size: 1.5em;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.popup-close-btn {
    background: transparent;
    border: none;
    color: var(--accent);
    font-size: 1.5em;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.popup-close-btn:hover {
    transform: rotate(90deg);
}

@media (max-width: 768px) {
    .domain-stats-sidebar {
        width: 100%;
        right: -100%;
    }
    
    .sidebar-toggle-btn {
        right: 5px;
        padding: 12px 6px;
        font-size: 1em;
    }
}

/* ===================== STILI MERCATO MIGLIORATI ===================== */

.market-qty-input {
    width: 60px !important; /* Forza larghezza fissa */
    padding: 6px !important;
    text-align: center;
    margin: 0 4px;
    background: #222;
    border: 1px solid var(--border-soft);
    color: var(--text);
    border-radius: 4px;
}

/* Nascondi le frecce input number (opzionale, per pulizia) */
.market-qty-input::-webkit-outer-spin-button,
.market-qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Responsive Table: Trasforma la tabella in card su mobile */
@media (max-width: 768px) {
    .market-table, .market-table tbody, .market-table tr, .market-table td {
        display: block;
        width: 100%;
    }
    
    .market-table thead {
        display: none; /* Nascondi intestazione su mobile */
    }
    
    .market-table tr {
        margin-bottom: 15px;
        background: var(--bg-panel);
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .market-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        text-align: right;
    }
    
    .market-table td:last-child {
        border-bottom: none;
        padding-top: 12px;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    /* Aggiunge etichette simulate via CSS per ogni cella */
    .market-table td:nth-of-type(1):before { content: "Risorsa"; font-weight: bold; color: var(--accent); }
    .market-table td:nth-of-type(2):before { content: "In Stock"; color: var(--text-soft); }
    .market-table td:nth-of-type(3):before { content: "Fabbisogno"; color: var(--text-soft); }
    .market-table td:nth-of-type(4):before { content: "Domanda"; color: var(--text-soft); }
    .market-table td:nth-of-type(5):before { content: "Offerta"; color: var(--text-soft); }
    .market-table td:nth-of-type(6):before { content: "Prezzo Acquisto"; color: #ff7c7c; }
    .market-table td:nth-of-type(7):before { content: "Prezzo Vendita"; color: #6ada91; }

    /* Nascondi il label per la cella delle azioni */
    .market-table td:last-child:before { content: ""; display: none; }

    /* Stile risorsa principale piÃ¹ grande */
    .market-table td:nth-of-type(1) {
        font-size: 1.1em;
        border-bottom: 1px solid var(--accent);
        margin-bottom: 8px;
        padding-bottom: 8px;
    }
}

/* ===================== STILI DINASTIA ===================== */

.dynasty-header-card {
    background: linear-gradient(135deg, #2c1e10, #1a1a1a);
    border: 2px solid var(--accent);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.dynasty-role {
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text-soft);
    margin-bottom: 5px;
}

.dynasty-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 10px 0;
    font-size: 1.1em;
}

.dynasty-traits {
    font-style: italic;
    color: #aaa;
}

.dynasty-section {
    margin-bottom: 20px;
    background: rgba(255,255,255,0.03);
    padding: 15px;
    border-radius: 12px;
    border: 1px solid var(--border-soft);
}

.dynasty-section h4 {
    border-bottom: 1px solid var(--border-soft);
    padding-bottom: 8px;
    margin-bottom: 15px;
    color: var(--accent);
}

.dynasty-empty-slot {
    text-align: center;
    padding: 20px;
    border: 2px dashed var(--border-soft);
    border-radius: 8px;
    color: var(--text-soft);
}

.heir-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
}

.person-card-ui {
    background: #222;
    border: 1px solid #444;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
}

.person-card-ui.heir { border-color: #6ada91; }
.person-card-ui.spouse { border-color: #d4af37; }

.candidate-card {
    background: #1a1a1a;
    border: 1px solid #444;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.candidate-origin { font-size: 0.8em; color: var(--accent); }
.candidate-bonus { font-size: 0.9em; color: #81c784; }

/* ===================== NUOVO HUD (STILE DARK MEDIEVAL) ===================== */

/* Barra Superiore (Contenitore Generale) */
.top-hud {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    /* Sfondo scuro semitrasparente uniforme al gioco */
    background: rgba(12, 12, 12, 0.95); 
    border-bottom: 1px solid var(--border-soft);
    z-index: 1000;
    padding: 10px 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 60px; /* Altezza fissa desktop */
}

/* Statistiche (Sinistra/Alto) */
.hud-stats-bar {
    display: flex;
    gap: 20px;
    align-items: center;
}

.hud-stats-bar .stat {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.95em;
    color: var(--text);
    font-family: 'Georgia', serif;
}

.hud-stats-bar .stat i {
    color: var(--accent); /* Oro */
    font-size: 1.1em;
}

/* Navigazione (Destra/Basso) */
.hud-nav-bar {
    display: flex;
    gap: 8px;
}

.hud-nav-bar button {
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-soft);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Georgia', serif;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Hover e Stato Attivo */
.hud-nav-bar button:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
}

.hud-nav-bar button.active {
    background: rgba(212, 175, 55, 0.15); /* Oro scuro trasparente */
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
}

/* Spaziatura contenuto principale per non finire sotto la barra */
.system-toolbar {
    margin-top: 130px; 
    padding: 20px;
}

/* ===================== MOBILE REDESIGN (USER FRIENDLY) ===================== */
@media (max-width: 768px) {
    
    /* 1. La barra superiore tiene SOLO le statistiche */
    .top-hud {
        height: 50px;
        padding: 0 12px;
        justify-content: center;
        background: #080808; /* Nero quasi totale */
        border-bottom: 1px solid #333;
    }

    .hud-stats-bar {
        width: 100%;
        justify-content: space-between;
        gap: 0;
        font-size: 0.8em; /* Testo piÃ¹ piccolo */
    }
    
    /* Nascondiamo l'icona o riduciamo spazio se necessario */
    .hud-stats-bar .stat { gap: 4px; }

    /* 2. La barra di navigazione scende in BASSO (App Style) */
    .hud-nav-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #121212; /* Grigio scuro */
        border-top: 1px solid var(--accent); /* Linea dorata sopra */
        height: 70px; /* Altezza fissa per il tocco */
        z-index: 2000;
        
        /* Abilita lo scroll orizzontale se i pulsanti sono troppi */
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        
        /* Centratura e spaziatura */
        padding: 8px 10px;
        gap: 12px;
        justify-content: flex-start; /* Allinea a sinistra per lo scroll */
        
        /* Nascondi scrollbar nativa ma permetti scroll */
        -webkit-overflow-scrolling: touch; 
        scrollbar-width: none; /* Firefox */
    }
    
    .hud-nav-bar::-webkit-scrollbar { 
        display: none; /* Chrome/Safari */
    }

    /* Stile Pulsanti Mobile */
    .hud-nav-bar button {
        flex: 0 0 auto; /* Non schiacciare i pulsanti */
        display: flex;
        flex-direction: column; /* Icona sopra, testo sotto */
        justify-content: center;
        align-items: center;
        min-width: 65px;
        padding: 4px;
        font-size: 0.65em; /* Testo molto piccolo leggibile */
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        color: #aaa;
    }
    
    /* Rimuoviamo emoji dal testo se necessario o le ingrandiamo */
    .hud-nav-bar button {
        gap: 4px;
    }

    /* Stato attivo mobile molto visibile */
    .hud-nav-bar button.active {
        background: #252525;
        border-color: var(--accent);
        color: #fff;
        transform: translateY(-2px);
    }

    /* Aggiustiamo i margini del contenuto */
    .system-toolbar {
        margin-top: 110px; /* Spazio per stats sopra */
        margin-bottom: 80px; /* Spazio per nav sotto */
        padding: 10px;
    }

    .domain-quick-nav {
        position: static;
        top: auto;
        display: flex;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        padding: 8px 4px;
    }

    .domain-quick-nav button {
        flex: 0 0 auto;
        font-size: 0.7em;
    }

    .domain-quick-btn {
        width: auto;
        min-width: 120px;
    }

    .domain-quick-summary {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
    }
    
    /* Nascondiamo la vecchia bottom-nav se presente nel codice originale per evitare duplicati */
    .bottom-nav {
        display: none !important; 
    }
}

/* Stili Pannello Bisogni */
.needs-legend {
    font-size: 0.75em;
    margin-bottom: 10px;
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.need-entry {
    background: rgba(12,12,12,0.6);
    border: 1px solid var(--border-soft);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.need-entry-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    font-weight: bold;
    color: var(--accent);
}

.need-bars-container {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.need-bar-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.8em;
    color: var(--text-soft);
}

.need-bar-row span {
    width: 90px;
    color: var(--text);
    font-weight: 600;
}

.need-track {
    flex: 1;
    height: 10px;
    background: linear-gradient(90deg, rgba(40,40,40,0.9), rgba(20,20,20,0.9));
    border: 1px solid var(--border-soft);
    border-radius: 6px;
    overflow: hidden;
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.45);
}

.need-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
}

.fill-prim { background: linear-gradient(90deg, #4caf50, #6ada91); }
.fill-sec { background: linear-gradient(90deg, #2196f3, #64b5f6); }

/* Status Warning */
.need-warning {
    color: #ff7c7c;
    font-size: 0.8em;
    margin-top: 4px;
    font-style: italic;
    background: rgba(255, 0, 0, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
}

/* Stile per il Modale Cronache */
.chronicle-content {
    max-width: 650px;
    background: #1a1612; /* Sfondo scuro caldo/marrone */
    border: 2px solid var(--accent);
    box-shadow: 0 0 50px rgba(0,0,0,0.9);
    text-align: left;
    font-family: 'Georgia', serif; /* Font serif per la narrativa */
    line-height: 1.6;
    color: #e0d8c0; /* Colore pergamena chiaro per il testo */
}

.chronicle-header {
    text-align: center;
}

.chronicle-header h2 {
    font-family: 'Cinzel', serif; /* Se disponibile, o Georgia */
    color: var(--accent);
    letter-spacing: 2px;
    margin-bottom: 5px;
}

.chronicle-text {
    font-size: 1.1em;
    min-height: 200px;
    white-space: pre-wrap; /* Mantiene i paragrafi dell'IA */
}

.chronicle-text p {
    margin-bottom: 15px;
}

/* Animazione caricamento */
.loading-story {
    text-align: center;
    padding: 40px;
    color: #888;
    font-style: italic;
}

.scribe-icon {
    font-size: 3em;
    display: block;
    margin-bottom: 15px;
    animation: writing 1s infinite alternate;
}

@keyframes writing {
    from { transform: rotate(-5deg); }
    to { transform: rotate(5deg); }
}

/* Messaggi dei Sovrani Stranieri */
.msg-foreign {
    border-left: 4px solid; 
    background: rgba(30, 20, 20, 0.8);
    padding: 15px;
    margin: 10px 0;
    border-radius: 0 10px 10px 0;
    position: relative;
}

.msg-foreign.auvrey { border-color: #d32f2f; } /* Rosso per Auvrey (Aggressivi) */
.msg-foreign.falken { border-color: #1976d2; } /* Blu per Falken (Commerciali) */

.foreign-badge {
    font-size: 0.7em;
    text-transform: uppercase;
    background: #000;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 5px;
    display: inline-block;
    letter-spacing: 1px;
}

.msg-actions {
    margin-top: 15px;
    padding: 15px;
    background: rgba(44, 62, 80, 0.5);
    border: 1px dashed var(--accent);
    border-radius: 12px;
    text-align: center;
    position: relative; /* Importante */
    z-index: 10;        /* Assicura che sia sopra lo sfondo */
}

.action-card {
    display: block;
    width: 100%;
    margin-bottom: 8px;
    padding: 12px;
    background: #1f2a36;
    border: 1px solid #34495e;
    color: #ecf0f1;
    border-radius: 8px;
    cursor: pointer; /* Fondamentale per UX */
    text-align: left;
    transition: background 0.2s, transform 0.1s;
    pointer-events: auto; /* Assicura che riceva i click */
}

.action-card:hover {
    background: #2c3e50;
    border-color: var(--accent);
    transform: translateX(5px);
}

.action-card:active {
    transform: scale(0.98);
}

.resource-warning {
    animation: pulse-red 2s infinite;
    border-color: red;
}

@keyframes pulse-red {
    0% { border-color: red; }
    50% { border-color: #ff4444; }
    100% { border-color: red; }
}

.budget-delta {
    font-size: 0.8em;
    margin-left: 5px;
    font-weight: bold;
}

.budget-delta.pos {
    color: #4caf50;
}

.budget-delta.neg {
    color: #f44336;
}

.map-context-menu {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 10px;
    display: none;
    z-index: 1000;
    min-width: 150px;
}

.map-context-menu .map-menu-btn {
    display: block;
    width: 100%;
    background: none;
    border: none;
    color: var(--text);
    padding: 8px;
    text-align: left;
    cursor: pointer;
    border-radius: 4px;
}

.map-context-menu .map-menu-btn:hover {
    background: var(--accent);
    color: var(--bg-main);
}

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background: rgba(0, 0, 0, 0.8);
    color: var(--text);
    padding: 12px 16px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease-out;
    max-width: 300px;
    word-wrap: break-word;
}

.toast.toast-warning {
    border-left-color: #ff9800;
}

.toast.toast-error {
    border-left-color: #f44336;
}

.toast.toast-success {
    border-left-color: #4caf50;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.faction-power-btn {
    background: linear-gradient(135deg, var(--accent), #b8860b);
    border: 1px solid var(--accent);
    color: var(--bg-main);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8em;
    transition: all 0.2s;
}

.faction-power-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
}

.faction-power-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.io-chain {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 4px 0;
    font-size: 0.85em;
}

.io-arrow {
    color: var(--accent);
    font-weight: bold;
}

.io-missing {
    color: #f44336;
    font-weight: bold;
}

/* Production Chain Styles */
.production-chain {
    margin: 15px 0;
    padding: 12px;
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    border: 1px solid var(--border-soft);
}

.chain-inputs, .chain-outputs {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.chain-inputs h5, .chain-outputs h5 {
    margin: 0 0 6px 0;
    color: var(--accent);
    font-size: 0.9em;
    font-weight: bold;
}

.chain-building {
    background: var(--bg-panel);
    padding: 8px 12px;
    border-radius: 6px;
    border: 2px solid var(--accent);
    font-weight: bold;
    color: var(--text);
    text-align: center;
    min-width: 120px;
}

.chain-arrow {
    color: var(--accent);
    font-size: 1.2em;
    font-weight: bold;
    margin: 0 8px;
}

.chain-resource {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85em;
    background: rgba(255,255,255,0.1);
}

.chain-resource.input {
    background: rgba(255, 124, 124, 0.2);
    border-left: 3px solid #ff7c7c;
}

.chain-resource.output {
    background: rgba(106, 218, 145, 0.2);
    border-left: 3px solid #6ada91;
}

.chain-resource.upkeep {
    background: rgba(255, 193, 7, 0.2);
    border-left: 3px solid #ffc107;
}

.chain-upkeep {
    margin-top: 10px;
    padding: 8px;
    background: rgba(255, 193, 7, 0.1);
    border-radius: 6px;
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.chain-upkeep h5 {
    margin: 0 0 6px 0;
    color: #ffc107;
    font-size: 0.9em;
    font-weight: bold;
}

.upkeep-gold {
    color: #ffc107;
    font-weight: bold;
    margin-bottom: 4px;
}

.upkeep-resources {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

    

/* ===== MIGLIORAMENTI VISUALI (NON TOCCA CODICE ESISTENTE) ===== */

/* Top Statistics Bar */
.top-stats-bar {
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    z-index: 3000;
    background: linear-gradient(135deg, rgba(15,15,15,0.98), rgba(8,8,8,0.95));
    backdrop-filter: blur(10px);
    border-bottom: 2px solid var(--border-soft);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    flex-wrap: wrap;
    gap: 12px;
}

.top-stats-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.top-stats-logo {
    font-size: 1.8em;
    animation: floatLogo 3s ease-in-out infinite;
}

@keyframes floatLogo {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
}

.top-stats-title {
    font-size: 1.2em;
    color: var(--accent);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.top-stats-right {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
}

.stat-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    background: var(--bg-panel-alt);
    border: 2px solid var(--border-soft);
    border-radius: 20px;
    font-size: 0.95em;
    transition: all 0.3s ease;
    cursor: help;
}

.stat-badge:hover {
    border-color: var(--accent-muted);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(212,175,55,0.2);
}

.stat-icon {
    font-size: 1.2em;
}

.stat-value {
    color: var(--accent);
    font-weight: bold;
    min-width: 40px;
    text-align: right;
}

/* Navigazione rapida sezione Dominio */
.domain-quick-nav {
    position: sticky;
    top: 96px;
    z-index: 2500;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    padding: 14px;
    margin-bottom: 12px;
    background: linear-gradient(180deg, rgba(7,7,7,0.95), rgba(5,5,5,0.9));
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 14px;
    backdrop-filter: blur(6px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.35);
}

.domain-quick-nav { box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset; }
.domain-overview-grid { box-shadow: 0 6px 30px rgba(0,0,0,0.6); padding: 6px; }

@keyframes fadeInUp { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
.domain-stat { animation: fadeInUp 0.35s ease both; }

.domain-quick-nav button {
    background: rgba(20,20,20,0.9);
    border: 1px solid var(--border-soft);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 0.85em;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 46px;
}

.domain-quick-nav button:hover,
.domain-quick-nav button.active {
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 4px 12px rgba(212,175,55,0.2);
}

.domain-quick-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin: 15px 0 25px;
}

.summary-card {
    background: rgba(10,10,10,0.8);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    transition: border-color 0.2s ease, transform 0.2s ease;
}

.summary-card .summary-label {
    font-size: 0.85em;
    letter-spacing: 1px;
    color: var(--text-soft);
    text-transform: uppercase;
}

.summary-card .summary-value {
    font-size: 1.6em;
    font-weight: bold;
}

.summary-card .summary-hint {
    font-size: 0.85em;
    color: var(--text-soft);
}

.summary-card.status-ok {
    border-color: rgba(106,218,145,0.4);
    box-shadow: inset 0 0 10px rgba(106,218,145,0.08);
}

.summary-card.status-warn {
    border-color: rgba(255,152,0,0.5);
    box-shadow: inset 0 0 10px rgba(255,152,0,0.08);
}

.summary-card.status-critical {
    border-color: rgba(244,67,54,0.6);
    box-shadow: inset 0 0 12px rgba(244,67,54,0.15);
}

.summary-card:hover {
    transform: translateY(-2px);
}

/* Domain quick nav buttons - specific override to avoid global button styles */
.domain-quick-btn {
    background: linear-gradient(180deg,#121212,#0d0d0d);
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 6px;
    width: 100%;
    min-width: 0;
    font-size: 0.9em;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
}

.domain-quick-btn:hover { 
    border-color: var(--accent);
    color: var(--accent);
}

.domain-quick-btn.active {
    background: linear-gradient(180deg, rgba(212,175,55,0.12), rgba(212,175,55,0.06));
    border-color: rgba(212,175,55,0.28);
    color: var(--accent);
    transform: translateY(-2px);
}

/* Layout per grid overview */
.domain-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.domain-stat {
    display: flex;
    align-items: center;
    gap: 12px;
    background: linear-gradient(180deg, rgba(22,22,22,0.95), rgba(12,12,12,0.85));
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 10px 12px;
    transition: transform 0.18s ease, box-shadow 0.18s ease;
}

/* Status visual for domain-stat (green/yellow/red) */
.domain-stat.status-ok { border-left: 4px solid rgba(106,218,145,0.7); }
.domain-stat.status-warn { border-left: 4px solid rgba(255,152,0,0.8); }
.domain-stat.status-critical { border-left: 4px solid rgba(244,67,54,0.9); }

.domain-stat:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.6); }
.domain-stat .stat-icon { font-size: 1.6em; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.8));
    width: 44px; height: 44px; display:flex; align-items:center; justify-content:center; border-radius:8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); }
.domain-stat .stat-body { display:flex; flex-direction: column; gap: 3px; }
.domain-stat .stat-label { color: var(--text-soft); font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
.domain-stat .stat-value { color: var(--accent); font-weight: 700; font-size: 1.25em; }
.domain-stat .stat-value.pulse { animation: pulseValue 0.8s ease both; }
@keyframes pulseValue { 0% { transform: scale(1); } 40% { transform: scale(1.08); } 100% { transform: scale(1); } }
.domain-stat .stat-hint { font-size: 0.8em; color: var(--text-soft); opacity:0.9 }

@media (max-width: 600px) {
    .domain-overview-grid { grid-template-columns: repeat(1,1fr); }
    .domain-stat { padding: 10px; }
}

/* Celebrate animation */
@keyframes celebrate {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.15) rotate(-5deg); }
    50% { transform: scale(1.15) rotate(0deg); }
    75% { transform: scale(1.15) rotate(5deg); }
}

.celebrate {
    animation: celebrate 0.6s ease-in-out;
}

/* Tooltip migliorato */
.tooltip {
    position: relative;
}

.tooltip::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-5px);
    background: var(--bg-panel);
    border: 2px solid var(--accent);
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    font-size: 0.85em;
    z-index: 1000;
}

.tooltip:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(-8px);
}

/* Miglioramenti hover per elementi esistenti */
.btn-main {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.btn-main::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s ease;
}

.btn-main:hover::before {
    left: 100%;
}

.btn-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 30px rgba(212,175,55,0.4);
}

.btn-main:active {
    transform: translateY(0);
}

/* Cards con hover migliorato */
.start-card:hover,
.action-card:hover,
.panel:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    border-color: var(--accent-muted);
}

.start-card,
.action-card,
.panel {
    transition: all 0.3s ease;
}

/* Tabs migliorate */
.tab-btn {
    transition: all 0.3s ease;
}

.tab-btn:hover {
    transform: translateY(-2px);
}

.tab-btn.active {
    box-shadow: 0 4px 20px rgba(212,175,55,0.3);
}

/* Scrollbar migliorata */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: var(--bg-panel);
    border-radius: 5px;
}

::-webkit-scrollbar-thumb {
    background: var(--border-strong);
    border-radius: 5px;
    transition: background 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--accent-muted);
}

/* Focus states accessibili */
button:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

/* Responsive per top bar */
@media (max-width: 768px) {
    .top-stats-bar {
        top: 50px;
        flex-direction: column;
        padding: 10px 15px;
    }
    
    .top-stats-right {
        width: 100%;
        justify-content: center;
    }
    
    .stat-badge {
        font-size: 0.85em;
        padding: 6px 10px;
    }
}

@media (max-width: 480px) {
    .top-stats-right {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        width: 100%;
    }
    
    .stat-badge {
        justify-content: center;
    }
}


</style>
</head>

<body>

<!-- ===== TOP STATISTICS BAR (MIGLIORAMENTO) ===== -->
<div class="top-stats-bar" id="top-stats-bar" style="display: none;">
    <div class="top-stats-left">
        <span class="top-stats-logo">ðŸ‘‘</span>
        <span id="top-hero-name" class="top-stats-title">Il Conte</span>
    </div>
    <div class="top-stats-right">
        <div class="stat-badge tooltip" data-tooltip="Popolazione totale">
            <span class="stat-icon">ðŸ‘¥</span>
            <span class="stat-value" id="top-pop">0</span>
        </div>
        <div class="stat-badge tooltip" data-tooltip="Tesoro del Conte">
            <span class="stat-icon">ðŸ’°</span>
            <span class="stat-value" id="top-gold">0</span>
        </div>
        <div class="stat-badge tooltip" data-tooltip="DisponibilitÃ  cibo">
            <span class="stat-icon">ðŸŒ¾</span>
            <span class="stat-value" id="top-food">0%</span>
        </div>
        <div class="stat-badge tooltip" data-tooltip="FelicitÃ  generale">
            <span class="stat-icon">ðŸ˜Š</span>
            <span class="stat-value" id="top-happiness">0%</span>
        </div>
    </div>
</div>

<div id="toast-container" class="toast-container"></div>
<div id="map-menu" class="map-context-menu"></div>

<!-- MENU INIZIALE MIGLIORATO -->
<div id="screen-start" class="screen active">
    <!-- Hero Section -->
    <div class="start-hero-enhanced">
        <div class="hero-crown">ðŸ‘‘</div>
        <h1 class="hero-title">Il Conte a Corte</h1>
        <p class="hero-subtitle">Simulatore Medievale Completo</p>
        <div class="hero-divider"></div>
        <p class="hero-description">Gestisci il tuo dominio attraverso le stagioni, bilancia le fazioni, costruisci il tuo regno e lascia un'ereditÃ  immortale</p>
    </div>

    <!-- Main Action Cards -->
    <div class="start-main-actions">
        <div class="action-card action-card-primary" onclick="goToEditorScreen()">
            <div class="action-icon">âš”ï¸</div>
            <h3>Nuova Partita</h3>
            <p>Inizia una nuova avventura medievale. Crea il tuo conte, configura la corte e plasmare il destino del tuo regno.</p>
            <div class="action-cta">Crea Regno â†’</div>
        </div>

        <div class="action-card action-card-secondary" onclick="openLoadModal()">
            <div class="action-icon">ðŸ“œ</div>
            <h3>Carica Partita</h3>
            <p>Riprendi una delle tue avventure salvate e continua a governare il tuo dominio.</p>
            <div id="save-list-preview" class="save-preview"></div>
            <div class="action-cta">Gestisci Salvataggi â†’</div>
        </div>
    </div>

    <!-- Features Grid -->
    <div class="features-section">
        <h3 class="features-title">Caratteristiche del Gioco</h3>
        <div class="features-grid">
            <div class="feature-item">
                <div class="feature-icon">ðŸ°</div>
                <div class="feature-name">Gestione Dominio</div>
                <div class="feature-desc">Amministra risorse, popolazione e sviluppo</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ðŸ‘¥</div>
                <div class="feature-name">Fazioni & SocietÃ </div>
                <div class="feature-desc">8 classi sociali con interessi contrastanti</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">âš”ï¸</div>
                <div class="feature-name">Guerra & Diplomazia</div>
                <div class="feature-desc">Gestisci eserciti e relazioni con contee vicine</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ðŸ—ºï¸</div>
                <div class="feature-name">Mappa Dinamica</div>
                <div class="feature-desc">Esplora territori e risorse geografiche</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ðŸŒ¾</div>
                <div class="feature-name">Ciclo Stagionale</div>
                <div class="feature-desc">Ogni stagione influenza economia e eventi</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ðŸ‘‘</div>
                <div class="feature-name">Sistema Dinastico</div>
                <div class="feature-desc">Costruisci un'ereditÃ  attraverso generazioni</div>
            </div>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="start-grid">
        <div class="start-card settings-card">
            <div class="card-header">
                <span class="card-icon">ðŸ”‘</span>
                <h3>Configurazione API</h3>
            </div>
            <p class="card-description">Archivia la chiave API Groq per attivare le funzionalitÃ  AI del gioco.</p>
            <input id="api-key-start" type="password" placeholder="gsk_xxxxxxxxxxxxxxxxxx" />
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn-main" onclick="saveApiKeyFromStart()">ðŸ’¾ Salva Chiave</button>
                <button class="btn-sec" onclick="clearStoredApiKey()">ðŸ—‘ï¸ Rimuovi</button>
            </div>
            <span id="api-key-status" class="api-status">âš ï¸ Chiave non impostata</span>
        </div>

        <div class="start-card settings-card">
            <div class="card-header">
                <span class="card-icon">ðŸŽ­</span>
                <h3>Editor PersonalitÃ </h3>
            </div>
            <p class="card-description">Personalizza il tono e l'atmosfera della tua corte.</p>
            
            <label for="personality-tone">Tono del Consigliere</label>
            <select id="personality-tone">
                <option value="saggio">ðŸ§™ Saggio e Riflessivo</option>
                <option value="pragmatico">âš–ï¸ Pragmatico e Diretto</option>
                <option value="ambizioso">ðŸ‘‘ Ambizioso e Visionario</option>
                <option value="misterioso">ðŸ”® Misterioso e Enigmatico</option>
            </select>

            <label for="personality-mood">Atmosfera della Corte</label>
            <select id="personality-mood">
                <option value="prudente">ðŸ›¡ï¸ Prudente e Cauta</option>
                <option value="bellicosa">âš”ï¸ Bellicosa e Aggressiva</option>
                <option value="visionaria">âœ¨ Visionaria e Innovativa</option>
                <option value="ombrosa">ðŸŒ™ Ombrosa e Intrigante</option>
            </select>

            <label for="personality-notes">Appunti della Corte</label>
            <textarea id="personality-notes" placeholder="Es. Il regno deve prosperare attraverso il commercio, mai attraverso la guerra..."></textarea>

            <button class="btn-main" onclick="savePersonalitySettingsForm()">ðŸ’¾ Salva Configurazione</button>
        </div>
    </div>

    <!-- Footer -->
    <div class="start-footer">
        <p>ðŸ° Simulatore Medievale Completo v2.0 â€¢ Gestisci, conquista, sopravvivi</p>
    </div>
</div>

<!-- SCHERMATA LOGIN -->
<div id="screen-login" class="screen">
    <h2>Accesso al Regno</h2>
    <label>Chiave API Groq:</label>
    <input id="api-key-input" type="text" placeholder="gsk_xxxxxxxxx" />

    <button class="btn-main" onclick="loginManual()">Entra</button>
</div>

<!-- EDITOR INIZIALE MIGLIORATO -->
<div id="screen-editor" class="screen">
    <div class="editor-header">
        <button class="btn-back" onclick="backToStart()">â† Indietro</button>
        <div class="editor-title">
            <h2>âš”ï¸ Crea il tuo Regno</h2>
            <p>Configura i dettagli del tuo dominio e inizia la tua avventura medievale</p>
        </div>
    </div>

    <div class="editor-grid">
        <div class="editor-section">
            <div class="section-header">
                <span class="section-icon">ðŸ‘‘</span>
                <h3>Il Conte</h3>
            </div>
            <label>Nome del Conte:</label>
            <input id="hero-name" type="text" placeholder="Es. Conte Alaric di Valmont" />
        </div>

        <div class="editor-section">
            <div class="section-header">
                <span class="section-icon">ðŸ°</span>
                <h3>La Contea</h3>
            </div>
            <label>Descrivi la tua Contea iniziale:</label>
            <textarea id="county-desc-init" placeholder="Es. Una fertile vallata circondata da montagne, ricca di boschi e attraversata da un fiume..."></textarea>
        </div>

        <div class="editor-section">
            <div class="section-header">
                <span class="section-icon">ðŸŽ­</span>
                <h3>Il Consigliere</h3>
            </div>
            <label>Nome del Consigliere:</label>
            <input id="adv-name" type="text" placeholder="Es. Ser Dorian il Saggio" />

            <label>PersonalitÃ  del Consigliere:</label>
            <select id="adv-pers">
                <option value="saggio">ðŸ§™ Saggio - Riflessivo e cauto nelle decisioni</option>
                <option value="pragmatico">âš–ï¸ Pragmatico - Orientato ai risultati concreti</option>
                <option value="ambizioso">ðŸ‘‘ Ambizioso - Mira sempre all'espansione</option>
                <option value="pauroso">ðŸ˜° Pauroso - Evita rischi e conflitti</option>
                <option value="corrotto">ðŸ’° Corrotto - Privilegia il profitto personale</option>
            </select>
        </div>
    </div>

    <button class="btn-main btn-start-game" onclick="startGame()">
        <span class="btn-icon">âš”ï¸</span>
        Inizia il Regno
    </button>
</div>

<!-- SCHERMATA DI GIOCO PRINCIPALE -->
<div id="screen-game" class="screen">
    <div class="top-hud">
        <div class="hud-stats-bar">
            <div class="stat"><i class="fas fa-calendar-alt"></i> <span id="hud-season">Primavera 1325</span></div>
            <div class="stat"><i class="fas fa-coins"></i> <span id="hud-gold">0</span></div>
            <div class="stat"><i class="fas fa-users"></i> <span id="hud-pop">0</span></div>
            <div class="stat"><i class="fas fa-smile"></i> <span id="hud-happy">50</span></div>
            <div class="stat"><i class="fas fa-shield-alt"></i> <span id="hud-security">50</span></div>
        </div>
        <div class="hud-nav-bar">
            <button onclick="switchTab('tab-chat', this)" class="active">ðŸ“œ Cronache</button>
            <button onclick="switchTab('tab-dominio', this)">ðŸ° Dominio</button>
            <button onclick="switchTab('tab-warehouse', this)">ðŸ“¦ Magazzino</button>
            <button onclick="switchTab('tab-diplomacy', this)">âš”ï¸ Guerra</button>
            <button onclick="switchTab('tab-map', this)">ðŸ—ºï¸ Mappa</button>
            <button onclick="switchTab('tab-market', this)">ðŸª Mercato</button>
            <button onclick="switchTab('tab-dynasty', this)">ðŸ‘‘ Dinastia</button>
            <button onclick="switchTab('tab-private', this)">ðŸ—£ï¸ Interlocutori</button>
            <button onclick="openBuildingModal()">ðŸ”¨ Costruzioni</button>
        </div>
    </div>

    <div class="system-toolbar">
        <div class="season-effects-text" id="season-effects-text">Il clima Ã¨ mite, i raccolti prosperano.</div>

<!-- ================= TAB: DOMINIO ================= -->

<!-- ================= TAB: DOMINIO (RIORGANIZZATO) ================= -->
<div id="tab-dominio" class="tab-view">

    <!-- Pulsante toggle per menu statistiche laterale -->
    <button class="sidebar-toggle-btn" onclick="toggleStatsSidebar()" title="Apri Statistiche">
        ðŸ“Š
    </button>

    <div class="domain-quick-nav" role="tablist" aria-label="Navigazione Dominio">
        <button class="domain-quick-btn active" aria-selected="true" onclick="scrollDomainSection('domain-overview-section', this)">Panoramica</button>
        <button class="domain-quick-btn" onclick="scrollDomainSection('domain-society-section', this)">SocietÃ </button>
        <button class="domain-quick-btn" onclick="scrollDomainSection('domain-economy-section', this)">Economia</button>
        <button class="domain-quick-btn" onclick="scrollDomainSection('domain-development-section', this)">Sviluppo</button>
    </div>

    <!-- ===== SEZIONE 1: PANORAMICA DEL DOMINIO (spostata nel sidebar) ===== -->
    <div id="domain-overview-section" style="margin-bottom: 35px; border-left: 3px solid var(--accent); padding-left: 15px;">
        <div style="font-size: 1.1em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <span style="width: 30px; height: 2px; background: var(--accent);"></span>
            ðŸ“Š Il Tuo Dominio
        </div>

        <h3>Descrizione</h3>
        <p id="visual-desc" style="font-size: 1.1em; line-height: 1.7; color: var(--text-soft); font-style: italic; padding: 15px; background: rgba(0,0,0,0.2); border-left: 3px solid var(--accent); border-radius: 8px;">
            Una giovane contea in attesa del suo destinoâ€¦
        </p>
        
        <p style="color: var(--text-soft); font-size: 0.9em; margin-top: 20px;">
            ðŸ’¡ Clicca sui tab per navigare rapidamente le sezioni del dominio, o usa i badge qui sotto per una panoramica rapida
        </p>

        <!-- OVERVIEW GRID -->
        <div class="domain-overview-grid" id="domain-overview-grid" aria-live="polite">
            <div class="domain-stat" id="stat-pop">
                <div class="stat-icon">ðŸ‘¥</div>
                <div class="stat-body">
                    <div class="stat-label">Popolazione</div>
                    <div class="stat-value" id="stat-pop-value">0</div>
                    <div class="stat-hint" id="stat-pop-hint">CapacitÃ  0</div>
                </div>
            </div>
            <div class="domain-stat" id="stat-food">
                <div class="stat-icon">ðŸŒ¾</div>
                <div class="stat-body">
                    <div class="stat-label">Scorte Cibo</div>
                    <div class="stat-value" id="stat-food-value">0%</div>
                    <div class="stat-hint" id="stat-food-hint">Stato scorte</div>
                </div>
            </div>
            <div class="domain-stat" id="stat-happy">
                <div class="stat-icon">ðŸ˜Š</div>
                <div class="stat-body">
                    <div class="stat-label">FelicitÃ </div>
                    <div class="stat-value" id="stat-happy-value">0%</div>
                    <div class="stat-hint" id="stat-happy-hint">Umore</div>
                </div>
            </div>
            <div class="domain-stat" id="stat-stability">
                <div class="stat-icon">âš–ï¸</div>
                <div class="stat-body">
                    <div class="stat-label">StabilitÃ </div>
                    <div class="stat-value" id="stat-stability-value">0%</div>
                    <div class="stat-hint" id="stat-stability-hint">Influenze fazioni</div>
                </div>
            </div>
            <div class="domain-stat" id="stat-gold">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-body">
                    <div class="stat-label">Tesoro</div>
                    <div class="stat-value" id="stat-gold-value">0</div>
                    <div class="stat-hint" id="stat-gold-hint">Risorse oro</div>
                </div>
            </div>
            <div class="domain-stat" id="stat-security">
                <div class="stat-icon">ðŸ›¡ï¸</div>
                <div class="stat-body">
                    <div class="stat-label">Sicurezza</div>
                    <div class="stat-value" id="stat-security-value">0%</div>
                    <div class="stat-hint" id="stat-security-hint">Difese locali</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== SEZIONE 2: SOCIETÃ€ ===== -->
    <div id="domain-society-section" style="margin-bottom: 35px; border-left: 3px solid var(--accent); padding-left: 15px;">
        <div style="font-size: 1.1em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <span style="width: 30px; height: 2px; background: var(--accent);"></span>
            ðŸ‘¥ SocietÃ  e Fazioni
        </div>

        <!-- Classi Sociali -->
        <h3>Classi Sociali</h3>
        <div class="social-classes-grid">
            <div class="social-class-card" onclick="toggleClassCard(this, 'nobility')" data-class="nobility">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-nobility">ðŸ‘‘</span>
                    <span class="social-class-name">NobiltÃ </span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="nobility-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="nobility-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-nobility">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-nobility">
                            <li>Prestigio e riconoscimento sociale</li>
                            <li>Terre e proprietÃ </li>
                            <li>Influenza politica</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-nobility">La nobiltÃ  controlla vaste proprietÃ  e terre. Il loro benessere dipende da tasse, rendite fondiarie e privilegi.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-nobility">Espandere i propri domini, ottenere titoli nobiliari superiori, influenzare le decisioni del conte.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('nobility')">
                        ðŸ’¬ Colloquio con Lord Emeric
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'clergy')" data-class="clergy">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-clergy">â›ª</span>
                    <span class="social-class-name">Clero</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="clergy-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="clergy-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-clergy">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-clergy">
                            <li>Luoghi di culto e chiese</li>
                            <li>Rispetto delle tradizioni religiose</li>
                            <li>Sostegno alle opere di caritÃ </li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-clergy">Il clero accumula ricchezza attraverso donazioni, decime e proprietÃ  ecclesiastiche.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-clergy">Espandere l'influenza religiosa, costruire nuove chiese, convertire i pagani e gli eretici.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('clergy')">
                        ðŸ’¬ Colloquio con Vescovo Aldebrando
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'militia')" data-class="militia">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-militia">âš”ï¸</span>
                    <span class="social-class-name">Milizia</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="militia-count">0</div>
                        <div class="social-class-label">Soldati</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="militia-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-militia">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-militia">
                            <li>Equipaggiamento e armi</li>
                            <li>Addestramento regolare</li>
                            <li>Compensi adeguati</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-militia">La milizia riceve stipendi dalla contea e bottini di guerra. Il loro benessere dipende dal mantenimento militare.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-militia">Espandere l'esercito, conquistare nuove terre, ottenere gloria in battaglia e migliori ricompense.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('militia')">
                        ðŸ’¬ Colloquio con Capitano Ronan
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'burghers')" data-class="burghers">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-burghers">ðŸ›ï¸</span>
                    <span class="social-class-name">Borghesi</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="burghers-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="burghers-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-burghers">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-burghers">
                            <li>OpportunitÃ  commerciali</li>
                            <li>Infrastrutture urbane</li>
                            <li>Sicurezza per le attivitÃ </li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-burghers">I borghesi prosperano attraverso commercio, artigianato e piccole imprese nelle cittÃ .</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-burghers">Espandere i mercati, ottenere privilegi commerciali, influenzare le politiche economiche.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('burghers')">
                        ðŸ’¬ Colloquio con Maestro Bernard
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'peasants')" data-class="peasants">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-peasants">ðŸ‘¥</span>
                    <span class="social-class-name">Contadini</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="peasants-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="peasants-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-peasants">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-peasants">
                            <li>Cibo sufficiente</li>
                            <li>Tasse ridotte</li>
                            <li>Protezione da carestie</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-peasants">I contadini vivono di agricoltura e allevamento. La loro ricchezza Ã¨ minima e instabile.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-peasants">Ridurre le corvÃ©e, ottenere terre proprie, protezione dai signori locali, vita migliore per i figli.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('peasants')">
                        ðŸ’¬ Colloquio con Odric il Lavoratore
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'mystics')" data-class="mystics">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-mystics">ðŸ”®</span>
                    <span class="social-class-name">Mistici</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="mystics-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="mystics-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-mystics">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-mystics">
                            <li>LibertÃ  di pratica spirituale</li>
                            <li>Rispetto delle loro tradizioni</li>
                            <li>Protezione da persecuzioni</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-mystics">I mistici vivono di offerte e servizi spirituali. La loro ricchezza Ã¨ modesta ma stabile.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-mystics">Preservare le antiche conoscenze, diffondere la saggezza, ottenere rispetto nella societÃ .</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('mystics')">
                        ðŸ’¬ Colloquio con Madre Elowen
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'outcasts')" data-class="outcasts">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-outcasts">ðŸšï¸</span>
                    <span class="social-class-name">Emarginati</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="outcasts-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="outcasts-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-outcasts">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-outcasts">
                            <li>Sopravvivenza di base</li>
                            <li>Reintegrazione sociale</li>
                            <li>OpportunitÃ  di riscatto</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-outcasts">Gli emarginati sopravvivono ai margini della societÃ  con elemosine, furti e lavori occasionali.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-outcasts">Essere accettati, trovare un posto nella societÃ , sfuggire alla povertÃ  e al disprezzo.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('outcasts')">
                        ðŸ’¬ Colloquio con Rasko il Senzapatria
                    </button>
                </div>
            </div>
            
            <div class="social-class-card" onclick="toggleClassCard(this, 'merchants')" data-class="merchants">
                <div class="social-class-header">
                    <span class="social-class-icon" id="icon-merchants">âš–ï¸</span>
                    <span class="social-class-name">Mercanti</span>
                </div>
                <div class="social-class-stats">
                    <div class="social-class-stat-item">
                        <div class="social-class-count" id="merchants-count">0</div>
                        <div class="social-class-label">Membri</div>
                    </div>
                    <div class="social-class-stat-item">
                        <div class="social-class-wealth" id="merchants-wealth">0ðŸ’°</div>
                        <div class="social-class-label">Ricchezza</div>
                    </div>
                </div>
                <div class="social-class-details" id="details-merchants">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Bisogni e NecessitÃ </h4>
                        <ul id="needs-merchants">
                            <li>Rotte commerciali sicure</li>
                            <li>Riduzione di dazi e tasse</li>
                            <li>Accordi commerciali vantaggiosi</li>
                        </ul>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸ’Ž Ricchezza Dettagliata</h4>
                        <p id="wealth-details-merchants">I mercanti accumulano fortune attraverso il commercio e le speculazioni. Sono tra i piÃ¹ ricchi.</p>
                    </div>
                    <div class="detail-section">
                        <h4>ðŸŽ¯ Aspirazioni</h4>
                        <p id="desires-merchants">Monopolizzare i commerci, ottenere privilegi esclusivi, espandere le reti commerciali internazionali.</p>
                    </div>
                    <button class="chat-link-btn" onclick="event.stopPropagation(); startFactionChat('merchants')">
                        ðŸ’¬ Colloquio con Ser Lothar
                    </button>
                </div>
            </div>
        </div>

        <button class="section-toggle" onclick="togglePanel('panel-reps')">
            Rappresentanti delle Fazioni
            <span>Chi sono i capi fazione?</span>
        </button>
        
        <div id="panel-reps" class="section-panel collapsed">
            <div class="representatives-grid">
                <div class="person-card">
                    <div class="person-name">Lord Emeric di Montferrand</div>
                    <div>NobiltÃ  â€” 46 anni. Orgoglioso e ambizioso.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Vescovo Aldebrando di Sorenza</div>
                    <div>Clero â€” 62 anni. Inflessibile e calcolatore.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Capitano Ronan il Ferro</div>
                    <div>Milizia â€” 38 anni. Diretto, leale, irritabile.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Odric il Lavoratore</div>
                    <div>Contadini â€” 33 anni. Paziente ma oppresso.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Maestro Bernard Forgiatore</div>
                    <div>Artigiani â€” 51 anni. Orgoglioso del mestiere.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Ser Lothar dei Ponti</div>
                    <div>Mercanti â€” 42 anni. Subdolo, affabile.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Madre Elowen la Veggente</div>
                    <div>Mistici â€” 67 anni. Enigmatica, calma.</div>
                </div>

                <div class="person-card">
                    <div class="person-name">Rasko il Senzapatria</div>
                    <div>Emarginati â€” 29 anni. Imprevedibile e rapido.</div>
                </div>
            </div>
        </div>

        <!-- Influenze delle Fazioni (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-factions')">
            Influenze delle Fazioni
            <span>Mostra condizioni correnti</span>
        </button>
        <div id="panel-factions" class="section-panel collapsed">
            <div id="faction-impact-list" class="faction-effects">
                <div class="faction-effect-card">Le fazioni reagiranno dopo il primo turno.</div>
            </div>
        </div>
    </div>

    <!-- ===== SEZIONE 3: ECONOMIA ===== -->
    <div id="domain-economy-section" style="margin-bottom: 35px; border-left: 3px solid var(--accent); padding-left: 15px;">
        <div style="font-size: 1.1em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <span style="width: 30px; height: 2px; background: var(--accent);"></span>
            ðŸ’° Economia e Risorse
        </div>

        <div class="eco-summary-grid">
            <div class="eco-card">
                <div class="label">Entrate stimate</div>
                <div class="value" id="eco-income">0</div>
                <small id="eco-income-note">Ultimo turno</small>
            </div>
            <div class="eco-card">
                <div class="label">Saldo cassa</div>
                <div class="value" id="eco-treasury">0</div>
                <small id="eco-treasury-note">Oro disponibile</small>
            </div>
            <div class="eco-card">
                <div class="label">Scorte cibo</div>
                <div class="value" id="eco-food">0%</div>
                <small id="eco-food-note">Capacitï¿½ granai</small>
            </div>
            <div class="eco-card">
                <div class="label">Stabilitï¿½</div>
                <div class="value" id="eco-stability">-</div>
                <small>Impatto fazioni</small>
            </div>
        </div>

        <!-- Risorse e Magazzini (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-resources')">
            Risorse e Magazzini
            <span>Apri/chiudi elenco</span>
        </button>
        <div id="panel-resources" class="section-panel">
            <div class="grid-stats resource-grid">
                <div class="stat-card">
                    <div class="stat-val" id="res-wood">0</div>
                    <div class="stat-sub">Legno</div>
                    <small class="res-delta" id="res-wood-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-stone">0</div>
                    <div class="stat-sub">Pietra</div>
                    <small class="res-delta" id="res-stone-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-iron">0</div>
                    <div class="stat-sub">Ferro</div>
                    <small class="res-delta" id="res-iron-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-copper">0</div>
                    <div class="stat-sub">Rame</div>
                    <small class="res-delta" id="res-copper-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-gold">0</div>
                    <div class="stat-sub">Oro grezzo</div>
                    <small class="res-delta" id="res-gold-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-herbs">0</div>
                    <div class="stat-sub">Erbe medicinali</div>
                    <small class="res-delta" id="res-herbs-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-grain">0</div>
                    <div class="stat-sub">Grano</div>
                    <small class="res-delta" id="res-grain-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-livestock">0</div>
                    <div class="stat-sub">Bestiame</div>
                    <small class="res-delta" id="res-livestock-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-textiles">0</div>
                    <div class="stat-sub">Tessuti</div>
                    <small class="res-delta" id="res-textiles-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-luxuries">0</div>
                    <div class="stat-sub">Beni di pregio</div>
                    <small class="res-delta" id="res-luxuries-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-arcane">0</div>
                    <div class="stat-sub">Essenza arcana</div>
                    <small class="res-delta" id="res-arcane-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-weapons">0</div>
                    <div class="stat-sub">Armi</div>
                    <small class="res-delta" id="res-weapons-delta">â€”</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-armor">0</div>
                    <div class="stat-sub">Armature</div>
                    <small class="res-delta" id="res-armor-delta">-</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-spices">0</div>
                    <div class="stat-sub">Spezie</div>
                    <small class="res-delta" id="res-spices-delta">-</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-parchment">0</div>
                    <div class="stat-sub">Pergamene</div>
                    <small class="res-delta" id="res-parchment-delta">-</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-candles">0</div>
                    <div class="stat-sub">Candele/Incensi</div>
                    <small class="res-delta" id="res-candles-delta">-</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-crystals">0</div>
                    <div class="stat-sub">Cristalli</div>
                    <small class="res-delta" id="res-crystals-delta">-</small>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="res-parade_horses">0</div>
                    <div class="stat-sub">Cavalli da parata</div>
                    <small class="res-delta" id="res-parade_horses-delta">-</small>
                </div>
            </div>
        </div>

        <!-- Politica Fiscale (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-taxes')">
            Politica Fiscale
            <span>Modifica categorie</span>
        </button>
        <div id="panel-taxes" class="section-panel collapsed">
            <div class="tax-panel">
                <div id="tax-grid" class="tax-grid"></div>
                <div class="tax-summary">
                    <span>Entrate ultimo turno: <strong id="tax-last">0</strong> oro</span>
                    <span>Trend: <strong id="tax-trend">â€”</strong></span>
                </div>
            </div>
        </div>

        <!-- Bisogni e Consumi (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-needs')">
            Soddisfazione e Potere d'Acquisto
            <span>Analisi Consumi</span>
        </button>
        <div id="panel-needs" class="section-panel collapsed">
            <div class="needs-legend">
                <span style="color:#6ada91">â–  Primari (Sopravvivenza)</span>
                <span style="color:#64b5f6">â–  Secondari (Comfort)</span>
            </div>
            <div id="needs-list-container">
                <div class="save-empty">Dati disponibili dopo il primo turno.</div>
            </div>
        </div>
    </div>

    <!-- ===== SEZIONE 4: SVILUPPO ===== -->
    <div id="domain-development-section" style="margin-bottom: 35px; border-left: 3px solid var(--accent); padding-left: 15px;">
        <div style="font-size: 1.1em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <span style="width: 30px; height: 2px; background: var(--accent);"></span>
            ðŸ—ï¸ Sviluppo e Governo
        </div>

        <div class="dev-summary-grid">
            <div class="dev-card">
                <div class="label">Leggi attive</div>
                <div class="value" id="dev-laws">0</div>
                <small id="dev-laws-note">Decreti in vigore</small>
            </div>
            <div class="dev-card">
                <div class="label">Opere in corso</div>
                <div class="value" id="dev-buildings">0</div>
                <small id="dev-buildings-note">Costruzioni e cantieri</small>
            </div>
            <div class="dev-card">
                <div class="label">Insediamenti</div>
                <div class="value" id="dev-settlements">0</div>
                <small id="dev-settlements-note">Villaggi e botteghe</small>
            </div>
            <div class="dev-card">
                <div class="label">Ordine pubblico</div>
                <div class="value" id="dev-order">-</div>
                <small>Milizia e sicurezza</small>
            </div>
        </div>

        <!-- Sintesi Insediamenti (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-assets')">
            Sintesi Insediamenti
            <span>Case, botteghe, campiâ€¦</span>
        </button>
        <div id="panel-assets" class="section-panel collapsed">
            <div id="asset-summary" class="asset-grid">
                <div class="asset-card">I dettagli compariranno dopo l'avvio.</div>
            </div>
        </div>

        <!-- Progetti di costruzione desiderati dalle categorie -->
        <button class="section-toggle" onclick="togglePanel('panel-projects')">
            Progetti delle Categorie
            <span>Cosa vorrebbero costruire</span>
        </button>
        <div id="panel-projects" class="section-panel collapsed">
            <div id="projects-grid" class="asset-grid"></div>
        </div>

        <!-- Leggi e Decreti (collassabile) -->
        <button class="section-toggle" onclick="togglePanel('panel-laws')">
            Leggi e Decreti
            <span>Gestisci editti</span>
        </button>
        <div id="panel-laws" class="section-panel collapsed">
            <div id="law-list" class="law-list" style="margin-bottom:12px;"></div>
            <div class="law-creator">
                <input id="law-custom-name" type="text" placeholder="Nome della legge" />
                <textarea id="law-custom-desc" placeholder="Descrivi obiettivi e vincoli"></textarea>
                <select id="law-custom-type">
                    <option value="production">Bonus produzione</option>
                    <option value="taxes">Modifica tassazione</option>
                    <option value="factions">Influenza fazioni</option>
                </select>
                <select id="law-custom-target"></select>
                <input id="law-custom-value" type="number" step="0.5" placeholder="Valore (es. 10)" />
                <button class="btn-main" onclick="createCustomLaw()">Istituisci nuova legge</button>
            </div>
        </div>
    </div>

</div>
<!-- ====================== TAB: MAGAZZINO ====================== -->
<div id="tab-warehouse" class="tab-view">

    <h2>ðŸ“¦ Magazzino e Risorse</h2>
    <p style="color: var(--text-soft); font-size: 0.9em; margin-bottom: 20px;">
        Monitora lo stock, la produzione, il consumo e l'autonomia di tutte le risorse.
    </p>
    
    <!-- Riepilogo veloce -->
    <div class="warehouse-summary" id="warehouse-summary"></div>

    <!-- Risorse critiche -->
    <div class="warehouse-section" id="critical-resources-section" style="display: none;">
        <h3 style="color: var(--accent); margin-top: 0;">âš ï¸ Risorse Critiche</h3>
        <div class="resource-list" id="critical-resources"></div>
    </div>

    <!-- Risorse in attenzione -->
    <div class="warehouse-section" id="warning-resources-section" style="display: none;">
        <h3 style="color: var(--accent); margin-top: 0;">âš¡ Risorse in Attenzione</h3>
        <div class="resource-list" id="warning-resources"></div>
    </div>

    <!-- Tutte le risorse -->
    <div class="warehouse-section">
        <h3 style="color: var(--accent); margin-top: 0;">ðŸ“Š Tutte le Risorse</h3>
        <div class="resource-list" id="all-resources"></div>
    </div>

    <!-- Bisogni popolazione -->
    <div class="population-needs">
        <h3 style="color: var(--accent); margin-top: 0;">ðŸ‘¥ Bisogni della Popolazione</h3>
        <div class="needs-grid" id="population-needs"></div>
    </div>

</div>

<!-- Sezione magazzino privato governatore -->
<div id="gov-private-section" class="section-panel" style="margin-top:0; padding:16px; display:none;">
    <h3 style="color:var(--accent); margin-top:0;">ðŸ“¦ Magazzino Privato del Governatore</h3>
    <p class="text-soft" style="margin:6px 0 12px;">Compra dal mercato usando l'oro del conte; le risorse restano private per costruzioni personali.</p>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; margin-bottom:12px;">
        <div style="flex:1; min-width:180px;">
            <label for="gov-buy-res" style="color:var(--text-soft); font-size:0.9em;">Risorsa</label>
            <select id="gov-buy-res" style="width:100%; padding:8px; background:#111; color:var(--text); border:1px solid var(--border-soft); border-radius:6px;"></select>
        </div>
        <div style="width:120px;">
            <label for="gov-buy-qty" style="color:var(--text-soft); font-size:0.9em;">Quantitï¿½ï¿½</label>
            <input id="gov-buy-qty" type="number" min="1" value="5" style="width:100%; padding:8px; background:#111; color:var(--text); border:1px solid var(--border-soft); border-radius:6px;" />
        </div>
        <button class="btn-main" style="width:180px;" onclick="handleGovernorPurchase()">Compra per il conte</button>
    </div>
    <div id="gov-storage-list" class="resource-list" style="background:rgba(255,255,255,0.02); border:1px solid var(--border-soft); border-radius:10px; padding:10px;"></div>
</div>

<!-- ====================== TAB: DIPLOMAZIA ====================== -->
<div id="tab-diplomacy" class="tab-view">
    <h2>Sala della Guerra e Diplomazia</h2>
    
    <div class="panel" style="border-color: #f44336; margin-bottom: 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="color:#f44336; margin:0;">âš”ï¸ Gestione Esercito</h3>
            <span id="army-status" style="font-size:0.9em; color:#aaa;">Stato: Pace</span>
        </div>
        
        <div class="grid-stats">
            <div class="stat-card">
                <div class="stat-val" id="mil-soldiers">0</div>
                <div class="stat-sub">Milizia (Professionisti)</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="mil-levies">0</div>
                <div class="stat-sub">Leva (Contadini)</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="mil-power">0</div>
                <div class="stat-sub">Potenza Totale</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="mil-weapons">0</div>
                <div class="stat-sub">Armi in Magazzino</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="mil-efficiency">100%</div>
                <div class="stat-sub">Efficienza Bellica</div>
            </div>
        </div>

        <div style="background:#220a0a; padding:10px; border-radius:8px; margin-top:10px; border:1px dashed #522;">
            <p style="font-size:0.9em; color:#ccc; margin-top:0;">
                Mobilitare i contadini fornisce un esercito numeroso ma distrugge l'economia agricola e riduce le tasse.
            </p>
            <button id="btn-mobilize" class="btn-main" style="background: linear-gradient(120deg, #8b0000, #4a0000); color:white;" onclick="toggleMobilization()">
                ðŸ”” Chiama la Leva (Mobilita Contadini)
            </button>
        </div>
    </div>

    <div id="diplomacy-list">
        </div>
</div>


<!-- ====================== TAB: MAPPA ====================== -->
<div id="tab-map" class="tab-view">

    <h2>Mappa della Contea</h2>
    <canvas id="county-map" width="480" height="480"
            style="border:1px solid #333; width:100%; margin-bottom:20px;"></canvas>

    <div class="map-legend">
        <div class="legend-item">
            <span class="legend-marker legend-circle"></span>
            <span>Villaggi e borghi del Conte</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker legend-diamond"></span>
            <span>Miniere (metalli preziosi)</span>
        </div>
        <div class="legend-item">
            <span class="legend-triangle"></span>
            <span>Segherie e taglialegna</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker legend-square"></span>
            <span>Cave e cantieri di pietra</span>
        </div>
        <div class="legend-item">
            <span class="legend-marker legend-cross"></span>
            <span>Monasteri e luoghi sacri</span>
        </div>
    </div>

    <h3>Mappa Regionale</h3>
    <canvas id="region-map" width="320" height="320"
            style="border:1px solid #333; width:100%;"></canvas>

</div>


<!-- ====================== TAB: MERCATO ====================== -->
<div id="tab-market" class="tab-view">
    <h3>Mercato Commerciale</h3>
    <p>Scambia risorse con le contee vicine e gestisci il mercato interno. I prezzi esterni riflettono gli accordi commerciali, mentre il mercato interno mostra surplus e deficit locali.</p>
    
    <div id="market-content">
        <!-- Contenuto popolato da renderMarket() -->
    </div>
</div>

<!-- ====================== TAB: DINASTIA ====================== -->
<div id="tab-dynasty" class="tab-view">
    <h2>Casata Reale</h2>
    
    <div class="dynasty-header-card">
        <div class="dynasty-role">Regnante Attuale</div>
        <h3 id="dynasty-ruler-name">Conte Alaric</h3>
        <div class="dynasty-stats">
            <span>EtÃ : <strong id="dynasty-ruler-age">25</strong></span>
            <span>Salute: <strong id="dynasty-ruler-health">Ottima</strong></span>
        </div>
        <p id="dynasty-ruler-traits" class="dynasty-traits">Tratti: Ambizioso, Carismatico</p>
    </div>

    <div class="dynasty-section">
        <h4>Consorte</h4>
        <div id="spouse-container">
            <div class="dynasty-empty-slot">
                <p>Il Conte non Ã¨ sposato.</p>
                <button class="btn-main" onclick="openMarriageMarket()">Cerca Pretendenti</button>
            </div>
        </div>
    </div>

    <div class="dynasty-section">
        <h4>Eredi e Figli</h4>
        <div id="heirs-list" class="heir-grid">
            <p class="text-soft">Nessun erede. La linea di successione Ã¨ a rischio!</p>
        </div>
    </div>

    <div class="dynasty-section">
        <button class="section-toggle" onclick="togglePanel('court-marriage-panel')">
            Matrimoni di Corte
            <span>Fai sposare i consiglieri</span>
        </button>
        <div id="court-marriage-panel" class="section-panel collapsed">
            <p class="text-soft">Puoi combinare matrimoni per i tuoi consiglieri per rafforzare la lealtÃ  delle fazioni.</p>
            <div id="court-marriage-list"></div>
        </div>
    </div>
</div>

<!-- ====================== TAB: CRONACHE (CHAT PUBBLICA) ====================== -->
<div id="tab-chat" class="tab-view active-tab">
    <div class="court-layout">
        
        <div class="court-main">
            <div class="chat-panel">
                <div class="chat-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>ðŸ‘‘ SALA DEL TRONO</span>
                        <span id="chat-turn" style="opacity:0.6; font-size:0.8em;">Anno 1325</span>
                    </div>
                    <div id="chat-faction-chips" class="faction-chips-inline"></div>
                </div>

                <div id="chat-log" class="chat-log"></div>

                <div class="input-area">
                    <input type="text" id="u-input" 
                           placeholder="Pronuncia un ordine, Conte..." 
                           autocomplete="off"
                           onkeypress="if(event.key==='Enter') send()">
                    <button class="send-btn" onclick="send()">âž¤</button>
                </div>
                
                <button class="season-advance-btn" onclick="advanceSeasonManually()">
                    ðŸ”” Suona la campana (Avanza Stagione)
                </button>
            </div>
        </div>

        <div class="court-sidebar">
            
            <div class="sidebar-panel">
                <div class="panel-title">ðŸ—ï¸ Cantieri Reali</div>
                <div id="construction-feed" class="event-feed">
                    <p class="event-empty">Nessun cantiere.</p>
                </div>
            </div>

            <div class="sidebar-panel">
                <div class="panel-title">ðŸ“œ Dispacci</div>
                <div id="event-feed" class="event-feed compact">
                    <p class="event-empty">Tutto tace.</p>
                </div>
            </div>

            <div class="sidebar-panel action-wrapper">
                <div class="panel-title">âš–ï¸ Proposte</div>
                <div id="action-list" class="action-list compact"></div>
                <button class="btn-sec small" onclick="askAdvisor()">ðŸ§  Chiedi consiglio</button>
            </div>

            <div class="sidebar-panel">
                <div class="panel-title">ðŸ§  I Consigli di Ser Dorian</div>
                <div id="advice-feed" class="event-feed compact" style="min-height: 100px;">
                    <p class="advice-empty">Sono al vostro servizio, mio Signore.</p>
                </div>
            </div>

        </div>
    </div>
</div>


<!-- ====================== TAB: INTERLOCUTORI (CHAT PRIVATE) ====================== -->
<div id="tab-private" class="tab-view">
    <h2>Colloqui Privati</h2>

    <div id="family-chat-buttons" style="border-bottom:1px dashed #444; padding-bottom:10px; margin-bottom:10px; display:none;">
        <h4 style="margin:0 0 5px 0; color:var(--accent);">Casata Reale</h4>
        <div id="family-selector" class="private-selector" style="margin:0;">
            </div>
    </div>

    <h4 style="margin:0 0 5px 0; color:#888;">Fazioni e Vicini</h4>
    <div id="private-selector" class="private-selector">
        <button class="btn-sec" onclick="openPrivateChat('nobility')">Lord Emeric (NobiltÃ )</button>
        <button class="btn-sec" onclick="openPrivateChat('clergy')">Vescovo Aldebrando (Clero)</button>
        <button class="btn-sec" onclick="openPrivateChat('militia')">Cap. Ronan (Milizia)</button>
        <button class="btn-sec" onclick="openPrivateChat('peasants')">Odric (Contadini)</button>
        <button class="btn-sec" onclick="openPrivateChat('burghers')">Bernard Forgiatore (Artigiani)</button>
        <button class="btn-sec" onclick="openPrivateChat('merchants')">Ser Lothar (Mercanti)</button>
        <button class="btn-sec" onclick="openPrivateChat('mystics')">Madre Elowen (Mistici)</button>
        <button class="btn-sec" onclick="openPrivateChat('outcasts')">Rasko (Emarginati)</button>
        <button class="btn-sec" onclick="openPrivateChat('auvrey')">Messo di Auvrey</button>
        <button class="btn-sec" onclick="openPrivateChat('falken')">Ambasciatrice di Falken</button>
    </div>

    <div id="private-chat-box" style="display:none;">
        <div class="chat-panel">
            <div class="chat-header" id="private-chat-title">Colloquio</div>
            <div id="private-chat-log" class="chat-log"></div>
            <div class="input-area">
                <input id="private-input" type="text" placeholder="Parla privatamente..." onkeypress="if(event.key==='Enter') sendPrivate()" />
                <button class="send-btn" onclick="sendPrivate()">âž¤</button>
            </div>
        </div>
        <button class="btn-main" style="margin-top:10px;" onclick="closePrivateChat()">Concludi colloquio</button>
    </div>
</div>

</div>

</div>

<div id="load-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Salvataggi</h3>
            <button class="close-btn" onclick="closeLoadModal()">âœ•</button>
        </div>

        <label for="save-slot-name">Nome salvataggio</label>
        <input id="save-slot-name" type="text" placeholder="Es. dopo assedio" />
        <button class="btn-main" onclick="manualSaveFromModal()">Salva in nuovo slot</button>

        <div id="modal-save-list"></div>
    </div>
</div>

<div id="modal-buildings" class="modal">
    <div class="modal-content" style="width: min(700px, 95vw);">
        <div class="modal-header">
            <h3>Registro dell'Architetto</h3>
            <button class="close-btn" onclick="closeBuildingModal()">âœ•</button>
        </div>
        <p style="font-size:0.9em; color:#aaa; margin-bottom:15px;">
            Seleziona un progetto per avviare il cantiere. Le risorse verranno dedotte immediatamente.
        </p>
        <div id="building-grid" class="start-grid">
            </div>
    </div>
</div>

<div id="modal-marriage" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Proposte di Matrimonio</h3>
            <button class="close-btn" onclick="closeMarriageModal()">âœ•</button>
        </div>
        <div id="marriage-candidates" class="start-grid"></div>
    </div>
</div>

<div id="modal-gameover" class="modal" style="z-index: 9999; background: rgba(0,0,0,0.95);">
    <div class="modal-content" style="text-align:center; border: 1px solid #d32f2f; background: #1a0505; max-width: 600px;">
        <h1 style="color:#d32f2f; font-family: 'Cinzel', serif; font-size: 3em; margin-bottom: 10px;">IL REGNO Ãˆ CADUTO</h1>
        
        <div id="death-icon" style="font-size: 4em; margin: 20px 0;">â˜ ï¸</div>
        
        <div id="gameover-story" style="font-style: italic; color: #e0e0e0; margin-bottom: 30px; line-height: 1.6;">
            </div>
        
        <div class="stat-summary" style="display:flex; justify-content:center; gap:20px; color:#888; font-size:0.9em; margin-bottom:30px;">
            <span>Anni di Regno: <strong id="go-years">0</strong></span>
            <span>EreditÃ : <strong id="go-legacy">Dimenticato</strong></span>
        </div>

        <button class="btn-main" onclick="location.reload()">ðŸ‘‘ Nuova Dinastia (Ricomincia)</button>
    </div>
</div>

<script>
/* ============================================================
   =================== VARIABILI PRINCIPALI ====================
   ============================================================ */

let apiKey = "";
let heroName = "";

// Helper per formattare denaro a centesimi
function fmtMoney(v) {
    const n = Number(v) || 0;
    return n.toFixed(2);
}

// --- DATI DINASTIA ---
let dynasty = {
    ruler: {
        name: "Conte", // SarÃ  sovrascritto da heroName
        age: 25,
        maxAge: 75 + Math.floor(Math.random() * 15), // Morte naturale tra 75 e 90
        health: 100,
        traits: ["Fondatore"]
    },
    spouse: null, // Oggetto { name, age, origin, bonus }
    heirs: []     // Array di oggetti { name, age, gender, traits }
};

let activeSuitorsList = []; // Per tenere traccia dei pretendenti generati

// Tracciamento della rabbia accumulata per fazione
let rebellionState = {
    nobility: 0, clergy: 0, militia: 0, peasants: 0,
    burghers: 0, merchants: 0, mystics: 0, outcasts: 0
};

// Soglie di pericolo
const UNREST_WARNING = 5; // Dopo 5 turni di infelicitÃ : Avvertimento (era 3)
const UNREST_DANGER = 8;  // Dopo 8 turni: Tentativo di sabotaggio (era 5)
const UNREST_REVOLT = 12;  // Dopo 12 turni: GAME OVER / Tentativo di uccisione (era 8)

// Memoria della chat pubblica (ultimi 10-15 scambi)
let publicChatHistory = [];

const RESOURCE_KEYS = [
    // Materie Prime
    "wood","stone","iron","copper","gold","grain","livestock","wool","herbs","clay","seeds",
    // Semilavorati
    "flour", "iron_ingots", "fabric", "leather", "parchment", "candles",
    // Prodotti Finiti (Alto valore)
    "bread", "tools", "clothes", "weapons", "armor", "furniture", "pottery", "parade_horses",
    // Speciali
    "luxuries","arcane","textiles","cotton","spices","incense","crystals"
];

const resourceLabels = {
    wood: "Legno",
    stone: "Pietra",
    iron: "Ferro",
    copper: "Rame",
    gold: "Oro",
    herbs: "Erbe",
    grain: "Grano",
    livestock: "Bestiame",
    wool: "Lana",
    clay: "Argilla",
    seeds: "Semi selezionati",
    flour: "Farina",
    iron_ingots: "Lingotti di Ferro",
    fabric: "Stoffa",
    leather: "Pelle",
    parchment: "Pergamene",
    candles: "Candele/Incensi",
    bread: "Pane",
    tools: "Utensili",
    clothes: "Vestiti",
    furniture: "Mobili",
    pottery: "Ceramica",
    textiles: "Tessuti",
    luxuries: "Beni di pregio",
    arcane: "Essenza arcana",
    weapons: "Armi",
    armor: "Armature",
    cotton: "Cotone",
    spices: "Spezie",
    incense: "Incenso",
    crystals: "Cristalli arcani",
    parade_horses: "Cavalli da parata"
};

const POP_NEEDS = {
    peasants: {
        // Mangiano pane (o grano se poveri)
        primary: { bread: 0.5 }, 
        // Vestiti base
        secondary: { clothes: 0.1, tools: 0.05 } 
    },
    burghers: {
        primary: { bread: 1.0, clothes: 0.2 },
        secondary: { furniture: 0.1, luxuries: 0.05 }
    },
    nobility: {
        primary: { bread: 1.5, clothes: 0.5 }, // Vestiti di lusso (consumano di piÃ¹)
        secondary: { luxuries: 0.5, weapons: 0.1, furniture: 0.2 }
    },
    militia: {
        primary: { bread: 1.2 },
        secondary: { weapons: 0.1, armor: 0.05 } // La milizia consuma equipaggiamento
    },
    merchants: {
        primary: { bread: 0.8, clothes: 0.3 },
        secondary: { luxuries: 0.1, furniture: 0.1 }
    },
    clergy: {
        primary: { bread: 0.7, clothes: 0.2 },
        secondary: { luxuries: 0.05, arcane: 0.02 }
    },
    mystics: {
        primary: { bread: 0.3, herbs: 0.1 },
        secondary: { arcane: 0.05, luxuries: 0.01 }
    },
    outcasts: {
        primary: { bread: 0.2 }, // Mangiano poco
        secondary: { wood: 0.02 }
    }
};

const SEASON_CYCLE = [
    {
        key: "spring",
        label: "Primavera",
        description: "Il disgelo porta nuova linfa ai campi.",
        production: { grain: 1.15, livestock: 1.05, herbs: 1.1 },
        warCost: 1,
        morale: { peasants: 2 }
    },
    {
        key: "summer",
        label: "Estate",
        description: "I mercati sono colmi e le strade sicure.",
        production: { grain: 1.05, livestock: 1.1, luxuries: 1.05 },
        warCost: 1.05,
        morale: { merchants: 2 }
    },
    {
        key: "autumn",
        label: "Autunno",
        description: "Si raccolgono tributi e si preparano le scorte.",
        production: { grain: 0.85, livestock: 0.9, herbs: 1.05 },
        warCost: 1.1,
        morale: { nobility: 1 }
    },
    {
        key: "winter",
        label: "Inverno",
        description: "La neve blocca i raccolti e le campagne militari sono dispendiose.",
        production: { grain: 0.2, livestock: 0.35, herbs: 0.6 },
        warCost: 1.35,
        morale: { peasants: -3, militia: -2 }
    }
];

const SETTLEMENT_TIERS = [
    { id: 0, name: "Borgo Rurale", threshold: 0, unlocks: ["cottage", "wheat_farm", "sheep_farm", "village_well", "granary"] },
    { id: 1, name: "Villaggio", threshold: 400, unlocks: ["market", "sawmill", "chapel", "mill", "bakery", "barracks"] },
    { id: 2, name: "Cittadina", threshold: 1000, unlocks: ["tenement", "stone_quarry", "iron_mine", "forge", "weaver", "watchtower", "inn"] },
    { id: 3, name: "CittÃ  Fortificata", threshold: 2500, unlocks: ["stone_walls", "church", "tailor", "tool_smith", "mercenary_camp", "harbor"] },
    { id: 4, name: "Capitale Ducale", threshold: 5000, unlocks: ["grand_cathedral", "noble_estate", "mint", "university", "theater", "library"] }
];

// Funzione per ottenere il livello attuale
function getCurrentTier() {
    const pop = county.pop;
    // Trova l'ultimo tier che soddisfa la soglia di popolazione
    return SETTLEMENT_TIERS.slice().reverse().find(t => pop >= t.threshold) || SETTLEMENT_TIERS[0];
}

function createDefaultWorldTime() {
    return { year: 1325, seasonIndex: 0 };
}

let worldTime = createDefaultWorldTime();

const TAX_CATEGORIES = [
    { key:"nobility", label:"NobiltÃ ", wealthFactor:6, tolerance:8 },
    { key:"clergy", label:"Clero", wealthFactor:4, tolerance:6 },
    { key:"militia", label:"Milizia", wealthFactor:3, tolerance:5 },
    { key:"peasants", label:"Contadini", wealthFactor:2, tolerance:4 },
    { key:"burghers", label:"Artigiani", wealthFactor:5, tolerance:7 },
    { key:"merchants", label:"Mercanti", wealthFactor:7, tolerance:9 },
    { key:"mystics", label:"Mistici", wealthFactor:3, tolerance:5 },
    { key:"outcasts", label:"Emarginati", wealthFactor:1, tolerance:3 }
];

function createDefaultTaxPolicy() {
    const policy = {};
    TAX_CATEGORIES.forEach(cat => { policy[cat.key] = 5; });
    return policy;
}

let taxPolicy = createDefaultTaxPolicy();
let taxHistory = [];

const BASE_LAW_LIBRARY = [
    {
        key: "grain_subsidy",
        name: "Sussidi Agricoli",
        description: "Il Conte paga parte delle sementi.",
        upkeepCost: 20, // Costo fisso in Oro per turno
        effects: {
            production: { grain: 1.25 },
            factions: { peasants: 4, nobility: -1 }
        }
    },
    {
        key: "bread_for_poor",
        name: "Pane per i Poveri",
        description: "Distribuzione gratuita di cibo agli indigenti.",
        upkeepCost: 50, // Costoso!
        consumeResource: { grain: 20 }, // Consuma anche cibo fisico
        effects: {
            factions: { peasants: 10, outcasts: 10, nobility: -5 },
            county: { health: 2, happy: 5 }
        }
    },
    {
        key: "road_maintenance",
        name: "Manutenzione Strade Reali",
        description: "Investimento costante nella viabilitÃ .",
        upkeepCost: 30,
        effects: {
            production: { gold: 1.1 }, // Aumenta efficienza commerciale
            factions: { merchants: 5 }
        }
    },
    {
        key: "trade_charter",
        name: "Carta dei Mercanti",
        description: "Agevolazioni per i mercanti: aumenta beni di pregio e oro, ma l'artigianato subisce concorrenza.",
        effects: {
            production: { luxuries: 1.2, textiles: 0.95 },
            taxes: { merchants: 2, burghers: -1 },
            factions: { merchants: 5, burghers: -3 }
        }
    },
    {
        key: "conscription_edict",
        name: "Editto di Leva",
        description: "Arruola contadini e artigiani nella milizia. PiÃ¹ sicurezza, ma malcontento tra i campi.",
        effects: {
            production: { grain: 0.9 },
            military: { manpower: 1.15 },
            factions: { militia: 5, peasants: -4, burghers: -2 }
        }
    }
];

function calculateDetailedUpkeep(targetState = null) {
    const buildingList = targetState ? targetState.buildings : buildings;
    const landCount = targetState ? targetState.landOwnership.count : landOwnership.count;
    
    let military = 0;
    let civil = 0;
    let court = 0;

    // 1. Mantenimento Edifici Specifici
    buildingList.forEach(b => {
        if (b.stage !== 'complete') return;
        const data = buildingData[b.type];
        if (!data || !data.upkeep) return;

        const cost = data.upkeep;

        // Categorizzazione
        if (['watchtower','barracks','stone_walls','mercenary_camp'].includes(b.type)) {
            military += cost;
        } else if (['noble_estate','grand_cathedral','library','theater'].includes(b.type)) {
            court += cost;
        } else {
            civil += cost; // Mercati, pozzi, ecc.
        }
    });

    // 2. Mantenimento Infrastrutture (Strade e Ponti astratti)
    // Costo basato sulla dimensione del territorio controllato (1 oro per tile)
    const infra = Math.floor(landCount * 1.5); 

    return { military, civil, court, infrastructure: infra };
}

let customLaws = [];
let activeLaws = [];
let lastResourceSnapshot = null;
let lastResourceDelta = null;

const RESERVED_SAVE_SLOTS = ["autosave", "quick"];
const DEFAULT_PERSONALITY = { advisorTone:"saggio", courtMood:"prudente", notes:"" };
let personalitySettings = { ...DEFAULT_PERSONALITY };

// ============================================================
// SISTEMA PERSONALITÃ€ COMPLETO
// ============================================================

// PersonalitÃ  del Consigliere basate sul tono scelto
const ADVISOR_PERSONALITIES = {
    saggio: {
        style: "Parli con saggezza e riflessione, citando proverbi e lezioni della storia",
        tone: "calmo, ponderato e filosofico",
        approach: "Preferisci soluzioni a lungo termine e diplomatiche",
        greeting: "Mio signore, riflettendo sulla situazione...",
        signature: "- Con deferenza, il vostro fedele consigliere"
    },
    pragmatico: {
        style: "Vai dritto al punto, senza fronzoli, con un'analisi fredda dei fatti",
        tone: "diretto, conciso e orientato ai risultati",
        approach: "Proponi soluzioni pratiche e immediate",
        greeting: "Conte, i fatti sono chiari:",
        signature: "- Senza tanti complimenti"
    },
    ambizioso: {
        style: "Spingi sempre per l'espansione e il potere, con un tocco di audacia",
        tone: "entusiasta, visionario e talvolta spregiudicato",
        approach: "Suggerisci mosse audaci per aumentare il potere",
        greeting: "Mio Signore, Ã¨ tempo di osare!",
        signature: "- Verso la grandezza!"
    },
    misterioso: {
        style: "Parli per enigmi e metafore, con riferimenti a forze nascoste",
        tone: "criptico, suggestivo e quasi profetico",
        approach: "Offri intuizioni velate e simboliche",
        greeting: "Le stelle sussurrano segreti, mio conte...",
        signature: "- Colui che vede oltre il velo"
    }
};

// Atmosfera della Corte
const COURT_MOODS = {
    prudente: {
        description: "La corte Ã¨ cauta e conservatrice, diffidente dei cambiamenti rapidi",
        effect: "Le persone parlano sottovoce e pesano ogni parola",
        npc_behavior: "I personaggi sono formali e diplomatici"
    },
    bellicosa: {
        description: "La corte ribolle di tensione militare, i guerrieri sono rispettati",
        effect: "Le conversazioni sono dirette e si parla di conquista e onore",
        npc_behavior: "I personaggi sono piÃ¹ aggressivi e diretti"
    },
    visionaria: {
        description: "La corte abbraccia innovazione e progresso, aperta al nuovo",
        effect: "C'Ã¨ entusiasmo per progetti ambiziosi e idee audaci",
        npc_behavior: "I personaggi propongono idee innovative e creative"
    },
    ombrosa: {
        description: "La corte Ã¨ piena di intrighi, sussurri e giochi di potere",
        effect: "Le vere intenzioni sono sempre nascoste",
        npc_behavior: "I personaggi parlano per allusioni e doppi sensi"
    }
};

// PersonalitÃ  dettagliate per ogni fazione
const FACTION_PERSONALITIES = {
    nobility: {
        name: "Lord Emeric di Montferrand",
        age: 46,
        traits: ["Orgoglioso", "Ambizioso", "Manipolatore"],
        style: "Parli con raffinatezza aristocratica, usando un linguaggio forbito",
        motivations: "Desideri piÃ¹ terre, titoli e influenza. Vedi la nobiltÃ  come naturalmente superiore",
        speech_patterns: "Usi perifrasi elaborate, riferimenti alla tua stirpe illustre",
        likes: "Banchetti sontuosi, tornei, terre fertili, privilegi esclusivi",
        dislikes: "Tasse troppo alte sulla nobiltÃ , perdita di prestigio, ascesa dei comuni",
        greeting: "Nobile conte, Ã¨ un onore intrattenersi con voi...",
        anger: "La mia casata non sarÃ  umiliata cosÃ¬!",
        happiness: "Finalmente il merito della nobiltÃ  viene riconosciuto!"
    },
    clergy: {
        name: "Vescovo Aldebrando di Sorenza",
        age: 62,
        traits: ["Inflessibile", "Calcolatore", "Devoto"],
        style: "Parli con autoritÃ  morale, citando le scritture e la volontÃ  divina",
        motivations: "Accrescere il potere della Chiesa, costruire cattedrali, convertire i pagani",
        speech_patterns: "Citi frequentemente le sacre scritture, invochi benedizioni e maledizioni",
        likes: "Decime generose, nuove chiese, divieto dell'usura, persecuzione degli eretici",
        dislikes: "Tasse sul clero, tolleranza dei mistici, matrimoni mondani",
        greeting: "Che il Signore illumini la vostra saggezza, conte...",
        anger: "State sfidando la volontÃ  dell'Altissimo!",
        happiness: "Il Signore sorriderÃ  a questa scelta giusta e pia!"
    },
    militia: {
        name: "Capitano Ronan il Ferro",
        age: 38,
        traits: ["Diretto", "Leale", "Irritabile"],
        style: "Parli in modo militaresco, senza fronzoli, con termini di guerra",
        motivations: "Vuoi un esercito forte, buone armi, rispetto per i soldati",
        speech_patterns: "Usi metafore militari, parli di onore e disciplina",
        likes: "Nuove armi e armature, addestramento, fortificazioni, paga puntuale",
        dislikes: "Mancanza di fondi militari, esercito trascurato, viltÃ  diplomatica",
        greeting: "Signore, riferisco:",
        anger: "Non possiamo difendere il regno con bastoni e promesse!",
        happiness: "Finalmente qualcuno che capisce il valore di un esercito forte!"
    },
    peasants: {
        name: "Odric il Lavoratore",
        age: 33,
        traits: ["Paziente", "Oppresso", "Resistente"],
        style: "Parli in modo semplice e umile, ma con una dignitÃ  sottile",
        motivations: "Cibo sufficiente, tasse sopportabili, giustizia per i deboli",
        speech_patterns: "Usi metafore agricole, parli delle stagioni e del lavoro dei campi",
        likes: "Raccolti abbondanti, tasse basse, giorni di festa, terre comuni",
        dislikes: "Tasse insostenibili, carestie, leva forzata, abusi dei nobili",
        greeting: "Mio signore, con tutto il rispetto...",
        anger: "Le nostre famiglie stanno morendo di fame!",
        happiness: "Benedetto siate, signore! Finalmente possiamo sfamare i bambini!"
    },
    burghers: {
        name: "Maestro Bernard Forgiatore",
        age: 51,
        traits: ["Orgoglioso del mestiere", "Pragmatico", "Corporativo"],
        style: "Parli con l'orgoglio dell'artigiano, enfatizzando qualitÃ  e maestria",
        motivations: "Protezione delle corporazioni, mercati fiorenti, prestigio per gli artigiani",
        speech_patterns: "Usi termini tecnici del tuo mestiere, parli di qualitÃ  e reputazione",
        likes: "Mercati prosperi, protezione delle corporazioni, commissioni importanti",
        dislikes: "Concorrenza sleale, dazi eccessivi, mancanza di materie prime",
        greeting: "Salute a voi, conte. Vengo dalla bottega...",
        anger: "Come possiamo lavorare in queste condizioni?!",
        happiness: "Questa Ã¨ una decisione degna di un vero signore!"
    },
    merchants: {
        name: "Ser Lothar dei Ponti",
        age: 42,
        traits: ["Subdolo", "Affabile", "Avido"],
        style: "Parli con false cortesie, sempre cercando l'affare migliore",
        motivations: "Profitto massimo, nuove rotte commerciali, monopoli vantaggiosi",
        speech_patterns: "Parli in termini di costi e guadagni, proponi sempre 'opportunitÃ '",
        likes: "Dazi bassi, libertÃ  commerciale, protezione delle carovane",
        dislikes: "Monopoli altrui, banditi sulle strade, guerre che bloccano i commerci",
        greeting: "Illustrissimo conte, ho un'opportunitÃ  che vi interesserÃ ...",
        anger: "Questo Ã¨ un furto! Un vero furto!",
        happiness: "Signore, questo accordo sarÃ  profittevole per entrambi!"
    },
    mystics: {
        name: "Madre Elowen la Veggente",
        age: 67,
        traits: ["Enigmatica", "Calma", "Profetica"],
        style: "Parli per visioni e simboli, con un tono quasi ipnotico",
        motivations: "Protezione dei luoghi sacri antichi, libertÃ  di pratica, rispetto per le tradizioni",
        speech_patterns: "Usi metafore naturali, parli di sogni e presagi",
        likes: "Tolleranza religiosa, luoghi sacri protetti, erbe e rituali rispettati",
        dislikes: "Persecuzione religiosa, distruzione di siti sacri, ignoranza verso i segni",
        greeting: "Le nebbie del tempo si aprono, conte...",
        anger: "State ignorando i segni! Il destino vi punirÃ !",
        happiness: "Le antiche forze sorridono a questa scelta saggia..."
    },
    outcasts: {
        name: "Rasko il Senzapatria",
        age: 29,
        traits: ["Imprevedibile", "Rapido", "Diffidente"],
        style: "Parli con un misto di cinismo e umorismo nero",
        motivations: "Sopravvivenza, accettazione, opportunitÃ  per riscattarsi",
        speech_patterns: "Linguaggio di strada, battute sarcastiche, riferimenti alla vita nei bassifondi",
        likes: "Amnistie, lavoro onesto offerto, riconoscimento dei diritti",
        dislikes: "Persecuzioni, povertÃ  estrema, disprezzo sociale",
        greeting: "Eh, signore... non pensavo di essere ricevuto...",
        anger: "Tanto per voi siamo solo spazzatura, vero?!",
        happiness: "Non me lo aspettavo... forse c'Ã¨ speranza per gente come noi..."
    }
};

function createDefaultResources() {
    return {
        wood: 40,
        stone: 20,
        iron: 10,
        copper: 5,
        gold: 50,
        herbs: 25,
        grain: 180,
        livestock: 80,
        textiles: 35,
        luxuries: 20,
        arcane: 15,
        weapons: 0,
        armor: 0
    };
}

function createDefaultCounty() {
    return {
        desc: "",
        pop: 50, // Allineato alla somma di createDefaultPopulation
        gold: 400, // Oro sufficiente per emergenze
        food: 80, // Partiamo con la pancia piena
        health: 70, // Buona salute iniziale
        happy: 60, // FelicitÃ  decente
        security: 60,
        turn: 1,
        resources: {
            wood: 150, // Abbastanza per costruire subito
            stone: 80,
            iron: 40,
            copper: 10,
            gold: 20, // Oro risorsa fisica
            herbs: 50,
            grain: 600, // SCORTA CRITICA: ~3 turni di cibo garantiti
            livestock: 50,
            textiles: 100, // Vestiti per l'inverno
            luxuries: 10,
            arcane: 5,
            weapons: 20, // Minimo per la milizia iniziale
            armor: 10
        }
    };
}

let county = createDefaultCounty();
lastResourceSnapshot = cloneResourceBag(county.resources);
lastResourceDelta = createEmptyResourceDelta();
let industrySummary = null;
let gameActive = false;

// Tracciamo l'ultimo stato per mostrare delta stagionale (pop, gold, food, health)
let lastPop = county.pop;
let lastGold = county.gold;
let lastFood = county.food;
let lastHealth = county.health;

// Memoria dell'ultimo stato dei bisogni per l'IA
let lastNeedsReport = {};

function checkResourceBottlenecks() {
    const bottlenecks = [];
    buildings.forEach(building => {
        if (building.stage !== 'complete') return;
        const data = buildingData[building.type];
        if (!data || !data.consumes) return;
        Object.entries(data.consumes).forEach(([resource, amount]) => {
            const available = county.resources[resource] || 0;
            if (available < amount) {
                bottlenecks.push({
                    building: building.type,
                    resource: resource,
                    needed: amount,
                    available: available,
                    shortfall: amount - available
                });
            }
        });
    });
    return bottlenecks;
}

// AGGIUNGI QUESTO OGGETTO GLOBALE PER LA GUERRA
let warState = {
    active: false,           // Siamo in guerra?
    enemy: null,             // Contro chi? (key della contea)
    type: 'invasion',        // 'invasion', 'siege', 'raid', 'campaign'
    phase: 'preparation',    // 'preparation', 'march', 'engagement', 'siege', 'aftermath'
    turn: 0,
    mobilized: false,        // Abbiamo chiamato la leva?
    leviesCount: 0,          // Contadini prestati alla guerra
    armyMorale: 50,          // Morale dell'esercito
    lastBattleResult: null,  // Ultimo esito per la cronaca
    
    // Morale e condizioni estese
    morale: {
        militia: 100,
        levies: 70,
        enemy: 80
    },
    
    // Comandanti
    commanders: [],
    enemyCommander: null,
    
    // Assedio
    siegeState: {
        active: false,
        wallsIntegrity: 100,
        suppliesRemaining: 100,
        daysElapsed: 0,
        breaches: []
    },
    
    // Tattica corrente
    currentTactic: 'balanced',
    
    // Log battaglia
    battleLog: [],
    
    // Statistiche cumulative
    stats: {
        battlesWon: 0,
        battlesLost: 0,
        enemiesSlain: 0,
        soldiersLost: 0,
        goldLooted: 0,
        citiesCaptured: 0
    }
};

// Variabile per tracciare se siamo in una negoziazione attiva
let activeDiplomacy = {
    active: false,
    partner: null, // 'auvrey' o 'falken'
    type: null     // 'demand_gold', 'demand_land', 'offer_alliance', 'threat_war'
};

// Struttura globale per il bilancio dettagliato
let detailedBudget = {
    income: {
        taxes_nobility: 0,
        taxes_burghers: 0,
        taxes_peasants: 0,
        taxes_other: 0,
        trade_export: 0,
        production_mint: 0 // Zecca
    },
    expenses: {
        upkeep_military: 0,      // Soldati, torri, mura
        upkeep_civil: 0,         // Mercati, pozzi, edifici pubblici
        upkeep_court: 0,         // Famiglia reale, lussi, cattedrali
        upkeep_infrastructure: 0,// Strade, ponti (calcolato su estensione territorio)
        welfare_laws: 0,         // Costo leggi attive (es. pane per i poveri)
        import_costs: 0          // Acquisti automatici o manuali
    },
    net: 0
};

// Registro degli eventi del turno corrente
let currentTurnEvents = [];

function logTurnEvent(text) {
    // Aggiunge un evento alla lista (es. "Ãˆ nato un figlio", "Costruito mercato")
    currentTurnEvents.push(text);
}


// Tracciamento transazioni economiche per il rapporto stagionale
let seasonalTransactions = {
    marketPurchases: 0,
    marketSales: 0,
    specialPurchases: 0,
    taxes: 0,
    maintenance: 0
};

/* ===================== TERRITORIO ===================== */
function createDefaultLand() {
    return {
        count: 40, // Terre del conte
        nobility: 20,
        clergy: 10,
        commons: 30 // Terre comuni per i contadini (importante per felicitÃ )
    };
}

let landOwnership = createDefaultLand();

const TOTAL_LAND = 100;

/* ===================== POPOLAZIONE ===================== */
function createDefaultPopulation() {
    return {
        // Totale: ~220 abitanti (Molto piÃ¹ gestibile)
        nobility: { count: 1, wealth: 200, literacy: 90, workforceRatio: 0.2, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        clergy: { count: 1, wealth: 100, literacy: 95, workforceRatio: 0.8, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        militia: { count: 2, wealth: 20, literacy: 20, workforceRatio: 1.0, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        peasants: { count: 34, wealth: 5, literacy: 5, workforceRatio: 0.8, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() }, // Forza lavoro principale
        burghers: { count: 5, wealth: 50, literacy: 40, workforceRatio: 0.8, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        merchants: { count: 1, wealth: 80, literacy: 70, workforceRatio: 0.9, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        mystics: { count: 1, wealth: 10, literacy: 30, workforceRatio: 0.5, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() },
        outcasts: { count: 5, wealth: 0, literacy: 0, workforceRatio: 0.6, employed: 0, resources: createEmptyResourceBag(), privateGold: 0, privateResources: createEmptyResourceBag() }
    };
}

let populationGroups = createDefaultPopulation();

function adjustPopulation(group, delta, targetState = null) {
    const groups = targetState ? targetState.populationGroups : populationGroups;
    if (!groups[group]) groups[group] = 0;
    groups[group] = Math.max(0, groups[group] + delta);
    recomputePopulation(targetState);
}

function recomputePopulation(targetState = null) {
    const groups = targetState ? targetState.populationGroups : populationGroups;
    const targetCounty = targetState ? targetState.county : county;
    targetCounty.pop = Object.values(groups).reduce((sum, val) => sum + (val.count || val), 0);
}

/* ===================== SISTEMA DINASTIA ===================== */

// Helper per etÃ  leggibile
function getAgeLabel(age) {
    return Math.floor(age);
}

// 1. AVANZAMENTO ETÃ€ (Da chiamare dentro progressSeason)
/* ===================== CICLO DELLA VITA (EVENTI DINASTICI) ===================== */

// Funzione principale da chiamare dentro progressSeason()
function processLifeEvents() {
    // 1. Invecchiamento e Recupero
    advanceAgeAndRecovery(dynasty.ruler);
    if (dynasty.spouse) advanceAgeAndRecovery(dynasty.spouse);
    
    // Rimuovi eredi morti o processa invecchiamento
    if (dynasty.heirs.length > 0) {
        // Filter crea un nuovo array tenendo solo i vivi
        dynasty.heirs = dynasty.heirs.filter(heir => {
            advanceAgeAndRecovery(heir);
            // Se Ã¨ morto durante l'invecchiamento (checkDeath chiamato dentro), lo rimuoviamo qui?
            // No, checkDeath gestisce la logica. Qui filtriamo se health <= 0 o flag 'dead'
            return !heir.isDead;
        });
    }

    // 2. Eventi Negativi (Malattia / Incidente)
    // PiÃ¹ bassa Ã¨ la salute/sicurezza della contea, piÃ¹ alto il rischio
    const illnessRisk = Math.max(0.05, (100 - county.health) / 200); // 5% min, sale se health bassa
    const accidentRisk = Math.max(0.02, (100 - county.security) / 300); // 2% min, sale se security bassa

    // Tenta evento sul Conte
    rollLifeEvent(dynasty.ruler, illnessRisk, accidentRisk);

    // Tenta evento sul Consorte
    if (dynasty.spouse) rollLifeEvent(dynasty.spouse, illnessRisk, accidentRisk);

    // Tenta evento su UN figlio a caso (per non spammare)
    if (dynasty.heirs.length > 0) {
        const randomHeir = dynasty.heirs[Math.floor(Math.random() * dynasty.heirs.length)];
        rollLifeEvent(randomHeir, illnessRisk, accidentRisk);
    }

    // 3. Tentativo di Nascita (solo se c'Ã¨ consorte)
    if (dynasty.spouse && !dynasty.ruler.isDead && !dynasty.spouse.isDead) {
        checkBirth();
    }

    // 4. Morte (Il Mietitore controlla tutti)
    // Nota: checkDeath viene chiamato dentro advanceAgeAndRecovery per naturale, 
    // ma chiamiamolo qui per eventi traumatici appena accaduti
    checkDeath(dynasty.ruler, "ruler");
    if (dynasty.spouse) checkDeath(dynasty.spouse, "spouse");
    dynasty.heirs.forEach(h => checkDeath(h, "heir"));

    updateDynastyUI();
}

// Gestisce invecchiamento e guarigione naturale
function advanceAgeAndRecovery(person) {
    person.age += 0.25;
    
    // Recupero salute se ha tratti negativi
    if (person.traits.includes("Malato")) {
        // Se la contea ha buona salute o ospedali, guarisce
        const cureChance = county.health > 60 ? 0.4 : 0.1; 
        if (Math.random() < cureChance) {
            removeTrait(person, "Malato");
            addMsg("system", `ðŸŒ¿ <strong>Guarigione:</strong> ${person.name} ha sconfitto la malattia.`);
        }
    }
    
    if (person.traits.includes("Ferito")) {
        const cureChance = 0.5; // Le ferite guariscono piÃ¹ facilmente
        if (Math.random() < cureChance) {
            removeTrait(person, "Ferito");
            addMsg("system", `ðŸ©¹ <strong>Guarigione:</strong> Le ferite di ${person.name} si sono rimarginate.`);
        }
    }
}

// Tira i dadi per eventi sfortunati
function rollLifeEvent(person, baseIllnessRisk, baseAccidentRisk) {
    if (person.isDead) return;

    // Age multipliers
    let ageMultiplier = 1.0;
    if (person.age < 5) ageMultiplier = 2.0; // Children more vulnerable
    else if (person.age > 60) ageMultiplier = 1.5; // Elderly more vulnerable

    // Illness
    let illnessRisk = baseIllnessRisk * ageMultiplier;
    if (person.traits.includes("Robust")) illnessRisk *= 0.5;
    if (person.traits.includes("Frail")) illnessRisk *= 2.0;
    if (!person.traits.includes("Malato") && Math.random() < illnessRisk) {
        addTrait(person, "Malato");
        addMsg("system", `ðŸ¤¢ <strong>Malattia:</strong> ${person.name} si Ã¨ ammalato.`);
    }

    // Accident
    let accidentRisk = baseAccidentRisk * ageMultiplier;
    if (person.traits.includes("Clumsy")) accidentRisk *= 2.0;
    if (person.traits.includes("Agile")) accidentRisk *= 0.5;
    if (!person.traits.includes("Ferito") && Math.random() < accidentRisk) {
        addTrait(person, "Ferito");
        addMsg("system", `ðŸ¤• <strong>Incidente:</strong> ${person.name} ha subito un incidente.`);
    }
}

// Gestisce la Nascita
function checkBirth() {
    // EtÃ  fertile approssimativa
    if (dynasty.ruler.age > 60 || dynasty.spouse.age > 45) return;
    if (dynasty.ruler.age < 16 || dynasty.spouse.age < 16) return;

    let chance = 0.05; // 5% base a stagione
    if (county.happy > 70) chance += 0.05; // Popolo felice = atmosfera migliore?
    if (county.food > 80) chance += 0.02; // Ben nutriti

    if (Math.random() < chance) {
        const isMale = Math.random() > 0.5;
        const name = isMale ? getRandomMaleName() : getRandomFemaleName();
        
        const child = {
            name: name,
            age: 0,
            gender: isMale ? "M" : "F",
            traits: [], // Nasce sano
            health: 100, // Valore salute interno (invisibile, usato per calcoli morte)
            isDead: false,
            maxAge: 70 + Math.floor(Math.random() * 20)
        };
        
        // Possibile complicazione parto (mortalitÃ  infantile medievale)
        if (Math.random() < 0.1) {
            addTrait(child, "Debole");
            addMsg("system", `âš ï¸ Il piccolo ${name} Ã¨ nato, ma Ã¨ molto debole.`);
        }

        dynasty.heirs.push(child);
        addMsg("system", `ðŸ‘¶ <strong>Lieto Evento:</strong> Ãˆ nato ${name}! La dinastia cresce.`);
        
        // Bonus felicitÃ 
        county.happy = Math.min(100, county.happy + 5);
        updateUI();
    }
}

// Il Tristo Mietitore
function checkDeath(person, role) {
    if (person.isDead) return;

    let deathChance = 0;

    // EtÃ -based mortality curve
    if (person.age < 1) deathChance = 0.10; // Infant mortality
    else if (person.age < 5) deathChance = 0.02;
    else if (person.age < 15) deathChance = 0.005;
    else if (person.age < 30) deathChance = 0.001;
    else if (person.age < 50) deathChance = 0.005;
    else if (person.age < 60) deathChance = 0.02;
    else if (person.age < 70) deathChance = 0.05;
    else if (person.age < 80) deathChance = 0.10;
    else deathChance = 0.20; // Over 80

    // Trait modifiers
    if (person.traits.includes("Robust")) deathChance *= 0.5;
    if (person.traits.includes("Frail")) deathChance *= 2.0;
    if (person.traits.includes("Malato")) deathChance *= 3.0;
    if (person.traits.includes("Ferito")) deathChance *= 1.5;

    // Environmental factors
    if (county.health < 20) deathChance *= 1.5;
    if (county.food < 10) deathChance *= 2.0;
    if (county.security < 20) deathChance *= 1.2;

    // Roll for death
    if (Math.random() < deathChance) {
        person.isDead = true;
        handleDeathEffect(person, role);
    }
}

function handleDeathEffect(person, role) {
    const name = person.name;
    
    // Effetti scenici
    if (role === "ruler") {
        logTurnEvent(`The ruler ${name} has passed away.`);
        handleSuccession(); // Logica successione esistente
    } 
    else if (role === "spouse") {
        addMsg("system", `âš°ï¸ <strong>Lutto Reale:</strong> Il consorte ${name} Ã¨ deceduto. La corte Ã¨ in lutto.`);
        logTurnEvent(`The consort ${name} has died.`);
        dynasty.spouse = null; // Rimuovi consorte
        county.happy = Math.max(0, county.happy - 10); // Era -15
    } 
    else if (role === "heir") {
        addMsg("system", `âš°ï¸ <strong>Tragedia:</strong> Il giovane ${name} Ã¨ morto prematuramente.`);
        logTurnEvent(`The heir ${name} has died prematurely.`);
        // La rimozione dall'array avviene nel filtro all'inizio di processLifeEvents
        county.happy = Math.max(0, county.happy - 7); // Era -10
    }
    
    updateUI();
}

// Helpers per i tratti
function addTrait(person, trait) {
    if (!person.traits) person.traits = [];
    if (!person.traits.includes(trait)) person.traits.push(trait);
}

function removeTrait(person, trait) {
    if (!person.traits) return;
    person.traits = person.traits.filter(t => t !== trait);
}

// 2. CONTROLLO MORTE
function checkRulerDeath() {
    const r = dynasty.ruler;
    const age = r.age;
    
    // Fattore di rischio base
    let deathChance = 0;

    // Vecchiaia
    if (age > 60) deathChance += 0.02; // 2% a stagione
    if (age > r.maxAge) deathChance += 0.50; // Rischio altissimo sopra maxAge

    // Salute
    if (county.health < 30) deathChance += 0.05;
    if (county.food < 10) deathChance += 0.10;

    if (Math.random() < deathChance) {
        handleSuccession();
    }
}

// 3. SUCCESSIONE O GAME OVER
function handleSuccession() {
    const deadRulerName = dynasty.ruler.name;
    
    // Cerca erede maggiorenne (o il piÃ¹ grande)
    const heir = dynasty.heirs.length > 0 ? dynasty.heirs[0] : null;

    if (heir) {
        // Successione riuscita
        alert(`ðŸ‘‘ IL RE Ãˆ MORTO, LUNGA VITA AL RE!\n\n${deadRulerName} Ã¨ deceduto. Ora governi come ${heir.name}.`);
        addMsg("system", `ðŸ’€ <b>LUTTO REALE:</b> ${deadRulerName} Ã¨ morto. ${heir.name} ascende al trono.`);
        
        // Passaggio di consegne
        dynasty.ruler = {
            name: heir.name,
            age: heir.age,
            maxAge: 70 + Math.floor(Math.random() * 20),
            health: 100,
            traits: heir.traits || ["Erede"],
            isDead: false
        };
        
        // Resetta famiglia (il nuovo conte non Ã¨ sposato con sua madre/padre!)
        dynasty.spouse = null; 
        dynasty.heirs = []; // I fratelli diventano cortigiani (semplificazione)
        
        updateDynastyUI();
        updateUI(); // Aggiorna nome conte
    } else {
        // GAME OVER
        document.getElementById("gameover-reason").innerText = `${deadRulerName} Ã¨ morto all'etÃ  di ${Math.floor(dynasty.ruler.age)} anni senza lasciare eredi. La casata Ã¨ estinta.`;
        document.getElementById("modal-gameover").classList.add("active");
    }
}

// 4. MATRIMONIO
function openMarriageMarket() {
    const modal = document.getElementById("modal-marriage");
    const grid = document.getElementById("marriage-candidates");
    grid.innerHTML = "";

    if (!activeSuitorsList || activeSuitorsList.length === 0) {
        activeSuitorsList = generateSuitors(); // Genera solo se non esiste
    }

    activeSuitorsList.forEach((suitor, index) => {
        // Inizializza chat temporanea per questo suitor
        const chatKey = `suitor_${index}`;
        privateChats[chatKey] = []; 

        const div = document.createElement("div");
        div.className = "candidate-card";
        div.innerHTML = `
            <strong>${suitor.name}</strong>
            <span class="candidate-origin">${suitor.originLabel}</span>
            <div>EtÃ : ${suitor.age}</div>
            <div>Rapporto: ${suitor.relation}/100</div>
            <div class="candidate-bonus">${suitor.bonusDesc}</div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-sec" onclick="openPrivateChat('suitor_${index}')">ðŸ’¬ Parla</button>
                <button class="btn-sec" onclick="giveGiftToSuitor(${index})">ðŸŽ Regala</button>
                <button class="btn-main" onclick="marrySuitorIndex(${index})">ðŸ’ Sposa</button>
            </div>
        `;
        grid.appendChild(div);
    });

    modal.classList.add("active");
}

function generateSuitors() {
    const suitors = [];
    // Candidato Nobile Locale
    suitors.push({
        name: "Lady Elara di Montferrand",
        age: 18 + Math.floor(Math.random()*10),
        origin: "nobility",
        originLabel: "NobiltÃ  Locale",
        bonusDesc: "+15 LealtÃ  NobiltÃ , +100 Oro",
        effects: { faction: "nobility", gold: 100 },
        relation: 50
    });
    // Candidato Estero (Auvrey)
    if (neighboringCounties.find(c=>c.key==='auvrey').relations > 30) {
        suitors.push({
            name: "Contessina Isabella d'Auvrey",
            age: 20 + Math.floor(Math.random()*8),
            origin: "auvrey",
            originLabel: "Contea di Auvrey",
            bonusDesc: "Alleanza con Auvrey, Prezzi Mercato ridotti",
            effects: { relation: "auvrey", trade: true },
            relation: 50
        });
    }
    // Candidato Mercante
    suitors.push({
        name: "Ginevra la Ricca",
        age: 25 + Math.floor(Math.random()*15),
        origin: "merchants",
        originLabel: "Gilda Mercanti",
        bonusDesc: "+300 Oro immediato",
        effects: { gold: 300, faction: "merchants" },
        relation: 50
    });

    return suitors;
}

function marrySuitorIndex(index) {
    const suitor = activeSuitorsList[index];
    if(!suitor) return;
    
    if (suitor.relation < 90) {
        addMsg("system", `ðŸ’” Il rapporto con ${suitor.name} non Ã¨ abbastanza alto (${suitor.relation}/100). Continua a parlare e regalare per migliorare il legame.`);
        return;
    }
    
    // Trasferisci la chat del suitor nella chat dello spouse (per mantenere lo storico!)
    const oldChatKey = `suitor_${index}`;
    if (privateChats[oldChatKey]) {
        privateChats['spouse'] = [...privateChats[oldChatKey]];
        // Aggiungi messaggio di sistema
        privateChats['spouse'].push({from:'system', text:'Il matrimonio Ã¨ stato celebrato.'});
    }

    marrySuitor(suitor); // Chiama la funzione logica originale
}

function marrySuitor(suitor) {
    dynasty.spouse = suitor;
    dynasty.spouse.maxAge = 70 + Math.floor(Math.random() * 20);
    dynasty.spouse.traits = dynasty.spouse.traits || [];
    dynasty.spouse.isDead = false;
    closeMarriageModal();
    
    // Applica effetti
    if (suitor.effects.gold) county.gold += suitor.effects.gold;
    if (suitor.effects.faction) factions[suitor.effects.faction] += 15;
    if (suitor.effects.relation) {
        const n = neighboringCounties.find(c=>c.key === suitor.effects.relation);
        if(n) { n.relations += 30; n.tradeAgreement = true; }
    }

    addMsg("system", `ðŸ’ <b>MATRIMONIO REALE:</b> Il Conte ha sposato ${suitor.name}!`);
    logTurnEvent(`Matrimonio reale celebrato con ${suitor.name}`);
    updateDynastyUI();
    updateUI();
}

function closeMarriageModal() {
    document.getElementById("modal-marriage").classList.remove("active");
}

function giveGiftToSuitor(index) {
    const suitor = activeSuitorsList[index];
    if (!suitor) return;
    
    const giftCost = 50;
    if (county.gold < giftCost) {
        addMsg("system", "Non hai abbastanza oro per un regalo adeguato.");
        return;
    }
    
    county.gold -= giftCost;
    const relationGain = 10 + Math.floor(Math.random() * 11); // 10-20
    suitor.relation = Math.min(100, suitor.relation + relationGain);
    
    addMsg("system", `ðŸŽ Hai regalato un dono prezioso a ${suitor.name}. Rapporto aumentato di ${relationGain} punti!`);
    updateUI();
    // Rileggi il modal per aggiornare il rapporto
    openMarriageMarket();
}

// 5. NASCITE
function checkBirth() {
    if (!dynasty.spouse) return;
    
    // ProbabilitÃ : piÃ¹ alta se entrambi giovani
    let chance = 0.08; // 8% a stagione base
    if (dynasty.ruler.age < 40 && dynasty.spouse.age < 35) chance += 0.10;
    
    if (Math.random() < chance) {
        const isMale = Math.random() > 0.5;
        const name = isMale ? getRandomMaleName() : getRandomFemaleName();
        
        const child = {
            name: name,
            age: 0,
            gender: isMale ? "M" : "F",
            traits: []
        };
        
        dynasty.heirs.push(child);
        addMsg("system", `ðŸ‘¶ <b>LIETO EVENTO:</b> Ãˆ nato un erede! Benvenuto al piccolo ${name}.`);
        logTurnEvent(`Ãˆ nato un erede: ${name}`);
        
        // Se Ã¨ il primo figlio, aumenta stabilitÃ 
        if (dynasty.heirs.length === 1) {
            addMsg("system", "La linea di successione Ã¨ assicurata. StabilitÃ  +10.");
        }
        
        updateDynastyUI();
    }
}

function getRandomMaleName() {
    const names = ["Edward", "William", "Henry", "Richard", "Baldwin", "Godfrey", "Charles"];
    return names[Math.floor(Math.random() * names.length)];
}

function getRandomFemaleName() {
    const names = ["Eleanor", "Matilda", "Isabella", "Adela", "Margaret", "Beatrice"];
    return names[Math.floor(Math.random() * names.length)];
}

// 6. INTERFACCIA UTENTE DINASTIA
function updateDynastyUI() {
    // Ruler
    const r = dynasty.ruler;
    let rulerStatus = "";
    if (r.traits.includes("Malato")) rulerStatus += "ðŸ¤¢ ";
    if (r.traits.includes("Ferito")) rulerStatus += "ðŸ¤• ";
    
    document.getElementById("dynasty-ruler-name").innerHTML = `${rulerStatus} ${r.name || heroName}`;
    document.getElementById("dynasty-ruler-age").innerText = Math.floor(r.age);
    document.getElementById("dynasty-ruler-health").innerText = county.health > 70 ? "Eccellente" : county.health > 40 ? "Buona" : "Cagionevole";
    
    // Spouse
    const spouseContainer = document.getElementById("spouse-container");
    if (dynasty.spouse) {
        let sStatus = "";
        if (dynasty.spouse.traits && dynasty.spouse.traits.includes("Malato")) sStatus += "ðŸ¤¢ ";
        
        spouseContainer.innerHTML = `
            <div class="person-card-ui spouse">
                <strong>${sStatus}${dynasty.spouse.name}</strong>
                <div>EtÃ : ${Math.floor(dynasty.spouse.age)}</div>
                <div style="font-size:0.8em; color:#aaa;">${dynasty.spouse.originLabel}</div>
                <div style="font-size:0.8em; color:#ff7c7c;">${dynasty.spouse.traits ? dynasty.spouse.traits.join(", ") : ""}</div>
            </div>
        `;
    } else {
        spouseContainer.innerHTML = `
            <div class="dynasty-empty-slot">
                <p>Nessun consorte.</p>
                <button class="btn-main" onclick="openMarriageMarket()">Cerca Pretendenti</button>
            </div>
        `;
    }

    // Heirs
    const heirsList = document.getElementById("heirs-list");
    heirsList.innerHTML = "";
    if (dynasty.heirs.length === 0) {
        heirsList.innerHTML = `<p class="text-soft" style="grid-column: 1/-1; text-align:center;">Nessun erede.</p>`;
    } else {
        dynasty.heirs.forEach(h => {
            let hStatus = "";
            if (h.traits.includes("Malato")) hStatus += "ðŸ¤¢ ";
            if (h.traits.includes("Ferito")) hStatus += "ðŸ¤• ";
            if (h.traits.includes("Debole")) hStatus += "ðŸƒ ";

            const div = document.createElement("div");
            div.className = "person-card-ui heir";
            div.innerHTML = `
                <strong>${hStatus}${h.name}</strong>
                <div>EtÃ : ${Math.floor(h.age)}</div>
                <div style="font-size:0.8em;">${h.traits.join(", ") || "Sano"}</div>
            `;
            heirsList.appendChild(div);
        });
    }

    // --- AGGIORNAMENTO BOTTONI CHAT FAMIGLIA ---
    const familySection = document.getElementById("family-chat-buttons");
    const familySelector = document.getElementById("family-selector");
    
    if (!familySection || !familySelector) return;

    let hasFamily = false;
    let html = "";

    // Bottone Coniuge
    if (dynasty.spouse) {
        hasFamily = true;
        // Crea un ID univoco per la chat, es. 'spouse'
        html += `<button class="btn-sec" style="border-color:#d4af37" onclick="openPrivateChat('spouse')">â¤ï¸ ${dynasty.spouse.name} (Consorte)</button>`;
        
        // Assicura che esista l'array della chat in memoria
        if (!privateChats['spouse']) privateChats['spouse'] = [];
    }

    // Bottoni Eredi
    dynasty.heirs.forEach((heir, index) => {
        hasFamily = true;
        const chatKey = `heir_${index}`;
        html += `<button class="btn-sec" style="border-color:#6ada91" onclick="openPrivateChat('${chatKey}')">ðŸ‘¶ ${heir.name} (Erede)</button>`;
        
        // Inizializza chat memoria
        if (!privateChats[chatKey]) privateChats[chatKey] = [];
    });

    familySelector.innerHTML = html;
    familySection.style.display = hasFamily ? "block" : "none";
}

// 7. EVENTI BAMBINI (Educazione)
function triggerChildEvent(child) {
    // Semplice scelta tramite prompt o modale (qui uso alert/prompt per semplicitÃ , 
    // meglio sarebbe integrarlo nella chat azioni)
    
    // Per integrazione pulita, lo mandiamo come messaggio in chat azioni
    addMsg("system", `ðŸŽ“ L'erede ${child.name} ha raggiunto i ${child.age} anni. Ãˆ tempo di scegliere la sua educazione.`);
    
    // Aggiungiamo trait casuale per ora, in futuro collegare a bottoni azione
    const newTrait = Math.random() > 0.5 ? "Guerriero" : "Erudito";
    child.traits.push(newTrait);
}

/* ===================== FAZIONI ===================== */
const factionOrder = [
    "nobility","clergy","militia","peasants",
    "burghers","merchants","mystics","outcasts"
];

function createDefaultFactions() {
    return {
        nobility: 50,
        clergy: 50,
        militia: 50,
        peasants: 50,
        burghers: 50,
        merchants: 50,
        mystics: 50,
        outcasts: 50
    };
}

let factions = createDefaultFactions();

/* ===================== CONTEE VICINE ===================== */
function createDefaultNeighbors() {
    return [
        { 
            key:"auvrey", 
            name:"Contea di Auvrey", 
            ruler: "Conte Emeric il Giovane",
            traits: ["Aggressivo", "Orgoglioso", "Espansionista"],
            power: 70, 
            wealth: 50, 
            relations: 40, 
            aggression: 40, // Quanto Ã¨ vicino alla guerra (0-100)
            fear: 10,       // Quanto teme il giocatore
            lastInteraction: 0,
            land:30,
            description: "Una contea ambiziosa guidata dal giovane Conte Emeric, che cerca di espandere i suoi confini attraverso alleanze e conquiste.",
            goals: ["Espandere territorio", "Formare alleanze matrimoniali", "Controllare rotte commerciali"],
            personality: "Ambizioso e calcolatore, ma impulsivo in battaglia.",
            specialResource: "textiles",
            events: []
        },
        { 
            key:"falken", 
            name:"Baronia di Falken", 
            ruler: "Baronessa Lidia",
            traits: ["Pragmatica", "Avida", "Difensiva"],
            power: 40, 
            wealth: 80, 
            relations: 60, 
            aggression: 10,
            fear: 20,
            lastInteraction: 0,
            land:18,
            description: "Una baronia montuosa difesa dal Barone Lothar, noto per le sue miniere e la sua neutralitÃ .",
            goals: ["Mantenere indipendenza", "Sviluppare miniere", "Proteggere confini"],
            personality: "Difensivo e pragmatico, preferisce la diplomazia alla guerra.",
            specialResource: "iron",
            events: []
        }
    ];
}

let neighboringCounties = createDefaultNeighbors();

/* ===================== CONSIGLIERE ===================== */
let advisor = { name:"", personality:"" };

/* ===================== CHAT PRIVATE ===================== */
let activePrivateChat = null;
function createDefaultPrivateChats() {
    return {
        nobility:[], clergy:[], militia:[], peasants:[],
        burghers:[], merchants:[], mystics:[], outcasts:[],
        auvrey:[], falken:[]
    };
}

let privateChats = createDefaultPrivateChats();

function ensureWorldSystems(targetState = null) {
    if (targetState) {
        if (!targetState.worldTime) targetState.worldTime = createDefaultWorldTime();
        if (!targetState.taxPolicy) targetState.taxPolicy = createDefaultTaxPolicy();
        if (!Array.isArray(targetState.activeLaws)) targetState.activeLaws = [];
        if (!Array.isArray(targetState.taxHistory)) targetState.taxHistory = [];
        if (!targetState.lastResourceSnapshot) targetState.lastResourceSnapshot = captureResourceSnapshot(targetState);
        if (!targetState.lastResourceDelta) targetState.lastResourceDelta = createEmptyResourceDelta();
        if (!Array.isArray(targetState.customLaws)) targetState.customLaws = [];
        if (!targetState.industrySummary) targetState.industrySummary = summarizeIndustry(targetState.structures, targetState.settlements);
        if (targetState.county && targetState.county.security === undefined) targetState.county.security = 50;
        return;
    }

    if (!worldTime) worldTime = createDefaultWorldTime();
    if (!taxPolicy) taxPolicy = createDefaultTaxPolicy();
    if (!Array.isArray(activeLaws)) activeLaws = [];
    if (!Array.isArray(taxHistory)) taxHistory = [];
    if (!lastResourceSnapshot) lastResourceSnapshot = captureResourceSnapshot();
    if (!lastResourceDelta) lastResourceDelta = createEmptyResourceDelta();
    if (!Array.isArray(customLaws)) customLaws = [];
    if (!industrySummary) industrySummary = summarizeIndustry(structures, settlements);
    if (county && county.security === undefined) county.security = 50;
}

const FACTION_EFFECT_DESCRIPTIONS = {
    nobility: { bonus:"Sostengono opere e portano oro extra.", malus:"Pretendono privilegi, drenano le casse." },
    clergy: { bonus:"Intercedono per la salute pubblica.", malus:"Condannano il conte, calano devozione." },
    militia: { bonus:"Sorvegliano le strade, meno disordini.", malus:"Disertano e pretendono paga." },
    peasants: { bonus:"Coltivano con zelo, raccolti floridi.", malus:"Scioperano nei campi, raccolti scarsi." },
    burghers: { bonus:"Tessuti di qualitÃ , stabilitÃ  urbana.", malus:"Artigiani in protesta, produzione lenta." },
    merchants: { bonus:"PiÃ¹ lussi e oro nei mercati.", malus:"Fuggono i capitali, calano gli scambi." },
    mystics: { bonus:"Rinforzano l'arcano e curano.", malus:"Diffondono superstizioni destabilizzanti." },
    outcasts: { bonus:"Meno crimini e piÃ¹ informatori.", malus:"Disordini e sabotaggi frequenti." }
};

const RESOURCE_FACTION_MAP = {
    grain: { faction:"peasants", scale:0.3 },
    livestock: { faction:"peasants", scale:0.25 },
    textiles: { faction:"burghers", scale:0.25 },
    luxuries: { faction:"merchants", scale:0.3 },
    arcane: { faction:"mystics", scale:0.35 },
    herbs: { faction:"clergy", scale:0.2 }
};

const ASSET_RULES = [
    {
        key:"housing_poor",
        label:"Case Povere",
        getCount: summary => summary.getCount('poor_housing'),
        consume:{ grain:4, wood:0.4 }
    },
    {
        key:"housing_middle", 
        label:"Case Medie",
        getCount: summary => summary.getCount('middle_housing'),
        consume:{ grain:3, livestock:0.8, textiles:0.5 },
        gold:1.5
    },
    {
        key:"housing_noble",
        label:"Residenze Nobili", 
        getCount: summary => summary.getCount('noble_housing'),
        consume:{ grain:2, livestock:1.5, luxuries:1.2 },
        gold:3
    },
    {
        key:"farms",
        label:"Campi Coltivati",
        getCount: summary => summary.getCount('farm'),
        produce:{ grain:32 },
        consume:{ wood:0.6 }
    },
    {
        key:"ranches",
        label:"Allevamenti",
        getCount: summary => summary.getCount('ranch'),
        produce:{ livestock:11 },
        consume:{ grain:7, herbs:0.5 }
    },
    {
        key:"mines",
        label:"Miniere",
        getCount: summary => summary.getCount('mine'),
        produce:{ iron:8, copper:4 },
        consume:{ wood:1.2 }
    },
    {
        key:"sawmills",
        label:"Segherie",
        getCount: summary => summary.getCount('sawmill'),
        produce:{ wood:15 },
        consume:{ grain:0.8 }
    },
    {
        key:"quarries",
        label:"Cave",
        getCount: summary => summary.getCount('quarry'),
        produce:{ stone:12 },
        consume:{ wood:0.6 }
    },
    {
        key:"shops",
        label:"Botteghe",
        getCount: summary => summary.getCount('shop'),
        produce:{ textiles:6, luxuries:1.5 },
        consume:{ grain:1.8, iron:0.6, copper:0.4 },
        gold:4
    },
    {
        key:"churches",
        label:"Chiese",
        getCount: summary => summary.getCount('church'),
        produce:{ herbs:2 },
        consume:{ grain:0.8 },
        gold:2
    },
    {
        key:"monasteries",
        label:"Monasteri",
        getCount: summary => summary.getCount('monastery'),
        produce:{ herbs:5, arcane:2 },
        consume:{ grain:1.2 },
        gold:3
    }
];

function getSeason(timeRef = worldTime) {
    const ref = timeRef || worldTime;
    if (!ref) return SEASON_CYCLE[0];
    return SEASON_CYCLE[(ref.seasonIndex || 0) % SEASON_CYCLE.length];
}

function advanceSeason(targetState = null, options = {}) {
    const timeRef = targetState ? targetState.worldTime : worldTime;
    if (!timeRef) return;
    timeRef.seasonIndex = ((timeRef.seasonIndex || 0) + 1) % SEASON_CYCLE.length;
    if (timeRef.seasonIndex === 0) timeRef.year = (timeRef.year || 1325) + 1;
    applySeasonalMorale(timeRef, targetState);
    
    // Sistema di popolazione dinamica
    if (!targetState) {
        processDemographicEvents();
        processCrimeAndStability();
        processEmigration();
        processSocialMobility();
        updateCategoryWealth();
        
        // Aggiorna domanda/offerta mercato
        const marketDynamics = calculateMarketDemand();
        // Qui possiamo usare marketDynamics per influenzare i prezzi
    }
    
    if (!targetState && !options.silent) {
        const season = getSeason(timeRef);
        addMsg("system", `â³ Inizia ${season.label}. ${season.description}`);
        updateSeasonUI();
    }
}

function applySeasonalMorale(timeRef, targetState = null) {
    const season = getSeason(timeRef);
    if (!season.morale) return;
    const factionsRef = targetState ? targetState.factions : factions;
    Object.entries(season.morale).forEach(([key, delta]) => {
        factionsRef[key] = clamp((factionsRef[key] || 50) + delta);
    });
}

function updateSeasonUI() {
    const season = getSeason();
    const yearEl = document.getElementById("season-year");
    const nameEl = document.getElementById("season-name");
    const textEl = document.getElementById("season-effects-text");
    if (yearEl) yearEl.innerText = worldTime.year;
    if (nameEl) nameEl.innerText = season.label;
    if (textEl) textEl.innerText = season.description;
}

function getLawLibrary() {
    return [...BASE_LAW_LIBRARY, ...customLaws];
}

function getActiveLawKeys(targetState = null) {
    if (targetState && Array.isArray(targetState.activeLaws)) return targetState.activeLaws;
    return activeLaws;
}

function isLawActive(key, targetState = null) {
    return getActiveLawKeys(targetState).includes(key);
}

function getLawDefinition(key) {
    return getLawLibrary().find(l => l.key === key);
}

function toggleLaw(key) {
    const idx = activeLaws.indexOf(key);
    if (idx >= 0) {
        activeLaws.splice(idx, 1);
        const def = getLawDefinition(key);
        if (def) applyLawFactionShift(def, -1);
    } else {
        activeLaws.push(key);
        const def = getLawDefinition(key);
        if (def) applyLawFactionShift(def, 1);
    }
    renderLawList();
    updateUI();
}

function applyLawFactionShift(law, direction = 1, targetState = null) {
    if (!law.effects || !law.effects.factions) return;
    const factionsRef = targetState ? targetState.factions : factions;
    Object.entries(law.effects.factions).forEach(([key, delta]) => {
        factionsRef[key] = clamp((factionsRef[key] || 50) + delta * direction);
    });
}

function renderLawList() {
    const list = document.getElementById("law-list");
    if (!list) return;
    list.innerHTML = "";
    const library = getLawLibrary();
    library.forEach(law => {
        const card = document.createElement("div");
        card.className = "law-card";
        const title = document.createElement("h4");
        title.innerText = law.name;
        const desc = document.createElement("p");
        desc.innerText = law.description;
        const active = activeLaws.includes(law.key);
        const btn = document.createElement("button");
        btn.className = active ? "btn-main" : "btn-sec";
        btn.innerText = active ? "Abroga" : "Promulga";
        btn.addEventListener("click", () => toggleLaw(law.key));
        card.append(title, desc, btn);
        list.appendChild(card);
    });
    if (!library.length) {
        list.innerHTML = '<div class="law-card">Nessuna legge disponibile.</div>';
    }
}

function ownedStructures(list = [], owner = "count") {
    if (!Array.isArray(list)) return [];
    return list.filter(item => (item.owner || "count") === owner);
}

function summarizeIndustry(structuresRef = structures, settlementsRef = settlements, stateRef = null) {
    const buildingsRef = stateRef ? stateRef.buildings : buildings;
    
    const summary = {
        getCount: (type) => buildingsRef.filter(b => b.type === type && b.stage === 'complete').length,
        settlements: (settlementsRef || []).length
    };
    return summary;
}

function updateIndustrySummary(targetState = null) {
    if (targetState) {
        targetState.industrySummary = summarizeIndustry(targetState.structures, targetState.settlements, targetState);
        if (targetState._cachedAssetFlows) delete targetState._cachedAssetFlows;
        return targetState.industrySummary;
    }
    industrySummary = summarizeIndustry();
    latestAssetFlows = null;
    return industrySummary;
}

function getIndustrySummary(targetState = null) {
    if (targetState) {
        if (!targetState.industrySummary) return updateIndustrySummary(targetState);
        return targetState.industrySummary;
    }
    if (!industrySummary) return updateIndustrySummary();
    return industrySummary;
}

function calculateAssetFlows(summary, stateRef = null) {
    const flows = { production:{}, consumption:{}, goldCost:0, detail:[] };
    if (!summary) return flows;
    ASSET_RULES.forEach(rule => {
        const count = Math.max(0, Math.round(rule.getCount(summary)));
        if (!count) return;
        const entry = { key:rule.key, label:rule.label, count, production:{}, consumption:{}, gold:0 };
        if (rule.produce) {
            Object.entries(rule.produce).forEach(([res, value]) => {
                const amount = Math.max(0, Math.round(value * count));
                if (!amount) return;
                entry.production[res] = amount;
                flows.production[res] = (flows.production[res] || 0) + amount;
            });
        }
        if (rule.consume) {
            Object.entries(rule.consume).forEach(([res, value]) => {
                const amount = Math.max(0, Math.round(value * count));
                if (!amount) return;
                entry.consumption[res] = amount;
                flows.consumption[res] = (flows.consumption[res] || 0) + amount;
            });
        }
        if (rule.gold) {
            entry.gold = Math.max(0, Math.round(rule.gold * count));
            flows.goldCost += entry.gold;
        }
        flows.detail.push(entry);
    });
    if (stateRef) {
        stateRef._cachedAssetFlows = flows;
    } else {
        latestAssetFlows = flows;
    }
    return flows;
}

function getCachedAssetFlows(stateRef = null) {
    if (stateRef && stateRef._cachedAssetFlows) return stateRef._cachedAssetFlows;
    return latestAssetFlows;
}

function formatFlowMap(map) {
    const entries = Object.entries(map || {}).filter(([, val]) => val && val !== 0);
    if (!entries.length) return "â€”";
    return entries.map(([key, val]) => `${resourceLabels[key] || key}:${val > 0 ? '+' : ''}${val}`).join(", ");
}

function summarizeStructureOutput(list = []) {
    const totals = {};
    list.forEach(item => {
        Object.entries(item.production || {}).forEach(([key, value]) => {
            const actual = Math.max(0, Math.floor(value * (item.condition || 100) / 100));
            totals[key] = (totals[key] || 0) + actual;
        });
    });
    return totals;
}

function updateAssetSummaryUI(summaryRef = null) {
    const container = document.getElementById("asset-summary");
    if (!container) return;
    
    // 1. Ricalcola staff ed efficienza prima di mostrare
    calculateLaborAndEducation();

    container.innerHTML = "";
    
    // 2. Lista unificata
    let allWorkplaces = [];

    // Aggiungi Edifici Costruiti (Quelli veri)
    const activeBuildings = buildings.filter(b => b.stage === 'complete');
    allWorkplaces = allWorkplaces.concat(activeBuildings);

    // Aggiungi Strutture Mappa (Ora sarÃ  vuoto all'inizio, ma si riempirÃ  se conquisti territori in futuro)
    const mapStructures = [
        { list: structures.mines, type: 'iron_mine' }, 
        { list: structures.sawmills, type: 'sawmill' },
        { list: structures.quarries, type: 'stone_quarry' },
        { list: structures.monasteries, type: 'monastery' }
    ];

    mapStructures.forEach(group => {
        if(group.list) {
            group.list.forEach((s) => {
                if (!s.id) s.id = `struct_${group.type}_${s.x}_${s.y}`;
                s.realType = group.type;
                // Mostra solo se appartiene al conte
                if(s.owner === 'count') allWorkplaces.push(s);
            });
        }
    });

    if (allWorkplaces.length === 0) {
        container.innerHTML = '<div class="asset-card">Nessuna struttura produttiva attiva.</div>';
        return;
    }

    // 3. Raggruppamento
    const groups = {};

    allWorkplaces.forEach(b => {
        const typeKey = b.realType || b.type;
        const data = buildingData[typeKey];
        
        // Se il tipo non esiste in buildingData (es. vecchi salvataggi), ignoralo o usa fallback
        if (!data) return; 

        if (!groups[typeKey]) {
            groups[typeKey] = {
                name: data.name,
                count: 0,
                totalStaff: 0,
                totalReq: 0,
                avgEff: 0,
                staffType: data.staff ? data.staff.type : 'none'
            };
        }

        groups[typeKey].count++;
        groups[typeKey].totalStaff += (b.currentStaff || 0);
        // Calcola quanto staff serve (se l'edificio Ã¨ attivo/normale/alto)
        const baseReq = data.staff ? data.staff.amount : 0;
        groups[typeKey].totalReq += baseReq;
        groups[typeKey].avgEff += (b.currentEfficiency || 0);
    });

    // 4. Render
    Object.keys(groups).sort().forEach(typeKey => {
        const g = groups[typeKey];
        const avgEffPct = g.count > 0 ? Math.floor((g.avgEff / g.count) * 100) : 0;
        let effColor = avgEffPct < 50 ? '#f44336' : (avgEffPct < 100 ? '#ffeb3b' : '#6ada91');

        const data = buildingData[typeKey];
        if (!data) return;

        const card = document.createElement("div");
        card.className = "asset-card";
        card.style.borderLeft = "4px solid var(--accent)"; 
        
        // Mostra staff solo se l'edificio lo richiede
        let staffHtml = "";
        if (g.staffType !== 'none') {
            staffHtml = `
            <div style="font-size:0.9em; margin-bottom:6px; display:flex; justify-content:space-between;">
                <span>ðŸ‘· <strong>Staff:</strong> ${g.totalStaff} / ${g.totalReq}</span>
                <span style="color:#aaa; font-size:0.85em;">(${factionLabel(g.staffType)})</span>
            </div>`;
        }

        // Mostra produzione se presente
        let productionHtml = "";
        if (data.recipe) {
            let prodParts = [];
            if (data.recipe.input) {
                const inputs = Object.entries(data.recipe.input).map(([res, amt]) => `${resourceLabels[res] || res}: ${amt}`).join(', ');
                prodParts.push(`<span style="color:#f44336;">Consuma: ${inputs}</span>`);
            }
            if (data.recipe.output) {
                const outputs = Object.entries(data.recipe.output).map(([res, amt]) => `${resourceLabels[res] || res}: ${amt}`).join(', ');
                prodParts.push(`<span style="color:#4caf50;">Produce: ${outputs}</span>`);
            }
            if (prodParts.length > 0) {
                productionHtml = `
                <div style="font-size:0.9em; margin-bottom:6px;">
                    ðŸ“¦ ${prodParts.join(' â†’ ')}
                </div>`;
            }
        }

        // Mostra abitazioni se presente
        let housingHtml = "";
        if (data.housing) {
            const classLabel = data.housingClass ? factionLabel(data.housingClass) : "Generiche";
            housingHtml = `
            <div style="font-size:0.9em; margin-bottom:6px;">
                ðŸ  Abitazioni (${classLabel}): +${g.count * data.housing} capacitÃ 
            </div>`;
        }

        card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <div style="font-weight:bold; color:var(--accent); font-size:1.05em;">
                    ${g.name} <span style="color:#fff; background:#333; padding:1px 6px; border-radius:4px; font-size:0.8em;">x${g.count}</span>
                </div>
            </div>
            ${staffHtml}
            ${productionHtml}
            ${housingHtml}
            <div style="background:#222; height:8px; border-radius:4px; margin-bottom:8px; overflow:hidden; border:1px solid #444;">
                <div style="background:${effColor}; width:${avgEffPct}%; height:100%;"></div>
            </div>
            <div style="text-align:right; font-size:0.8em; color:${effColor}; margin-bottom:8px;">Efficienza: ${avgEffPct}%</div>

            <div style="display:flex; gap:5px; border-top:1px solid #333; padding-top:8px;">
                <button class="btn-sec" style="flex:1; font-size:0.75em; padding:6px;" onclick="setGroupPriority('${typeKey}', 'normal')">Reset PrioritÃ </button>
            </div>
        `;
        container.appendChild(card);
    });
}

// Funzione helper per cambiare prioritÃ 
function setBuildingPriority(id, level) {
    let target = null;

    // 1. Cerca negli edifici costruiti
    target = buildings.find(b => b.id === id);

    // 2. Se non trovato, cerca nelle strutture della mappa
    if (!target) {
        const allStructs = [
            ...structures.mines, 
            ...structures.sawmills, 
            ...structures.quarries, 
            ...structures.monasteries
        ];
        // Nota: Qui assumiamo che 'updateAssetSummaryUI' abbia giÃ  assegnato gli ID agli oggetti in memoria
        target = allStructs.find(s => s.id === id);
    }

    if (target) {
        target.priority = level;
        
        // Feedback visivo immediato
        addMsg("system", `âš™ï¸ PrioritÃ  aggiornata a <strong>${level.toUpperCase()}</strong> per la struttura.`);
        
        // Ricalcola immediatamente il lavoro per vedere l'effetto sull'efficienza
        calculateLaborAndEducation();
        
        // Aggiorna l'interfaccia
        updateUI(); 
    } else {
        console.error("Struttura non trovata per ID:", id);
    }
}

function setGroupPriority(typeKey, level) {
    let count = 0;

    // 1. Aggiorna Edifici Costruiti
    buildings.forEach(b => {
        if (b.type === typeKey && b.stage === 'complete') {
            b.priority = level;
            count++;
        }
    });

    // 2. Aggiorna Strutture Mappa
    // Helper per cercare nelle liste di strutture
    const updateStructList = (list, targetRealType) => {
        if (!list) return;
        list.forEach(s => {
            // Controlla se l'oggetto ha il realType assegnato o se stiamo mappando manualmente
            // (La funzione updateAssetSummaryUI assegna realType, ma qui potremmo operare sui dati grezzi)
            // Usiamo la logica inversa: se il tipo passato corrisponde alla lista
            if (targetRealType === typeKey) {
                s.priority = level;
                count++;
            }
        });
    };

    updateStructList(structures.mines, 'iron_mine');
    updateStructList(structures.sawmills, 'sawmill');
    updateStructList(structures.quarries, 'stone_quarry');
    updateStructList(structures.monasteries, 'monastery');

    // Feedback
    const priorityLabel = level === 'high' ? "ALTA" : (level === 'low' ? "FERMO" : "NORMALE");
    addMsg("system", `âš™ï¸ PrioritÃ  impostata su <strong>${priorityLabel}</strong> per tutte le strutture di tipo: <em>${buildingName(typeKey) || typeKey}</em>.`);

    // Ricalcola e aggiorna UI
    calculateLaborAndEducation();
    updateUI();
}

function calculateLogisticNeeds(stateRef = null) {
    const needs = [];
    const popRef = stateRef ? stateRef.populationGroups : populationGroups;
    
    // Gestisce sia la struttura con .count che valori diretti
    const militia = popRef && popRef.militia ? 
        (popRef.militia.count !== undefined ? popRef.militia.count : popRef.militia) : 0;
    
    if (militia > 0) {
        needs.push({ resource:"iron", amount: Math.ceil(militia * 0.08), tag:"military" });
        needs.push({ resource:"wood", amount: Math.ceil(militia * 0.04), tag:"military" });
        needs.push({ resource:"textiles", amount: Math.ceil(militia * 0.02), tag:"military" });
    }

    const buildingList = stateRef ? (stateRef.buildings || []) : buildings;
    if (Array.isArray(buildingList)) {
        const activeSites = buildingList.filter(b => b.stage === "building").length;
        if (activeSites > 0) {
            needs.push({ resource:"wood", amount: activeSites * 2, tag:"construction" });
            needs.push({ resource:"stone", amount: activeSites * 2, tag:"construction" });
            needs.push({ resource:"iron", amount: activeSites, tag:"construction" });
        }
    }

    return needs;
}

function delayConstructionProjects(targetState = null, extraTurns = 1) {
    const list = targetState ? (targetState.buildings || []) : buildings;
    if (!Array.isArray(list) || !extraTurns) return;
    list.forEach(site => {
        if (site.stage === "building") site.turns_left += extraTurns;
    });
}

function applyLogisticConsequences(needs, deficits, stateRef = null) {
    const impact = { military:false, construction:false };
    if (!needs || !needs.length) return impact;
    const tags = new Set();
    needs.forEach(entry => {
        if (deficits[entry.resource]) tags.add(entry.tag);
    });

    const factionsRef = stateRef ? stateRef.factions : factions;
    const countyRef = stateRef ? stateRef.county : county;

    if (tags.has("military")) {
        impact.military = true;
        factionsRef.militia = clamp((factionsRef.militia || 50) - 4);
        factionsRef.nobility = clamp((factionsRef.nobility || 50) - 1);
        countyRef.health = clamp(countyRef.health - 1);
    }

    if (tags.has("construction")) {
        impact.construction = true;
        delayConstructionProjects(stateRef, 1);
    }

    return impact;
}

const DEFICIT_FACTION_MAP = {
    grain: ["peasants"],
    livestock: ["peasants"],
    wood: ["burghers", "peasants"],
    stone: ["burghers"],
    iron: ["militia", "burghers"],
    copper: ["militia", "burghers"],
    textiles: ["burghers"],
    luxuries: ["nobility", "merchants"],
    herbs: ["clergy", "mystics"],
    arcane: ["mystics", "clergy"],
    gold: ["merchants", "nobility"]
};

function buildFactionDeficitMessage(factionKey, resourceKey, amount) {
    const label = resourceLabels[resourceKey] || resourceKey;
    switch(factionKey) {
        case "peasants":
            return `I villaggi non vedono abbastanza ${label}. Senza scorte rischiamo rivolte nei campi.`;
        case "burghers":
            return `Le botteghe restano inattive: servono ${label} per lavorare e pagare le tasse.`;
        case "militia":
            return `Gli arsenali sono vuoti di ${label}; come possiamo difendere la contea?`;
        case "merchants":
            return `I mercati perdono credito senza ${label}. Dobbiamo riaprire i traffici.`;
        case "nobility":
            return `Le casate considerano offensivo il deficit di ${label}. Pretendono attenzione immediata.`;
        case "clergy":
            return `I riti richiedono ${label}; il popolo ha bisogno della nostra guida spirituale.`;
        case "mystics":
            return `Le nostre arti languono senza ${label}. Il regno perderÃ  protezione arcana.`;
        default:
            return `${factionLabel(factionKey)} avverte la mancanza di ${label}.`;
    }
}

function triggerFactionInterjections(context = {}) {
    const messages = [];
    const deficits = context.economy?.deficits || {};
    Object.entries(deficits).forEach(([resourceKey, amount]) => {
        const factionTargets = DEFICIT_FACTION_MAP[resourceKey];
        if (!factionTargets) return;
        factionTargets.forEach(key => {
            const text = buildFactionDeficitMessage(key, resourceKey, amount);
            if (text) messages.push({ key, text, priority: 3 });
        });
    });

    if (context.economy?.logisticImpact?.military) {
        messages.push({
            key: "militia",
            text: "Senza ferrivecchi e razioni la guardia non puÃ² reggere un assedio.",
            priority: 4
        });
    }
    if (context.economy?.logisticImpact?.construction) {
        messages.push({
            key: "burghers",
            text: "I cantieri languono: spedite legname e pietra o le maestranze sciopereranno.",
            priority: 3
        });
    }

    if (context.maxAggression !== undefined && context.maxAggression >= 80) {
        messages.push({
            key: "militia",
            text: "Le frontiere ribollono di stendardi stranieri. Occorre prepararci ora, non quando sarÃ  tardi.",
            priority: 2
        });
    }

    factionOrder.forEach(key => {
        const mood = factions[key] || 50;
        if (mood <= 28 && Math.random() < 0.5) {
            messages.push({ key, text: getFactionChatLine(key, mood), priority: 1 });
        } else if (mood >= 75 && Math.random() < 0.25 && !messages.length) {
            messages.push({ key, text: getFactionChatLine(key, mood), priority: 0 });
        }
    });

    if (!messages.length) return;

    messages.sort((a, b) => (b.priority || 0) - (a.priority || 0));
    const used = new Set();
    const selected = [];
    messages.forEach(msg => {
        if (selected.length >= 3) return;
        if (used.has(msg.key)) return;
        selected.push(msg);
        used.add(msg.key);
    });

    selected.forEach(msg => {
        addMsg("ai", `<strong>${factionLabel(msg.key)}</strong>: ${msg.text}`);
    });
}

// Mappa Emoji/Icone per Fazioni
const FACTION_ICONS = {
    nobility: "ðŸ¦", clergy: "âœï¸", peasants: "ðŸŒ¾", militia: "âš”ï¸",
    burghers: "ðŸ”¨", merchants: "âš–ï¸", mystics: "ðŸ”®", outcasts: "ðŸ€"
};

const COURT_RELATIONSHIPS = {
    nobility: { friends: ['clergy'], enemies: ['peasants', 'burghers'] },
    clergy: { friends: ['nobility', 'mystics'], enemies: ['merchants', 'outcasts'] },
    militia: { friends: ['nobility'], enemies: ['outcasts', 'peasants'] },
    peasants: { friends: ['outcasts'], enemies: ['nobility', 'militia'] },
    burghers: { friends: ['merchants'], enemies: ['nobility'] },
    merchants: { friends: ['burghers'], enemies: ['clergy'] },
    mystics: { friends: ['clergy'], enemies: ['burghers'] },
    outcasts: { friends: ['peasants'], enemies: ['militia'] }
};

function triggerCourtEvent(context) {
    const deficits = context.deficits || {};
    // ... (Logica selezione attori esistente rimane uguale) ...
    
    // Esempio di selezione (copia dal tuo codice o usa logica semplificata)
    let mainActor = 'peasants'; // Fallback
    let antagonist = 'nobility'; // Fallback
    let topic = "la fame";

    // ... (Tua logica di selezione attore/antagonista) ...

    // Prompt Migliorato per Realismo
    const actorName = getChatName(mainActor).split(" ")[0]; // Solo nome (es. Odric)
    const antagName = getChatName(antagonist).split(" ")[0]; // Solo nome (es. Lord Emeric)
    const actorTitle = factionLabel(mainActor);
    const antagTitle = factionLabel(antagonist);

    // Definisci la tensione della scena basata sui dati reali
    const tensionLevel = factions[mainActor] < 40 || factions[antagonist] < 40 ? "ALTA TENSIONE" : "DIBATTITO CIVILE";

    const prompt = `
    Sei il Regista della Sala del Trono.
    
    ATTORI:
    1. ${actorName} (${actorTitle}) - LealtÃ  verso il Conte: ${factions[mainActor]}/100.
    2. ${antagName} (${antagTitle}) - LealtÃ  verso il Conte: ${factions[antagonist]}/100.
    
    RELAZIONE TRA FAZIONI: ${COURT_RELATIONSHIPS[mainActor]?.enemies.includes(antagonist) ? 'NEMICI NATURALI' : 'NEUTRALI/ALLEATI'}.
    
    SITUAZIONE: ${tensionLevel}. Si discute di: "${topic}".
    
    COMPITO:
    Scrivi UNA breve scena (max 4 righe totali) di dialogo diretto.
    - Se sono NEMICI o la lealtÃ  Ã¨ bassa: Devono esserci frecciate, accuse o sarcasmo.
    - Se sono ALLEATI: Devono concordare o cercare una soluzione comune.
    - Il Conte Ã¨ presente ma ascolta in silenzio.
    
    FORMATO (Usa ESATTAMENTE questo):
    SCENA: [Una frase descrittiva dell'atmosfera, es. "Odric si fa avanti stringendo il cappello tra le mani..."]
    ${actorName}: "[Battuta coerente con la sua classe sociale]"
    ${antagName}: "[Risposta coerente con la sua classe sociale]"
    
    Non aggiungere saluti formali inutili. Vai dritto al conflitto/problema.
    `;

    callGroq(prompt, "debate");
}







function togglePanel(id) {
    const panel = document.getElementById(id);
    if (!panel) return;
    panel.classList.toggle("collapsed");
}

function refreshLawTargetOptions() {
    const typeSelect = document.getElementById("law-custom-type");
    const targetSelect = document.getElementById("law-custom-target");
    if (!typeSelect || !targetSelect) return;
    const type = typeSelect.value;
    const options = [];
    if (type === "production") {
        RESOURCE_KEYS.forEach(key => options.push({ value: key, label: resourceLabels[key] || key }));
    } else if (type === "taxes") {
        TAX_CATEGORIES.forEach(cat => options.push({ value: cat.key, label: cat.label }));
    } else {
        factionOrder.forEach(key => options.push({ value: key, label: factionLabel(key) }));
    }
    targetSelect.innerHTML = options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join("");
}

function setupLawCreator() {
    const typeSelect = document.getElementById("law-custom-type");
    if (!typeSelect) return;
    typeSelect.addEventListener("change", refreshLawTargetOptions);
    refreshLawTargetOptions();
}

function createCustomLaw() {
    const nameInput = document.getElementById("law-custom-name");
    const descInput = document.getElementById("law-custom-desc");
    const typeSelect = document.getElementById("law-custom-type");
    const targetSelect = document.getElementById("law-custom-target");
    const valueInput = document.getElementById("law-custom-value");
    if (!nameInput || !descInput || !typeSelect || !targetSelect || !valueInput) return;

    const name = nameInput.value.trim();
    const desc = descInput.value.trim() || "Senza descrizione";
    const type = typeSelect.value;
    const target = targetSelect.value;
    const rawValue = parseFloat(valueInput.value);

    if (!name || !target || Number.isNaN(rawValue)) {
        addMsg("system", "âš ï¸ Compila nome, valore e scegli un bersaglio per la legge.");
        return;
    }

    const effects = {};
    if (type === "production") {
        const multiplier = 1 + rawValue / 100;
        if (!effects.production) effects.production = {};
        effects.production[target] = multiplier;
    } else if (type === "taxes") {
        if (!effects.taxes) effects.taxes = {};
        effects.taxes[target] = rawValue;
    } else if (type === "factions") {
        if (!effects.factions) effects.factions = {};
        effects.factions[target] = rawValue;
    }

    const key = slugify(`${name}_${Date.now()}`);
    customLaws.push({ key: `custom_${key}`, name, description: desc, effects, custom:true });
    renderLawList();
    nameInput.value = "";
    descInput.value = "";
    valueInput.value = "";
}

function getFactionProductionMultiplier(resourceKey, targetState = null) {
    const map = RESOURCE_FACTION_MAP[resourceKey];
    if (!map) return 1;
    const factionsRef = targetState ? targetState.factions : factions;
    const mood = (factionsRef[map.faction] || 50) - 50;
    return Math.max(0.5, 1 + (mood / 100) * map.scale);
}

function getProductionMultiplier(resourceKey, targetState = null) {
    const season = getSeason(targetState ? targetState.worldTime : worldTime);
    let mult = 1;
    if (season.production && season.production[resourceKey]) {
        mult *= season.production[resourceKey];
    }
    getActiveLawKeys(targetState).forEach(key => {
        const law = getLawDefinition(key);
        if (law && law.effects && law.effects.production && law.effects.production[resourceKey]) {
            mult *= law.effects.production[resourceKey];
        }
    });
    mult *= getFactionProductionMultiplier(resourceKey, targetState);
    return mult;
}

function renderTaxGrid(force = false) {
    const grid = document.getElementById("tax-grid");
    if (!grid) return;
    if (force) {
        delete grid.dataset.rendered;
    }
    if (grid.dataset.rendered === "1") {
        syncTaxGridValues();
        return;
    }
    grid.innerHTML = "";
    TAX_CATEGORIES.forEach(cat => {
        const card = document.createElement("div");
        card.className = "tax-card";
        const label = document.createElement("label");
        label.innerHTML = `<span>${cat.label}</span><span id="tax-rate-${cat.key}">${taxPolicy[cat.key]}%</span>`;
        const input = document.createElement("input");
        input.type = "range";
        input.id = `tax-slider-${cat.key}`;
        input.min = 0;
        input.max = 30;
        input.step = 1;
        input.value = taxPolicy[cat.key];
        input.addEventListener("input", (ev) => setTaxRate(cat.key, Number(ev.target.value)));
        card.append(label, input);
        grid.appendChild(card);
    });
    grid.dataset.rendered = "1";
    updateTaxSummary();
}

function syncTaxGridValues() {
    TAX_CATEGORIES.forEach(cat => {
        const slider = document.getElementById(`tax-slider-${cat.key}`);
        if (slider) slider.value = taxPolicy[cat.key];
        const label = document.getElementById(`tax-rate-${cat.key}`);
        if (label) label.innerText = `${taxPolicy[cat.key]}%`;
    });
    updateTaxSummary();
}

function setTaxRate(key, value) {
    taxPolicy[key] = Number(value);
    const label = document.getElementById(`tax-rate-${key}`);
    if (label) label.innerText = `${value}%`;
    updateTaxSummary();
}

function getLawTaxModifier(categoryKey, targetState = null) {
    let delta = 0;
    getActiveLawKeys(targetState).forEach(key => {
        const law = getLawDefinition(key);
        if (law && law.effects && law.effects.taxes && law.effects.taxes[categoryKey]) {
            delta += law.effects.taxes[categoryKey];
        }
    });
    return delta;
}

function ensureTaxPolicy(targetState) {
    if (targetState) {
        if (!targetState.taxPolicy) targetState.taxPolicy = createDefaultTaxPolicy();
        return targetState.taxPolicy;
    }
    return taxPolicy;
}

function collectTaxes(targetState = null, options = {}) {
    const statePop = targetState ? targetState.populationGroups : populationGroups;
    const stateCounty = targetState ? targetState.county : county;
    const stateFactions = targetState ? targetState.factions : factions;
    const policy = ensureTaxPolicy(targetState);
    let total = 0;
    TAX_CATEGORIES.forEach(cat => {
    const pop = statePop[cat.key]?.count || 0;  // âœ… Prende il numero di persone
    const baseWealth = pop * cat.wealthFactor;  // âœ… Ora funziona!
        const lawDelta = getLawTaxModifier(cat.key, targetState);
        const effectivePercent = Math.max(0, (policy[cat.key] || 0) + lawDelta);
        const income = Math.floor(baseWealth * (effectivePercent / 100));
        total += income;

        // Distribuzione ricchezza privata
        const privateShare = {
            nobility: 0.7,
            merchants: 0.6,
            clergy: 0.5,
            militia: 0.3,
            burghers: 0.4,
            peasants: 0.1,
            mystics: 0.2,
            outcasts: 0.05
        }[cat.key] || 0.1;
        const privateIncome = Math.floor(income * privateShare);
        statePop[cat.key].privateGold = (statePop[cat.key].privateGold || 0) + privateIncome;

        const tolerance = cat.tolerance;
        if (effectivePercent > tolerance) {
            const penalty = Math.round((effectivePercent - tolerance) / 2);
            stateFactions[cat.key] = clamp((stateFactions[cat.key] || 50) - penalty);
        } else if (effectivePercent < tolerance - 3) {
            stateFactions[cat.key] = clamp((stateFactions[cat.key] || 50) + 1);
        }
    });
    total = Math.max(0, total);
    stateCounty.gold += total;
    if (!targetState) {
        recordTaxHistory(total);
        if (!options.silent) addMsg("system", `ðŸ’° Entrate fiscali: ${total} oro.`);
        updateTaxSummary();
    }
    return total;
}

function recordTaxHistory(amount) {
    taxHistory.push(amount);
    if (taxHistory.length > 8) taxHistory.shift();
}

function updateTaxSummary() {
    const lastEl = document.getElementById("tax-last");
    const trendEl = document.getElementById("tax-trend");
    const last = taxHistory[taxHistory.length - 1] || 0;
    const prev = taxHistory[taxHistory.length - 2] || last;
    if (lastEl) lastEl.innerText = last;
    if (trendEl) {
        if (taxHistory.length < 2 || last === prev) trendEl.innerText = "stabile";
        else trendEl.innerText = last > prev ? `â†‘ +${last - prev}` : `â†“ ${last - prev}`;
    }
}

function applySeasonalUpkeep(targetState = null, options = {}) {
    const timeRef = targetState ? targetState.worldTime : worldTime;
    const season = getSeason(timeRef);
    const stateCounty = targetState ? targetState.county : county;
    const popRef = targetState ? targetState.populationGroups : populationGroups;
    const militia = popRef.militia || 0;
    const upkeep = Math.floor(militia * 0.2 * season.warCost);
    if (!upkeep) return;
    stateCounty.gold = Math.max(0, stateCounty.gold - upkeep);
    if (!targetState && !options.silent) {
        addMsg("system", `ðŸ›¡ï¸ Costi stagionali delle truppe: -${upkeep} oro.`);
    }
}

function factionLabel(key) {
    return key.charAt(0).toUpperCase() + key.slice(1);
}

function getFactionEffectText(key, value) {
    const ref = FACTION_EFFECT_DESCRIPTIONS[key] || {};
    if (value >= 65) return ref.bonus || "Sono soddisfatti.";
    if (value <= 35) return ref.malus || "Sono inquieti.";
    return "Equilibrati.";
}

function getFactionChatLine(key, mood) {
    const ref = FACTION_EFFECT_DESCRIPTIONS[key] || {};
    if (mood >= 70) return ref.bonus || "Vi onoriamo, Conte.";
    if (mood <= 30) return ref.malus || "La nostra pazienza Ã¨ agli sgoccioli.";
    return "Attendiamo che le promesse diventino fatti.";
}

function handleFactionChipClick(key) {
    ensureWorldSystems();
    const mood = factions[key] || 50;
    const line = getFactionChatLine(key, mood);
    addMsg("ai", `<strong>${factionLabel(key)}</strong>: ${line}`);
}

function renderFactionChips() {
    const container = document.getElementById("chat-faction-chips");
    if (!container) return;
    container.innerHTML = "";
    factionOrder.forEach(key => {
        const btn = document.createElement("button");
        btn.className = "faction-chip";
        const mood = factions[key] || 50;
        if (mood <= 35) btn.classList.add("low");
        else if (mood >= 65) btn.classList.add("high");
        btn.innerText = factionLabel(key);
        btn.title = `LealtÃ : ${mood}`;
        btn.addEventListener("click", () => handleFactionChipClick(key));
        container.appendChild(btn);
    });
}

function updateFactionImpactUI(targetState = null) {
    const container = document.getElementById("faction-impact-list");
    if (!container) return;
    container.innerHTML = "";
    const factionsRef = targetState ? targetState.factions : factions;
    factionOrder.forEach(key => {
        const val = factionsRef[key] || 50;
        const card = document.createElement("div");
        card.className = "faction-effect-card";
        card.innerHTML = `<strong>${factionLabel(key)}</strong><div>Loyalty: ${val}</div><div>${getFactionEffectText(key, val)}</div>`;
        container.appendChild(card);
    });
}

/* ============================================================
   ============ MENU INIZIALE, SALVATAGGI E IMPOSTAZIONI ======
   ============================================================ */

function initStartScreen() {
    ensureWorldSystems();
    loadStoredApiKey();
    loadPersonalitySettings();
    renderSaveCollection("save-list", { closeOnLoad:true });
    renderSavePreview();
    updateSaveStatusFromStorage();
    activateScreen("screen-start");
}

function renderSavePreview() {
    const saves = getSaveSlots();
    const preview = document.getElementById("save-list-preview");
    if (!preview) return;
    
    if (saves.length === 0) {
        preview.innerHTML = '<div style="text-align:center; color:var(--text-soft); font-style:italic;">Nessun salvataggio disponibile</div>';
    } else {
        const latest = saves[saves.length - 1];
        preview.innerHTML = `
            <div style="font-size:0.9em;">
                <div style="color:var(--accent); font-weight:bold; margin-bottom:4px;">ðŸ“Œ Ultima partita:</div>
                <div>${latest.meta.label || 'Senza nome'}</div>
                <div style="font-size:0.8em; color:var(--text-soft); margin-top:4px;">
                    ${new Date(latest.timestamp).toLocaleDateString('it-IT')} â€¢ ${saves.length} salvataggi totali
                </div>
            </div>
        `;
    }
}

function activateScreen(id) {
    document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
    const target = document.getElementById(id);
    if (target) target.classList.add("active");
    if (id !== "screen-start") closeLoadModal();
}

function goToEditorScreen() {
    activateScreen("screen-editor");
    syncEditorDefaults();
}

function backToStart() {
    activateScreen("screen-start");
    initStartScreen();
}

function openLoginScreen() {
    syncApiKeyInputs(apiKey || safeStorageGet("conte_api_key") || "");
    activateScreen("screen-login");
}

function syncEditorDefaults() {
    const advSelect = document.getElementById("adv-pers");
    if (advSelect && personalitySettings && personalitySettings.advisorTone) {
        advSelect.value = personalitySettings.advisorTone;
    }
}

function saveApiKeyFromStart() {
    const startInput = document.getElementById("api-key-start");
    const key = startInput ? startInput.value.trim() : "";
    if (!key) {
        updateApiKeyStatus("Inserisci una chiave valida.", false);
        return;
    }
    setApiKey(key);
    updateApiKeyStatus("Chiave salvata in locale.");
}

function clearStoredApiKey() {
    apiKey = "";
    safeStorageRemove("conte_api_key");
    syncApiKeyInputs("");
    updateApiKeyStatus("Chiave rimossa.");
}

function setApiKey(key) {
    apiKey = key ? key.trim() : "";
    if (apiKey) safeStorageSet("conte_api_key", apiKey);
    syncApiKeyInputs(apiKey);
}

function ensureApiKey() {
    if (apiKey) return apiKey;
    const stored = safeStorageGet("conte_api_key");
    if (stored) {
        apiKey = stored;
        syncApiKeyInputs(apiKey);
        updateApiKeyStatus("Chiave caricata automaticamente.");
    }
    return apiKey;
}

function syncApiKeyInputs(value) {
    const loginInput = document.getElementById("api-key-input");
    const startInput = document.getElementById("api-key-start");
    if (loginInput) loginInput.value = value || "";
    if (startInput) startInput.value = value || "";
}

function updateApiKeyStatus(text, positive = true) {
    const status = document.getElementById("api-key-status");
    if (status) {
        status.innerText = text;
        status.style.color = positive ? "var(--text-soft)" : "#ff6b6b";
    }
}

function loadStoredApiKey() {
    const stored = safeStorageGet("conte_api_key");
    if (stored) {
        apiKey = stored;
        syncApiKeyInputs(apiKey);
        updateApiKeyStatus("Chiave ricordata.");
    }
}

function savePersonalitySettingsForm() {
    const toneInput = document.getElementById("personality-tone");
    const moodInput = document.getElementById("personality-mood");
    const notesInput = document.getElementById("personality-notes");
    personalitySettings = {
        advisorTone: (toneInput && toneInput.value) || DEFAULT_PERSONALITY.advisorTone,
        courtMood: (moodInput && moodInput.value) || DEFAULT_PERSONALITY.courtMood,
        notes: notesInput ? notesInput.value.trim() : ""
    };
    safeStorageSet("conte_personality_settings", JSON.stringify(personalitySettings));
}

function loadPersonalitySettings() {
    try {
        const raw = safeStorageGet("conte_personality_settings");
        if (raw) personalitySettings = JSON.parse(raw);
    } catch(e) {
        personalitySettings = { ...DEFAULT_PERSONALITY };
    }
    syncPersonalityForm(personalitySettings);
}

function syncPersonalityForm(settings) {
    const tone = document.getElementById("personality-tone");
    const mood = document.getElementById("personality-mood");
    const notes = document.getElementById("personality-notes");
    if (tone && settings && settings.advisorTone) tone.value = settings.advisorTone;
    if (mood && settings && settings.courtMood) mood.value = settings.courtMood;
    if (notes) notes.value = (settings && settings.notes) ? settings.notes : "";
}

function openLoadModal() {
    renderSaveCollection("modal-save-list", { showDelete:true });
    const modal = document.getElementById("load-modal");
    if (modal) modal.classList.add("active");
}

function closeLoadModal() {
    const modal = document.getElementById("load-modal");
    if (modal) modal.classList.remove("active");
}

function manualSaveFromModal() {
    const input = document.getElementById("save-slot-name");
    const name = input ? input.value.trim() : "";
    const slotKey = name ? slugify(name) : `manuale_${Date.now()}`;
    const label = name || "Salvataggio manuale";
    saveGame(slotKey, { label });
    if (input) input.value = "";
    renderSaveCollection("modal-save-list", { showDelete:true });
}

function quickSaveGame() {
    saveGame("quick", { label:"Salvataggio rapido", skipSlug:true });
}

function autoSaveGame() {
    saveGame("autosave", { label:"Autosave", silent:true, skipSlug:true });
}

function saveGame(slotKey = "manuale", options = {}) {
    const { label = slotKey, silent = false, skipSlug = false } = options;
    if (typeof localStorage === "undefined") return;

    let finalKey = slotKey || "slot";
    if (!skipSlug && !RESERVED_SAVE_SLOTS.includes(finalKey)) {
        finalKey = slugify(finalKey) || `slot_${Date.now()}`;
    }

    const payload = {
        meta: {
            slot: finalKey,
            label,
            timestamp: Date.now(),
            heroName,
            turn: county.turn
        },
        state: captureGameState()
    };

    safeStorageSet(`conte_save_${finalKey}`, JSON.stringify(payload));
    const statusText = `${label} â€“ Turno ${county.turn}`;
    safeStorageSet("conte_last_save_label", statusText);
    updateSaveStatus(statusText);
    updateSaveCollections();

    if (!silent) {
        addMsg("system", `ðŸ’¾ Salvataggio completato (${label}).`);
    }
}

function loadGame(slotKey) {
    if (!slotKey) return;
    const raw = safeStorageGet(`conte_save_${slotKey}`);
    if (!raw) {
        addMsg("system", "âŒ Salvataggio non trovato.");
        return;
    }

    try {
        const data = JSON.parse(raw);
        restoreGameState(data.state || data);
        updateUI();
        drawCountyMap();
        drawRegionMap();
        activateScreen("screen-game");
        refreshAllStats();
        triggerStartupNarrative(false);
        const loadedLabel = data.meta && data.meta.label ? data.meta.label : slotKey;
        addMsg("system", `ðŸ“‚ Caricata la partita ${loadedLabel} (Turno ${county.turn}).`);
        closeLoadModal();
        updateSaveCollections();
    } catch(e) {
        addMsg("system", "âš ï¸ Impossibile caricare il salvataggio.");
    }
}

function deleteSave(slotKey) {
    safeStorageRemove(`conte_save_${slotKey}`);
    updateSaveCollections();
}

function updateSaveCollections() {
    renderSaveCollection("save-list", { closeOnLoad:true });
    const loadModal = document.getElementById("load-modal");
    if (loadModal && loadModal.classList.contains("active")) {
        renderSaveCollection("modal-save-list", { showDelete:true });
    }
}

function renderSaveCollection(containerId, options = {}) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const slots = getSaveSlots();

    if (!slots.length) {
        container.innerHTML = '<p class="save-empty">Nessun salvataggio disponibile.</p>';
        return;
    }

    container.innerHTML = "";
    slots.forEach(slot => {
        const row = document.createElement("div");
        row.className = "save-entry";

        const details = document.createElement("div");
        details.className = "save-entry-details";
        const title = document.createElement("strong");
        title.innerText = slot.meta.label || slot.slot;
        const subtitle = document.createElement("span");
        subtitle.innerText = `${slot.meta.heroName || "Conte"} â€” Turno ${slot.meta.turn || 1}`;
        const time = document.createElement("small");
        time.innerText = new Date(slot.meta.timestamp || Date.now()).toLocaleString("it-IT");
        details.append(title, subtitle, time);

        const actions = document.createElement("div");
        actions.className = "save-entry-actions";
        const loadBtn = document.createElement("button");
        loadBtn.className = "btn-sec";
        loadBtn.innerText = "Carica";
        loadBtn.addEventListener("click", () => loadGame(slot.slot));
        actions.appendChild(loadBtn);

        if (options.showDelete) {
            const delBtn = document.createElement("button");
            delBtn.className = "btn-sec";
            delBtn.innerText = "Elimina";
            delBtn.addEventListener("click", () => {
                if (confirm(`Eliminare ${slot.meta.label || slot.slot}?`)) {
                    deleteSave(slot.slot);
                    renderSaveCollection(containerId, options);
                }
            });
            actions.appendChild(delBtn);
        }

        row.append(details, actions);
        container.appendChild(row);
    });
}

function getSaveSlots() {
    if (typeof localStorage === "undefined") return [];
    const slots = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key || !key.startsWith("conte_save_")) continue;
        try {
            const payload = JSON.parse(localStorage.getItem(key));
            slots.push({
                slot: key.replace("conte_save_", ""),
                meta: payload.meta || { timestamp: Date.now(), label: key }
            });
        } catch(e) {
            continue;
        }
    }
    return slots.sort((a,b) => (b.meta.timestamp || 0) - (a.meta.timestamp || 0));
}

function captureGameState() {
    ensureWorldSystems();
    const snapshot = JSON.parse(JSON.stringify({
        heroName,
        advisor,
        county,
        landOwnership,
        populationGroups,
        factions,
        neighboringCounties,
        structures,
        buildings,
        settlements,
        worldMap,
        privateChats,
        publicChatHistory,
        personalitySettings,
        worldTime,
        taxPolicy,
        taxHistory,
        activeLaws,
        lastResourceSnapshot,
        lastResourceDelta,
        industrySummary,
        customLaws,
        dynasty
    }));
    snapshot.county.resources = normalizeResourceBag(snapshot.county.resources);
    return snapshot;
}

function restoreGameState(state) {
    county = state.county ? JSON.parse(JSON.stringify(state.county)) : createDefaultCounty();
    const sourceResources = (state.county && state.county.resources) ? state.county.resources : {};
    county.resources = normalizeResourceBag(sourceResources);
    landOwnership = state.landOwnership ? JSON.parse(JSON.stringify(state.landOwnership)) : createDefaultLand();
    populationGroups = state.populationGroups ? JSON.parse(JSON.stringify(state.populationGroups)) : createDefaultPopulation();
    // Migra vecchi salvataggi alla nuova struttura
    populationGroups = migratePopulationGroups(populationGroups);
    factions = state.factions ? JSON.parse(JSON.stringify(state.factions)) : createDefaultFactions();
    neighboringCounties = state.neighboringCounties ? JSON.parse(JSON.stringify(state.neighboringCounties)) : createDefaultNeighbors();
    structures = state.structures ? JSON.parse(JSON.stringify(state.structures)) : createEmptyStructures();
    buildings = state.buildings ? JSON.parse(JSON.stringify(state.buildings)) : [];
    settlements = state.settlements ? JSON.parse(JSON.stringify(state.settlements)) : [];
    worldMap = state.worldMap ? JSON.parse(JSON.stringify(state.worldMap)) : worldMap;
    privateChats = state.privateChats ? JSON.parse(JSON.stringify(state.privateChats)) : createDefaultPrivateChats();
    personalitySettings = state.personalitySettings || personalitySettings;
    heroName = state.heroName || heroName;
    worldTime = state.worldTime ? JSON.parse(JSON.stringify(state.worldTime)) : createDefaultWorldTime();
    taxPolicy = state.taxPolicy ? JSON.parse(JSON.stringify(state.taxPolicy)) : createDefaultTaxPolicy();
    taxHistory = Array.isArray(state.taxHistory) ? [...state.taxHistory] : [];
    activeLaws = Array.isArray(state.activeLaws) ? [...state.activeLaws] : [];
    lastResourceSnapshot = state.lastResourceSnapshot ? JSON.parse(JSON.stringify(state.lastResourceSnapshot)) : captureResourceSnapshot();
    lastResourceDelta = state.lastResourceDelta ? JSON.parse(JSON.stringify(state.lastResourceDelta)) : createEmptyResourceDelta();
    industrySummary = state.industrySummary ? JSON.parse(JSON.stringify(state.industrySummary)) : null;
    customLaws = Array.isArray(state.customLaws) ? JSON.parse(JSON.stringify(state.customLaws)) : [];
    publicChatHistory = state.publicChatHistory || [];
    dynasty = state.dynasty ? JSON.parse(JSON.stringify(state.dynasty)) : dynasty;
    
    // Aggiorna UI dinastia al caricamento
    updateDynastyUI();
    
    ensureWorldSystems();
    recomputePopulation();
}

function normalizeResourceBag(source = {}) {
    const bag = {};
    RESOURCE_KEYS.forEach(key => bag[key] = Number(source[key] ?? 0));
    return bag;
}

function cloneResourceBag(source = {}) {
    return JSON.parse(JSON.stringify(normalizeResourceBag(source)));
}

function createEmptyResourceDelta() {
    const bag = {};
    RESOURCE_KEYS.forEach(key => bag[key] = 0);
    return bag;
}

function createEmptyResourceBag() {
    return createEmptyResourceDelta();
}

// Magazzino privato del governatore
let governorStorage = null;
function getGovernorStorage() {
    if (!governorStorage) governorStorage = createEmptyResourceBag();
    return governorStorage;
}

function migratePopulationGroups(groups) {
    const defaultGroups = createDefaultPopulation();
    
    // Se Ã¨ giÃ  nella nuova struttura, restituisci come Ã¨
    if (groups.nobility && typeof groups.nobility === 'object' && 'count' in groups.nobility) {
        return groups;
    }
    
    // Altrimenti, migra dalla vecchia struttura
    const migrated = {};
    Object.keys(defaultGroups).forEach(key => {
        if (typeof groups[key] === 'number') {
            // Vecchio formato: nobility: 25
            migrated[key] = {
                count: groups[key],
                wealth: defaultGroups[key].wealth,
                resources: createEmptyResourceBag()
            };
        } else if (groups[key] && typeof groups[key] === 'object') {
            // Nuovo formato o parzialmente migrato
            migrated[key] = {
                count: groups[key].count || defaultGroups[key].count,
                wealth: groups[key].wealth || defaultGroups[key].wealth,
                resources: groups[key].resources || createEmptyResourceBag()
            };
        } else {
            // Usa default
            migrated[key] = defaultGroups[key];
        }
    });
    
    return migrated;
}

function captureResourceSnapshot(targetState = null) {
    if (targetState && targetState.county && targetState.county.resources) {
        return cloneResourceBag(targetState.county.resources);
    }
    if (county && county.resources) return cloneResourceBag(county.resources);
    return createEmptyResourceDelta();
}

function computeResourceDelta(startSnapshot, endSnapshot) {
    const delta = {};
    RESOURCE_KEYS.forEach(key => {
        const startVal = startSnapshot && startSnapshot[key] !== undefined ? startSnapshot[key] : 0;
        const endVal = endSnapshot && endSnapshot[key] !== undefined ? endSnapshot[key] : 0;
        delta[key] = endVal - startVal;
    });
    return delta;
}

function resetResourceTracking(targetState = null) {
    if (targetState) {
        targetState.lastResourceSnapshot = captureResourceSnapshot(targetState);
        targetState.lastResourceDelta = createEmptyResourceDelta();
        return;
    }
    lastResourceSnapshot = captureResourceSnapshot();
    lastResourceDelta = createEmptyResourceDelta();
}

function resetGameState() {
    county = createDefaultCounty();
    landOwnership = createDefaultLand();
    populationGroups = createDefaultPopulation();
    factions = createDefaultFactions();
    neighboringCounties = createDefaultNeighbors();
    
    // Resetta le strutture della mappa (rimangono vuote perchÃ© autogenerateStructures Ã¨ vuota)
    structures = createEmptyStructures();
    
    // === EDIFICI INIZIALI (Starter Kit) ===
    // Solo questi appariranno nella Sintesi Insediamenti all'inizio
    buildings = [
        // Cibo
        { id: "start_farm_1", type: "wheat_farm", x: 0, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal", currentStaff: 10, currentEfficiency: 1 },
        { id: "start_farm_2", type: "wheat_farm", x: 1, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal", currentStaff: 10, currentEfficiency: 1 },
        { id: "start_sheep", type: "sheep_farm", x: 0, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal", currentStaff: 8, currentEfficiency: 1 },
        
        // Abitazioni (Per coprire i ~220 pop iniziali)
        { id: "start_house_1", type: "cottage", x: 2, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_2", type: "cottage", x: 2, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_3", type: "cottage", x: 3, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_tenement", type: "tenement", x: 1, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" }, // Palazzina
        // Cottage aggiuntivi per raggiungere 220 capacitÃ 
        { id: "start_house_4", type: "cottage", x: 4, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_5", type: "cottage", x: 4, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_6", type: "cottage", x: 5, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_7", type: "cottage", x: 5, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_8", type: "cottage", x: 6, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_9", type: "cottage", x: 6, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_10", type: "cottage", x: 7, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_11", type: "cottage", x: 7, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_12", type: "cottage", x: 8, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_13", type: "cottage", x: 8, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_14", type: "cottage", x: 9, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_15", type: "cottage", x: 9, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_16", type: "cottage", x: 10, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_17", type: "cottage", x: 10, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_18", type: "cottage", x: 11, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_19", type: "cottage", x: 11, y: 1, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_house_20", type: "cottage", x: 12, y: 0, owner: "count", stage: "complete", condition: 100, priority: "normal" },

        // Servizi
        { id: "start_well", type: "village_well", x: 1, y: 2, owner: "count", stage: "complete", condition: 100, priority: "normal" },
        { id: "start_market", type: "market", x: 2, y: 2, owner: "count", stage: "complete", condition: 100, priority: "normal" }
    ];
    // ====================================
    
    settlements = [];
    worldMap.tiles = [];
    privateChats = createDefaultPrivateChats();
    publicChatHistory = []; 
    lastNeedsReport = {}; 
    activePrivateChat = null;
    county.turn = 1;
    worldTime = createDefaultWorldTime();
    taxPolicy = createDefaultTaxPolicy();
    taxHistory = [];
    activeLaws = [];
    
    // Reset Dinastia
    dynasty = {
        ruler: {
            name: "Conte", 
            age: 25,
            maxAge: 75 + Math.floor(Math.random() * 15), 
            health: 100,
            traits: ["Fondatore"],
            isDead: false
        },
        spouse: null, 
        heirs: []     
    };

    // Generazione Mondo
    generateWorldMap();
    generateSettlements();
    autogenerateStructures(); // Ora questa non aggiunge nulla!

    resetResourceTracking();
    ensureWorldSystems();
    clearInterfaceLogs();
}

function updateSaveStatus(text) {
    const el = document.getElementById("save-status");
    if (el) el.innerText = text || "Nessun salvataggio registrato.";
}

function updateSaveStatusFromStorage() {
    const stored = safeStorageGet("conte_last_save_label");
    if (stored) updateSaveStatus(stored);
}

function slugify(str) {
    return str.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}

function safeStorageGet(key) {
    try { return localStorage.getItem(key); } catch(e) { return null; }
}

function safeStorageSet(key, value) {
    try { localStorage.setItem(key, value); } catch(e) {}
}

function safeStorageRemove(key) {
    try { localStorage.removeItem(key); } catch(e) {}
}

/* ============================================================
   =================== GENERAZIONE MAPPA =======================
   ============================================================ */

let worldMap = {
    width: 20,
    height: 20,
    tiles: []
};

let settlements = [];

/* ---- FUNZIONE PRINCIPALE ---- */
function generateWorldMap() {
    worldMap.tiles = [];

    for (let y = 0; y < worldMap.height; y++) {
        for (let x = 0; x < worldMap.width; x++) {

            const terrain = randomTerrain();
            const fertility = baseFertility(terrain) + rand(-10,10);
            const resources = generateResources(terrain);
            const owner = assignOwner(x, y);

            worldMap.tiles.push({
                x, y,
                terrain,
                fertility: clamp(fertility),
                resources,
                owner
            });
        }
    }
}

function getTile(x, y) {
    if (x < 0 || y < 0 || x >= worldMap.width || y >= worldMap.height) return null;
    return worldMap.tiles[y * worldMap.width + x];
}

/* ---- TIPO DI TERRENO ---- */
function randomTerrain() {
    const r = Math.random();
    if (r < 0.30) return "plains";
    if (r < 0.50) return "forest";
    if (r < 0.70) return "hills";
    if (r < 0.82) return "mountain";
    if (r < 0.92) return "swamp";
    return "lake";
}

/* ---- FERTILITÃ€ BASE ---- */
function baseFertility(t) {
    switch(t){
        case "plains": return 70;
        case "forest": return 50;
        case "hills": return 40;
        case "mountain": return 20;
        case "swamp": return 25;
        case "lake": return 60;
    }
}

/* ---- GENERAZIONE RISORSE ---- */
function generateResources(terrain) {
    let r = {
        wood:0, stone:0, iron:0, copper:0, gold:0, herbs:0,
        gems:0, silver:0, mystic_crystals:0
    };

    if (terrain === "forest") r.wood = rand(50,100);
    if (terrain === "hills") { r.stone = rand(40,80); r.copper = rand(20,50); }
    if (terrain === "mountain") { r.iron = rand(40,100); }

    if (terrain === "swamp") r.herbs = rand(30,60);

    // RARI
    if (Math.random() < 0.03) r.gold = rand(10,30);
    if (Math.random() < 0.03) r.gems = rand(5,20);
    if (Math.random() < 0.03) r.silver = rand(10,30);
    if (Math.random() < 0.02) r.mystic_crystals = rand(5,15);

    return r;
}

/* ---- ASSEGNAZIONE TERRITORIO ---- */
function assignOwner(x, y) {
    if (x > 7 && x < 12 && y > 7 && y < 12) return "count";
    if (y < 4) return "auvrey";
    if (x > 13 && y > 13) return "falken";

    const r = Math.random();
    if (r < 0.33) return "nobility";
    if (r < 0.66) return "clergy";
    return "commons";
}

function generateSettlements() {
    settlements = worldMap.tiles
        .filter(t => t.owner === "count" && t.fertility > 50)
        .sort(() => 0.5 - Math.random())
        .slice(0, 10)
        .map(t => ({ x: t.x, y: t.y }));
}

function assignInitialStructures() {
    updateIndustrySummary();
}

/* ---- UTILS ---- */
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function clamp(v){ return Math.max(0, Math.min(100,v)); }

function createEmptyStructures() {
    return {
        mines: [],
        sawmills: [],
        quarries: [],
        monasteries: []
    };
}

let structures = createEmptyStructures();
let latestAssetFlows = null;

/* ---- GENERAZIONE AUTOMATICA ---- */
function autogenerateStructures() {
    // Abbiamo rimosso la generazione automatica di miniere, segherie, ecc.
    // Ora la mappa contiene solo il terreno naturale.
    // Le strutture devono essere costruite dal giocatore.
    
    // Lasciamo solo l'aggiornamento iniziale dei totali
    updateIndustrySummary();
}

/* ============================================================
   =================== EDIFICI AVANZATI ========================
   ============================================================ */

let buildings = [];  // Lista edifici in costruzione

let laborEfficiency = {}; // Mappa globale efficienza per tipo edificio

const buildingData = {
    // --- MATERIE PRIME (Tier 1) ---
    wheat_farm: {
        name: "Fattoria di Grano",
        desc: "Coltiva il grano base per il pane. Essenziale per non morire di fame.",
        cost: { gold: 50, wood: 20 },
        time: 3,
        upkeep: 2, // Costo oro per turno
        staff: { type: 'peasants', amount: 10 },
        recipe: { output: { grain: 25 } } // Produce 25 Grano
    },
    sheep_farm: {
        name: "Allevamento Ovini",
        desc: "Produce lana per i vestiti e un po' di carne.",
        cost: { gold: 60, wood: 30 },
        time: 3,
        upkeep: 3,
        staff: { type: 'peasants', amount: 8 },
        recipe: { output: { wool: 15, livestock: 2 } }
    },
    iron_mine: {
        name: "Miniera di Ferro",
        desc: "Estrae ferro grezzo. Richiede molto legno per puntellare i tunnel.",
        cost: { gold: 140, wood: 40, stone: 80 },
        time: 6,
        upkeep: 10,
        resourceUpkeep: { wood: 2 }, // CONSUMA LEGNO OGNI TURNO PER FUNZIONARE
        staff: { type: 'peasants', amount: 15 },
        recipe: { output: { iron: 12 } }
    },
    stone_quarry: {
        name: "Cava di Pietra",
        desc: "Taglia blocchi di pietra per le costruzioni avanzate.",
        cost: { gold: 85, wood: 40 },
        time: 5,
        upkeep: 5,
        resourceUpkeep: { iron: 1 }, // Consuma attrezzi (ferro)
        staff: { type: 'peasants', amount: 12 },
        recipe: { output: { stone: 10 } }
    },
    sawmill: {
        name: "Segheria",
        desc: "Taglia i tronchi delle foreste circostanti.",
        cost: { gold: 90, stone: 30 },
        time: 4,
        upkeep: 4,
        staff: { type: 'peasants', amount: 10 },
        recipe: { output: { wood: 15 } }
    },

    // --- TRASFORMAZIONE (Tier 2) ---
    mill: {
        name: "Mulino a Vento",
        desc: "Converte il Grano in Farina. Senza di questo il pane non si fa.",
        cost: { gold: 100, wood: 50, stone: 20 },
        time: 4,
        upkeep: 5,
        staff: { type: 'peasants', amount: 5 },
        recipe: { input: { grain: 10 }, output: { flour: 12 } }
    },
    weaver: {
        name: "Filanda",
        desc: "Trasforma la Lana grezza in Tessuti utilizzabili.",
        cost: { gold: 150, wood: 60 },
        time: 5,
        upkeep: 8,
        staff: { type: 'burghers', amount: 8 },
        recipe: { input: { wool: 8 }, output: { fabric: 8 } }
    },
    forge: {
        name: "Forgia",
        desc: "Fonde il Ferro grezzo in Lingotti e Armi.",
        cost: { gold: 200, wood: 80, stone: 120 },
        time: 5,
        upkeep: 12,
        resourceUpkeep: { wood: 5 }, // Carbone per il fuoco
        staff: { type: 'burghers', amount: 6 },
        recipe: { input: { iron: 6 }, output: { iron_ingots: 5, weapons: 1 } }
    },

    // --- PRODOTTI FINITI (Tier 3) ---
    bakery: {
        name: "Forno Comunale",
        desc: "Usa Farina e Legna per sfornare Pane per la popolazione.",
        cost: { gold: 80, stone: 40 },
        time: 3,
        upkeep: 5,
        staff: { type: 'burghers', amount: 4 },
        recipe: { input: { flour: 5, wood: 2 }, output: { bread: 20 } }
    },
    tailor: {
        name: "Sartoria",
        desc: "Crea Vestiti dai Tessuti. Aumenta felicitÃ  e salute in inverno.",
        cost: { gold: 200, wood: 50 },
        time: 6,
        upkeep: 10,
        staff: { type: 'burghers', amount: 5 },
        recipe: { input: { fabric: 4 }, output: { clothes: 5 } }
    },

    // --- SERVIZI E SPECIALI ---
    market: {
        name: "Mercato",
        desc: "Genera Oro passivo basato sulla popolazione.",
        cost: { gold: 100, wood: 50 },
        time: 3,
        upkeep: 5, // Tasse di gestione
        staff: { type: 'merchants', amount: 5 },
        recipe: { output: { gold: 15 } } // Genera oro direttamente
    },
    barracks: {
        name: "Caserma",
        desc: "Ospita soldati. Consuma Cibo e Ferro per mantenere la Sicurezza.",
        cost: { gold: 120, stone: 70 },
        time: 5,
        upkeep: 20,
        resourceUpkeep: { bread: 5, weapons: 1 }, // Mantenimento truppe
        staff: { type: 'militia', amount: 10 },
        effect: "Sicurezza ++"
    },
    church: {
        name: "Chiesa",
        desc: "Produce Fede (Erbe/Arcano) e FelicitÃ , consuma Candele (Lana/Grasso).",
        cost: { gold: 250, stone: 150 },
        time: 6,
        upkeep: 10,
        staff: { type: 'clergy', amount: 5 },
        recipe: { input: { gold: 5 }, output: { herbs: 3, happy: 2 } } // Le offerte generano benefici
    },
    cottage: {
        name: "Cottage",
        desc: "Aumenta la capacitÃ  abitativa (+10 pop).",
        housing: 10,
        housingClass: 'peasants',
        cost: { gold: 30, wood: 20 },
        time: 2,
        upkeep: 1,
        effect: "Popolazione Max +"
    },
    tenement: {
        name: "Palazzina",
        desc: "Abitazione piÃ¹ grande per famiglie contadine.",
        housing: 20,
        housingClass: 'peasants',
        cost: { gold: 60, wood: 40 },
        time: 3,
        upkeep: 2,
        effect: "Popolazione Max +"
    },
    townhouse: {
        name: "Casa Cittadina",
        desc: "Abitazione confortevole per artigiani e mercanti.",
        housing: 15,
        housingClass: 'burghers',
        cost: { gold: 150, wood: 80, stone: 50 },
        time: 5,
        upkeep: 5,
        effect: "Popolazione Max +"
    },
    manor: {
        name: "Maniero",
        desc: "Residenza signorile per la nobiltÃ .",
        housing: 10,
        housingClass: 'nobility',
        cost: { gold: 400, wood: 200, stone: 150 },
        time: 8,
        upkeep: 15,
        effect: "Popolazione Max +"
    },
    // Edifici privati per fazioni
    private_manor: {
        name: "Maniero Privato",
        desc: "Residenza privata costruita dalla nobiltÃ  con risorse proprie.",
        housing: 8,
        housingClass: 'nobility',
        owner: 'nobility',
        cost: { gold: 300, wood: 150, stone: 100 },
        time: 6,
        upkeep: 10,
        effect: "Popolazione Max + (Privato)"
    },
    private_shop: {
        name: "Negozio Privato",
        desc: "Bottega commerciale costruita dai mercanti con risorse proprie.",
        housing: 5,
        housingClass: 'merchants',
        owner: 'merchants',
        cost: { gold: 200, wood: 50, stone: 30 },
        time: 4,
        upkeep: 5,
        effect: "Ricchezza Mercantile + (Privato)"
    }
};

const STRUCTURE_UPKEEP = { structures: 0, military: 0 };

function calculateSeasonalBudget() {
    // Simulazione accurata del bilancio stagionale usando lo stato attuale
    // Questo calcolo riflette esattamente ciÃ² che accadrÃ  in progressSeason()
    
    // === ENTRATE ===
    const income = {
        taxes_nobility: 0,
        taxes_burghers: 0,
        taxes_peasants: 0,
        taxes_other: 0,
        trade_export: 0,
        production_mint: 0
    };
    
    // Calcolo Tasse (basato sulla ricchezza reale dei pop)
    TAX_CATEGORIES.forEach(cat => {
        const popGroup = populationGroups[cat.key];
        if (!popGroup) return;
        
        const pop = popGroup.count || 0;
        const wealth = popGroup.wealth || 0;
        const baseTaxable = Math.min(wealth, pop * cat.wealthFactor);
        const percent = taxPolicy[cat.key] || 0;
        const taxIncome = Math.floor(baseTaxable * (percent / 100));
        
        if (cat.key === 'nobility') income.taxes_nobility += taxIncome;
        else if (cat.key === 'burghers') income.taxes_burghers += taxIncome;
        else if (cat.key === 'peasants') income.taxes_peasants += taxIncome;
        else income.taxes_other += taxIncome;
    });
    
    // Commercio (approssimazione basata su vendite recenti)
    income.trade_export = Math.floor(seasonalTransactions.marketSales || 0);
    
    // Zecca
    const mints = buildings.filter(b => b.type === 'mint' && b.stage === 'complete').length;
    income.production_mint = mints * 50;
    
    const totalIncome = Object.values(income).reduce((a, b) => a + b, 0);
    
    // === SPESE ===
    const upkeep = calculateDetailedUpkeep();
    
    // Costo Leggi Attive
    let lawCostGold = 0;
    activeLaws.forEach(lawKey => {
        const law = getLawDefinition(lawKey);
        if (law && law.upkeepCost) lawCostGold += law.upkeepCost;
    });
    
    // Stipendi Milizia (pagati dalla contea)
    const militiaWages = Math.floor((populationGroups.militia?.count || 0) * 1.2);
    
    // Upkeep Edifici
    let upkeepBuildings = 0;
    buildings.filter(b => b.stage === 'complete').forEach(b => {
        const data = buildingData[b.type];
        if (data && data.upkeep) upkeepBuildings += data.upkeep;
    });
    
    const expenses = {
        upkeep_military: upkeep.military + militiaWages,
        upkeep_civil: upkeep.civil,
        upkeep_court: upkeep.court,
        upkeep_infrastructure: upkeep.infrastructure,
        upkeep_buildings: upkeepBuildings,
        welfare_laws: lawCostGold,
        import_costs: Math.floor(seasonalTransactions.marketPurchases || 0)
    };
    
    const totalExpense = Object.values(expenses).reduce((a, b) => a + b, 0);
    const net = totalIncome - totalExpense;
    
    return {
        income,
        expenses,
        net: Number.isFinite(net) ? net : 0
    };
}

function buildingName(type){
    return buildingData[type].name;
}

function calculateLaborAndEducation() {
    // 1. Reset Occupazione
    Object.keys(populationGroups).forEach(k => populationGroups[k].employed = 0);
    
    // 2. Calcolo Forza Lavoro Totale Disponibile
    const availableLabor = {};
    Object.keys(populationGroups).forEach(k => {
        availableLabor[k] = Math.floor(populationGroups[k].count * (populationGroups[k].workforceRatio || 0.6));
    });

    // 3. Creazione lista posti di lavoro UNIFICATA (Stessa logica della UI)
    let activeWorkplaces = [];

    // A. Edifici
    buildings.filter(b => b.stage === 'complete').forEach(b => activeWorkplaces.push(b));

    // B. Strutture (Usiamo i tipi mappati per accedere a buildingData)
    // Assegniamo 'realType' al volo se manca, per coerenza con la UI
    structures.mines.forEach(s => { s.realType = 'iron_mine'; activeWorkplaces.push(s); });
    structures.sawmills.forEach(s => { s.realType = 'sawmill'; activeWorkplaces.push(s); });
    structures.quarries.forEach(s => { s.realType = 'stone_quarry'; activeWorkplaces.push(s); });
    structures.monasteries.forEach(s => { s.realType = 'monastery'; activeWorkplaces.push(s); });

    // --- ORDINAMENTO PER PRIORITÃ€ ---
    const priorityValue = { 'high': 2, 'normal': 1, 'low': 0 };
    
    activeWorkplaces.sort((a, b) => {
        const pA = priorityValue[a.priority || 'normal'];
        const pB = priorityValue[b.priority || 'normal'];
        return pB - pA; // Ordine decrescente (Alta prima)
    });

    // 4. Assegnazione
    activeWorkplaces.forEach(building => {
        // Usa realType se esiste (strutture), altrimenti type (edifici)
        const typeKey = building.realType || building.type;
        const data = buildingData[typeKey];
        
        // Se prioritÃ  Ã¨ 'low', spegni
        if (building.priority === 'low') {
            building.currentEfficiency = 0;
            building.currentStaff = 0;
            building.requiredStaff = data && data.staff ? data.staff.amount : 0;
            return;
        }

        // Se non ci sono dati o staff richiesto, efficienza 100% (o gestita altrove)
        if (!data || !data.staff) {
            building.currentEfficiency = 1.0;
            return;
        }

        const workerType = data.staff.type;
        const required = data.staff.amount;
        const minLit = data.minLiteracy || 0;

        // Preleviamo lavoratori
        let hired = 0;
        if (availableLabor[workerType] >= required) {
            hired = required;
            availableLabor[workerType] -= required;
        } else {
            hired = availableLabor[workerType]; 
            availableLabor[workerType] = 0;
        }

        // Salvataggio dati sull'istanza
        building.currentStaff = hired;
        building.requiredStaff = required;

        populationGroups[workerType].employed += hired;

        // Calcolo Efficienza
        let efficiency = required > 0 ? hired / required : 0;

        // Malus Istruzione
        const currentLiteracy = populationGroups[workerType].literacy || 0;
        if (currentLiteracy < minLit) {
            const literacyPenalty = (minLit - currentLiteracy) * 0.015;
            efficiency = Math.max(0.1, efficiency - literacyPenalty);
        }

        building.currentEfficiency = efficiency;
    });
    
    // 4. Gestione Istruzione (Scolarizzazione)
    const schools = buildings.filter(b => b.type === 'school' && b.stage === 'complete');
    // Efficienza scuole dipende se hanno insegnanti (Clero)
    let educationPower = 0;
    schools.forEach(s => educationPower += (s.currentEfficiency || 0) * 2); // Ogni scuola dÃ  +2 punti crescita max

    // Crescita graduale alfabetizzazione
    Object.keys(populationGroups).forEach(k => {
        const group = populationGroups[k];
        // Target naturale basato sulla classe + bonus scuole
        let targetLiteracy = 0;
        if(k === 'nobility') targetLiteracy = 90;
        else if(k === 'clergy') targetLiteracy = 95;
        else if(k === 'burghers') targetLiteracy = 50 + (educationPower * 5);
        else if(k === 'peasants') targetLiteracy = 5 + (educationPower * 3);
        
        // Avvicinamento lento al target
        if (group.literacy < targetLiteracy) {
            group.literacy += 0.5; // Crescita lenta
        }
    });

    // 5. MobilitÃ  Sociale basata su Salari/Lavoro
    // Se ci sono posti di lavoro qualificati (Burghers) liberi e Contadini istruiti -> Promozione
    // Eseguiamo solo se c'Ã¨ richiesta non soddisfatta
    const burgherDemand = activeWorkplaces
        .filter(b => buildingData[(b.realType || b.type)]?.staff?.type === 'burghers')
        .reduce((acc, b) => acc + buildingData[(b.realType || b.type)].staff.amount, 0);
    
    const burghersAvailable = Math.floor(populationGroups.burghers.count * 0.8);
    
    if (burgherDemand > burghersAvailable && populationGroups.peasants.literacy > 20) {
        // Promozione sociale
        const promoted = Math.min(10, Math.floor(populationGroups.peasants.count * 0.01));
        populationGroups.peasants.count -= promoted;
        populationGroups.burghers.count += promoted;
        if(promoted > 0) logTurnEvent(`${promoted} contadini istruiti sono diventati artigiani per coprire la domanda di lavoro.`);
    }
}

function processProductionChains(targetState = null) {
    const stateRef = targetState ? targetState.county : county;
    const resourceBag = stateRef.resources;
    const report = { produced: {}, consumed: {}, shortages: [] };

    // Ordine logico: Prima estrazione -> Poi trasformazione -> Poi prodotti finiti
    const productionPriority = [
        ['wheat_farm', 'sheep_farm', 'iron_mine', 'stone_quarry', 'sawmill'], // Tier 1
        ['mill', 'weaver', 'forge'], // Tier 2
        ['bakery', 'tailor', 'church', 'market', 'barracks'] // Tier 3
    ];

    const buildingsList = buildings.filter(b => b.stage === 'complete');

    productionPriority.forEach(group => {
        buildingsList.filter(b => group.includes(b.type)).forEach(building => {
            const data = buildingData[building.type];
            if (!data) return;

            let efficiency = building.currentEfficiency || 1.0; // 1.0 se non calcolato diversamente
            
            // 1. CONTROLLO MANTENIMENTO RISORSE (Resource Upkeep)
            // Se l'edificio richiede risorse per funzionare (es. Legno per Miniera)
            if (data.resourceUpkeep) {
                for (const [res, amt] of Object.entries(data.resourceUpkeep)) {
                    if ((resourceBag[res] || 0) < amt) {
                        efficiency = 0; // L'edificio si ferma!
                        if (!report.shortages.includes(res)) report.shortages.push(res);
                    } else {
                        resourceBag[res] -= amt; // Consuma risorsa mantenimento
                        report.consumed[res] = (report.consumed[res] || 0) + amt;
                    }
                }
            }

            if (efficiency <= 0) return; // Edificio fermo

            // 2. GESTIONE RICETTA (Recipe)
            if (data.recipe) {
                // A. Consumo Input (es. Grano -> Farina)
                if (data.recipe.input) {
                    for (const [res, amt] of Object.entries(data.recipe.input)) {
                        const needed = Math.floor(amt * efficiency);
                        if ((resourceBag[res] || 0) < needed) {
                            efficiency = 0; // Manca materia prima
                            if (!report.shortages.includes(res)) report.shortages.push(res);
                        } 
                    }
                    
                    // Se abbiamo tutto, consumiamo
                    if (efficiency > 0) {
                        for (const [res, amt] of Object.entries(data.recipe.input)) {
                            const realCost = Math.floor(amt * efficiency);
                            resourceBag[res] -= realCost;
                            report.consumed[res] = (report.consumed[res] || 0) + realCost;
                        }
                    }
                }

                // B. Generazione Output
                if (efficiency > 0 && data.recipe.output) {
                    for (const [res, amt] of Object.entries(data.recipe.output)) {
                        const realOutput = Math.floor(amt * efficiency);
                        
                        // Gestione speciale per output non-risorse
                        if (res === 'gold') stateRef.gold += realOutput;
                        else if (res === 'happy') stateRef.happy = Math.min(100, stateRef.happy + realOutput);
                        else if (res === 'security') stateRef.security = Math.min(100, stateRef.security + realOutput);
                        else {
                            resourceBag[res] = (resourceBag[res] || 0) + realOutput;
                            report.produced[res] = (report.produced[res] || 0) + realOutput;
                        }
                    }
                }
            }
        });
    });

    return report;
}

</script>
<script>

/* ============================================================
   ====================== PRODUZIONE PER TURNO =================
   ============================================================ */

function applyProduction(targetState = null, options = {}) {
    const { silent = false, skipUI = false } = options;
    const stateStruct = targetState ? targetState.structures : structures;
    const stateCounty = targetState ? targetState.county : county;
    stateCounty.resources = normalizeResourceBag(stateCounty.resources);
    const notifyStructures = !targetState && !silent;

    const total = {
        wood:0, stone:0, iron:0, copper:0, gold:0, herbs:0,
        grain:0, livestock:0, textiles:0, luxuries:0, arcane:0
    };

    const mines = ownedStructures(stateStruct && stateStruct.mines ? stateStruct.mines : []);
    mines.forEach(m => {
        for (let k in m.production) {
            const amount = Math.floor(m.production[k] * (m.condition / 100));
            if (k === "gems" || k === "silver") {
                total.luxuries += amount;
            } else if (k === "mystic_crystals") {
                total.arcane += amount;
            } else {
                total[k] = (total[k] || 0) + amount;
            }
        }
        degradeStructure(m, { notify: notifyStructures });
    });

    const sawmills = ownedStructures(stateStruct && stateStruct.sawmills ? stateStruct.sawmills : []);
    sawmills.forEach(s => {
        const amount = Math.floor(s.production.wood * (s.condition / 100));
        total.wood += amount;
        degradeStructure(s, { notify: notifyStructures });
    });

    const quarries = ownedStructures(stateStruct && stateStruct.quarries ? stateStruct.quarries : []);
    quarries.forEach(q => {
        const amount = Math.floor(q.production.stone * (q.condition / 100));
        total.stone += amount;
        degradeStructure(q, { notify: notifyStructures });
    });

    const monasteries = ownedStructures(stateStruct && stateStruct.monasteries ? stateStruct.monasteries : []);
    monasteries.forEach(m => {
        const amount = Math.floor(m.production.herbs * (m.condition / 100));
        total.herbs += amount;
        degradeStructure(m, { notify: notifyStructures });
    });

    Object.keys(total).forEach(k => {
        stateCounty.resources[k] = (stateCounty.resources[k] || 0) + total[k];
    });

    if (!targetState && !silent) {
        addMsg("system", `â›ï¸ Produzione del turno: ${formatResourceReport(total)}`);
        if (!skipUI) updateResourceUI();
    }

    return total;
}

// AGGIUNTA IN applyProduction o funzione dedicata
function processWarProduction() {
    // Trova fucine attive
    const forges = buildings.filter(b => b.type === 'forge' && b.stage === 'complete');
    
    forges.forEach(forge => {
        // Controlla input (Ferro + Legno)
        if (county.resources.iron >= 5 && county.resources.wood >= 5) {
            county.resources.iron -= 5;
            county.resources.wood -= 5;
            
            // Output
            county.resources.weapons = (county.resources.weapons || 0) + 3;
            county.resources.armor = (county.resources.armor || 0) + 1;
        } else {
            // Se mancano risorse, la forgia non lavora
            // (Opzionale: messaggio di avviso)
        }
    });
}

/* ===================== SISTEMA MILITARE AVANZATO ===================== */

// 1. MOBILITAZIONE (Chiamata alle Armi)
function toggleMobilization() {
    const peasantGroup = populationGroups.peasants;
    
    if (!warState.mobilized) {
        // ATTIVA LEVA
        if (peasantGroup.count < 100) {
            addMsg("system", "âŒ Non ci sono abbastanza uomini validi per formare un esercito.");
            return;
        }

        // Prendi il 30% della forza lavoro contadina
        const levyAmount = Math.floor(peasantGroup.count * 0.30);
        
        warState.leviesCount = levyAmount;
        peasantGroup.count -= levyAmount; // Rimuovi dall'economia!
        warState.mobilized = true;
        
        // Calo felicitÃ  immediato
        county.happy -= 10;
        factions.peasants -= 15;
        
        addMsg("system", `âš”ï¸ <strong>LEVA GENERALE:</strong> ${levyAmount} contadini hanno lasciato i campi per prendere le armi. La produzione agricola crollerÃ .`);
    } else {
        // SCIOGLI ESERCITO (Ritorno ai campi)
        const survivors = warState.leviesCount;
        peasantGroup.count += survivors;
        
        warState.leviesCount = 0;
        warState.mobilized = false;
        
        county.happy += 5;
        factions.peasants += 5;
        
        addMsg("system", `ðŸ•Šï¸ <strong>SMOBILITAZIONE:</strong> ${survivors} uomini tornano alle loro famiglie.`);
    }
    
    updateUI();
}

// 2. CALCOLO POTENZA MILITARE
/* ===================== LOGICA MILITARE AGGIORNATA ===================== */

function getArmyEfficiency() {
    const soldiers = populationGroups.militia.count; // Solo professionisti per ora
    const levies = warState.mobilized ? warState.leviesCount : 0;
    const totalTroops = soldiers + levies;

    if (totalTroops <= 0) return 100;

    // Calcolo Armi necessarie
    // I soldati (militia) consumano 1 arma a testa per essere al 100%
    // Le leve (contadini) possono combattere con forconi (efficienza ridotta ma non zero)
    const weaponsStock = county.resources.weapons || 0;
    
    // Calcoliamo quanti soldati sono armati correttamente
    const armedTroops = Math.min(totalTroops, weaponsStock);
    
    // Efficienza base: percentuale di truppe armate
    let efficiency = (armedTroops / totalTroops) * 100;
    
    // Se ci sono leve non armate, hanno un'efficienza minima del 20% (forconi e bastoni)
    // Se sono soldati professionisti senza armi, efficienza 10% (pugni?)
    if (efficiency < 100) {
        const unarmed = totalTroops - weaponsStock;
        // Bonus minimo per non rendere l'esercito inutile se manca 1 spada
        efficiency += (unarmed / totalTroops) * 15; 
    }

    return Math.min(100, Math.floor(efficiency));
}

function calculateMilitaryPower() {
    const soldiers = populationGroups.militia.count;
    const levies = warState.mobilized ? warState.leviesCount : 0;
    
    // Potenza Base
    let rawPower = (soldiers * 5) + (levies * 1.5); // Soldati valgono molto piÃ¹ delle leve

    // Fattore Efficienza Armamenti
    const efficiencyPct = getArmyEfficiency();
    
    // Applicazione Efficienza
    let finalPower = Math.floor(rawPower * (efficiencyPct / 100));

    // Bonus Armature (Aggiunge resistenza extra, non attacco)
    const armorStock = county.resources.armor || 0;
    const totalTroops = soldiers + levies;
    if (armorStock > 0 && totalTroops > 0) {
        const armorCoverage = Math.min(1, armorStock / totalTroops);
        finalPower *= (1 + (armorCoverage * 0.3)); // Max +30% bonus se tutti corazzati
    }

    // Bonus Difensivi (Mura)
    finalPower += (county.security * 2);

    return Math.floor(finalPower);
}

// 3. SIMULAZIONE BATTAGLIA
function resolveBattle(enemyKey) {
    const enemy = neighboringCounties.find(c => c.key === enemyKey);
    if (!enemy) return;
    
    const myPower = calculateMilitaryPower();
    // Il nemico ha potenza base + bonus aggressione
    const enemyPower = (enemy.power * 10) + (enemy.aggression * 2);
    
    addMsg("system", `âš”ï¸ <strong>BATTAGLIA CAMPALE contro ${enemy.name}</strong>`);
    addMsg("system", `Noi: ${myPower} forza (Uomini: ${populationGroups.militia.count + warState.leviesCount}) vs Loro: ${enemyPower} forza.`);

    // Logica CasualitÃ 
    const luck = 0.8 + (Math.random() * 0.4); // Fattore 0.8x a 1.2x
    const finalMyPower = myPower * luck;
    
    // Calcolo Perdite (Morti)
    // PiÃ¹ Ã¨ cruenta la battaglia, piÃ¹ morti ci sono. 
    // I contadini (Leva) muoiono molto piÃ¹ facilmente della Milizia.
    const baseCasualtiesPct = 0.1 + (Math.random() * 0.2); // 10-30% di perdite
    
    let deadMilitia = Math.floor(populationGroups.militia.count * baseCasualtiesPct * 0.5); // Milizia muore meno
    let deadLevies = 0;
    
    if (warState.mobilized) {
        deadLevies = Math.floor(warState.leviesCount * baseCasualtiesPct * 1.5); // Contadini muoiono molto
        warState.leviesCount -= deadLevies;
        // Nota: Questi non tornano in populationGroups.peasants! SONO MORTI PER SEMPRE.
    }
    populationGroups.militia.count -= deadMilitia;
    
    // Consumo Armi
    const brokenWeapons = Math.floor((deadMilitia + deadLevies) * 0.8);
    county.resources.weapons = Math.max(0, (county.resources.weapons||0) - brokenWeapons);

    // ESITO
    if (finalMyPower >= enemyPower) {
        // VITTORIA
        const loot = Math.floor(enemy.wealth * 2);
        county.gold += loot;
        enemy.power = Math.max(0, enemy.power - 20);
        enemy.aggression = Math.max(0, enemy.aggression - 30); // Si calmano
        county.happy += 10;
        addMsg("system", `ðŸ† <strong>VITTORIA!</strong> Il nemico Ã¨ in rotta. Abbiamo saccheggiato ${loot} oro.`);
    } else {
        // SCONFITTA - PenalitÃ  ridotte
        const goldLost = Math.floor(county.gold * 0.2);
        county.gold -= goldLost;
        county.happy -= 15; // Era -20
        county.security -= 8; // Era -10
        county.health -= 4; // Era -5 - Feriti e malattie
        addMsg("system", `ðŸ”¥ <strong>SCONFITTA!</strong> Il nemico ha razziato le nostre terre (-${goldLost} oro).`);
    }
    
    addMsg("system", `â˜ ï¸ <strong>Caduti:</strong> ${deadMilitia} soldati e ${deadLevies} contadini.`);
    
    if (deadLevies > 50) {
        addMsg("system", "ðŸ“‰ La perdita di cosÃ¬ tanti contadini avrÃ  conseguenze disastrose sui prossimi raccolti.");
    }
    
    updateUI();
}

function degradeStructure(s, options = {}) {
    const notify = options.notify !== false;
    s.condition -= rand(0, 2);
    if (notify && s.condition < 35 && Math.random() < 0.12) {
        addMsg("ai", `âš ï¸ La struttura (${s.type}) in ${s.x},${s.y} Ã¨ in pessime condizioni.`);
    }
}

function updateResourceUI() {
    const bag = county.resources || {};
    RESOURCE_KEYS.forEach(key => {
        const valEl = document.getElementById(`res-${key}`);
        if (valEl) valEl.innerText = bag[key] || 0;
        const deltaEl = document.getElementById(`res-${key}-delta`);
        if (!deltaEl) return;
        const deltaValue = lastResourceDelta ? (lastResourceDelta[key] || 0) : 0;
        deltaEl.innerText = formatDeltaValue(deltaValue);
        deltaEl.classList.remove("positive", "negative");
        if (deltaValue > 0) deltaEl.classList.add("positive");
        else if (deltaValue < 0) deltaEl.classList.add("negative");
    });
}

function formatDeltaValue(value) {
    if (!value) return "â€”";
    return value > 0 ? `+${value}` : `${value}`;
}

function calculateHousingCapacity() {
    let capacity = 50; // CapacitÃ  base del castello
    
    // CapacitÃ  aggiunta dagli edifici costruiti
    buildings.forEach(b => {
        if (b.stage === 'complete') {
            const data = buildingData[b.type];
            if (data && data.housing) {
                capacity += data.housing;
            }
            // Bonus extra specifici
            if (b.type === 'barracks') capacity += 50; 
            if (b.type === 'grand_cathedral') capacity += 50; // Aumentato rifugio
        }
    });
    return capacity;
}

function processVillageEconomy(targetState = null, options = {}) {
    const { silent = false, skipUI = false } = options;
    const stateRef = targetState || null;
    const summary = updateIndustrySummary(stateRef);
    const flows = calculateAssetFlows(summary, stateRef);
    const production = calculateVillageProduction(stateRef);
    const consumption = calculateVillageConsumption(stateRef);
    const logisticNeeds = calculateLogisticNeeds(stateRef);
    logisticNeeds.forEach(need => {
        consumption[need.resource] = (consumption[need.resource] || 0) + need.amount;
    });
    const deficits = {};
    const stateCounty = stateRef ? stateRef.county : county;
    stateCounty.resources = normalizeResourceBag(stateCounty.resources);
    const resourceBag = stateCounty.resources;

    if (flows.goldCost) {
        const need = flows.goldCost;
        const available = stateCounty.gold || 0;
        if (available >= need) {
            stateCounty.gold = available - need;
        } else {
            const paidRatio = available / need;
            stateCounty.gold = 0;
            Object.keys(production).forEach(key => {
                production[key] = Math.floor(production[key] * paidRatio);
            });
            Object.keys(consumption).forEach(key => {
                consumption[key] = Math.floor((consumption[key] || 0) * paidRatio);
            });
            deficits.gold = Math.ceil(need - available);
        }
    }

    Object.keys(production).forEach(key => {
        resourceBag[key] = (resourceBag[key] || 0) + production[key];
    });

    Object.keys(consumption).forEach(key => {
        const available = resourceBag[key] || 0;
        const finalAmount = available - consumption[key];
        if (finalAmount < 0) {
            deficits[key] = Math.abs(finalAmount);
            resourceBag[key] = 0;
        } else {
            resourceBag[key] = finalAmount;
        }
    });

    applyEconomicEffects(production, consumption, deficits, stateRef);
    const logisticImpact = applyLogisticConsequences(logisticNeeds, deficits, stateRef);

    if (!targetState && !silent) {
        const upkeepNote = flows.goldCost ? ` | Manutenzione: ${flows.goldCost} oro` : "";
        addMsg("system", `âš–ï¸ Economia locale â€” Prodotti: ${formatResourceReport(production)} | Consumi: ${formatResourceReport(consumption)}${upkeepNote}`);
        if (Object.keys(deficits).length) {
            addMsg("system", `âš ï¸ Carenze critiche: ${formatResourceReport(deficits)}`);
        }
        if (logisticImpact.military) {
            addMsg("system", "âš”ï¸ Le forniture militari sono insufficienti: la disciplina cala e la salute pubblica ne risente.");
        }
        if (logisticImpact.construction) {
            addMsg("system", "ðŸ—ï¸ I cantieri rallentano per mancanza di materiali: alcuni lavori slittano.");
        }
        if (!skipUI) updateUI();
    }

    return { production, consumption, deficits, logisticImpact, logisticNeeds };
}

function processPopNeedsSystem(targetState = null, options = {}) {
    const { silent = false } = options;
    const statePop = targetState ? targetState.populationGroups : populationGroups;
    const stateCounty = targetState ? targetState.county : county;
    const stateFactions = targetState ? targetState.factions : factions;
    const marketPrices = getMarketPrices(); 
    
    // Resetta il report per questo turno
    if (!targetState) lastNeedsReport = {};

    let reportLog = [];
    let totalSatisfaction = 0;
    let groupsProcessed = 0;

    for (const [groupKey, data] of Object.entries(statePop)) {
        if (data.count <= 0) continue;
        const needs = POP_NEEDS[groupKey];
        if (!needs) continue;

        let primaryMet = 0;
        let secondaryMet = 0;
        
        // Tracking per il report IA
        let povertyStrikes = 0; // Quante volte non hanno avuto soldi
        let shortageStrikes = 0; // Quante volte mancava merce

        const attemptPurchase = (needList, isPrimary) => {
            let count = 0; 
            let met = 0;
            for (const [resKey, amountPerCapita] of Object.entries(needList)) {
                count++;
                const totalDemand = Math.ceil(amountPerCapita * data.count);
                const stock = stateCounty.resources[resKey] || 0;
                const unitPrice = marketPrices[resKey] || 1;
                const maxAffordable = Math.floor(data.wealth / unitPrice);
                
                const actualBuy = Math.min(totalDemand, stock, maxAffordable);
                
                // Transazione
                if (actualBuy > 0) {
                    stateCounty.resources[resKey] -= actualBuy;
                    data.wealth -= actualBuy * unitPrice;
                    stateCounty.gold += Math.floor(actualBuy * unitPrice * 0.3);
                }

                // Analisi cause fallimento per l'IA
                if (actualBuy < totalDemand) {
                    if (maxAffordable < totalDemand) povertyStrikes++; // Hanno fallito per soldi
                    else if (stock < totalDemand) shortageStrikes++;   // Hanno fallito per stock
                }

                met += (totalDemand > 0 ? actualBuy / totalDemand : 1);
            }
            return { count, met };
        };

        const pRes = attemptPurchase(needs.primary || {}, true);
        const sRes = attemptPurchase(needs.secondary || {}, false);

        const pScore = pRes.count > 0 ? (pRes.met / pRes.count) : 1;
        const sScore = sRes.count > 0 ? (sRes.met / sRes.count) : 1;

        // --- SALVATAGGIO DATI PER L'IA ---
        if (!targetState) {
            let status = "Soddisfatto";
            let reason = "Nessuna";
            
            if (pScore < 0.5) {
                status = "DISPERATO";
                // Determiniamo la causa principale
                if (povertyStrikes > shortageStrikes) reason = "POVERTÃ€ ESTREMA (Prezzi troppo alti)";
                else reason = "CARESTIA (Magazzini vuoti)";
            } else if (pScore < 0.9) {
                status = "In difficoltÃ ";
                if (povertyStrikes > 0) reason = "Potere d'acquisto basso";
                else reason = "ScarsitÃ  merci";
            }

            lastNeedsReport[groupKey] = {
                wealth: Math.floor(data.wealth),
                primary: Math.floor(pScore * 100),
                secondary: Math.floor(sScore * 100),
                status: status,
                mainIssue: reason
            };
        }
        // ---------------------------------

        // Conseguenze migliorate - piÃ¹ generose
        if (pScore < 0.8) {
            const severity = (1 - pScore);
            stateCounty.health = Math.max(0, stateCounty.health - (severity * 3)); // Era 5
            stateFactions[groupKey] = Math.max(0, stateFactions[groupKey] - (severity * 15)); // Era 20
        } else {
            stateFactions[groupKey] = Math.min(100, stateFactions[groupKey] + 2); // Era 1
        }

        // Bisogni secondari - piÃ¹ equilibrati
        if (sScore < 0.5) { // Soglia abbassata da 0.6
            stateCounty.happy = Math.max(0, stateCounty.happy - 1); // Era -2
            stateFactions[groupKey] = Math.max(0, stateFactions[groupKey] - 1); // Era -2
        } else if (sScore > 0.8) { // Soglia abbassata da 0.9
            stateCounty.happy = Math.min(100, stateCounty.happy + 2); // Era +1
            stateFactions[groupKey] = Math.min(100, stateFactions[groupKey] + 3); // Era +2
        }
        
        // NUOVO: Bonus extra se ENTRAMBI i bisogni sono soddisfatti
        if (pScore > 0.9 && sScore > 0.9) {
            stateCounty.happy = Math.min(100, stateCounty.happy + 2);
            stateFactions[groupKey] = Math.min(100, stateFactions[groupKey] + 2);
        }

        totalSatisfaction += (pScore * 0.7 + sScore * 0.3);
        groupsProcessed++;
    }

    return totalSatisfaction / (groupsProcessed || 1);
}

function calculateVillageProduction(stateRef = null) {
    // Eseguiamo prima il calcolo occupazione
    if(!stateRef) calculateLaborAndEducation(); 

    const summary = getIndustrySummary(stateRef);
    const flows = getCachedAssetFlows(stateRef) || calculateAssetFlows(summary, stateRef);
    const production = { ...flows.production };

    // Applica efficienza lavoro agli edifici manifatturieri (Fabbriche, ecc.)
    const buildingsRef = stateRef ? stateRef.buildings : buildings;
    buildingsRef.forEach(b => {
        if (b.stage !== 'complete') return;
        const data = buildingData[b.type];
        if (!data) return; // Salta edifici con type non definito in buildingData
        
        // Se Ã¨ un edificio produttivo custom (es. Fabbrica Tessile)
        if (data.productionOutput && b.currentEfficiency > 0) {
            // Controlla input (es. Cotone)
            let hasInput = true;
            if (data.productionInput) {
                for(let res in data.productionInput) {
                    if ((county.resources[res] || 0) < data.productionInput[res]) hasInput = false;
                }
            }

            if (hasInput) {
                // Consuma input
                if (data.productionInput) {
                    for(let res in data.productionInput) {
                        county.resources[res] -= data.productionInput[res] * b.currentEfficiency; // Consumo scalato? O fisso? Facciamo scalato
                    }
                }
                // Genera output scalato per efficienza
                for(let res in data.productionOutput) {
                    production[res] = (production[res] || 0) + (data.productionOutput[res] * b.currentEfficiency);
                }
            }
        }
        
        // Piantagioni Cotone (senza input)
        if (b.type === 'cotton_plantation') {
             production.cotton = (production.cotton || 0) + (15 * b.currentEfficiency);
        }
    });

    // Applica moltiplicatori standard
    Object.keys(production).forEach(key => {
        const mult = getProductionMultiplier(key, stateRef);
        production[key] = Math.max(0, Math.floor(production[key] * mult));
    });
    return production;
}

function calculateVillageConsumption(stateRef = null) {
    const popRef = stateRef ? stateRef.populationGroups : populationGroups;
    const flows = getCachedAssetFlows(stateRef) || calculateAssetFlows(getIndustrySummary(stateRef), stateRef);
    const consumption = { ...flows.consumption };
    
    // Gestisce sia la struttura con .count che valori diretti
    const getPop = (group) => {
        if (!popRef[group]) return 0;
        return popRef[group].count !== undefined ? popRef[group].count : (popRef[group] || 0);
    };
    
    const grainExtra = Math.floor(((getPop('militia') + getPop('peasants')) * 0.05));
    const livestockExtra = Math.floor((getPop('nobility') * 0.02));
    const textilesExtra = Math.floor((getPop('burghers') * 0.02));
    const herbsExtra = Math.floor((getPop('mystics') * 0.05));
    if (grainExtra) consumption.grain = (consumption.grain || 0) + grainExtra;
    if (livestockExtra) consumption.livestock = (consumption.livestock || 0) + livestockExtra;
    if (textilesExtra) consumption.textiles = (consumption.textiles || 0) + textilesExtra;
    if (herbsExtra) consumption.herbs = (consumption.herbs || 0) + herbsExtra;
    return consumption;
}

function applyEconomicEffects(production, consumption, deficits, stateRef = null) {
    const countyRef = stateRef ? stateRef.county : county;
    const factionsRef = stateRef ? stateRef.factions : factions;

    // --- SISTEMA CRESCITA POPOLAZIONE (Dentro applyEconomicEffects) ---
    const totalPop = countyRef.pop;
    const capacity = calculateHousingCapacity();
    const vacancy = Math.max(0, capacity - totalPop);

    // 1. IMMIGRAZIONE (Attratta dalle case vuote)
    if (vacancy > 0) {
        // Base: riempi il 10% delle case vuote ogni stagione
        let immigrationRate = 0.10; 
        
        // Bonus/Malus basati sull'attrattiva della cittÃ 
        if (countyRef.happy > 70) immigrationRate += 0.05; // CittÃ  felice attira di piÃ¹
        if (countyRef.food < 50) immigrationRate = 0;      // Niente cibo, niente arrivi
        if (countyRef.security < 40) immigrationRate *= 0.5; // Insicurezza scoraggia

        const immigrants = Math.ceil(vacancy * immigrationRate);
        
        if (immigrants > 0) {
            // I nuovi arrivati sono principalmente contadini poveri in cerca di fortuna
            adjustPopulation("peasants", immigrants, stateRef);
            if (!stateRef) {
                addMsg("system", `ðŸ˜ï¸ <strong>Crescita:</strong> ${immigrants} nuovi abitanti si sono stabiliti nelle case vuote.`);
            }
        }
    } 
    // 2. SOVRAFFOLLAMENTO (Stop alla crescita)
    else {
        if (!stateRef && Math.random() < 0.2) {
            addMsg("system", "âš ï¸ <strong>Sovraffollamento:</strong> Non ci sono piÃ¹ case libere! La crescita Ã¨ ferma. Costruisci cottage o palazzine.");
        }
        // PenalitÃ  felicitÃ  se troppo stretti
        countyRef.happy = Math.max(0, countyRef.happy - 1);
    }
    // --- FINE NUOVA LOGICA ---

    const prodGrain = production.grain || 0;
    const consGrain = consumption.grain || 0;
    const prodLivestock = production.livestock || 0;
    const consLivestock = consumption.livestock || 0;
    const prodTextiles = production.textiles || 0;
    const consTextiles = consumption.textiles || 0;
    const prodLuxuries = production.luxuries || 0;
    const consLuxuries = consumption.luxuries || 0;
    const prodArcane = production.arcane || 0;
    const consArcane = consumption.arcane || 0;
    const foodShortage = deficits.grain || deficits.livestock;
    const textileShortage = deficits.textiles;
    const luxuryShortage = deficits.luxuries;
    const arcaneShortage = deficits.arcane || deficits.herbs;
    const goldShortage = deficits.gold;

    if (foodShortage) {
        countyRef.food = clamp(countyRef.food - 6);
        countyRef.happy = clamp(countyRef.happy - 4);
        factionsRef.peasants -= 4;
        factionsRef.militia -= 2;
        const loss = Math.max(1, Math.floor(((deficits.grain || 0) + (deficits.livestock || 0)) / 120));
        adjustPopulation("peasants", -loss, stateRef);
    } else if (prodGrain > consGrain) {
        countyRef.food = clamp(countyRef.food + 3);
        factionsRef.peasants += 1;
    }

    if (textileShortage) {
        factionsRef.burghers -= 3;
        countyRef.happy = clamp(countyRef.happy - 2);
    } else if (prodTextiles > consTextiles) {
        factionsRef.burghers += 1;
    }

    if (luxuryShortage) {
        factionsRef.nobility -= 3;
        factionsRef.merchants -= 2;
        countyRef.happy = clamp(countyRef.happy - 3);
    } else if (prodLuxuries > consLuxuries) {
        factionsRef.nobility += 1;
        factionsRef.merchants += 1;
        const delta = Math.max(0, Math.floor((prodLuxuries - consLuxuries) / 200));
        if (delta) adjustPopulation("merchants", delta, stateRef);
    }

    if (arcaneShortage) {
        factionsRef.mystics -= 3;
        factionsRef.clergy -= 1;
        countyRef.health = clamp(countyRef.health - 4);
    } else if (prodArcane > consArcane) {
        factionsRef.mystics += 1;
        countyRef.health = clamp(countyRef.health + 2);
    }

    if (goldShortage) {
        countyRef.happy = clamp(countyRef.happy - 2);
        factionsRef.merchants -= 3;
        factionsRef.burghers -= 2;
    }

    factionOrder.forEach(f => factionsRef[f] = clamp(factionsRef[f]));
}

function formatResourceReport(obj) {
    const entries = Object.entries(obj)
        .filter(([, value]) => value && value !== 0)
        .map(([key, value]) => `${resourceLabels[key] || key}:${value}`);
    return entries.length ? entries.join(", ") : "nessuno";
}

function diffResources(start, end) {
    const result = {};
    RESOURCE_KEYS.forEach(key => {
        const endVal = (end && end[key] !== undefined) ? end[key] : 0;
        const startVal = (start && start[key] !== undefined) ? start[key] : 0;
        result[key] = endVal - startVal;
    });
    return result;
}

function diffFactions(start, end) {
    const result = {};
    const keys = new Set([...(Object.keys(start || {})), ...(Object.keys(end || {}))]);
    keys.forEach(key => {
        const endVal = (end && end[key] !== undefined) ? end[key] : 0;
        const startVal = (start && start[key] !== undefined) ? start[key] : 0;
        result[key] = endVal - startVal;
    });
    return result;
}

function formatResourceDelta(delta) {
    const entries = Object.entries(delta)
        .filter(([, val]) => val !== 0)
        .map(([key, val]) => `${resourceLabels[key] || key}:${val > 0 ? "+" + val : val}`);
    return entries.length ? entries.join(", ") : "nessuna variazione";
}

function formatFactionDelta(delta) {
    const entries = Object.entries(delta)
        .filter(([, val]) => val !== 0)
        .map(([key, val]) => `${key}:${val > 0 ? "+" + val : val}`);
    return entries.length ? entries.join(", ") : "stabili";
}

function simulateEconomyTurns(turns = 5) {
    const simState = captureGameState();
    ensureWorldSystems(simState);
    const startResources = cloneResourceBag(simState.county.resources);
    const startFactions = JSON.parse(JSON.stringify(simState.factions));

    for (let i = 0; i < turns; i++) {
        advanceSeason(simState, { silent:true });
        applyProduction(simState, { silent:true });
        processVillageEconomy(simState, { silent:true });
        collectTaxes(simState, { silent:true });
        applySeasonalUpkeep(simState, { silent:true });
    }

    const resourceDelta = diffResources(startResources, simState.county.resources);
    const factionDelta = diffFactions(startFactions, simState.factions);

    addMsg("system", `ðŸ“Š Simulazione ${turns} turni â€” Risorse: ${formatResourceDelta(resourceDelta)} | Fazioni: ${formatFactionDelta(factionDelta)}`);
}


/* ============================================================
   ======================= COSTRUZIONI =========================
   ============================================================ */

// Chiamata da parte dellâ€™IA (parte 6 la utilizzerÃ )
function startBuilding(data) {
    const type = data.type;
    const name = buildingData[type].name;
    const owner = buildingData[type].owner || null;

    // COSTI
    const cost = data.cost;
    if (!hasResources(cost, owner)) {
        addMsg("ai", `âŒ Mancano le risorse per costruire ${name}.`);
        return;
    }

    payResources(cost, owner);

    buildings.push({
        id: crypto.randomUUID(),
        type: type,
        x: data.x,
        y: data.y,
        owner: owner || "count",
        turns_left: data.turns,
        condition: 100,
        stage: "building",
        resources_needed: cost
    });

    addMsg("ai", `ðŸ—ï¸ Avviata la costruzione di <b>${name}</b> in (${data.x}, ${data.y}). SarÃ  completata in ${data.turns} turni.`);
}

function hasResources(cost, owner = null) {
    for (let k in cost) {
        // Controllo Valuta
        if (k === 'gold' || k === 'oro') {
            if (owner) {
                if ((populationGroups[owner].privateGold || 0) < cost[k]) return false;
            } else {
                if ((county.gold || 0) < cost[k]) return false;
            }
        } 
        // Controllo Materiali
        else {
            if (owner) {
                if ((populationGroups[owner].privateResources[k] || 0) < cost[k]) return false;
            } else {
                if ((county.resources[k] || 0) < cost[k]) return false;
            }
        }
    }
    return true;
}

function payResources(cost, owner = null) {
    for (let k in cost) {
        // 1. GESTIONE DELL'ORO (assumendo sia la chiave 'gold' o 'oro' e sia in county.gold)
        if (k === 'gold' || k === 'oro') {
            if (owner) {
                if (populationGroups[owner].privateGold !== undefined) {
                    populationGroups[owner].privateGold -= cost[k];
                }
            } else {
                if (county.gold !== undefined) {
                    county.gold -= cost[k]; // Sottrae dal Tesoro separato
                }
            }
        } 
        // 2. GESTIONE DELLE ALTRE RISORSE (legno, pietra, etc.)
        else if (owner) {
            if (populationGroups[owner].privateResources[k] !== undefined) {
                populationGroups[owner].privateResources[k] -= cost[k];
            }
        } else if (county.resources[k] !== undefined) {
            county.resources[k] -= cost[k]; // Sottrae dal contenitore generico
        }
    }
}


function registerNewStructure(collectionKey, production, sourceBuilding, typeLabel = null) {
    if (!structures[collectionKey]) structures[collectionKey] = [];
    const entry = {
        x: sourceBuilding.x,
        y: sourceBuilding.y,
        owner: sourceBuilding.owner || "count",
        type: typeLabel || collectionKey,
        condition: 100,
        workers: rand(6, 14),
        production: production
    };
    structures[collectionKey].push(entry);
    updateIndustrySummary();
}

function processBuildings() {
    buildings.forEach(b => {
        if (b.stage === "building") {

            b.turns_left--;

            if (b.turns_left <= 0) {
                b.stage = "complete";
                addMsg("ai", `ðŸ° L'edificio <b>${buildingName(b.type)}</b> Ã¨ stato completato!`);
                applyBuildingEffects(b);
            } else {
                maybeConstructionEvent(b);
            }
        }
    });
}


/* ============================================================
   ================== EVENTI DURANTE COSTRUZIONI ===============
   ============================================================ */

function maybeConstructionEvent(b) {
    if (Math.random() < 0.15) {
        const txt = constructionEventText(b.type);
        addMsg("ai", txt);
        b.turns_left += rand(1, 2); // ritardo lavori
    }
}

function constructionEventText(type) {
    switch(type) {
        case "forge": return "â›“ï¸ Un apprendista si Ã¨ ferito: la Forgia subirÃ  un ritardo.";
        case "harbor": return "ðŸŒŠ Una tempesta ha danneggiato i lavori del Porto.";
        case "watchtower": return "ðŸšï¸ Una sezione della Torre di Guardia Ã¨ crollata.";
        case "mercenary_camp": return "âš”ï¸ I mercenari hanno iniziato una rissa, lavori sospesi.";
        case "market": return "ðŸ’° Dispute tra mercanti hanno rallentato la costruzione del Mercato.";
        case "monk_clinic": return "ðŸ™ I monaci attendono nuove erbe: lavori rallentati.";
        case "sawmill": return "ðŸŒ² Le inondazioni hanno bloccato il cantiere della segheria.";
        case "stone_quarry": return "ðŸª¨ Cedimenti nel terreno rallentano lo scavo della cava.";
        case "iron_mine": return "â›ï¸ Falda instabile: servono puntelli aggiuntivi.";
        case "mint": return "ðŸ’° Difetti negli stampi delle monete hanno fermato la zecca.";
        case "barracks": return "âš”ï¸ Reclute indisciplinate rallentano l'addestramento.";
    }
}


/* ============================================================
   ================== EFFETTI EDIFICI COMPLETATI ===============
   ============================================================ */

function applyBuildingEffects(b) {
    // --- Helper per registrare strutture produttive ---
    const addStructure = (listKey, production, label) => {
        registerNewStructure(listKey, production, b, label);
        addMsg("system", `âš™ï¸ Produzione avviata: una nuova ${b.name} Ã¨ operativa.`);
    };

    logTurnEvent(`Completata la costruzione di: ${b.name}`);

    switch(b.type) {
        // --- AGRICOLTURA & SOPRAVVIVENZA ---
        case "village_well":
            county.health = clamp(county.health + 8);
            factions.peasants += 5;
            break;
        case "wheat_field":
            // Aggiungiamo una "farm" generica alla lista delle strutture
            // Nota: usiamo 'farms' se hai una lista generica, o creiamo un hook
            // Se non hai una lista 'farms' in 'structures', modifichiamo direttamente le risorse base
            // Per semplicitÃ  qui aumentiamo la produzione base del territorio se non c'Ã¨ una struttura specifica
            county.food = clamp(county.food + 10); 
            factions.peasants += 5;
            addMsg("system", "ðŸŒ¾ I nuovi campi aumentano la sicurezza alimentare.");
            break;
        case "dairy_farm":
            county.food = clamp(county.food + 5);
            factions.peasants += 3;
            // Simuliamo produzione aggiuntiva
            if(!county.resources.livestock) county.resources.livestock = 0;
            break;
        case "granary":
            county.security = clamp(county.security + 2);
            // Logica custom: protegge dalla carestia invernale (gestito narrativamente o in eventi futuri)
            factions.peasants += 4;
            break;

        // --- ECONOMIA ---
        case "market":
            county.happy = clamp(county.happy + 8);
            factions.merchants += 8;
            county.gold += 15; // Bonus immediato commercio
            break;
        case "harbor":
            factions.merchants += 10;
            factions.nobility += 2;
            county.gold += 50;
            break;
        case "mint":
            county.gold += 100; // Riserva immediata
            factions.merchants += 5;
            factions.nobility += 2;
            break;
        
        // --- PRODUZIONE RISORSE (STRUTTURE REALI) ---
        case "sawmill":
            addStructure("sawmills", { wood: rand(30, 60) }, "Segheria");
            break;
        case "stone_quarry":
            addStructure("quarries", { stone: rand(25, 50) }, "Cava");
            break;
        case "iron_mine":
            addStructure("mines", { iron: rand(30, 60), copper: rand(10, 20) }, "Miniera");
            break;

        // --- MILITARE ---
        case "watchtower":
            factions.militia += 5;
            county.security = clamp(county.security + 5);
            neighboringCounties.forEach(c => c.aggression = Math.max(0, c.aggression - 8));
            break;
        case "barracks":
            factions.militia += 8;
            adjustPopulation("militia", 10); // PiÃ¹ reclute
            county.security = clamp(county.security + 10);
            break;
        case "mercenary_camp":
            factions.militia += 5;
            factions.clergy -= 5;
            county.security = clamp(county.security + 15); // Molto sicuri ma costosi
            break;
        case "forge":
            factions.burghers += 6;
            factions.militia += 4;
            break;
        case "stone_walls":
            county.security = 100; // Massima sicurezza
            factions.nobility += 10;
            factions.burghers += 5;
            neighboringCounties.forEach(c => c.aggression = Math.max(0, c.aggression - 20));
            addMsg("system", "ðŸ›¡ï¸ Le mura sono completate! La contea Ã¨ ora una fortezza.");
            break;

        // --- FEDE ---
        case "chapel":
            factions.clergy += 5;
            county.happy = clamp(county.happy + 3);
            break;
        case "church":
            factions.clergy += 10;
            county.happy = clamp(county.happy + 6);
            county.health = clamp(county.health + 2);
            addStructure("monasteries", { herbs: rand(2,5) }, "Chiesa"); // Produce piccola quantitÃ  fede/erbe
            break;
        case "grand_cathedral":
            factions.clergy = 100; // Estasi religiosa
            factions.nobility += 15;
            county.happy = clamp(county.happy + 15);
            addMsg("system", "ðŸ”” Le campane della Cattedrale suonano per la prima volta. Un giorno storico!");
            break;
        case "monk_clinic":
            county.health = clamp(county.health + 15);
            factions.clergy += 8;
            break;

        // --- ISTRUZIONE & SOCIALE ---
        case "school":
            factions.burghers += 10;
            factions.mystics += 5;
            // Simuliamo efficienza: riduce sprechi
            county.gold += 20; 
            break;
        case "library":
            factions.mystics += 15;
            factions.clergy -= 2; // RivalitÃ  sul sapere
            addMsg("system", "ðŸ“š La biblioteca attira saggi da ogni dove.");
            break;
        case "theater":
            county.happy = clamp(county.happy + 12);
            factions.nobility += 5;
            factions.peasants += 5;
            break;

        // --- ABITAZIONI ---
        case "cottage":
            adjustPopulation("peasants", 50);
            factions.peasants += 5;
            break;
        case "tenement":
            adjustPopulation("burghers", 150);
            factions.burghers += 10;
            county.health = clamp(county.health - 5);
            break;
        case "noble_estate":
            adjustPopulation("nobility", 20);
            factions.nobility += 10;
            county.happy = clamp(county.happy + 10);
            break;
            
        // Edifici privati
        case "private_manor":
            // Aumenta ricchezza privata della nobiltÃ 
            populationGroups.nobility.privateGold += 20; // Bonus ricchezza privata
            populationGroups.nobility.privateResources = normalizeResourceBag(populationGroups.nobility.privateResources);
            populationGroups.nobility.privateResources.luxuries = (populationGroups.nobility.privateResources.luxuries || 0) + 5;
            factions.nobility += 5; // Aumenta lealtÃ 
            addMsg("system", "ðŸ° Il maniero privato aumenta il prestigio e la ricchezza della nobiltÃ .");
            break;
        case "private_shop":
            // Aumenta ricchezza privata dei mercanti
            populationGroups.merchants.privateGold += 15;
            populationGroups.merchants.privateResources = normalizeResourceBag(populationGroups.merchants.privateResources);
            populationGroups.merchants.privateResources.textiles = (populationGroups.merchants.privateResources.textiles || 0) + 10;
            factions.merchants += 5;
            addMsg("system", "ðŸ›’ Il negozio privato incrementa i commerci e la ricchezza dei mercanti.");
            break;
            
        default:
            addMsg("system", `Costruzione di ${b.type} completata.`);
    }

    // Aggiornamento finale UI e Fazioni
    factionOrder.forEach(f => factions[f] = clamp(factions[f]));
    updateUI();
}


/* ============================================================
   ========== STRUTTURE EVENTI RANDOM (MINIERE, ECC.) ==========
   ============================================================ */

function triggerStructureEvents(options = {}) {
    const { skipUI = false } = options;

    // Crollo miniere
    structures.mines.forEach(m => {
        if (Math.random() < 0.02) {
            m.condition -= 30;
            addMsg("ai", `ðŸ’¥ Crollo nella miniera (${m.x},${m.y}): feriti e produzione ridotta.`);
            county.pop -= rand(1,4);
        }
    });

    // Incendio Segherie
    structures.sawmills.forEach(s => {
        if (Math.random() < 0.015) {
            s.condition -= 40;
            addMsg("ai", `ðŸ”¥ Incendio nella segheria (${s.x},${s.y}): perdita di legno.`);
            county.resources.wood = Math.max(0, county.resources.wood - rand(20,60));
        }
    });

    // Frane Cave
    structures.quarries.forEach(q => {
        if (Math.random() < 0.01) {
            q.condition -= 20;
            addMsg("ai", `ðŸª¨ Frana nella cava (${q.x},${q.y}): lavori sospesi.`);
        }
    });

    // Miracoli Monasteri
    structures.monasteries.forEach(m => {
        if (Math.random() < 0.02) {
            addMsg("ai", `âœ¨ I monaci di (${m.x},${m.y}) hanno guarito dei malati.`);
            county.health = clamp(county.health + 5);
        }
    });

    if (!skipUI) updateUI();
}


/* ============================================================
   =================== EFFETTI SULLE FAZIONI ===================
   ============================================================ */

function structureFactionEffect() {

    structures.mines.forEach(() => {
        factions.nobility += 1;
        factions.militia += 1;
        factions.peasants -= 1;
    });

    structures.sawmills.forEach(() => {
        factions.merchants += 1;
        factions.commons += 1;
        factions.mystics -= 1;
    });

    structures.quarries.forEach(() => {
        factions.burghers += 1;
        factions.nobility -= 1;
    });

    structures.monasteries.forEach(() => {
        factions.clergy += 1;
        factions.merchants -= 1;
    });

    factionOrder.forEach(f => factions[f] = clamp(factions[f]));
}


/* ============================================================
   ==================== CHAT PRIVATA ===========================
   ============================================================ */

function openPrivateChat(key) {
    activePrivateChat = key;
    document.getElementById("private-chat-box").style.display = "block";
    document.getElementById("private-chat-title").innerText =
        "Colloquio con " + getChatName(key);

    loadPrivateChat();
    
    // Se aperto dal modal matrimonio, chiudi il modal e vai alla tab private
    if (document.getElementById("modal-marriage").classList.contains("active")) {
        closeMarriageModal();
        const privateBtn = document.querySelector('.nav-btn[onclick*="tab-private"]');
        switchTab('tab-private', privateBtn);
    }
}

function closePrivateChat() {
    const key = activePrivateChat;
    const factionName = getChatName(key);

    // Nascondi UI
    activePrivateChat = null;
    document.getElementById("private-chat-box").style.display = "none";

    addMsg("system", `Il colloquio con ${factionName} Ã¨ terminato. Il Conte riflette sulle richieste...`);

    // PROMPT SPECIFICO PER GENERARE AZIONI DI GIOCO
    // Chiediamo all'IA di tradurre la chiacchierata in meccaniche di gioco (Costruzioni, Leggi, ecc.)
    const promptAction = `
    Ho appena finito un colloquio privato con ${factionName} (${factionLabel(key)}).
    
    Basandoti sulla logica del gioco (dove posso costruire edifici come Mercati, Mura, Chiese o promulgare Leggi):
    1. Riassumi in una frase cosa voleva la fazione.
    2. Proponi 3 azioni di gioco concrete che posso fare ora per accontentarli o punirli.
    
    USA IL FORMATO AZIONI STANDARD:
    - **[Nome Azione]**: [Descrizione effetto]
    `;

    callGroq(promptAction, "action");
}

function loadPrivateChat() {
    const log = document.getElementById("private-chat-log");
    log.innerHTML = "";
    privateChats[activePrivateChat].forEach(m => addPrivateMsg(m.from, m.text));
}

function addPrivateMsg(type, text) {
    const log = document.getElementById("private-chat-log");
    const div = document.createElement("div");
    div.className = `msg msg-${type}`;
    const time = timestamp();
    div.innerHTML = `<div class="msg-text">${text}</div><div class="msg-meta">${time}</div>`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

function sendPrivate() {
    const input = document.getElementById("private-input");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    privateChats[activePrivateChat].push({ from:"user", text:text });
    addPrivateMsg("user", text);

    // Call IA (parte 6 gestisce privateDialog)
    callGroqPrivate(activePrivateChat, text);
}


/* ============================================================
   ==================== AGGIORNAMENTO UI =======================
   ============================================================ */

function clearInterfaceLogs() {
    const chatLog = document.getElementById("chat-log");
    if (chatLog) chatLog.innerHTML = "";

    const eventFeed = document.getElementById("event-feed");
    if (eventFeed) eventFeed.innerHTML = '<p class="event-empty">Nessun evento registrato.</p>';

    const adviceFeed = document.getElementById("advice-feed");
    if (adviceFeed) adviceFeed.innerHTML = '<p class="advice-empty">Nessun consiglio registrato.</p>';

    const actionList = document.getElementById("action-list");
    if (actionList) actionList.innerHTML = '<p class="action-empty">Nessuna proposta al momento.</p>';

    const actionPrompt = document.getElementById("action-prompt");
    if (actionPrompt) actionPrompt.innerText = "In attesa di nuovi suggerimenti dalla corte.";
}

/* ===================== SISTEMA FINANZIARIO FAZIONI ===================== */

// 1. CHIEDERE UN PRESTITO (Il Conte riceve Oro, la Fazione perde Ricchezza, LealtÃ  cala leggermente per il debito morale)
function requestLoan(factionKey) {
    const faction = populationGroups[factionKey];
    const amount = 100; // Prestito standard

    if (faction.wealth < amount) {
        addMsg("system", `âŒ I ${factionLabel(factionKey)} non hanno abbastanza oro per prestarti ${amount} monete.`);
        return;
    }

    faction.wealth -= amount;
    county.gold += amount;
    // Il debito abbassa la lealtÃ  perchÃ© il Conte perde autoritÃ  dipendendo da loro
    factions[factionKey] = Math.max(0, factions[factionKey] - 5); 

    addMsg("system", `ðŸ’° Hai ottenuto un prestito di ${amount} oro dai ${factionLabel(factionKey)}. (LealtÃ  -5)`);
    updateUI();
}

// 2. DONAZIONE (Il Conte perde Oro, la Fazione guadagna Ricchezza, LealtÃ  sale)
function donateToFaction(factionKey) {
    const amount = 50; // Donazione standard

    if (county.gold < amount) {
        addMsg("system", "âŒ Non hai abbastanza oro per fare questa donazione.");
        return;
    }

    county.gold -= amount;
    populationGroups[factionKey].wealth += amount;
    factions[factionKey] = Math.min(100, factions[factionKey] + 8); // Bonus lealtÃ 

    addMsg("system", `ðŸŽ Hai donato ${amount} oro ai ${factionLabel(factionKey)}. La loro lealtÃ  aumenta (+8).`);
    updateUI();
}

// 3. CONFISCA / TASSA STRAORDINARIA (Il Conte prende Oro, la Fazione perde Ricchezza, LealtÃ  crolla)
function seizeAssets(factionKey) {
    const faction = populationGroups[factionKey];
    const amount = Math.floor(faction.wealth * 0.5); // Prendi il 50% della loro ricchezza

    if (amount < 10) {
        addMsg("system", `I ${factionLabel(factionKey)} non hanno nulla da confiscare.`);
        return;
    }

    faction.wealth -= amount;
    county.gold += amount;
    factions[factionKey] = Math.max(0, factions[factionKey] - 25); // Malus gravissimo
    county.happy = Math.max(0, county.happy - 5); // Malcontento generale

    addMsg("system", `âš–ï¸ Hai confiscato ${amount} oro ai ${factionLabel(factionKey)}. Sono furiosi! (LealtÃ  -25)`);
    updateUI();
}

function renderPopulationDetails() {
    const grid = document.querySelector('.social-classes-grid'); 
    if(!grid) return;
    
    let html = "";
    Object.entries(populationGroups).forEach(([key, data]) => {
        const workforce = Math.floor(data.count * (data.workforceRatio || 0.6));
        const employed = data.employed || 0;
        const unemployed = Math.max(0, workforce - employed);
        const unempPct = workforce > 0 ? Math.round((unemployed / workforce) * 100) : 0;
        const occPct = workforce > 0 ? Math.round((employed / workforce) * 100) : 0;
        
        // Colore stato occupazione
        let jobColor = "#6ada91";
        if (unempPct > 20) jobColor = "#ff9800"; // Disoccupazione media
        if (unempPct > 50) jobColor = "#f44336"; // Disoccupazione alta
        if (workforce > 0 && employed >= workforce) jobColor = "#2196f3"; // Piena occupazione (Labor shortage)

        // CORREZIONE QUI SOTTO: Aggiunto onclick="toggleClassCard(this, '${key}')" e data-class="${key}"
        html += `
        <div class="social-class-card" onclick="toggleClassCard(this, '${key}')" data-class="${key}">
            <div class="social-class-header">
                <span class="social-class-icon">${FACTION_ICONS[key] || 'ðŸ‘¤'}</span>
                <span class="social-class-name">${factionLabel(key)}</span>
            </div>
            <div class="social-class-stats">
                <div class="social-class-count" style="font-size:1.2em">${data.count}</div>
                <div class="social-class-wealth" style="color:#ffd700">${fmtMoney(data.wealth)} ðŸ’°</div>
                
                <div style="margin-top:6px; border-top:1px solid #333; padding-top:4px; font-size:0.75em;">
                    <div style="display:flex; justify-content:space-between;">
                        <span>ðŸ“š Istr:</span>
                        <span>${Math.floor(data.literacy)}%</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; color:${jobColor}">
                        <span>âš’ï¸ Occ:</span>
                        <span>${workforce > 0 ? occPct + '%' : 'â€”'}</span>
                    </div>
                    <div style="font-size:0.9em; text-align:right; opacity:0.7">
                        (${unemployed} in cerca)
                    </div>
                </div>
            </div>
            
            <div class="social-class-details" id="details-${key}">
                 </div>
        </div>
        `;
    });
    
    grid.innerHTML = html;
}

function scrollDomainSection(targetId, btn) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const offset = 150;
    const targetTop = el.getBoundingClientRect().top + window.scrollY - offset;
    window.scrollTo({ top: Math.max(0, targetTop), behavior: 'smooth' });
    if (btn) {
        document.querySelectorAll('.domain-quick-nav button').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
    }
}

function updateDomainSummaryCards(capacity, stabilityValue) {
    const occupancy = capacity > 0 ? Math.round((county.pop / capacity) * 100) : 0;
    const foodValue = Math.round(county.food);
    const happyValue = Math.round(county.happy);
    const stabilityRounded = Math.round(stabilityValue);
    const foodHintText = foodValue >= 70 ? 'Granai pieni' : foodValue >= 40 ? 'Monitorare scorte' : 'Razione critica';
    const happyHintText = happyValue >= 70 ? 'Corte serena' : happyValue >= 45 ? 'Tensioni diffuse' : 'Malcontento';
    const stabilityHintText = stabilityValue >= 70 ? 'Fazioni cooperative' : stabilityValue >= 45 ? 'Equilibrio fragile' : 'Rischio sommosse';

    // Aggiorna la griglia panoramica (stat-card)
    const statPopVal = document.getElementById('stat-pop-value');
    if (statPopVal) { statPopVal.classList.add('pulse'); statPopVal.innerText = county.pop; setTimeout(()=>statPopVal.classList.remove('pulse'), 900); }
    const statPopHint = document.getElementById('stat-pop-hint');
    if (statPopHint) statPopHint.innerText = `CapacitÃ  ${capacity} (${occupancy}% occupate)`;
    const statFoodVal = document.getElementById('stat-food-value');
    if (statFoodVal) { statFoodVal.classList.add('pulse'); statFoodVal.innerText = `${foodValue}%`; setTimeout(()=>statFoodVal.classList.remove('pulse'), 900); }
    const statFoodHint = document.getElementById('stat-food-hint');
    if (statFoodHint) statFoodHint.innerText = foodHintText;
    const statHappyVal = document.getElementById('stat-happy-value');
    if (statHappyVal) { statHappyVal.classList.add('pulse'); statHappyVal.innerText = `${happyValue}%`; setTimeout(()=>statHappyVal.classList.remove('pulse'), 900); }
    const statHappyHint = document.getElementById('stat-happy-hint');
    if (statHappyHint) statHappyHint.innerText = happyHintText;
    const statStabVal = document.getElementById('stat-stability-value');
    if (statStabVal) { statStabVal.classList.add('pulse'); statStabVal.innerText = `${stabilityRounded}%`; setTimeout(()=>statStabVal.classList.remove('pulse'), 900); }
    const statStabHint = document.getElementById('stat-stability-hint');
    if (statStabHint) statStabHint.innerText = stabilityHintText;
    const statGoldVal = document.getElementById('stat-gold-value');
    if (statGoldVal) { statGoldVal.classList.add('pulse'); statGoldVal.innerText = fmtMoney(county.gold); setTimeout(()=>statGoldVal.classList.remove('pulse'), 900); }
    const statSecVal = document.getElementById('stat-security-value');
    if (statSecVal) { statSecVal.classList.add('pulse'); statSecVal.innerText = `${Math.round(county.security)}%`; setTimeout(()=>statSecVal.classList.remove('pulse'), 900); }
    // Set visual status on overview grid (if present)
    const setCardStatus = (id, s) => { const el = document.getElementById(id); if (!el) return; el.classList.remove('status-ok','status-warn','status-critical'); el.classList.add(s); };
    setCardStatus('stat-pop', occupancy >= 100 ? 'status-critical' : occupancy >= 90 ? 'status-warn' : 'status-ok');
    setCardStatus('stat-food', foodValue < 25 ? 'status-critical' : foodValue < 50 ? 'status-warn' : 'status-ok');
    setCardStatus('stat-happy', happyValue < 35 ? 'status-critical' : happyValue < 55 ? 'status-warn' : 'status-ok');
    setCardStatus('stat-stability', stabilityValue < 35 ? 'status-critical' : stabilityValue < 55 ? 'status-warn' : 'status-ok');
}

function updateUI() {
    ensureWorldSystems();
    const summary = updateIndustrySummary();
    document.getElementById("visual-desc").innerText = `"${county.desc}"`;

    // Dentro updateUI()...
    
    const capacity = calculateHousingCapacity();
    const popColor = county.pop > capacity ? "#ff7c7c" : "#fff"; // Rosso se sovraffollato
    
    // Aggiorna il testo della popolazione indicando anche la capacitÃ 
    const valPopEl = document.getElementById("val-pop");
    if (valPopEl) {
        valPopEl.innerHTML = `
            <span style="color:${popColor}">${county.pop}</span> 
            <span style="font-size:0.6em; color:#888;">/ ${capacity} cap.</span>
        `;
    }
    // Visual indicators for changes (pop, gold, food, health)
    (function(){
        const THRESH = 1; // minimum absolute change to show indicator
        const localFmtMoney = (v) => { const n = Number(v) || 0; return n.toFixed(2); };

        function setDelta(id, delta, textFormatter) {
            const el = document.getElementById(id);
            if (!el) return;
            if (Math.abs(delta) < THRESH) { el.innerHTML = ''; el.classList.remove('active','up','down'); return; }
            const up = delta > 0;
            const txt = textFormatter ? textFormatter(delta) : (up ? '+' : '-') + Math.abs(delta);
            const svgUp = '<svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path fill="currentColor" d="M8 3l5 6H3z"></path></svg>';
            const svgDown = '<svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path fill="currentColor" d="M8 13l-5-6h10z"></path></svg>';
            el.innerHTML = (up ? svgUp : svgDown) + '<span style="margin-left:4px">' + (up ? '+' : '-') + txt + '</span>';
            el.classList.add('active', up ? 'up' : 'down');
            el.classList.remove(up ? 'down' : 'up');
            setTimeout(() => { el.classList.remove('active'); }, 3000);
        }

        // Population (integer)
        setDelta('pop-delta', county.pop - (typeof lastPop === 'number' ? lastPop : county.pop), d => String(Math.abs(d)));
        // Gold (currency)
        setDelta('gold-delta', county.gold - (typeof lastGold === 'number' ? lastGold : county.gold), d => localFmtMoney(Math.abs(d)) );
        // Food (percent points)
        setDelta('food-delta', county.food - (typeof lastFood === 'number' ? lastFood : county.food), d => Math.abs(Math.round(d)) + '%');
        // Health (percent points)
        setDelta('health-delta', county.health - (typeof lastHealth === 'number' ? lastHealth : county.health), d => Math.abs(Math.round(d)) + '%');
    })();

    // Aggiorna gli ultimi valori per il prossimo ciclo
    lastPop = county.pop;
    lastGold = county.gold;
    lastFood = county.food;
    lastHealth = county.health;
    
    // ... resto della funzione

    const valGoldEl = document.getElementById("val-gold");
    if (valGoldEl) valGoldEl.innerText = fmtMoney(county.gold);

    updateBar("food", county.food);
    updateBar("health", county.health);
    updateBar("happy", county.happy);
    const stabilityValue = calculateStability();
    updateBar("stability", stabilityValue);

    const landCountEl = document.getElementById("land-count");
    if (landCountEl) landCountEl.innerText = landOwnership.count;
    const landNobilityEl = document.getElementById("land-nobility");
    if (landNobilityEl) landNobilityEl.innerText = landOwnership.nobility;
    const landClergyEl = document.getElementById("land-clergy");
    if (landClergyEl) landClergyEl.innerText = landOwnership.clergy;
    const landCommonsEl = document.getElementById("land-commons");
    if (landCommonsEl) landCommonsEl.innerText = landOwnership.commons;

    // Aggiorna classi sociali con ricchezza dettagliata
    renderPopulationDetails();
    updateDomainSummaryCards(capacity, stabilityValue);

    updateResourceUI();
    updateDiplomacyUI();
    updateFactionImpactUI();
    renderFactionChips();
    updateAssetSummaryUI(summary);
    renderTaxGrid();
    renderLawList();
    updateTaxSummary();
    updateSeasonUI();

    // Update HUD stats
    const season = getSeason();
    const hudSeasonEl = document.getElementById('hud-season');
    if (hudSeasonEl) hudSeasonEl.textContent = `${season.label} ${worldTime.year}`;
    const hudGoldEl = document.getElementById('hud-gold');
    if (hudGoldEl) hudGoldEl.textContent = county.gold;
    const hudPopEl = document.getElementById('hud-pop');
    if (hudPopEl) hudPopEl.textContent = `${county.pop} / ${capacity}`;
    const hudHappyEl = document.getElementById('hud-happy');
    if (hudHappyEl) hudHappyEl.textContent = county.happy;
    const hudSecurityEl = document.getElementById('hud-security');
    if (hudSecurityEl) hudSecurityEl.textContent = county.security;

    const turnTag = document.getElementById("chat-turn");
    if (turnTag) turnTag.innerText = `Turno ${county.turn}`;

    updateConstructionUI();
    renderResourceStats();
    renderMarket();
    renderNeedsPanel();
    
    // Add real-time budget delta
    const budgetDelta = detailedBudget.net;
    const deltaEl = document.getElementById('hud-gold-delta');
    if (deltaEl) {
        deltaEl.textContent = (budgetDelta >= 0 ? '+' : '') + budgetDelta;
        deltaEl.className = 'budget-delta ' + (budgetDelta >= 0 ? 'pos' : 'neg');
    }
    
    // Render faction powers
    renderFactionPowers();
}

function updateDiplomacyUI() {
    // Aggiorna Statistiche Militari
    const milSoldiersEl = document.getElementById("mil-soldiers");
    if (milSoldiersEl) milSoldiersEl.innerText = populationGroups.militia.count;
    const milLeviesEl = document.getElementById("mil-levies");
    if (milLeviesEl) milLeviesEl.innerText = warState.leviesCount;
    const milPowerEl = document.getElementById("mil-power");
    if (milPowerEl) milPowerEl.innerText = calculateMilitaryPower();
    const milWeaponsEl = document.getElementById("mil-weapons");
    if (milWeaponsEl) milWeaponsEl.innerText = county.resources.weapons || 0;
    
    // Aggiorna Efficienza con colore
    const eff = getArmyEfficiency();
    let effColor = eff > 80 ? "#6ada91" : eff > 40 ? "#ff9800" : "#f44336";
    const effEl = document.getElementById("mil-efficiency");
    if (effEl) {
        effEl.innerText = eff + "%";
        effEl.style.color = effColor;
    }
    
    // Aggiorna testo pulsante
    const mobBtn = document.getElementById("btn-mobilize");
    if (mobBtn) {
        if (warState.mobilized) {
            mobBtn.innerText = "ðŸ³ï¸ Sciogli la Leva (Torna ai campi)";
            mobBtn.style.background = "#444";
        } else {
            mobBtn.innerText = "ðŸ”” Chiama la Leva (Mobilita Contadini)";
            mobBtn.style.background = "linear-gradient(120deg, #8b0000, #4a0000)";
        }
    }

    // Genera Card Diplomatiche
    const container = document.getElementById("diplomacy-list");
    container.innerHTML = "";

    neighboringCounties.forEach(c => {
        // Calcola stato relazione
        let statusColor = "#aaa";
        let statusText = "Neutrale";
        if (c.relations > 70) { statusColor = "#6ada91"; statusText = "Alleato"; }
        if (c.relations < 30) { statusColor = "#ff7c7c"; statusText = "Ostile"; }
        if (warState.active && warState.enemy === c.key) { statusColor = "#f44336"; statusText = "IN GUERRA"; }

        const div = document.createElement("div");
        div.className = "diplomacy-card";
        if (warState.active && warState.enemy === c.key) div.style.borderColor = "#f44336";

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <h3 style="margin:0; color:var(--accent)">${c.name}</h3>
                <span style="color:${statusColor}; font-weight:bold;">${statusText}</span>
            </div>
            <p style="font-size:0.85em; color:#ccc;">${c.description}</p>
            
            <div class="grid-stats" style="grid-template-columns:1fr 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                <div class="stat-card" style="padding:5px;">
                    <div class="stat-val" style="font-size:1em;">${c.relations}</div>
                    <div class="stat-sub">Relazione</div>
                </div>
                <div class="stat-card" style="padding:5px;">
                    <div class="stat-val" style="font-size:1em;">${c.power}</div>
                    <div class="stat-sub">Forza</div>
                </div>
                <div class="stat-card" style="padding:5px;">
                    <div class="stat-val" style="font-size:1em;">${c.aggression}</div>
                    <div class="stat-sub">Aggr.</div>
                </div>
                <div class="stat-card" style="padding:5px;">
                    <div class="stat-val" style="font-size:1em;">${c.wealth}</div>
                    <div class="stat-sub">Ricchezza</div>
                </div>
            </div>

            <div class="diplomacy-actions">
                ${renderDiplomacyButtons(c)}
            </div>
        `;
        container.appendChild(div);
    });
}

function renderDiplomacyButtons(neighbor) {
    if (warState.active && warState.enemy === neighbor.key) {
        return `
            <button class="btn-main" style="background:#f44336; color:white; width:100%;" onclick="resolveBattle('${neighbor.key}')">âš”ï¸ ORDINA ATTACCO</button>
            <button class="btn-sec" onclick="sueForPeace('${neighbor.key}')">ðŸ³ï¸ Chiedi Tregua</button>
        `;
    } else {
        return `
            <button class="btn-sec" onclick="sendDiplomaticGift('${neighbor.key}')">ðŸŽ Invia Dono (50 oro)</button>
            <button class="btn-sec" onclick="requestTradeMeeting('${neighbor.key}')">ðŸ“œ Accordo Commerciale</button>
            <button class="btn-sec" style="border-color:#f44336; color:#f44336;" onclick="declareWarAdvanced('${neighbor.key}')">âš”ï¸ DICHIARA GUERRA</button>
        `;
    }
}

// Logica Diplomatica (Funzioni di supporto)
/* VECCHIA FUNZIONE declareWar - Ora sostituita da declareWarAdvanced
function declareWar(key) {
    const target = neighboringCounties.find(c => c.key === key);
    if (!confirm(`Sei sicuro di voler dichiarare guerra alla ${target.name}?`)) return;
    
    warState.active = true;
    warState.enemy = key;
    target.relations = 0; // Crollo relazioni
    target.aggression = 100;
    
    addMsg("system", `ðŸ“£ <strong>GUERRA!</strong> Hai dichiarato guerra alla ${target.name}. Prepara le truppe!`);
    updateUI();
}
*/

function sueForPeace(key) {
    const target = neighboringCounties.find(c => c.key === key);
    
    // Costo della pace: Oro o Territorio
    const cost = 300;
    if (county.gold < cost) {
        addMsg("system", `Il nemico rifiuta la pace. Chiedono ${cost} oro come riparazioni.`);
        return;
    }
    
    county.gold -= cost;
    warState.active = false;
    warState.enemy = null;
    target.relations = 20; // Tregua fredda
    
    addMsg("system", `ðŸ³ï¸ <strong>PACE FIRMATA.</strong> Abbiamo pagato ${cost} oro di riparazioni.`);
    updateUI();
}

function sendDiplomaticGift(key) {
    const target = neighboringCounties.find(c => c.key === key);
    if (county.gold < 50) return;
    
    county.gold -= 50;
    target.relations = Math.min(100, target.relations + 15);
    addMsg("system", `ðŸŽ Dono inviato alla ${target.name}. Le relazioni migliorano.`);
    updateUI();
}

function requestTradeMeeting(neighborKey) {
    const neighbor = neighboringCounties.find(c => c.key === neighborKey);
    if (!neighbor) return;

    // Costo diplomatico: oro e possibile calo relazioni se rifiuto
    const cost = 20;
    if (county.gold < cost) {
        addMsg("system", "Non hai abbastanza oro per organizzare un incontro diplomatico.");
        return;
    }

    county.gold -= cost;
    addMsg("system", `Hai inviato un emissario alla ${neighbor.name} per discutere accordi commerciali. Costo: ${cost} oro.`);

    // Simula risposta basata su relazioni
    const successChance = Math.min(90, neighbor.relations + 20); // Base 20% + relazioni
    const success = rand(1, 100) <= successChance;

    setTimeout(() => {
        if (success) {
            neighbor.tradeAgreement = true;
            neighbor.relations = Math.min(100, neighbor.relations + rand(5, 15));
            addMsg("system", `ðŸŽ‰ Successo! La ${neighbor.name} accetta l'accordo commerciale. I prezzi nel mercato sono ora ridotti e puoi accedere alle loro merci speciali.`);
        } else {
            neighbor.relations = Math.max(0, neighbor.relations - rand(5, 10));
            addMsg("system", `âŒ La ${neighbor.name} rifiuta l'incontro. Le relazioni si deteriorano leggermente.`);
        }
        updateUI();
        renderMarket();
    }, 2000); // Ritardo per simulare il tempo dell'incontro
}

// Sistema di domanda/offerta basato sulle categorie sociali
function calculateMarketDemand() {
    const demand = createEmptyResourceBag();
    const supply = createEmptyResourceBag();
    
    // NobiltÃ : domanda lusso, cavalli da parata e arredi rari
    demand.luxuries += populationGroups.nobility.count * 2;
    demand.arcane += populationGroups.nobility.count * 1;
    demand.parade_horses += populationGroups.nobility.count * 0.8;
    demand.furniture += populationGroups.nobility.count * 0.6;
    demand.spices += populationGroups.nobility.count * 0.8;
    
    // Clero: domanda cibo e beni sacri, offerta spirituale
    demand.grain += populationGroups.clergy.count * 3;
    demand.textiles += populationGroups.clergy.count * 1;
    demand.parchment += populationGroups.clergy.count * 1.5;
    demand.candles += populationGroups.clergy.count * 1.5;
    demand.incense += populationGroups.clergy.count * 1.2;
    
    // Militia: domanda armi e cibo, offerta protezione
    demand.iron += populationGroups.militia.count * 2;
    demand.grain += populationGroups.militia.count * 4;
    demand.leather += populationGroups.militia.count * 1;
    demand.weapons += populationGroups.militia.count * 0.8;
    demand.armor += populationGroups.militia.count * 0.6;
    
    // Peasants: offerta cibo e materie prime, domanda beni essenziali
    supply.grain += populationGroups.peasants.count * 1;
    supply.wood += populationGroups.peasants.count * 0.5;
    supply.stone += populationGroups.peasants.count * 0.3;
    supply.seeds += populationGroups.peasants.count * 0.4;
    demand.textiles += populationGroups.peasants.count * 0.5;
    demand.tools += populationGroups.peasants.count * 0.4;
    
    // Burghers: domanda lusso moderato, offerta artigianato
    demand.luxuries += populationGroups.burghers.count * 1;
    demand.fabric += populationGroups.burghers.count * 0.5;
    supply.textiles += populationGroups.burghers.count * 2;
    supply.iron += populationGroups.burghers.count * 1;
    supply.tools += populationGroups.burghers.count * 0.5;
    
    // Merchants: domanda tutto, offerta commercio
    Object.keys(demand).forEach(key => {
        demand[key] += populationGroups.merchants.count * 0.5;
    });
    
    // Mystics: domanda arcane e reagenti, offerta mistica
    demand.arcane += populationGroups.mystics.count * 3;
    demand.crystals += populationGroups.mystics.count * 1.5;
    demand.herbs += populationGroups.mystics.count * 1.2;
    demand.incense += populationGroups.mystics.count * 0.8;
    
    // Outcasts: offerta lavoro, domanda sopravvivenza
    supply.wood += populationGroups.outcasts.count * 0.5;
    demand.grain += populationGroups.outcasts.count * 2;
    demand.candles += populationGroups.outcasts.count * 0.6;
    
    return { demand, supply };
}

// MobilitÃ  sociale
function processSocialMobility() {
    // MobilitÃ  sociale basata sulla domanda di lavoro dagli edifici costruiti
    let burgherDemand = 0;
    let militiaDemand = 0;

    // Conta la domanda di lavoro dagli edifici attivi
    for (const [buildingKey, building] of Object.entries(buildingData)) {
        if (building.laborRequired && county.buildings[buildingKey] && county.buildings[buildingKey].count > 0) {
            const activeBuildings = county.buildings[buildingKey].count;
            if (building.laborRequired === 'burgher') {
                burgherDemand += activeBuildings;
            } else if (building.laborRequired === 'militia') {
                militiaDemand += activeBuildings;
            }
        }
    }

    // Limita le promozioni per turno per evitare cambiamenti drastici
    const maxPromotionsPerTurn = 3;

    // Promuovi contadini a borghesi se c'Ã¨ domanda
    if (burgherDemand > populationGroups.burghers.count && populationGroups.peasants.count > 10) {
        const neededBurghers = Math.min(burgherDemand - populationGroups.burghers.count, maxPromotionsPerTurn);
        const actualPromotions = Math.min(neededBurghers, Math.floor(populationGroups.peasants.count / 2)); // Non promuovere piÃ¹ della metÃ  dei contadini

        if (actualPromotions > 0) {
            populationGroups.peasants.count -= actualPromotions;
            populationGroups.burghers.count += actualPromotions;
            populationGroups.burghers.wealth += actualPromotions * 20; // Piccola ricchezza iniziale
            addMsg("system", `ðŸ“ˆ ${actualPromotions} contadini sono diventati borghesi per soddisfare la domanda di lavoro specializzato!`);
        }
    }

    // Promuovi contadini a milizia se c'Ã¨ domanda
    if (militiaDemand > populationGroups.militia.count && populationGroups.peasants.count > 10) {
        const neededMilitia = Math.min(militiaDemand - populationGroups.militia.count, maxPromotionsPerTurn);
        const actualPromotions = Math.min(neededMilitia, Math.floor(populationGroups.peasants.count / 2));

        if (actualPromotions > 0) {
            populationGroups.peasants.count -= actualPromotions;
            populationGroups.militia.count += actualPromotions;
            addMsg("system", `âš”ï¸ ${actualPromotions} contadini sono stati arruolati nella milizia per difendere il villaggio!`);
        }
    }

    // Vecchia logica per borghesi che diventano nobili (se applicabile)
    if (populationGroups.burghers.wealth > 200 && populationGroups.burghers.count > 10) {
        const promotions = Math.min(1, Math.floor(populationGroups.burghers.count / 30)); // Ridotto per bilanciare
        if (promotions > 0) {
            populationGroups.burghers.count -= promotions;
            populationGroups.nobility.count += promotions;
            populationGroups.nobility.wealth += promotions * 100;
            addMsg("system", `ðŸ“ˆ ${promotions} borghesi sono diventati nobili grazie alla loro ricchezza!`);
        }
    }
}

/* ===================== FIX DEMOGRAFIA SICURA ===================== */

// Helper per modificare la popolazione senza andare sotto zero o rompere i dati
function safeAdjustPop(groupKey, amount) {
    if (!populationGroups[groupKey]) return 0;
    
    const current = populationGroups[groupKey].count;
    
    // Se stiamo sottraendo (morte/emigrazione)
    if (amount < 0) {
        // Non uccidere mai gli ultimi 10 sopravvissuti (Safeguard anti-estinzione)
        const safeMinimum = 10; 
        const maxLoss = Math.max(0, current - safeMinimum);
        // Applica la perdita ma non oltre il massimo possibile
        const actualLoss = Math.min(Math.abs(amount), maxLoss);
        populationGroups[groupKey].count -= actualLoss;
        return -actualLoss; // Ritorna la variazione reale
    } 
    // Se stiamo aggiungendo (nascita)
    else {
        populationGroups[groupKey].count += amount;
        return amount;
    }
}

// Eventi demografici
function processDemographicEvents() {
    const events = [];
    let totalDeaths = 0;
    let totalBirths = 0;

    // 1. NASCITE (Basate su felicitÃ  e cibo)
    // Solo se c'Ã¨ cibo a sufficienza
    if (county.food > county.pop * 0.8) { 
        const fertilePop = (populationGroups.peasants.count || 0) + (populationGroups.burghers.count || 0);
        // Tasso di natalitÃ  moderato (1% - 3%)
        const birthRate = Math.max(0.01, Math.min(0.03, county.happy / 100 * 0.03)); 
        const births = Math.floor(fertilePop * birthRate);
        
        if (births > 0) {
            safeAdjustPop("peasants", births);
            totalBirths += births;
            events.push(`ðŸ‘¶ ${births} nuove nascite.`);
        }
    }

    // 2. MORTI (Fame, Malattie, Vecchiaia)
    // Fame: Se il cibo Ã¨ sotto il 40% del fabbisogno
    if (county.food < county.pop * 0.4) {
        const severity = 1 - (county.food / (county.pop * 0.4)); // 0.0 a 1.0
        // Max 10% di morti per fame per turno (per evitare estinzione istantanea)
        const deathRate = severity * 0.10; 
        
        const peasantDeaths = Math.floor(populationGroups.peasants.count * deathRate);
        const outcastDeaths = Math.floor(populationGroups.outcasts.count * deathRate);
        
        const d1 = safeAdjustPop("peasants", -peasantDeaths);
        const d2 = safeAdjustPop("outcasts", -outcastDeaths);
        
        if ((d1 + d2) < 0) {
            events.push(`ðŸ’€ Carestia: ${Math.abs(d1+d2)} morti di fame.`);
            logTurnEvent(`Care stia nel regno: ${Math.abs(d1+d2)} morti di fame.`);
        }
        totalDeaths += Math.abs(d1+d2);
    }

    // Malattie (Randomico + Salute)
    if (Math.random() < 0.15 && county.health < 50) {
        const plagueSeverity = (50 - county.health) / 200; // Max 25%
        const deaths = Math.floor(county.pop * plagueSeverity);
        
        // Distribuisci le morti (colpisce piÃ¹ i poveri)
        const d1 = safeAdjustPop("peasants", -Math.floor(deaths * 0.6));
        const d2 = safeAdjustPop("outcasts", -Math.floor(deaths * 0.2));
        const d3 = safeAdjustPop("burghers", -Math.floor(deaths * 0.1));
        const d4 = safeAdjustPop("militia", -Math.floor(deaths * 0.1));

        const actualDeaths = Math.abs(d1+d2+d3+d4);
        if (actualDeaths > 0) {
            events.push(`ðŸ¦  Epidemia: ${actualDeaths} vittime.`);
            logTurnEvent(`Epidemia nel regno: ${actualDeaths} vittime.`);
        }
        totalDeaths += actualDeaths;
    }

    // Vecchiaia naturale (Tasso fisso basso 0.5%)
    const naturalRate = 0.005;
    Object.keys(populationGroups).forEach(key => {
        const deaths = Math.floor(populationGroups[key].count * naturalRate);
        safeAdjustPop(key, -deaths);
    });

    // Aggiorna il totale "county.pop" sommando i gruppi reali
    // Questo impedisce al sistema di "perdere il conto"
    recomputePopulation();

    // Mostra eventi solo se significativi
    events.forEach(e => addMsg("system", e));
}

// Sistema di delinquenza basato sulla soddisfazione
function processCrimeAndStability() {
    const events = [];
    
    // Calcola livello di delinquenza basato su felicitÃ , cibo e salute
    const happinessFactor = (100 - county.happy) / 100; // PiÃ¹ felice = meno crimine
    const foodFactor = Math.max(0, (county.pop * 0.5 - county.food) / (county.pop * 0.5)); // PiÃ¹ fame = piÃ¹ crimine
    const healthFactor = (100 - county.health) / 100; // PiÃ¹ malattie = piÃ¹ crimine
    
    const crimeLevel = (happinessFactor + foodFactor + healthFactor) / 3; // Media dei fattori
    const crimeRate = Math.min(0.15, crimeLevel * 0.1); // Max 15% di crimine
    
    if (crimeRate > 0.05) { // Solo se crimine significativo
        // Effetti del crimine
        const crimeIncidents = Math.floor(county.pop * crimeRate);
        const goldLost = Math.floor(crimeIncidents * 2); // Ogni crimine costa ~2 oro
        const stabilityLoss = Math.floor(crimeLevel * 10); // Perdita stabilitÃ 
        
        county.gold = Math.max(0, county.gold - goldLost);
        county.happy = Math.max(0, county.happy - stabilityLoss);
        
        events.push(`ðŸš” ${crimeIncidents} incidenti criminali! Perdita di ${goldLost}ðŸ’° e stabilitÃ  ridotta.`);
    }
    
    // Mostra eventi criminali
    events.forEach(event => addMsg("system", event));
}

// Sistema di emigrazione
function processEmigration() {
    // Calcolo rischio emigrazione
    const happinessFactor = (100 - county.happy) / 100;
    const foodFactor = Math.max(0, (county.pop * 0.5 - county.food) / (county.pop * 0.5));
    
    // Rischio medio
    const risk = (happinessFactor + foodFactor) / 2;
    
    // Emigrano solo se il rischio Ã¨ alto (>40%)
    if (risk > 0.4) {
        const rate = Math.min(0.05, risk * 0.1); // Max 5% della pop
        const totalEmigrants = Math.floor(county.pop * rate);
        
        if (totalEmigrants > 0) {
            const e1 = safeAdjustPop("peasants", -Math.floor(totalEmigrants * 0.6));
            const e2 = safeAdjustPop("burghers", -Math.floor(totalEmigrants * 0.3));
            const e3 = safeAdjustPop("outcasts", -Math.floor(totalEmigrants * 0.1));
            
            const actualEmigrants = Math.abs(e1+e2+e3);
            
            if (actualEmigrants > 0) {
                addMsg("system", `ðŸƒ ${actualEmigrants} abitanti hanno abbandonato la contea.`);
                recomputePopulation(); // Ricalcola subito
            }
        }
    }
}

// Calcola livello di stabilitÃ  sociale
function calculateStability() {
    // La stabilitÃ  Ã¨ inversamente proporzionale alla delinquenza
    const happinessFactor = county.happy / 100; // PiÃ¹ felice = piÃ¹ stabile
    const foodFactor = Math.min(1, county.food / (county.pop * 0.5)); // PiÃ¹ cibo = piÃ¹ stabile
    const healthFactor = county.health / 100; // PiÃ¹ salute = piÃ¹ stabile
    const housingFactor = Math.min(1, calculateHousingCapacity() / county.pop); // PiÃ¹ spazio = piÃ¹ stabile
    
    const stability = (happinessFactor + foodFactor + healthFactor + housingFactor) / 4;
    return Math.floor(stability * 100);
}

// Aggiorna ricchezze delle categorie
function updateCategoryWealth() {
    // === ECONOMIA MEDIEVALE REALISTICA ===
    // Gerarchia di ricchezza: NobiltÃ  > Mercanti/Clero > Borghesi > Milizia > Contadini > Emarginati > Mistici
    
    // CONTADINI (Peasants): I piÃ¹ poveri, vivono di sussistenza
    // Guadagnano pochissimo perchÃ© la maggior parte del raccolto va ai signori
    const peasantIncome = Math.floor(
        (populationGroups.peasants.count * 0.08) + // Minimo di sussistenza: 0.08 oro a testa
        ((county.resources.grain || 0) * 0.005) + // Solo 0.5% del grano (il resto va ai nobili)
        ((county.resources.livestock || 0) * 0.01) // 1% del bestiame
    );
    populationGroups.peasants.wealth += peasantIncome;
    
    // ARTIGIANI (Burghers): Classe media urbana, vendono i loro manufatti
    // Guadagnano dalla vendita di beni artigianali
    const burghersBaseIncome = populationGroups.burghers.count * 1.5; // Reddito fisso discreto
    const textilesProfit = (county.resources.textiles || 0) * 0.25; // 25% profitto sui tessuti
    const ironProfit = (county.resources.iron || 0) * 0.3; // 30% profitto sul ferro lavorato
    const copperProfit = (county.resources.copper || 0) * 0.35; // 35% profitto sul rame
    const burghersIncome = Math.floor(burghersBaseIncome + textilesProfit + ironProfit + copperProfit);
    populationGroups.burghers.wealth += burghersIncome;
    
    // MERCANTI (Merchants): Ricchi commercianti, controllano il commercio
    // Guadagnano da OGNI transazione commerciale + beni di lusso
    const merchantsBaseIncome = populationGroups.merchants.count * 3; // Reddito base alto
    const tradingFees = (seasonalTransactions.marketSales + seasonalTransactions.marketPurchases) * 0.12; // 12% su tutte le transazioni
    const luxuriesMonopoly = (county.resources.luxuries || 0) * 0.4; // 40% sui beni di lusso (alto margine!)
    const specialTradeBonus = seasonalTransactions.specialPurchases * 0.2; // 20% sul commercio speciale
    const merchantsIncome = Math.floor(merchantsBaseIncome + tradingFees + luxuriesMonopoly + specialTradeBonus);
    populationGroups.merchants.wealth += merchantsIncome;
    
    // MILIZIA (Militia): Soldati pagati dalla contea
    // Stipendio fisso modesto
    const militiaWage = 1.2; // 1.2 oro per soldato (ridotto, erano poveri!)
    const militiaIncome = Math.floor(populationGroups.militia.count * militiaWage);
    populationGroups.militia.wealth += militiaIncome;
    
    // NOBILTÃ€ (Nobility): I piÃ¹ ricchi, vivono di rendite fondiarie
    // Guadagnano dalle terre e dai privilegi feudali
    const nobilityLandRent = landOwnership.nobility * 8; // 8 oro per unitÃ  di terra (alto!)
    const feudalDues = Math.floor(county.gold * 0.015); // 1.5% dell'oro statale
    const grainTithes = (county.resources.grain || 0) * 0.03; // 3% del grano (decime feudali)
    const nobilityIncome = Math.floor(nobilityLandRent + feudalDues + grainTithes + (populationGroups.nobility.count * 15));
    populationGroups.nobility.wealth += nobilityIncome;
    
    // CLERO (Clergy): Ricchi grazie a decime e proprietÃ  ecclesiastiche
    // Guadagnano da terre della chiesa e offerte
    const clergyLandRent = landOwnership.clergy * 6; // 6 oro per unitÃ  di terra ecclesiastica
    const tithesIncome = Math.floor(county.gold * 0.012); // 1.2% decime
    const offerings = Math.floor(county.pop * 0.015); // Offerte dai fedeli
    const clergyIncome = Math.floor(clergyLandRent + tithesIncome + offerings + (populationGroups.clergy.count * 8));
    populationGroups.clergy.wealth += clergyIncome;
    
    // MISTICI (Mystics): Ai margini della societÃ , vivono di caritÃ  e servizi
    // Guadagnano poco da pozioni e rituali
    const herbsSales = (county.resources.herbs || 0) * 0.08; // 8% vendita erbe
    const arcaneSales = (county.resources.arcane || 0) * 0.15; // 15% servizi arcani
    const mysticsIncome = Math.floor(herbsSales + arcaneSales + (populationGroups.mystics.count * 1));
    populationGroups.mystics.wealth += mysticsIncome;
    
    // EMARGINATI (Outcasts): I piÃ¹ poveri, vivono di espedienti
    // Quasi nessun reddito legale
    const outcastsIncome = Math.floor(populationGroups.outcasts.count * 0.15); // Pochissimo
    // Bonus dal crimine se la sicurezza Ã¨ bassa
    if (county.security < 50) {
        const crimeBonus = Math.floor((50 - county.security) * populationGroups.outcasts.count * 0.02);
        populationGroups.outcasts.wealth += crimeBonus;
    }
    populationGroups.outcasts.wealth += outcastsIncome;
    
    // Previeni ricchezze negative
    Object.keys(populationGroups).forEach(key => {
        populationGroups[key].wealth = Math.max(0, populationGroups[key].wealth);
    });
}

function updateCategoryWealthBasedOnJobs() {
    // Salari base per tipo di lavoro
    const WAGES = {
        peasants: 0.5,   // Basso salario agricolo
        burghers: 2.5,   // Salario artigiano
        clergy: 2.0,     // Salario insegnante/prete
        nobility: 5.0,   // Rendita amministrativa
        // ...
    };

    Object.entries(populationGroups).forEach(([key, data]) => {
        const wage = WAGES[key] || 1;
        const incomeFromJobs = (data.employed || 0) * wage;
        
        // Aggiungi al wealth esistente
        data.wealth += incomeFromJobs;
        
        // Sussistenza disoccupati (costa ricchezza o crea povertÃ )
        const workforce = Math.floor(data.count * (data.workforceRatio || 0.6));
        const unemployed = Math.max(0, workforce - (data.employed || 0));
        
        if (unemployed > 0) {
            data.wealth -= unemployed * 0.2; // Costo della vita senza salario
        }
        
        data.wealth = Math.max(0, data.wealth); // Mai sotto zero
    });
}

function ensureNeighborResources(countyRef) {
    if (!countyRef.resources) {
        countyRef.resources = {
            grain: rand(80, 160),
            wood: rand(60, 120),
            stone: rand(50, 110),
            iron: rand(30, 80),
            gold: rand(40, 120),
            textiles: rand(20, 60)
        };
    }
    return countyRef.resources;
}

function simulateNeighborEconomy(countyRef, options = {}) {
    const { silent = false } = options;
    ensureNeighborResources(countyRef);
    const production = {
        grain: Math.max(20, Math.floor(countyRef.land * 1.2 + rand(5, 20))),
        wood: Math.max(10, Math.floor(countyRef.land * 0.8 + rand(4, 12))),
        stone: Math.max(6, Math.floor(countyRef.land * 0.5 + rand(2, 8))),
        iron: Math.max(4, Math.floor(countyRef.power * 0.4 + rand(1, 6))),
        textiles: Math.max(3, Math.floor(countyRef.wealth * 0.25 + rand(1, 4)))
    };
    const consumption = {
        grain: Math.max(25, Math.floor(countyRef.power * 0.6 + rand(5, 15))),
        wood: Math.max(12, Math.floor(countyRef.land * 0.6 + rand(3, 10))),
        stone: Math.max(8, Math.floor(countyRef.land * 0.4 + rand(1, 6))),
        iron: Math.max(6, Math.floor(countyRef.power * 0.25 + rand(0, 4))),
        gold: Math.max(10, Math.floor(countyRef.wealth * 0.3 + rand(2, 8))),
        textiles: Math.max(4, Math.floor(countyRef.wealth * 0.2 + rand(1, 4)))
    };

    Object.entries(production).forEach(([key, value]) => {
        countyRef.resources[key] = (countyRef.resources[key] || 0) + value;
    });

    const deficits = [];
    Object.entries(consumption).forEach(([key, value]) => {
        const current = countyRef.resources[key] || 0;
        const final = current - value;
        if (final < 0) {
            deficits.push(key);
            countyRef.resources[key] = 0;
        } else {
            countyRef.resources[key] = final;
        }
    });

    if (deficits.length) {
        countyRef.wealth = clamp((countyRef.wealth || 50) - deficits.length * 2);
        countyRef.relations = Math.max(0, countyRef.relations - deficits.length * 2);
        countyRef.aggression = Math.min(100, countyRef.aggression + deficits.length * 3);
        if (!silent) {
            addMsg("system", `ðŸŒ«ï¸ ${countyRef.name} Ã¨ in crisi (${deficits.join(", ")}). Le relazioni peggiorano.`);
        }
    } else {
        countyRef.wealth = clamp((countyRef.wealth || 50) + 1);
        countyRef.relations = Math.min(100, countyRef.relations + 1);
        countyRef.aggression = Math.max(0, countyRef.aggression - 1);
        if (!silent && Math.random() < 0.15) {
            addMsg("system", `${countyRef.name} registra un avanzo commerciale e potrebbe cercare accordi.`);
        }
    }

    if (countyRef.aggression > 80 && !silent) {
        addMsg("system", `âš ï¸ ${countyRef.name} accumula truppe al confine: l'economia li spinge alla guerra.`);
    }

    countyRef.lastEconomy = { production, consumption, deficits };
}

function processNeighborEconomies(options = {}) {
    const { silent = false } = options;
    neighboringCounties.forEach(neigh => simulateNeighborEconomy(neigh, { silent }));
}

// Arrotonda a 2 cifre decimali (es. 45.67%)
function fmtPct(value) {
    if (value === undefined || value === null) return "0.00%";
    // Se il valore Ã¨ 0-1 (es. 0.5), lo moltiplichiamo per 100
    // Se Ã¨ giÃ  0-100, lo usiamo direttamente.
    // Nel tuo codice usi spesso valori 0-100, quindi assumiamo quello.
    return parseFloat(value).toFixed(2) + "%";
}

// Versione per numeri 0-1 (es. needs calculation returns 0.85)
function fmtPctFrac(value) {
    return (value * 100).toFixed(2) + "%";
}

function updateBar(id,val){
    const bar = document.getElementById(`bar-${id}`);
    const txt = document.getElementById(`txt-${id}`);
    if (bar) bar.style.width = val + "%";
    if (txt) txt.innerText = parseFloat(val).toFixed(2) + "%";
}

function renderNeedsPanel() {
    const container = document.getElementById("needs-list-container");
    if (!container) return;

    // Se non ci sono dati (inizio gioco)
    if (!lastNeedsReport || Object.keys(lastNeedsReport).length === 0) {
        container.innerHTML = '<div class="save-empty">I dati sui consumi appariranno qui dopo il prossimo cambio di stagione.</div>';
        return;
    }

    let html = "";
    
    // Ordine standard fazioni
    const order = ["nobility", "clergy", "militia", "burghers", "merchants", "peasants", "mystics", "outcasts"];

    order.forEach(key => {
        const data = lastNeedsReport[key];
        if (!data) return;

        // Recuperiamo il nome leggibile
        const label = factionLabel(key);
        
        // Colore ricchezza
        const wealthColor = data.wealth < 20 ? "#ff7c7c" : "#ffd700";

        // Avvisi critici
        let warningHtml = "";
        if (data.mainIssue && data.mainIssue !== "Nessuna") {
            warningHtml = `<div class="need-warning">âš ï¸ ${data.mainIssue} (${data.status})</div>`;
        }

        html += `
            <div class="need-entry">
                <div class="need-entry-header">
                    <span>${label}</span>
                    <span style="color:${wealthColor}">ðŸ’° ${data.wealth} oro</span>
                </div>
                
                <div class="need-bars-container">
                    <div class="need-bar-row">
                        <span style="width:60px">Primari</span>
                        <div class="need-track">
                            <div class="need-fill fill-prim" style="width: ${data.primary}%"></div>
                        </div>
                        <span style="width:45px; text-align:right;">${fmtPct(data.primary)}</span>
                    </div>
                    
                    <div class="need-bar-row">
                        <span style="width:60px">Secondari</span>
                        <div class="need-track">
                            <div class="need-fill fill-sec" style="width: ${data.secondary}%"></div>
                        </div>
                        <span style="width:45px; text-align:right;">${fmtPct(data.secondary)}</span>
                    </div>
                </div>
                ${warningHtml}
            </div>
        `;
    });

    container.innerHTML = html;
}

async function generateSeasonStory() {
    // 1. Setup UI Modale (Feedback visivo immediato)
    const modal = document.getElementById("modal-chronicle");
    const body = document.getElementById("chronicle-body");
    const titleDate = document.getElementById("chronicle-date");
    
    if (modal) modal.classList.add("active");
    if (titleDate) titleDate.innerText = `Anno ${worldTime.year}, ${getSeason().label}`;
    if (body) body.innerHTML = `
        <div class="loading-story">
            <span class="scribe-icon">âœï¸</span>
            <p>Il Mastrocronista sta osservando il regno per scrivere le cronache...</p>
        </div>`;

    if (!ensureApiKey()) {
        body.innerHTML = "<p>Chiave API mancante. Impossibile scrivere la storia.</p>";
        return;
    }

    // 2. CALCOLO DEL "TONO" REALE (Logica rigida anti-allucinazione)
    let realmStatus = "NEUTRO";
    let prosperityDesc = "";
    
    // Dati attuali
    const foodStock = county.food; 
    const happiness = county.happy;
    const gold = county.gold;
    
    // Verifica se c'Ã¨ una vera crisi alimentare nei dati dei bisogni
    // (Se lastNeedsReport Ã¨ vuoto o non ha "DISPERATO", non c'Ã¨ carestia vera)
    const isStarving = (lastNeedsReport && Object.values(lastNeedsReport).some(r => r.status === "DISPERATO"));

    // LOGICA DI PRIORITÃ€: I fatti numerici vincono sulla fantasia dell'IA
    if (isStarving || foodStock < 20) {
        realmStatus = "CRISI NERA";
        prosperityDesc = "C'Ã¨ una carestia reale. Il popolo soffre la fame e la disperazione cresce.";
    } else if (foodStock > 80 && happiness > 60 && gold > 300) {
        realmStatus = "ETÃ€ DELL'ORO";
        prosperityDesc = "I granai traboccano, i commerci fioriscono e il popolo Ã¨ felice. Regna la pace.";
    } else if (foodStock > 40 && happiness > 45) {
        realmStatus = "STABILE";
        prosperityDesc = "La vita scorre tranquilla. Non ci sono disastri, nÃ© carestie, nÃ© pestilenze in corso.";
    } else {
        realmStatus = "DIFFICILE";
        prosperityDesc = "Tempi duri. Si tira la cinghia, ma il regno resiste senza catastrofi.";
    }

    // 3. Costruzione Prompt
    const eventsList = currentTurnEvents.length > 0 ? currentTurnEvents.join("\n- ") : "Nessun evento maggiore, la stagione Ã¨ passata in tranquillitÃ .";
    
    const systemPrompt = `
    SEI IL MASTROCRONISTA DEL REGNO.
    Scrivi un breve resoconto narrativo (max 80-100 parole) per l'ultima stagione.

    === STATO REALE OBBLIGATORIO: ${realmStatus} ===
    DATI DI FATTO: ${prosperityDesc}
    
    EVENTI ACCADUTI REALMENTE:
    - ${eventsList}

    REGOLE FERREE (Se le violi il gioco si rompe):
    1. **COERENZA**: Se lo stato Ã¨ "STABILE" o "ETÃ€ DELL'ORO", Ã¨ **VIETATO** inventare carestie, pestilenze, morti o disastri.
    2. **DESCRIZIONE**: 
       - Se Ã¨ "ETÃ€ DELL'ORO": Descrivi banchetti, mercati pieni, canti nei campi.
       - Se Ã¨ "STABILE": Descrivi la serena routine quotidiana.
    3. **STILE**: Usa un tono da cronaca medievale. Non iniziare sempre con "Il sole sorge".
    4. Se non ci sono eventi specifici, celebra la buona amministrazione del Conte (o lamentati delle tasse se lo stato Ã¨ DIFFICILE).
    `;

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type":"application/json",
                "Authorization":"Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.6, // Temperatura bassa per ridurre le allucinazioni
                messages: [{ role: "system", content: systemPrompt }]
            })
        });

        const data = await resp.json();
        const story = data.choices[0].message.content;

        // 4. VISUALIZZAZIONE E SALVATAGGIO (Il Fix per non perdere la storia)
        
        // A) Mostra nel Modale (Formattato)
        const formattedStory = story.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        body.innerHTML = `<p>${formattedStory}</p>`;

        // B) Salva nella Chat Principale (CosÃ¬ rimane nello storico scorribile quando chiudi il modale)
        const chatLog = document.getElementById("chat-log");
        const narrativeDiv = document.createElement("div");
        narrativeDiv.className = "msg-scene"; // Usa lo stile esistente per la narrativa
        // Aggiungiamo un bordo dorato specifico per le cronache stagionali
        narrativeDiv.style.borderLeft = "4px solid #d4af37"; 
        narrativeDiv.innerHTML = `<strong>ðŸ“œ Cronache di ${getSeason().label} ${worldTime.year}</strong><br><br>${formattedStory}`;
        chatLog.appendChild(narrativeDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

        // C) Salva nella memoria dell'IA (CosÃ¬ si ricorda cosa Ã¨ successo nel prossimo turno)
        publicChatHistory.push({ role: "assistant", content: `[CRONACA ${worldTime.year}]: ${story}` });

    } catch (e) {
        body.innerHTML = `<p>Il cronista non riesce a scrivere (Errore: ${e.message})</p>`;
        console.error(e);
    }
}

function refreshAllStats() {
    // Calcola sommari senza modificare i dati (dry run)
    updateIndustrySummary(); 
    calculateResourceStats(); 
    calculateHousingCapacity();
    // Forza l'aggiornamento UI
    updateUI(); 
}

async function triggerStartupNarrative(isNewGame) {
    const chatLog = document.getElementById("chat-log");
    
    // Messaggio di caricamento
    const loadingDiv = document.createElement("div");
    loadingDiv.className = "msg-system";
    loadingDiv.innerHTML = "<em>Il cronista sta rileggendo le pergamene...</em>";
    loadingDiv.id = "startup-loader";
    chatLog.appendChild(loadingDiv);

    // Costruiamo il contesto per l'IA
    const ctx = generateDeepContext(); // Usa la funzione esistente che include guerra e risorse
    
    let prompt = "";
    if (isNewGame) {
        prompt = `
        SEI IL NARRATORE. Ãˆ l'inizio di una nuova partita (Anno ${worldTime.year}).
        Il giocatore Ã¨ il nuovo Conte ${heroName}.
        Descrivi brevemente l'atmosfera della contea basandoti su questi dati iniziali:
        ${ctx}
        Saluta il Conte e spiegagli la situazione in 2 frasi evocative.
        `;
    } else {
        prompt = `
        SEI IL NARRATORE. Il giocatore ha appena caricato la partita (Anno ${worldTime.year}).
        Riassumi DOVE ERAVAMO RIMASTI basandoti su questi dati attuali:
        ${ctx}
        
        FOCUS CRUCIALE:
        - Se warState.active Ã¨ true, RICORDA CHE SIAMO IN GUERRA contro ${warState.enemy}.
        - Se c'Ã¨ carestia, ricordalo.
        - Concludi con "Bentornato, mio Signore. I vostri ordini?"
        `;
    }

    try {
        // Chiamata diretta all'API (simile a callGroq ma one-shot)
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type":"application/json", "Authorization":"Bearer " + apiKey },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.7,
                messages: [{ role: "system", content: prompt }]
            })
        });
        
        const data = await resp.json();
        const text = data.choices[0].message.content;

        // Rimuovi loader e aggiungi messaggio
        const loader = document.getElementById("startup-loader");
        if(loader) loader.remove();
        
        addMsg("ai", text); // Usa la tua funzione standard per aggiungere messaggi

        // Aggiungi alla memoria dell'IA per mantenere il contesto
        publicChatHistory.push({ role: "assistant", content: text });

    } catch (e) {
        console.error(e);
        if(document.getElementById("startup-loader")) document.getElementById("startup-loader").remove();
        addMsg("system", "Bentornato, Conte. (Impossibile recuperare la cronaca narrativa).");
    }
}

function closeChronicleModal() {
    document.getElementById("modal-chronicle").classList.remove("active");
}

/* ============================================================
   ==================== INVIO MESSAGGI PUBBLICI =================
   ============================================================ */

/* ============================================================
   ========== EVENTI POSITIVI CASUALI (BILANCIAMENTO) ==========
   ============================================================ */

function triggerPositiveEvents() {
    // ProbabilitÃ  base di eventi positivi: 30% per turno
    if (Math.random() > 0.3) return;
    
    const events = [
        // Eventi di felicitÃ  generale
        {
            condition: () => county.happy < 80,
            trigger: () => {
                county.happy = Math.min(100, county.happy + 5);
                const events = [
                    "ðŸŽ­ Una compagnia di giullari visita la contea. Il popolo ride di cuore!",
                    "ðŸŽª Una fiera ambulante porta gioia e mercanzia esotica.",
                    "â˜€ï¸ Il bel tempo porta una stagione di raccolti abbondanti e sorrisi.",
                    "ðŸŽµ Un trovatore compone una ballata in onore della contea. Tutti cantano!",
                    "ðŸº Viene scoperta un'antica fonte di acqua pura. Benedizione!",
                    "ðŸŒ¸ I giardini del castello fioriscono magnificamente. Un buon presagio!"
                ];
                addMsg("system", events[Math.floor(Math.random() * events.length)]);
            }
        },
        // Eventi di crescita economica
        {
            condition: () => county.gold < 500,
            trigger: () => {
                const bonus = Math.floor(50 + Math.random() * 100);
                county.gold += bonus;
                county.happy = Math.min(100, county.happy + 3);
                const events = [
                    `ðŸ’° Un mercante generoso dona ${bonus} oro per le opere pie!`,
                    `â›ï¸ I minatori trovano una vena ricca! +${bonus} oro dalle miniere.`,
                    `ðŸ“¦ Un carico di merci preziose arriva inaspettato. +${bonus} oro.`,
                    `ðŸŽ Un nobile in visita lascia doni generosi: ${bonus} oro!`
                ];
                addMsg("system", events[Math.floor(Math.random() * events.length)]);
            }
        },
        // Eventi di salute
        {
            condition: () => county.health < 80,
            trigger: () => {
                county.health = Math.min(100, county.health + 7);
                county.happy = Math.min(100, county.happy + 2);
                const events = [
                    "ðŸŒ¿ Un guaritore errante distribuisce rimedi efficaci. La salute migliora!",
                    "â›ª I monaci pregano per la salute del popolo. Le malattie regrediscono!",
                    "ðŸƒ Le erbe di stagione hanno proprietÃ  curative straordinarie.",
                    "ðŸ’Š Un alchimista scopre una nuova cura per le febbri comuni!"
                ];
                addMsg("system", events[Math.floor(Math.random() * events.length)]);
            }
        },
        // Eventi che migliorano le fazioni
        {
            condition: () => true,
            trigger: () => {
                const factionKeys = Object.keys(factions);
                const randomFaction = factionKeys[Math.floor(Math.random() * factionKeys.length)];
                factions[randomFaction] = Math.min(100, factions[randomFaction] + 5);
                county.happy = Math.min(100, county.happy + 2);
                
                const eventsMap = {
                    nobility: "ðŸ‘‘ Un torneo cavalleresco rinforza l'orgoglio nobiliare!",
                    clergy: "âœï¸ Una reliquia sacra viene donata alla chiesa. Il clero gioisce!",
                    militia: "âš”ï¸ Le truppe vincono un'esercitazione. Il morale sale!",
                    peasants: "ðŸŒ¾ Un raccolto eccezionale riempie i granai dei contadini!",
                    burghers: "ðŸ”¨ Gli artigiani completano un'opera magistrale. Grande orgoglio!",
                    merchants: "ðŸ›’ I mercanti concludono affari vantaggiosi. ProsperitÃ !",
                    mystics: "ðŸ”® I saggi prevedono un futuro luminoso per la contea!",
                    outcasts: "ðŸŽ­ Gli emarginati ottengono un atto di giustizia. Gratitudine!"
                };
                
                addMsg("system", eventsMap[randomFaction] || `I ${factionLabel(randomFaction)} sono piÃ¹ contenti. (+5 LealtÃ )`);
            }
        },
        // Eventi di risorse bonus
        {
            condition: () => true,
            trigger: () => {
                const resources = ['grain', 'wood', 'stone', 'iron'];
                const res = resources[Math.floor(Math.random() * resources.length)];
                const amount = Math.floor(20 + Math.random() * 40);
                county.resources[res] = (county.resources[res] || 0) + amount;
                
                const eventsMap = {
                    grain: `ðŸŒ¾ Un raccolto spontaneo dona ${amount} unitÃ  di grano!`,
                    wood: `ðŸŒ² Alberi caduti forniscono ${amount} legno stagionato!`,
                    stone: `ðŸª¨ Scoperta una cava abbandonata con ${amount} pietre!`,
                    iron: `â›ï¸ Un vecchio deposito rivela ${amount} unitÃ  di ferro!`
                };
                
                addMsg("system", eventsMap[res]);
            }
        }
    ];
    
    // Filtra eventi che soddisfano le condizioni
    const validEvents = events.filter(e => e.condition());
    
    // Attiva un evento casuale tra quelli validi
    if (validEvents.length > 0) {
        const event = validEvents[Math.floor(Math.random() * validEvents.length)];
        event.trigger();
        updateUI();
    }
}

/* ============================================================
   ==================== PROGRESSIONE STAGIONE =================
   ============================================================ */

function progressSeason(options = {}) {
    const { silent = false } = options;
    currentTurnEvents = [];
    ensureWorldSystems();
    county.turn++;
    
    const turnTag = document.getElementById("chat-turn");
    if (turnTag) turnTag.innerText = `Anno ${worldTime.year} - ${getSeason().label}`;

    // Snapshot Iniziale
    const startSnapshot = captureResourceSnapshot();
    const startGold = county.gold;
    const startHappy = county.happy;
    const budget = calculateSeasonalBudget();

    // Reset transazioni stagionali
    seasonalTransactions = {
        marketPurchases: 0,
        marketSales: 0,
        specialPurchases: 0,
        taxes: 0,
        maintenance: 0
    };

    // --- ELABORAZIONE TURNO ---
    advanceSeason(null, { silent: true }); // Stagione avanza silenziosamente
    
    processLifeEvents(); 
    
    // 1. Calcola dinamiche lavorative (PRIMA della produzione)
    calculateLaborAndEducation(); 
    
    // 1.5 Aggiorna ricchezza (Salari) - Modifica updateCategoryWealth per usare i salari
    updateCategoryWealthBasedOnJobs(); 
    
    // 1.5. Produzione Bellica (Prima della produzione normale)
    processWarProduction();
    
    // 2. CICLO DI PRODUZIONE (Sostituisce applyProduction)
    const productionReport = processProductionChains();

    // 3. Gestione Carenze (Feedback all'IA)
    if (productionReport.shortages.length > 0) {
        logTurnEvent(`âš ï¸ Produzione rallentata per mancanza di materie prime: ${productionReport.shortages.join(', ')}.`);
    }

    // 4. Consumo (Bisogni e PovertÃ )
    processPopNeedsSystem(null, { silent: silent });
    
    // 1. CALCOLO ENTRATE (Tasse Dettagliate)
    detailedBudget.income = { taxes_nobility:0, taxes_burghers:0, taxes_peasants:0, taxes_other:0, trade_export:0, production_mint:0 };
    
    // Tasse (Versione Dettagliata)
    const taxPolicyRef = ensureTaxPolicy(null);
    TAX_CATEGORIES.forEach(cat => {
        const pop = populationGroups[cat.key].count;
        const wealth = populationGroups[cat.key].wealth; // Ricchezza del gruppo
        // Calcolo basato sulla ricchezza reale del gruppo, non solo sulla popolazione
        // Se il gruppo Ã¨ povero, le tasse rendono 0
        const baseTaxable = Math.min(wealth, pop * cat.wealthFactor); 
        
        const percent = taxPolicyRef[cat.key];
        const income = Math.floor(baseTaxable * (percent / 100));
        
        // Sottrai oro al gruppo
        populationGroups[cat.key].wealth = Math.max(0, populationGroups[cat.key].wealth - income);
        
        // Registra entrata
        if(cat.key === 'nobility') detailedBudget.income.taxes_nobility += income;
        else if(cat.key === 'burghers') detailedBudget.income.taxes_burghers += income;
        else if(cat.key === 'peasants') detailedBudget.income.taxes_peasants += income;
        else detailedBudget.income.taxes_other += income;
    });

    // Entrate da Commercio (Vendite Mercato)
    detailedBudget.income.trade_export = seasonalTransactions.marketSales;
    
    // Entrate da Zecca (Se esiste edificio 'mint')
    const mints = buildings.filter(b => b.type === 'mint' && b.stage === 'complete').length;
    detailedBudget.income.production_mint = mints * 50;

    const totalIncome = Object.values(detailedBudget.income).reduce((a,b)=>a+b,0);
    county.gold += totalIncome;

    // 2. CALCOLO USCITE (Spese Dettagliate)
    const upkeep = calculateDetailedUpkeep();
    
    // Stipendi Milizia (pagati dal tesoro della contea)
    const militiaWages = Math.floor((populationGroups.militia?.count || 0) * 1.2);
    
    // Costo Leggi Attive
    let lawCostGold = 0;
    activeLaws.forEach(lawKey => {
        const law = getLawDefinition(lawKey);
        if (law && law.upkeepCost) lawCostGold += law.upkeepCost;
        // Gestione consumo risorse fisiche (es. Grano per legge Pane)
        if (law && law.consumeResource) {
            for (let res in law.consumeResource) {
                county.resources[res] = Math.max(0, (county.resources[res] || 0) - law.consumeResource[res]);
            }
        }
    });

    detailedBudget.expenses = {
        upkeep_military: upkeep.military + militiaWages, // Include stipendi soldati
        upkeep_civil: upkeep.civil,
        upkeep_court: upkeep.court,
        upkeep_infrastructure: upkeep.infrastructure,
        welfare_laws: lawCostGold,
        import_costs: seasonalTransactions.marketPurchases
    };

    const totalExpense = Object.values(detailedBudget.expenses).reduce((a,b)=>a+b,0);
    
    // Applicazione Spese
    county.gold -= totalExpense;
    detailedBudget.net = totalIncome - totalExpense;

    // Bancarotta? - PENALITÃ€ RIDOTTE
    if (county.gold < 0) {
        addMsg("system", "ðŸ’¸ <strong>BANCAROTTA!</strong> Il tesoro Ã¨ vuoto. Le truppe disertano e le strutture crollano.");
        county.gold = 0;
        county.security = Math.max(0, county.security - 5); // Era -10
        county.happy = Math.max(0, county.happy - 5); // Era -10
    }
    
    // Eventi vari
    processBuildings();
    triggerStructureEvents({ skipUI: true });
    structureFactionEffect();
    processNeighborEconomies({ silent: true });
    
    // NUOVO: Eventi Positivi Casuali per bilanciare
    if (!silent) triggerPositiveEvents();

    // Crescita Demografica - CONDIZIONI MIGLIORATE
    let popGrowth = 0;
    if (county.food > 40 && county.health > 30 && county.happy > 25) { // Soglie abbassate
        popGrowth = Math.floor(county.pop * 0.015); // 1.5% crescita annuale
    } else if (county.food < 15 || county.health < 15 || county.happy < 15) { // Soglie abbassate
        popGrowth = -Math.floor(county.pop * 0.008); // 0.8% decrescita (era 1%)
    }
    county.pop = Math.max(100, county.pop + popGrowth); // Minimo 100 pop
    if (popGrowth > 0) {
        addMsg("system", `ðŸ‘¶ La popolazione cresce di ${popGrowth} anime grazie alla prosperitÃ .`);
        county.happy = Math.min(100, county.happy + 1); // NUOVO: Bonus felicitÃ  per crescita
    } else if (popGrowth < 0) {
        addMsg("system", `ðŸ’€ La popolazione diminuisce di ${Math.abs(popGrowth)} anime a causa delle difficoltÃ .`);
    }

    // Effetti di Guerra
    if (warState.mobilized) {
        // PenalitÃ  economica per la leva: meno braccia nei campi
        // Riduciamo la produzione di grano simulata
        county.resources.grain = Math.floor(county.resources.grain * 0.6); 
        addMsg("system", "ðŸ“‰ I raccolti soffrono a causa della mancanza di contadini (Leva attiva).");
    }

    if (warState.active) {
        // Costo della guerra
        const warCost = (populationGroups.militia.count * 2) + (warState.leviesCount * 1);
        county.gold -= warCost;
        detailedBudget.expenses.upkeep_military += warCost;
        addMsg("system", `âš”ï¸ Spese di guerra: -${warCost} oro per rifornimenti.`);
        
        // Eventuale controattacco nemico automatico
        const enemy = neighboringCounties.find(c => c.key === warState.enemy);
        if (Math.random() < 0.3) { // 30% probabilitÃ  di raid nemico
            addMsg("system", `ðŸ”¥ Incursione nemica! Truppe di ${enemy.name} bruciano i confini.`);
            county.pop -= rand(10, 30);
            county.gold -= rand(20, 50);
        }
    }

    // Snapshot Finale & Delta
    const endSnapshot = captureResourceSnapshot();
    lastResourceDelta = computeResourceDelta(startSnapshot, endSnapshot);
    lastResourceSnapshot = cloneResourceBag(endSnapshot);
    // (Queste variabili servivano per il vecchio report, le lasciamo per sicurezza interna ma non le usiamo per stampare)
    const goldDelta = county.gold - startGold;
    const happyDelta = county.happy - startHappy;

    checkInternalStability();
    updateUI();
    autoSaveGame();

    // --- NUOVA GESTIONE OUTPUT ---
    if (!silent) {
        // Abbiamo rimosso tutti i vecchi addMsg("system", reportHTML)
        // Abbiamo rimosso triggerCourtEvent e generateWorldNarration che scrivevano in chat
        
        // L'unica cosa che deve succedere Ã¨ l'apertura del popup narrativo
        setTimeout(() => {
            generateSeasonStory();
            // Dopo la narrazione, controlla se un vicino vuole parlare
            setTimeout(() => checkDiplomaticIntrusion(), 2000);
        }, 1000);
    }
}

// =======================================
// CREA IL BLOCCO AZIONI IN CHAT
// =======================================
function appendActionsBlock(actions) {
    const chatLog = document.getElementById("chat-log");
    
    // Crea il contenitore
    const box = document.createElement("div");
    box.className = "msg-actions";
    
    // Titolo
    const header = document.createElement("div");
    header.className = "action-header";
    header.textContent = "AZIONI POSSIBILI";
    box.appendChild(header);

    // Crea i pulsanti
    actions.forEach(a => {
        const btn = document.createElement("button");
        btn.className = "action-card"; // Assicurati che questa classe abbia lo stile nel CSS
        
        // Aggiungiamo un cursore puntatore per far capire che Ã¨ cliccabile
        btn.style.cursor = "pointer"; 
        btn.innerHTML = a.label; // Usa innerHTML per permettere le emoji

        // --- IL FIX FONDAMENTALE ---
        // Assegniamo la funzione direttamente, non come stringa HTML
        btn.onclick = function() {
            console.log("Azione cliccata:", a.code); // Debug nella console
            executeAction(a.code);
            // Opzionale: Rimuovi i pulsanti dopo il click per evitare click doppi
            box.remove(); 
        };

        box.appendChild(btn);
    });

    chatLog.appendChild(box);
    // Scroll automatico verso il basso
    chatLog.scrollTop = chatLog.scrollHeight;
}

// =======================================
// ESEGUI L'AZIONE SCELTA
// =======================================
function executeAction(action) {
    console.log("Azione selezionata:", action);
    let userMessage = "";

    if (action.startsWith("diplo_")) {
        handleDiplomaticAction(action);
        return;
    }

    // --- NUOVI COMANDI FINANZIARI ---
    if (action.startsWith("donate_")) {
        const faction = action.split("_")[1];
        donateToFaction(faction);
        userMessage = `Ho inviato una donazione ai ${factionLabel(faction)}.`;
    } 
    else if (action.startsWith("loan_")) {
        const faction = action.split("_")[1];
        requestLoan(faction);
        userMessage = `Ho chiesto un prestito ai ${factionLabel(faction)}.`;
    } 
    else if (action.startsWith("seize_")) {
        const faction = action.split("_")[1];
        seizeAssets(faction);
        userMessage = `Ho ordinato la confisca dei beni dei ${factionLabel(faction)}.`;
    }
    
    // ... (i tuoi casi esistenti build_ ecc.) ...
    else if (action.startsWith("build_")) {
        const type = action.substring(6); // Rimuove "build_" per ottenere il tipo completo
        if (buildingData[type]) {
            orderBuilding(type);
            const b = buildingData[type];
            userMessage = `Ho ordinato la costruzione di ${b.name}.`;
        } else {
            console.error(`Edificio sconosciuto: ${type}`);
            userMessage = `Errore: Edificio ${type} non trovato.`;
        }
    } else if (action === "emergency_tax_merchants") {
        county.gold += 50;
        factions.burghers = Math.max(0, factions.burghers - 10);
        addMsg("system", "ðŸ’° Tassa straordinaria imposta ai mercanti: +50 oro, ma la loro lealtÃ  cala.");
        updateUI();
        userMessage = "Ho imposto una tassa straordinaria ai mercanti per riempire le casse.";
    } else if (action === "emergency_tax_church") {
        county.gold += 30;
        factions.clergy = Math.max(0, factions.clergy - 15);
        addMsg("system", "â›ª Beni requisiti alla Chiesa: +30 oro, ma i religiosi sono infuriati.");
        updateUI();
        userMessage = "Ho requisito beni alla Chiesa per finanziare il regno.";
    } else if (action === "open_law_modal") {
        document.getElementById("modal-law-creator").classList.add("active");
        userMessage = "Voglio creare una nuova legge per il regno.";
    } else if (action === "recruit_militia") {
        county.militia = (county.militia || 0) + 10;
        county.gold -= 20;
        addMsg("system", "ðŸŽ–ï¸ Reclutati 10 uomini per la milizia: -20 oro.");
        updateUI();
        userMessage = "Ho reclutato nuovi uomini per la milizia.";
    } 
    // Aggiungi dentro executeAction(action)
    else if (action.startsWith("revolt_crush_")) {
        const faction = action.split("_")[2];
        const rebels = populationGroups[faction].count;
        const militaryPower = calculateMilitaryPower(); // Funzione creata nel passo precedente
        
        // Per vincere, la potenza militare deve superare la "potenza" della folla
        // La folla Ã¨ numerosa ma debole (diviso 10)
        const rebelPower = rebels / 5; 
        
        if (militaryPower > rebelPower) {
            const deadRebels = Math.floor(rebels * 0.3);
            populationGroups[faction].count -= deadRebels;
            factions[faction] = 10; // Sottomessi ma odiano
            county.happy -= 20;
            rebellionState[faction] = 0; // Reset rabbia (paura)
            
            addMsg("system", `ðŸ©¸ <strong>MASSACRO:</strong> La milizia ha disperso la folla. ${deadRebels} morti. Il tuo trono Ã¨ salvo, ma macchiato di sangue.`);
            updateUI();
        } else {
            triggerGameOver("overrun", faction);
        }
    }

    else if (action.startsWith("revolt_speak_")) {
        // Tentativo diplomatico
        const chance = (county.happy / 200) + 0.2; // Max ~70% se molto felici
        if (Math.random() < chance) {
            addMsg("system", "ðŸ—£ï¸ Le tue parole hanno toccato il cuore della folla. Si disperdono pacificamente.");
            rebellionState[action.split("_")[2]] = 3;
        } else {
            triggerGameOver("mob_kill");
        }
    }

    else if (action === "gameover_abdicate") {
        triggerGameOver("abdication");
    }
    else if (action === "coup_mercenaries") {
        if (county.gold >= 300) {
            county.gold -= 300;
            addMsg("system", "ðŸ’° I mercenari hanno difeso il castello! Il traditore Ã¨ stato catturato e giustiziato.");
            rebellionState.militia = 0; // Reset rabbia
            factions.militia = 20; // Umiliati
        } else {
            triggerGameOver("coup");
        }
    }
    else if (action === "coup_duel") {
        const chance = (county.health / 200) + 0.3; // Base 30% + salute
        if (Math.random() < chance) {
            addMsg("system", "âš”ï¸ Hai sconfitto il traditore in duello! La milizia si sottomette.");
            rebellionState.militia = 0;
            factions.militia = 15;
        } else {
            triggerGameOver("coup");
        }
    }
    // Aggiungi dentro executeAction(action)
    else if (action === "edict_prioritize_food") {
        // Imposta prioritÃ  ALTA a tutte le fattorie e mulini
        buildings.forEach(b => {
            if (['wheat_farm', 'sheep_farm', 'mill', 'bakery', 'granary'].includes(b.type)) {
                b.priority = 'high';
            } else {
                b.priority = 'normal'; // Normalizza gli altri per liberare risorse
            }
        });
        addMsg("system", "ðŸ“œ <strong>Editto del Pane:</strong> Tutte le strutture alimentari hanno prioritÃ  assoluta sulla manodopera.");
        updateUI();
        userMessage = "Ho ordinato che tutti i lavoratori disponibili si concentrino sulla produzione di cibo!";
    }
    
    else if (action === "edict_prioritize_industry") {
        buildings.forEach(b => {
            if (['iron_mine', 'sawmill', 'forge', 'textile_factory', 'tool_smith'].includes(b.type)) {
                b.priority = 'high';
            } else {
                b.priority = 'normal';
            }
        });
        addMsg("system", "ðŸ“œ <strong>Editto Industriale:</strong> PrioritÃ  alle miniere e manifatture.");
        updateUI();
        userMessage = "Voglio che l'industria lavori a pieno regime, spostate i contadini nelle miniere!";
    }

    else {
        userMessage = action; // Fallback
    }

    // Dopo l'azione, fai reagire l'IA
    if (userMessage) {
        addMsg("user", userMessage);
        callGroq(userMessage, "action");
    }
}

function generateWorldNarration() {
    let narration = `<strong>ðŸŒ Notizie dal Mondo Esterno:</strong><br>`;

    neighboringCounties.forEach(c => {
        const relationLevel = c.relations > 70 ? "alleate" : c.relations > 40 ? "neutra" : "ostile";
        const activity = c.aggression > 50 ? "prepara incursioni" : c.power > county.power * 1.2 ? "rafforza le difese" : "commercia pacificamente";

        narration += `${c.name} (${relationLevel}): ${c.description.split('.')[0]}. Attualmente ${activity}.<br>`;
    });

    // Aggiungi eventi casuali mondiali
    if (rand(0, 10) > 7) {
        const events = [
            "Banditi infestano le strade tra le contee, rallentando i commerci.",
            "Una carestia colpisce regioni lontane, aumentando la domanda di grano.",
            "Alleanze matrimoniali si formano tra nobili delle contee vicine."
        ];
        narration += `<em>${events[Math.floor(Math.random() * events.length)]}</em>`;
    }

    return narration;
}

function advanceSeasonManually() {
    addMsg("system", "âž¡ï¸ Il Conte ordina di passare alla stagione successiva.");
    progressSeason({ silent:false });
}

function send() {
    ensureWorldSystems();
    const input = document.getElementById("u-input");
    const text = input.value.trim();
    if (!text) return;

    input.value = "";
    if (text === "/avanza") {
        advanceSeasonManually();
        return;
    }

    addMsg("user", text);

    // Ora IA (parte 6)
    callGroq(text, "action");
}

function timestamp() {
    return new Date().toLocaleTimeString("it-IT", {
        hour: "2-digit",
        minute: "2-digit"
    });
}

function addMsg(type, text) {
    const log = document.getElementById("chat-log");
    const div = document.createElement("div");

    // Gestione speciale per i messaggi delle fazioni (Riconosciuti dal nome in grassetto all'inizio)
    // L'IA tende a rispondere "Lord Emeric: ..." -> Lo intercettiamo
    if (type === 'ai' && text.includes(':')) {
        const parts = text.split(':');
        const possibleName = parts[0].trim().replace(/\*/g, ''); // Rimuovi bold markdown
        
        // Cerca se il nome corrisponde a una fazione
        let foundFaction = null;
        const factionNamesMap = {
            "Lord Emeric": "nobility", "Vescovo Aldebrando": "clergy", 
            "Capitano Ronan": "militia", "Odric": "peasants", 
            "Maestro Bernard": "burghers", "Ser Lothar": "merchants",
            "Madre Elowen": "mystics", "Rasko": "outcasts"
        };
        
        // Match parziale del nome
        for(let name in factionNamesMap) {
            if (possibleName.includes(name) || possibleName.includes(name.split(" ")[1])) {
                foundFaction = factionNamesMap[name];
                break;
            }
        }

        if (foundFaction) {
            // Renderizza come Card Fazione
            div.className = `msg-faction ${foundFaction}`;
            div.innerHTML = `
                <div class="faction-avatar">${FACTION_ICONS[foundFaction] || 'ðŸ‘¤'}</div>
                <span class="faction-title">${possibleName}</span>
                <div class="msg-text">${parts.slice(1).join(':').trim()}</div>
            `;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            return;
        }
    }

    // Fallback standard
    if (type === "system") {
        div.className = "msg-system";
        div.innerHTML = text; // Permetti HTML per il report
    } else {
        div.className = `msg msg-${type}`;
        div.innerHTML = `<div class="msg-text">${text}</div><div class="msg-meta">${timestamp()}</div>`;
    }
    
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

function addEventCard(text) {
    if (!text) return;
    const feed = document.getElementById("event-feed");
    if (!feed) return;

    const emptyState = feed.querySelector(".event-empty");
    if (emptyState) emptyState.remove();

    const card = document.createElement("div");
    card.className = "event-card";
    card.innerHTML = `
        <div class="event-time">${timestamp()}</div>
        <div class="msg-text">${text}</div>
    `;

    feed.prepend(card);

    const cards = feed.querySelectorAll(".event-card");
    if (cards.length > 8) {
        feed.removeChild(feed.lastElementChild);
    }
}

function addAdviceCard(text) {
    if (!text) return;
    const feed = document.getElementById("advice-feed");
    if (!feed) return;

    const emptyState = feed.querySelector(".advice-empty");
    if (emptyState) emptyState.remove();

    const card = document.createElement("div");
    card.className = "event-card";
    card.innerHTML = `
        <div class="event-time">${timestamp()}</div>
        <div class="msg-text">${text}</div>
    `;

    feed.prepend(card);

    const cards = feed.querySelectorAll(".event-card");
    if (cards.length > 6) {
        feed.removeChild(feed.lastElementChild);
    }
}

function renderActionSuggestions(actions, promptText = "Scegli un'azione proposta dalla corte.") {
    const list = document.getElementById("action-list");
    const promptEl = document.getElementById("action-prompt");
    if (!list || !promptEl) return;

    promptEl.innerText = promptText || "Scegli un'azione proposta dalla corte.";
    list.innerHTML = "";

    if (!actions.length) {
        promptEl.innerText = "In attesa di nuovi suggerimenti dalla corte.";
        list.innerHTML = '<p class="action-empty">Nessuna proposta al momento.</p>';
        return;
    }

    actions.forEach(action => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "action-card";
        btn.innerHTML = `<strong>${action.title}</strong><span>${action.desc}</span>`;
        btn.addEventListener("click", () => {
            const input = document.getElementById("u-input");
            if (!input) return;
            input.value = action.command || action.title;
            input.focus();
        });
        list.appendChild(btn);
    });
}

function extractActionsFromText(text) {
    const lower = text.toLowerCase();
    const idx = lower.indexOf("ecco le azioni");
    if (idx === -1) {
        return { remainingText: text, actions: [], prompt: "" };
    }

    const actionBlock = text.slice(idx).trim();
    const promptLineMatch = actionBlock.match(/^[^\n]+/);
    let prompt = promptLineMatch ? promptLineMatch[0].trim() : "Scegli un'azione proposta dalla corte.";
    const questionMatch = actionBlock.match(/Quale azione[^\n]*/i);
    if (questionMatch) prompt = questionMatch[0].trim();

    const listText = actionBlock.replace(/^[^\n]+\n?/, "").trim();
    const regex = /- \*\*(.+?)\*\*:([\s\S]*?)(?=\n- \*\*|$)/g;
    const actions = [];
    let match;
    while ((match = regex.exec(listText)) !== null) {
        actions.push({
            title: match[1].trim(),
            desc: match[2].replace(/\s+/g, " ").trim(),
            command: match[1].trim()
        });
    }

    return {
        remainingText: text.slice(0, idx).trim(),
        actions,
        prompt
    };
}

function askAdvisor() {
    // 1. Feedback visivo immediato nella chat principale
    addMsg("system", "ðŸ§  Il Conte ha convocato Ser Dorian per un consulto privato...");

    // 2. Costruzione contesto
    let problems = [];
    if (county.gold < 100) problems.push("siamo poveri");
    if (county.food < 50) problems.push("c'Ã¨ poca cibo");
    if (county.security < 40) problems.push("i confini sono deboli");
    
    const context = problems.length 
        ? `Mio signore, ${problems.join(", ")}. Dobbiamo agire.` 
        : "La situazione Ã¨ stabile, ma possiamo sempre migliorare.";

    // 3. Chiamata API con modalitÃ  'advice'
    // Nota: usiamo un prompt specifico per evitare conflitti con la chat
    const prompt = `
    ${context}
    Analizza la situazione attuale (Anno ${worldTime.year}, ${getSeason().label}) e dammi 2 consigli strategici brevi e diretti.
    `;
    
    callGroq(prompt, "advice");
}

function openBudgetModal() {
    const modal = document.getElementById("modal-budget");
    if (modal) {
        renderBudget();
        modal.classList.add("active");
    }
}

function closeLawModal() {
    document.getElementById("modal-law-creator").classList.remove("active");
}

function createLaw() {
    const name = document.getElementById("law-name").value.trim();
    const desc = document.getElementById("law-desc").value.trim();
    const upkeep = parseInt(document.getElementById("law-upkeep").value) || 0;
    const resourceKey = document.getElementById("law-resource").value;
    const resourceAmount = parseInt(document.getElementById("law-resource-amount").value) || 0;

    if (!name) {
        alert("Inserisci un nome per la legge.");
        return;
    }

    const lawKey = name.toLowerCase().replace(/\s+/g, '_');
    const law = {
        name: name,
        desc: desc,
        upkeepCost: upkeep,
        consumeResource: resourceAmount > 0 ? { [resourceKey]: resourceAmount } : null
    };

    // Aggiungi alla lista delle leggi disponibili (fittizia, in realtÃ  salva in activeLaws)
    activeLaws.push(lawKey);
    // Salva la definizione
    if (!window.lawDefinitions) window.lawDefinitions = {};
    window.lawDefinitions[lawKey] = law;

    addMsg("system", `ðŸ“œ Nuova legge promulgata: <strong>${name}</strong> - ${desc}`);
    closeLawModal();
    updateUI();
}

function getLawDefinition(key) {
    return window.lawDefinitions ? window.lawDefinitions[key] : null;
}

function renderBudget() {
    const container = document.getElementById("budget-content");
    if (!container) return;

    const inc = detailedBudget.income;
    const exp = detailedBudget.expenses;
    const totalInc = Object.values(inc).reduce((a,b)=>a+b,0);
    const totalExp = Object.values(exp).reduce((a,b)=>a+b,0);

    // Calcolo entrate dei pop per dare visione completa economia
    const popIncomes = {
        peasants: Math.floor(
            (populationGroups.peasants.count * 0.08) +
            ((county.resources.grain || 0) * 0.005) +
            ((county.resources.livestock || 0) * 0.01)
        ),
        burghers: Math.floor(
            (populationGroups.burghers.count * 1.5) +
            ((county.resources.textiles || 0) * 0.25) +
            ((county.resources.iron || 0) * 0.3) +
            ((county.resources.copper || 0) * 0.35)
        ),
        merchants: Math.floor(
            (populationGroups.merchants.count * 3) +
            ((seasonalTransactions.marketSales + seasonalTransactions.marketPurchases) * 0.12) +
            ((county.resources.luxuries || 0) * 0.4)
        ),
        nobility: Math.floor(
            (landOwnership.nobility * 8) +
            (county.gold * 0.015) +
            ((county.resources.grain || 0) * 0.03) +
            (populationGroups.nobility.count * 15)
        ),
        clergy: Math.floor(
            (landOwnership.clergy * 6) +
            (county.gold * 0.012) +
            (county.pop * 0.015) +
            (populationGroups.clergy.count * 8)
        )
    };

    container.innerHTML = `
        <div class="budget-columns">
            <div class="budget-col">
                <h4>ðŸ’° Entrate Tesoro (+${totalInc})</h4>
                <div class="budget-row"><span>Tasse NobiltÃ </span> <span>${inc.taxes_nobility}</span></div>
                <div class="budget-row"><span>Tasse Borghesia</span> <span>${inc.taxes_burghers}</span></div>
                <div class="budget-row"><span>Tasse Contadini</span> <span>${inc.taxes_peasants}</span></div>
                <div class="budget-row"><span>Altri Ceti</span> <span>${inc.taxes_other}</span></div>
                <div class="budget-row"><span>Commercio/Export</span> <span>${inc.trade_export}</span></div>
                <div class="budget-row"><span>Produzione (Zecca)</span> <span>${inc.production_mint}</span></div>
            </div>
            
            <div class="budget-col">
                <h4>ðŸ’¸ Uscite Tesoro (-${totalExp})</h4>
                <div class="budget-row"><span>Militare & Difesa</span> <span class="money-minus">${exp.upkeep_military}</span></div>
                <div class="budget-row"><span>Corte & Prestigio</span> <span class="money-minus">${exp.upkeep_court}</span></div>
                <div class="budget-row"><span>Civile & Mercati</span> <span class="money-minus">${exp.upkeep_civil}</span></div>
                <div class="budget-row"><span>Infrastrutture</span> <span class="money-minus">${exp.upkeep_infrastructure}</span></div>
                <div class="budget-row"><span>Leggi & Welfare</span> <span class="money-minus">${exp.welfare_laws}</span></div>
                <div class="budget-row"><span>Importazioni</span> <span class="money-minus">${exp.import_costs}</span></div>
            </div>
        </div>
        
        <div class="net-balance-card">
            <div>Bilancio Tesoro</div>
            <div class="net-balance-val ${detailedBudget.net >= 0 ? 'money-plus' : 'money-minus'}">
                ${detailedBudget.net > 0 ? '+' : ''}${detailedBudget.net} ðŸ’°
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:5px;">
                Tesoro Attuale: ${county.gold} ðŸ’°
            </div>
        </div>

        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-soft);">
            <h4 style="color: var(--accent); margin-bottom: 10px;">ðŸ“Š Economia dei Ceti (redditi stagionali)</h4>
            <div class="budget-columns">
                <div class="budget-col">
                    <div class="budget-row"><span>ðŸ‘¨â€ðŸŒ¾ Contadini</span> <span>${popIncomes.peasants} ðŸ’°</span></div>
                    <div class="budget-row"><span>ðŸª Borghesi</span> <span>${popIncomes.burghers} ðŸ’°</span></div>
                    <div class="budget-row"><span>ðŸ’¼ Mercanti</span> <span>${popIncomes.merchants} ðŸ’°</span></div>
                </div>
                <div class="budget-col">
                    <div class="budget-row"><span>ðŸ‘‘ NobiltÃ </span> <span>${popIncomes.nobility} ðŸ’°</span></div>
                    <div class="budget-row"><span>â›ª Clero</span> <span>${popIncomes.clergy} ðŸ’°</span></div>
                </div>
            </div>
            <div style="font-size: 0.75em; color: var(--text-soft); margin-top: 8px; font-style: italic;">
                Questi redditi vengono guadagnati dai ceti attraverso produzione, commercio e rendite. 
                Il Tesoro della Contea li tassa attraverso le aliquote impostate.
            </div>
        </div>
    `;
}

</script>
<script>

/* ============================================================
   ========================= GROQ ENGINE ========================
   ============================================================ */

async function callGroq(userText, mode="action", retryCount = 0) {
    if (!ensureApiKey()) {
        addMsg("system", "ðŸ” Inserisci una chiave API.");
        activateScreen("screen-login");
        return;
    }

    // Stop dopo 3 tentativi per evitare loop infiniti
    if (retryCount > 3) {
        addMsg("system", "âš ï¸ La Corte Ã¨ troppo affollata (Server occupato). Riprova tra poco.");
        return;
    }

    const promptData = buildPrompt(userText, mode);
    
    // OTTIMIZZAZIONE 1: Riduciamo la memoria storica per risparmiare token
    // Invece di 10 messaggi, ne teniamo solo 4 (piÃ¹ che sufficienti per il contesto immediato)
    if (publicChatHistory.length > 4) {
        publicChatHistory = publicChatHistory.slice(-4);
    }

    publicChatHistory.push({ role: "user", content: userText });

    const apiMessages = [
        { role: "system", content: promptData.system },
        ...publicChatHistory
    ];

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type":"application/json",
                "Authorization":"Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.6,
                messages: apiMessages
            })
        });

        // GESTIONE ERRORE RATE LIMIT (429)
        if (resp.status === 429) {
            console.warn("Rate limit colpito. Attendo 2.5s...");
            // Rimuove l'ultimo messaggio utente dalla storia per non duplicarlo nel retry
            publicChatHistory.pop(); 
            // Aspetta 2500ms
            await new Promise(resolve => setTimeout(resolve, 2500));
            // Riprova ricorsivamente
            return callGroq(userText, mode, retryCount + 1);
        }

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error?.message || 'API Error');

        const aiMsg = data.choices[0].message.content;
        publicChatHistory.push({ role: "assistant", content: aiMsg });
        handleAIResponse(aiMsg, mode);

    } catch(e) {
        // Se Ã¨ un errore diverso dal 429, lo mostriamo
        console.error(e);
        addMsg("system", "âš ï¸ Il consigliere tace (Errore: " + e.message + ")");
        publicChatHistory.pop(); // Clean up
    }
}


function getChatName(key) {
    // Gestione dinamica Eredi
    if (key.startsWith('heir_')) {
        const idx = parseInt(key.split('_')[1]);
        return dynasty.heirs[idx] ? dynasty.heirs[idx].name : "Erede";
    }

    // Gestione dinamica Pretendenti (Chat pre-matrimonio)
    if (key.startsWith('suitor_')) {
        const idx = parseInt(key.split('_')[1]);
        return activeSuitorsList[idx] ? activeSuitorsList[idx].name : "Pretendente";
    }

    // Gestione consorte
    if (key === 'spouse') {
        return dynasty.spouse ? dynasty.spouse.name : "Consorte";
    }

    // Prima prova a usare FACTION_PERSONALITIES (sistema nuovo)
    if (FACTION_PERSONALITIES[key]) {
        return FACTION_PERSONALITIES[key].name;
    }

    // Fallback per contee vicine e altri casi speciali
    const fallbackMap = {
        auvrey: "Messo di Auvrey", 
        falken: "Ambasciatrice Falken"
    };

    return fallbackMap[key] || key;
}



/* ==================== CHAT PRIVATA ==================== */

async function callGroqPrivate(factionKey, userText) {

    if (!ensureApiKey()) {
        addPrivateMsg("system", "ðŸ” Chiave API mancante.");
        return;
    }

    const promptData = buildPrivatePrompt(factionKey, userText);
    
    // Recupera storico (assicurati che privateChats[factionKey] esista)
    if (!privateChats[factionKey]) privateChats[factionKey] = [];
    const history = privateChats[factionKey].slice(-6).map(msg => ({
        role: msg.from === "user" ? "user" : "assistant",
        content: msg.text // Nota: qui salviamo il testo pulito
    }));

    const apiMessages = [
        { role: "system", content: promptData.system },
        ...history,
        { role: "user", content: promptData.user }
    ];

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":"Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.8,
                messages: apiMessages
            })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error('API Error');

        let rawMsg = data.choices[0].message.content;
        
        // --- PARSING DELLA RISPOSTA ---
        let cleanMsg = rawMsg;
        let relChange = 0;
        let suggestedEnd = false;

        // 1. Estrai cambio relazione [REL: +/-X]
        const relMatch = rawMsg.match(/\[REL:\s*([+-]?\d+)\]/i);
        if (relMatch) {
            relChange = parseInt(relMatch[1]);
            cleanMsg = cleanMsg.replace(relMatch[0], ""); // Rimuovi dal testo visibile
        }

        // 2. Estrai status fine [STATUS: END]
        if (rawMsg.includes("[STATUS: END]")) {
            suggestedEnd = true;
            cleanMsg = cleanMsg.replace("[STATUS: END]", "");
        }

        cleanMsg = cleanMsg.trim();

        // --- APPLICAZIONE EFFETTI ---
        if (relChange !== 0) {
            applyPrivateRelationChange(factionKey, relChange);
        }

        // Salvataggio e Display
        privateChats[factionKey].push({ from:"ai", text: cleanMsg });
        addPrivateMsg("ai", cleanMsg);

        // Se l'IA suggerisce di chiudere o se c'Ã¨ un cambio relazione, mostra feedback
        if (relChange !== 0) {
            const sign = relChange > 0 ? "+" : "";
            const color = relChange > 0 ? "#6ada91" : "#ff7c7c";
            addPrivateMsg("system", `<span style="color:${color}">Rapporto ${sign}${relChange}</span>`);
        }

        if (suggestedEnd) {
            showPrivateActions(factionKey); // Mostra bottoni azione finale
        }

    } catch(e) {
        addPrivateMsg("system", "âš ï¸ Errore comunicazione: " + e);
    }
}


// Funzione helper per applicare i cambiamenti matematici
function applyPrivateRelationChange(key, delta) {
    // Caso Pretendente
    if (key.startsWith('suitor_')) {
        const idx = parseInt(key.split('_')[1]);
        const suitor = activeSuitorsList[idx];
        if (suitor) {
            suitor.relation = Math.max(0, Math.min(100, suitor.relation + delta));
            // Aggiorna UI se necessario (es. ricarica modale se aperto)
        }
    }
    // Caso Fazione / Personaggio Standard
    else {
        // Mappa chiave chat -> chiave fazione
        const map = {
            nobility:"nobility", clergy:"clergy", militia:"militia", 
            peasants:"peasants", burghers:"burghers", merchants:"merchants", 
            mystics:"mystics", outcasts:"outcasts"
        };
        
        // Se stiamo parlando con Lord Emeric (nobility), aggiorna la fazione nobility
        const factionKey = map[key] || key; // Fallback se la chiave Ã¨ giÃ  quella giusta
        if (factions[factionKey] !== undefined) {
            factions[factionKey] = Math.max(0, Math.min(100, factions[factionKey] + delta));
        }
    }
}

function showPrivateActions(key) {
    const log = document.getElementById("private-chat-log");
    const actionsDiv = document.createElement("div");
    actionsDiv.className = "msg-actions";
    actionsDiv.style.marginTop = "15px";

    let html = `<div class="action-header">Concludi Colloquio</div>`;

    // Azioni Comuni
    html += `<button class="btn-sec" onclick="endPrivateChat('${key}', 'bye')">ðŸ‘‹ Congeda / Arrivederci</button>`;

    // Azioni Specifiche per Pretendenti
    if (key.startsWith('suitor_')) {
        const idx = parseInt(key.split('_')[1]);
        const suitor = activeSuitorsList[idx];
        
        if (suitor.relation >= 60) {
             html += `<button class="btn-main" onclick="endPrivateChat('${key}', 'marry')">ðŸ’ Proponi Matrimonio</button>`;
        } else {
             html += `<button class="btn-sec" disabled style="opacity:0.5">ðŸ’ Proponi Matrimonio (Rapporto insufficiente)</button>`;
        }
        
        html += `<button class="btn-sec" onclick="giveGiftToSuitor(${idx})">ðŸŽ Invia Regalo (+Relazione)</button>`;
    }

    actionsDiv.innerHTML = html;
    log.appendChild(actionsDiv);
    log.scrollTop = log.scrollHeight;
}

function endPrivateChat(key, action) {
    const log = document.getElementById("private-chat-log");
    
    if (action === 'bye') {
        addPrivateMsg("user", "Arrivederci.");
        setTimeout(() => {
            addPrivateMsg("system", "Il colloquio Ã¨ terminato.");
            closePrivateChat();
        }, 800);
    }
    
    if (action === 'marry') {
        const idx = parseInt(key.split('_')[1]);
        addPrivateMsg("user", "Vuoi unire la tua casata alla mia?");
        setTimeout(() => {
            marrySuitorIndex(idx); // Funzione esistente
            closePrivateChat();
        }, 1000);
    }
}

/* ============================================================
   ======================= SUPER PROMPT =========================
   ============================================================ */

function getFeasibleActions() {
    const actions = [];
    const treasury = county.gold;
    
    // 1. ANALISI BISOGNI CRITICI (PrioritÃ  assoluta)
    if (lastNeedsReport) {
        Object.entries(lastNeedsReport).forEach(([key, data]) => {
            // Se stanno morendo di fame per povertÃ  (Prezzi alti, Ricchezza bassa)
            if (data.mainIssue && data.mainIssue.includes("POVERTÃ€") || data.wealth < 10) {
                actions.push(`DONARE ORO ai ${factionLabel(key)} (Costo: 50 oro) - Risolve la crisi economica`);
            }
            // Se stanno morendo di fame per mancanza merce
            else if (data.mainIssue && data.mainIssue.includes("CARESTIA")) {
                actions.push(`IMPORTARE CIBO d'urgenza per i ${factionLabel(key)}`);
            }
        });
    }

    // 2. ANALISI FINANZIARIA (Prestiti e Confische)
    Object.entries(populationGroups).forEach(([key, data]) => {
        const label = factionLabel(key);
        
        // Se la fazione Ã¨ molto ricca e il Conte ha meno di 200 oro -> Suggerisci Prestito o Tassa
        if (data.wealth > 300 && treasury < 200) {
            actions.push(`CHIEDERE PRESTITO ai ${label} (Ottieni 100 oro, -5 LealtÃ )`);
            if (factions[key] < 40) {
                // Se sono giÃ  ostili, tanto vale confiscare
                actions.push(`CONFISCARE BENI ai ${label} (Ottieni ${Math.floor(data.wealth/2)} oro, -25 LealtÃ )`);
            }
        }
        
        // Se la fazione Ã¨ arrabbiata (LealtÃ  < 40) ma non povera -> Corruzione/Regalo
        if (factions[key] < 40 && treasury > 100) {
            actions.push(`INVIARE DONO ai ${label} per calmarli (Costo: 50 oro)`);
        }
    });

    // 3. PROPOSTE COSTRUZIONI (Solo se pertinenti)
    if (treasury > 100) {
        if (county.food < 100) actions.push("COSTRUIRE Fattoria o Granaio (PrioritÃ  Cibo)");
        if (county.security < 40) actions.push("COSTRUIRE Torre di Guardia o Caserma (PrioritÃ  Sicurezza)");
    } else {
        actions.push("RISPARMIARE ORO (Nessuna costruzione consigliata)");
    }

    // Mescoliamo e prendiamo max 4 suggerimenti per non confondere l'IA
    return actions.sort(() => 0.5 - Math.random()).slice(0, 4).join("\n- ");
}

function getDynamicActions(response = "") {
    const actions = [];
    const lower = response.toLowerCase();

    // ... (tuoi controlli esistenti su costruzioni) ...
    if (lower.includes("costruzione") || lower.includes("edificio") || lower.includes("costruire")) {
        // Edifici costruibili
        const buildable = Object.entries(buildingData).filter(([key, data]) => {
            return checkResources(data.cost);
        });

        buildable.slice(0, 3).forEach(([key, data]) => {  // Limita a 3
            const effects = [];
            if (data.effect) effects.push(data.effect);
            if (data.housing) effects.push(`+${data.housing} alloggi`);
            effects.push(`LealtÃ  contadini +5`);
            const effectDesc = effects.join(", ");
            actions.push({
                label: `ðŸ—ï¸ Costruisci ${data.name} (${data.cost.gold} oro) - ${effectDesc}`,
                code: `build_${key}`
            });
        });
    }

    // Rilevamento intelligente delle azioni finanziarie
    Object.keys(populationGroups).forEach(key => {
        const label = factionLabel(key).toLowerCase();
        
        // DONAZIONI
        if (lower.includes(`donare`) && lower.includes(label)) {
            actions.push({
                label: `ðŸŽ Dona 50 oro ai ${factionLabel(key)}`,
                code: `donate_${key}`
            });
        }
        
        // PRESTITI
        if ((lower.includes(`prestito`) || lower.includes(`chiedere oro`)) && lower.includes(label)) {
            actions.push({
                label: `ðŸ’° Chiedi prestito ai ${factionLabel(key)}`,
                code: `loan_${key}`
            });
        }
        
        // CONFISCHE
        if ((lower.includes(`confiscare`) || lower.includes(`tassa`) || lower.includes(`requisire`)) && lower.includes(label)) {
            actions.push({
                label: `âš–ï¸ Confisca beni ai ${factionLabel(key)}`,
                code: `seize_${key}`
            });
        }
    });

    if (lower.includes("oro") || lower.includes("tesoro") || lower.includes("soldi") || lower.includes("povero")) {
        if (county.gold < 50) {
            actions.push({
                label: "ðŸ’° Tassa straordinaria ai Mercanti - +50 oro, lealtÃ  mercanti -10, felicitÃ  generale -2",
                code: "emergency_tax_merchants"
            });
            actions.push({
                label: "â›ª Requisire beni alla Chiesa - +30 oro, lealtÃ  chiesa -15, morale nobili -3",
                code: "emergency_tax_church"
            });
        }
    }

    if (lower.includes("legge") || lower.includes("decreto") || lower.includes("regola")) {
        actions.push({
            label: "ðŸ“œ Crea una nuova legge - Personalizza effetti su tasse, produzione o fazioni",
            code: "open_law_modal"
        });
    }

    if (lower.includes("milizia") || lower.includes("soldati") || lower.includes("sicurezza") || lower.includes("banditi")) {
        actions.push({
            label: "ðŸŽ–ï¸ Convoca la milizia - +10 milizia, sicurezza +5, -20 oro, lealtÃ  contadini -2",
            code: "recruit_militia"
        });
    }

    // Se c'Ã¨ carestia o mancanza di cibo
    if (county.food < 40 || (lastNeedsReport && Object.values(lastNeedsReport).some(r => r.mainIssue.includes("CARESTIA")))) {
        actions.push({
            label: "ðŸŒ¾ PrioritÃ  Cibo (Editto) - Sposta lavoratori su campi e forni",
            code: "edict_prioritize_food"
        });
    }

    // Se c'Ã¨ disoccupazione alta o richiesta armi
    if (warState.active || county.resources.weapons < 10) {
        actions.push({
            label: "âš’ï¸ PrioritÃ  Industria (Editto) - Sposta lavoratori su miniere e fucine",
            code: "edict_prioritize_industry"
        });
    }

    return actions;
}

function generateDeepContext() {
    // VERSIONE OTTIMIZZATA (Low Token Usage)
    
    // 1. Dati Base
    let ctx = `[STATO ANNO ${worldTime.year} ${getSeason().label}]\n`;
    ctx += `CONTE: ${dynasty.ruler.name} (Salute ${dynasty.ruler.health}%). POP: ${county.pop} (FelicitÃ  ${county.happy}%, Sicurezza ${county.security}%).\n`;
    ctx += `ORO: ${county.gold}. CIBO: ${county.food}% fabbisogno.\n`;

    // 2. Guerra (Solo se attiva)
    if (warState.active) {
        ctx += `âš ï¸ GUERRA ATTIVA vs ${warState.enemy}. Leve: ${warState.mobilized ? "SÃŒ" : "NO"}. Eff. Militare: ${getArmyEfficiency()}%.\n`;
    }

    // 3. Risorse Scarse (Non elencare tutto, solo ciÃ² che manca o Ã¨ critico)
    const stats = calculateResourceStats();
    let issues = [];
    Object.entries(stats).forEach(([k, s]) => {
        if (getResourceStatus(s) === 'critical') issues.push(`${k.toUpperCase()} ESAURITO`);
        else if (getResourceStatus(s) === 'warning') issues.push(`${k} scaso`);
    });
    if (issues.length > 0) ctx += `CRISI RISORSE: ${issues.join(", ")}.\n`;

    // 4. Fazioni Arrabbiate (Solo quelle sotto 40)
    let angry = [];
    factionOrder.forEach(key => {
        if (factions[key] < 40) angry.push(`${key} (${factions[key]}%)`);
    });
    if (angry.length > 0) ctx += `RIVOLTE POSSIBILI: ${angry.join(", ")}.\n`;

    // 5. Vicini
    ctx += `VICINI: `;
    ctx += neighboringCounties.map(n => `${n.name.split(' ')[0]} (Rel ${n.relations}, Pot ${n.power})`).join(" | ");
    
    // CALCOLO STATISTICHE LAVORO PER IA
    let laborStats = "";
    const totalWorkforce = Object.values(populationGroups).reduce((sum, g) => sum + Math.floor(g.count * (g.workforceRatio||0.6)), 0);
    const totalEmployed = Object.values(populationGroups).reduce((sum, g) => sum + (g.employed || 0), 0);
    const unemploymentRate = Math.floor(((totalWorkforce - totalEmployed) / totalWorkforce) * 100);
    
    laborStats += `DISOCCUPAZIONE: ${unemploymentRate}% (Forza Lavoro: ${totalWorkforce}, Occupati: ${totalEmployed}).\n`;
    
    // Evidenzia problemi specifici
    if (populationGroups.burghers.employed >= Math.floor(populationGroups.burghers.count * 0.8)) {
        laborStats += "CRITICO: Mancano artigiani qualificati per le fabbriche.\n";
    }
    if (populationGroups.peasants.literacy < 10) {
        laborStats += "ISTRUZIONE: Bassa. Difficile trovare lavoratori qualificati.\n";
    }

    ctx += laborStats;
    
    return ctx;
}

/* ===================== DIPLOMAZIA VIVA ===================== */

function checkDiplomaticIntrusion() {
    // Se siamo giÃ  in guerra o in dialogo, evita
    if (activeDiplomacy.active || warState.active) return;

    // 30% di probabilitÃ  che un vicino intervenga a stagione
    if (Math.random() > 0.3) return;

    const neighbor = neighboringCounties[Math.floor(Math.random() * neighboringCounties.length)];
    const turn = county.turn;

    // Evita spam (minimo 2 turni di pausa)
    if (turn - neighbor.lastInteraction < 2) return;
    
    neighbor.lastInteraction = turn;
    triggerForeignDialog(neighbor);
}

async function triggerForeignDialog(neighbor) {
    activeDiplomacy.active = true;
    activeDiplomacy.partner = neighbor.key;

    // Determina l'intento in base alle statistiche
    let intent = "neutral";
    let contextPrompt = "";

    // CASO 1: Minaccia di Guerra (Relazioni basse o AggressivitÃ  alta)
    if (neighbor.relations < 30 || neighbor.aggression > 70) {
        activeDiplomacy.type = "threat";
        intent = "hostile";
        contextPrompt = `
        Il tuo obiettivo Ã¨ minacciare il giocatore. Sei furioso.
        Pretendi un tributo di ${Math.floor(county.gold * 0.2)} oro o cedi territorio, altrimenti sarÃ  guerra.
        Sii arrogante.
        `;
    }
    // CASO 2: Richiesta Commerciale (Falken o ricchi)
    else if (neighbor.key === 'falken' || neighbor.wealth < 30) {
        activeDiplomacy.type = "trade";
        intent = "mercantile";
        contextPrompt = `
        Vuoi comprare risorse o chiedere un prestito.
        Sii diplomatico ma viscido. Proponi un affare.
        `;
    }
    // CASO 3: Alleanza/Saluti (Relazioni alte)
    else {
        activeDiplomacy.type = "greeting";
        intent = "friendly";
        contextPrompt = `
        Vieni a portare i saluti e a rafforzare l'alleanza.
        Avvisa il giocatore di eventuali pericoli esterni.
        `;
    }

    // Chiediamo all'IA di generare il messaggio di ingresso
    const systemPrompt = `
    SEI ${neighbor.ruler} di ${neighbor.name}.
    Tratti: ${neighbor.traits.join(", ")}.
    Relazione con il giocatore: ${neighbor.relations}/100.
    
    CONTESTO: Entri nella sala del trono del giocatore (Chat).
    ${contextPrompt}
    
    Scrivi SOLO il dialogo diretto tra virgolette. Max 2 frasi.
    `;

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type":"application/json", "Authorization":"Bearer " + apiKey },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.8,
                messages: [{ role: "system", content: systemPrompt }]
            })
        });
        
        const data = await resp.json();
        const msg = data.choices[0].message.content;

        // Mostra in Chat con stile speciale
        addForeignMsg(neighbor.key, neighbor.name, msg);
        
        // Aggiungi alla memoria IA
        publicChatHistory.push({ role: "assistant", content: `${neighbor.name}: "${msg}"` });

        // Genera le opzioni di risposta per il giocatore
        generateDiplomaticOptions(neighbor, activeDiplomacy.type);

    } catch(e) {
        console.error(e);
        activeDiplomacy.active = false; // Reset in caso di errore
    }
}

function addForeignMsg(key, name, text) {
    const log = document.getElementById("chat-log");
    const div = document.createElement("div");
    div.className = `msg-foreign ${key}`;
    div.innerHTML = `
        <span class="foreign-badge" style="color:white">${name}</span>
        <div class="msg-text" style="color:#eee; font-style:italic;">${text}</div>
    `;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
}

function generateDiplomaticOptions(neighbor, type) {
    const actions = [];
    
    if (type === "threat") {
        const tribute = Math.floor(county.gold * 0.2);
        actions.push({
            label: `ðŸ’¸ Paga Tributo (${tribute} oro) - Evita guerra, -Orgoglio`,
            code: `diplo_pay_${neighbor.key}_${tribute}`
        });
        actions.push({
            label: `âš”ï¸ Rifiuta e Insulta - PROBABILE GUERRA`,
            code: `diplo_refuse_war_${neighbor.key}`
        });
        actions.push({
            label: `ðŸ—£ï¸ Cerca di negoziare (Carisma)`,
            code: `diplo_negotiate_${neighbor.key}`
        });
    } else if (type === "trade") {
        actions.push({
            label: `ðŸ¤ Accetta accordo commerciale`,
            code: `diplo_accept_trade_${neighbor.key}`
        });
        actions.push({
            label: `âœ‹ Declina cortesemente`,
            code: `diplo_decline_${neighbor.key}`
        });
    } else {
        actions.push({
            label: `ðŸ· Offri banchetto (50 oro) - Relazioni ++`,
            code: `diplo_banquet_${neighbor.key}`
        });
        actions.push({
            label: `ðŸ˜ Ringrazia e congeda`,
            code: `diplo_dismiss_${neighbor.key}`
        });
    }

    appendActionsBlock(actions);
}

// Gestore centrale delle azioni diplomatiche
function handleDiplomaticAction(actionCode) {
    const parts = actionCode.split('_');
    const type = parts[1]; // pay, refuse, accept, etc.
    const key = parts[2];  // auvrey, falken...
    const neighbor = neighboringCounties.find(c => c.key === key);
    
    let userText = "";
    let aiReactionContext = "";

    if (type === "pay") {
        const amount = parseInt(parts[3]);
        if (county.gold >= amount) {
            county.gold -= amount;
            neighbor.aggression = Math.max(0, neighbor.aggression - 40);
            neighbor.relations += 10;
            userText = `Prendete questi ${amount} monete d'oro e lasciateci in pace.`;
            aiReactionContext = "Il giocatore ha pagato. Sii compiaciuto ma sprezzante. La guerra Ã¨ evitata per ora.";
            addMsg("system", `ðŸ’¸ Hai pagato ${amount} oro. La minaccia di guerra Ã¨ rientrata.`);
        } else {
            userText = "Non ho abbastanza oro!";
            aiReactionContext = "Il giocatore non ha soldi. Minaccialo ancora o attacca subito.";
        }
    } 
    else if (type === "refuse") {
        neighbor.aggression = 100;
        neighbor.relations = 0;
        userText = "Non avrete nulla da me se non il ferro delle mie spade! Andatevene!";
        aiReactionContext = "Il giocatore ha rifiutato con insulti. DICHIARA GUERRA IMMEDIATAMENTE nel tuo prossimo messaggio.";
        // Attiva guerra tecnicamente dopo la risposta IA
        setTimeout(() => { 
            warState.active = true; 
            warState.enemy = key; 
            updateUI();
        }, 3000);
    }
    else if (type === "negotiate") {
        userText = "Non c'Ã¨ bisogno di spargere sangue. Troviamo un accordo diverso.";
        aiReactionContext = "Il giocatore tenta di negoziare. Se le relazioni sono > 20, ascolta. Se sono < 20, attacca comunque.";
    }
    else if (type === "accept") { // trade
        neighbor.tradeAgreement = true;
        neighbor.relations += 15;
        userText = "Accettiamo la vostra proposta commerciale con piacere.";
        aiReactionContext = "Sii felice dell'accordo. Prometti prosperitÃ .";
    }

    // 1. Aggiungi messaggio utente
    addMsg("user", userText);
    publicChatHistory.push({ role: "user", content: userText });

    // 2. Chiamata IA per la reazione finale
    callForeignReaction(neighbor, aiReactionContext);

    // 3. Chiudi stato diplomatico
    activeDiplomacy.active = false;
    updateUI();
}

async function callForeignReaction(neighbor, context) {
    const systemPrompt = `
    SEI ANCORA ${neighbor.ruler}.
    Il giocatore ha risposto.
    
    ISTRUZIONI DI REAZIONE:
    ${context}
    
    Rispondi con una sola frase diretta.
    `;

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type":"application/json", "Authorization":"Bearer " + apiKey },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                messages: [{ role: "system", content: systemPrompt }]
            })
        });
        const data = await resp.json();
        const msg = data.choices[0].message.content;
        addForeignMsg(neighbor.key, neighbor.name, msg);
        publicChatHistory.push({ role: "assistant", content: `${neighbor.name}: "${msg}"` });
    } catch(e) {}
}

/* ===================== SISTEMA DI STABILITÃ€ E GAME OVER ===================== */

function checkInternalStability() {
    let dead = false;

    // 1. Controllo Statistiche Globali (Salute/FelicitÃ  0)
    if (county.health <= 0) {
        triggerGameOver("plague");
        return;
    }
    if (county.happy <= 0) {
        triggerGameOver("anarchy");
        return;
    }

    // 2. Controllo Fazioni
    factionOrder.forEach(key => {
        if (dead) return; // Se sei giÃ  morto, stop

        const loyalty = factions[key];
        
        // Se la lealtÃ  Ã¨ critica (< 20), aumenta la rabbia (era <= 30)
        if (loyalty <= 20) {
            rebellionState[key]++;
            handleUnrestEscalation(key, rebellionState[key]);
        } 
        // Se la lealtÃ  torna alta (> 40), la rabbia scende piÃ¹ velocemente (era > 50)
        else if (loyalty >= 40 && rebellionState[key] > 0) {
            rebellionState[key] -= 2; // Scende piÃ¹ velocemente (era -1)
        }
        // Se la lealtÃ  Ã¨ media (> 30), la rabbia scende lentamente
        else if (loyalty >= 30 && rebellionState[key] > 0) {
            rebellionState[key]--;
        }
    });
}

function handleUnrestEscalation(factionKey, level) {
    const name = factionLabel(factionKey);
    
    // LIVELLO 1: Avvertimento
    if (level === UNREST_WARNING) {
        addMsg("system", `âš ï¸ <strong>Tensione:</strong> I ${name} sono furiosi. Si mormora di tradimento.`);
        publicChatHistory.push({ role: "system", content: `[ALLARME] I ${name} stanno pianificando qualcosa contro il Conte.` });
    }
    
    // LIVELLO 2: Sabotaggio (Danni economici)
    else if (level === UNREST_DANGER) {
        addMsg("system", `ðŸ”¥ <strong>Sabotaggio:</strong> I ${name} hanno colpito le tue proprietÃ  per protesta.`);
        
        if (factionKey === 'nobility' || factionKey === 'merchants') {
            county.gold = Math.max(0, county.gold - 200); // Furto o blocco fondi
        } else {
            // Danni fisici
            county.security -= 5;
            if (county.resources.grain) county.resources.grain -= 50; // Incendio granai
        }
        updateUI();
    }
    
    // LIVELLO 3: IL COLPO FINALE (Resa dei conti)
    else if (level >= UNREST_REVOLT) {
        triggerRevoltEvent(factionKey);
    }
}

function triggerRevoltEvent(factionKey) {
    // Reset del timer per evitare loop infiniti nello stesso turno
    rebellionState[factionKey] = 5; 

    // CASO A: RIVOLTA ARMATA (Contadini, Emarginati, Borghesi)
    if (['peasants', 'outcasts', 'burghers'].includes(factionKey)) {
        const rebelCount = populationGroups[factionKey].count;
        addMsg("system", `ðŸ”¥ <strong>INSURREZIONE!</strong> Una folla di ${rebelCount} ${factionLabel(factionKey)} marcia sul castello con torce e forconi!`);
        
        // Scelta del giocatore
        const actions = [
            { label: "âš”ï¸ Ordina alla Milizia di disperderli (Sangue)", code: `revolt_crush_${factionKey}` },
            { label: "ðŸ—£ï¸ Tenta di calmarli di persona (Rischioso)", code: `revolt_speak_${factionKey}` },
            { label: "ðŸƒ Fuggi dai passaggi segreti (Abdicazione)", code: `gameover_abdicate` }
        ];
        appendActionsBlock(actions);
    }
    
    // CASO B: COLPO DI STATO MILITARE (Milizia)
    else if (factionKey === 'militia') {
        addMsg("system", `âš”ï¸ <strong>TRADIMENTO!</strong> Il Capitano Ronan entra nella sala del trono con la spada sguainata. "La contea ha bisogno di un leader forte..."`);
        
        // Se hai mercenari o nobili fedeli, forse ti salvi
        if (buildings.find(b => b.type === 'mercenary_camp' && b.stage === 'complete')) {
            const actions = [
                { label: "ðŸ’° Paga i Mercenari per difenderti (-300 oro)", code: `coup_mercenaries` },
                { label: "ðŸ’€ Affrontalo a duello", code: `coup_duel` }
            ];
            appendActionsBlock(actions);
        } else {
            triggerGameOver("coup");
        }
    }
    
    // CASO C: INTRIGO E VELENO (Nobili, Clero, Mercanti, Mistici)
    else {
        triggerAssassinationAttempt(factionKey);
    }
}

// Gestione Assassinio
function triggerAssassinationAttempt(factionKey) {
    // Calcolo probabilitÃ  sopravvivenza - MOLTO MIGLIORATA
    // Base 50% (era 30%) + Bonus Sicurezza (max 30%) + Bonus Spie (20%) + Bonus Edifici (10%)
    let survivalChance = 0.5; // Base aumentata da 0.3 a 0.5
    
    // Bonus sicurezza piÃ¹ generoso
    if (county.security > 70) survivalChance += 0.3;
    else if (county.security > 50) survivalChance += 0.2;
    else if (county.security > 30) survivalChance += 0.1;
    
    // Bonus spie
    if (factions.outcasts > 70) survivalChance += 0.2;
    else if (factions.outcasts > 50) survivalChance += 0.1;
    
    // Bonus edifici difensivi
    if (buildings.find(b => (b.type === 'walls' || b.type === 'stone_walls') && b.stage === 'complete')) {
        survivalChance += 0.05;
    }
    if (buildings.find(b => b.type === 'watchtower' && b.stage === 'complete')) {
        survivalChance += 0.05;
    }
    
    // Cap massimo al 95% (sempre un minimo rischio)
    survivalChance = Math.min(0.95, survivalChance);
    
    addMsg("system", `ðŸ•µï¸ Un'ombra si muove nella notte... I ${factionLabel(factionKey)} hanno inviato un assassino.`);
    
    if (Math.random() < survivalChance) {
        // SALVO
        addMsg("system", `ðŸ›¡ï¸ <strong>SVENTATO!</strong> Le tue guardie hanno intercettato l'assassino all'ultimo secondo. La minaccia Ã¨ passata, ma la tensione resta.`);
        rebellionState[factionKey] = Math.max(0, rebellionState[factionKey] - 3); // Reset maggiore
    } else {
        // MORTO
        triggerGameOver("assassination", factionKey);
    }
}

async function triggerGameOver(type, factionKey = "") {
    const modal = document.getElementById("modal-gameover");
    const storyDiv = document.getElementById("gameover-story");
    const factionName = factionKey ? factionLabel(factionKey) : "il destino";
    
    // Mostra subito il modale
    modal.classList.add("active");
    storyDiv.innerHTML = "<em>Scrivendo l'ultimo capitolo...</em>";
    
    // Prompt per l'IA
    let promptContext = "";
    switch(type) {
        case "plague": promptContext = "Il Conte Ã¨ morto di peste, abbandonato da tutti nel castello infetto."; break;
        case "anarchy": promptContext = "L'anarchia regna. Il Conte Ã¨ morto linciato dai suoi stessi sudditi in una rivolta generale."; break;
        case "coup": promptContext = "Il Capitano della Guardia ha decapitato il Conte e preso il potere."; break;
        case "assassination": promptContext = `Il Conte Ã¨ stato avvelenato durante un banchetto dai ${factionName}.`; break;
        case "overrun": promptContext = `La milizia ha fallito. Una folla di ${factionName} ha invaso il castello e fatto a pezzi il Conte.`; break;
        case "mob_kill": promptContext = "Il Conte ha provato a parlare alla folla, ma Ã¨ stato colpito da una pietra e linciato."; break;
        case "abdication": promptContext = "Il Conte Ã¨ fuggito nella notte, vivendo il resto dei suoi giorni in esilio come un mendicante."; break;
    }

    const systemPrompt = `
    Scrivi un breve epitaffio drammatico (max 3 frasi) per il Conte ${heroName}.
    CAUSA MORTE: ${promptContext}
    Anno: ${worldTime.year}.
    Usa un tono solenne e tragico.
    `;

    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type":"application/json", "Authorization":"Bearer " + apiKey },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                messages: [{ role: "system", content: systemPrompt }]
            })
        });
        const data = await resp.json();
        storyDiv.innerText = data.choices[0].message.content;
    } catch(e) {
        storyDiv.innerText = promptContext;
    }

    // Aggiorna statistiche finali
    document.getElementById("go-years").innerText = `${worldTime.year - 1325} anni`;
    
    // Pulisci salvataggio (Permadeath opzionale)
    // safeStorageRemove("conte_save_autosave");
}

function buildPrompt(userText, mode) {
    // 1. Genera il contesto completo e aggiornato
    const fullContext = generateDeepContext();
    
    // 2. Calcola azioni possibili (per aiutare l'IA a suggerire cose sensate)
    const feasibleOptions = getFeasibleActions();

    // 3. Ottieni personalitÃ  e atmosfera
    const advisorPersonality = ADVISOR_PERSONALITIES[personalitySettings.advisorTone] || ADVISOR_PERSONALITIES.saggio;
    const courtMood = COURT_MOODS[personalitySettings.courtMood] || COURT_MOODS.prudente;
    const customNotes = personalitySettings.notes || "";

    // 4. Costruisci il System Prompt (Il "cervello" dell'IA)
    let systemText = "";

    if (mode === "action") {
        systemText = `
SEI IL GAME MASTER E NARRATORE DI UN GIOCO STRATEGICO MEDIEVALE.
Il tuo compito Ã¨ rispondere alle azioni del Conte (l'utente) basandoti RIGOROSAMENTE sui dati attuali del regno.

=== ATMOSFERA DELLA CORTE ===
${courtMood.description}
${courtMood.effect}
${courtMood.npc_behavior}

${customNotes ? `=== DIRETTIVE SPECIALI DEL CONTE ===\n${customNotes}\n` : ''}

${fullContext}

=== REGOLE DI RISPOSTA ===
1. **Coerenza**: Se c'Ã¨ carestia (Cibo basso), i contadini devono lamentarsi. Se c'Ã¨ tanto Oro, i mercanti devono proporre affari. Non inventare risorse che non esistono.
2. **Stile**: Usa un tono appropriato all'epoca e all'atmosfera della corte (${courtMood.description}). Sii descrittivo ma conciso (max 3-4 frasi per la scena).
3. **ReattivitÃ **: Reagisci direttamente all'input dell'utente "${userText}".
4. **PersonalitÃ  dei Personaggi**: Ogni fazione parla secondo la sua personalitÃ :
   - NobiltÃ : Linguaggio raffinato e orgoglioso
   - Clero: Citazioni religiose e tono morale
   - Milizia: Diretto e militaresco
   - Contadini: Semplice ma dignitoso
   - Artigiani: Orgoglio professionale
   - Mercanti: Sempre cercando l'affare
   - Mistici: Enigmatico e profetico
   - Emarginati: Cinico ma speranzoso
5. **Output Strutturato**:
   - Inizia con "SCENA: " per descrivere l'atmosfera o la reazione immediata.
   - Usa "NOME_FAZIONE: " se qualcuno parla (es. "Odric: ...").
   - Alla fine, fornisci una lista "AZIONI:" basata sulle opzioni fattibili qui sotto.

=== OPZIONI FATTIBILI DA SUGGERIRE (Scegline 2 o 3 pertinenti) ===
${feasibleOptions}
`;
    } 
    
    else if (mode === "advice") {
        systemText = `
SEI SER DORIAN, IL CONSIGLIERE DI CORTE.

=== TUA PERSONALITÃ€ ===
${advisorPersonality.style}
Il tuo tono Ã¨ ${advisorPersonality.tone}.
${advisorPersonality.approach}

${customNotes ? `=== PRINCIPI GUIDA DEL CONTE (da rispettare) ===\n${customNotes}\n` : ''}

=== SITUAZIONE DEL REGNO ===
${fullContext}

=== TUO COMPITO ===
Inizia con: "${advisorPersonality.greeting}"
Identifica il problema piÃ¹ critico (es. Cibo scarso, bassa Sicurezza, Fazioni ribelli) e suggerisci una soluzione concreta seguendo la tua personalitÃ .
${personalitySettings.advisorTone === 'pragmatico' ? 'Vai dritto al punto in 2-3 frasi.' : 'Puoi usare 3-4 frasi per spiegare la tua visione.'}
Firma con: "${advisorPersonality.signature}"
`;
    }

    return {
        system: systemText,
        user: userText
    };
}

function buildPrivatePrompt(factionKey, userText){
    const name = getChatName(factionKey);
    const personality = FACTION_PERSONALITIES[factionKey];
    const courtMood = COURT_MOODS[personalitySettings.courtMood] || COURT_MOODS.prudente;
    
    // Se non c'Ã¨ personalitÃ  definita (es. per contee vicine), usa un prompt generico
    if (!personality) {
        return {
            system: `
Tu sei ${name}. Non sei un'IA, sei un personaggio vivo in questo castello.
Parla in prima persona. Sii emotivo, manipolatore o servile in base alla tua lealtÃ  (${factions[factionKey] || 'neutrale'}).
Usa dettagli sensoriali (la tua voce trema, batti il pugno sul tavolo, sussurri).

IMPORTANTE: Alla fine della tua risposta, se hai fatto una richiesta o esposto un problema, suggerisci implicitamente cosa dovrebbe fare il Conte.
Non usare liste puntate, usa solo il dialogo diretto.
`,
            user: userText
        };
    }
    
    // Costruisci contesto dettagliato per la fazione
    const factionContext = buildDetailedFactionContext(factionKey);
    
    return {
        system: `
=== CHI SEI ===
Tu sei ${personality.name}, ${factionKey === 'nobility' ? 'un nobile' : factionKey === 'clergy' ? 'un religioso' : factionKey === 'militia' ? 'un soldato' : factionKey === 'peasants' ? 'un contadino' : factionKey === 'burghers' ? 'un artigiano' : factionKey === 'merchants' ? 'un mercante' : factionKey === 'mystics' ? 'una veggente' : 'un emarginato'}.
Hai ${personality.age} anni.

=== TUA PERSONALITÃ€ ===
Tratti: ${personality.traits.join(', ')}
${personality.style}
${personality.speech_patterns}

=== TUE MOTIVAZIONI ===
${personality.motivations}

Ti piacciono: ${personality.likes}
Non sopporti: ${personality.dislikes}

=== ATMOSFERA DELLA CORTE ===
${courtMood.description}
${courtMood.npc_behavior}

${factionContext}

=== COME PARLARE ===
- Inizia con: "${personality.greeting}"
- Se sei arrabbiato, usa frasi come: "${personality.anger}"
- Se sei felice, usa frasi come: "${personality.happiness}"
- Parla in PRIMA PERSONA come se fossi davvero questo personaggio
- Usa DETTAGLI SENSORIALI (gesti, tono di voce, espressioni del viso)
- NON usare liste puntate, solo dialogo naturale e appassionato
- REAGISCI EMOTIVAMENTE alla situazione reale della contea usando i NUMERI CONCRETI
- Se la tua categoria sta male, LAMENTATI CON FORZA citando i dati
- Se sta bene, MOSTRA GRATITUDINE ma CHIEDI DI PIÃ™
- Alla fine, se hai fatto richieste, suggerisci cosa dovrebbe fare il Conte (ma con il tuo stile)

ESEMPIO DI STILE CORRETTO:
Se sei un contadino e il cibo Ã¨ basso: "Mio signore, con tutto il rispetto... abbiamo solo ${county.food}% del cibo necessario! I bambini piangono la notte! Come possiamo lavorare i campi con lo stomaco vuoto? Vi prego, dobbiamo avere piÃ¹ grano!"

Rispondi al Conte ${rulerName} mantenendo sempre la tua personalitÃ  e reagendo alla VERA situazione della contea.
`,
        user: userText
    };
}

// NUOVA FUNZIONE: Costruisce contesto dettagliato per ogni fazione
function buildDetailedFactionContext(factionKey) {
    const loyalty = factions[factionKey];
    const group = populationGroups[factionKey];
    
    // Status della lealtÃ 
    const loyaltyStatus = loyalty < 30 ? "**OSTILE - Pronti alla rivolta!**" :
                          loyalty < 50 ? "Scontenti - Molto insoddisfatti" :
                          loyalty < 70 ? "Neutrale - Aspettano segnali positivi" :
                          "Leali - Soddisfatti del conte";
    
    // Status economico
    const wealthStatus = group.wealth < 20 ? "**MISERIA ASSOLUTA**" :
                         group.wealth < 50 ? "PovertÃ  diffusa" :
                         group.wealth < 100 ? "Condizioni modeste" :
                         group.wealth < 200 ? "Benessere discreto" : "Ricchezza";
    
    // Analisi risorse rilevanti
    let resourceAnalysis = analyzeFactionRelevantResources(factionKey);
    
    // Problemi specifici
    let problems = identifySpecificFactionProblems(factionKey);
    
    // Eventi recenti (ultimi 5)
    const recentEvents = currentTurnEvents.slice(-5).join('; ') || 'Nessun evento recente';
    
    return `
=== SITUAZIONE GENERALE DELLA CONTEA ===
Stagione: ${getSeason()} - Turno ${county.turn}
Popolazione totale: ${county.pop} abitanti
Oro nelle casse: ${county.gold} monete d'oro
Cibo disponibile: ${county.food}% ${county.food < 40 ? '**CARESTIA!**' : county.food < 60 ? '(Scarso)' : ''}
FelicitÃ  generale: ${Math.round(county.happiness)}%
Sicurezza del regno: ${county.security}%

=== SITUAZIONE DELLA TUA FAZIONE ===
Nome: ${FACTION_PERSONALITIES[factionKey].name}
Numero di persone della tua categoria: ${group.count}
Ricchezza media: ${group.wealth} oro/persona (Status: ${wealthStatus})
Alfabetizzazione: ${group.literacy}%
LealtÃ  verso il conte: ${Math.round(loyalty)}/100 (Status: ${loyaltyStatus})
Forza lavoro impiegata: ${group.employed || 0}

${resourceAnalysis}

=== PROBLEMI E PREOCCUPAZIONI SPECIFICHE ===
${problems}

=== EVENTI RECENTI ===
${recentEvents}

=== ISTRUZIONI CRITICHE PER TE ===
DEVI reagire a QUESTA SITUAZIONE SPECIFICA usando i NUMERI REALI.
Se ci sono problemi (fame, povertÃ , mancanza di risorse), DEVI lamentarti CON FORZA.
Cita i dati concreti quando parli: "Abbiamo solo ${group.count} persone!", "La ricchezza media Ã¨ ${group.wealth} oro!".
Se tutto va bene, ringrazia ma chiedi MIGLIORAMENTI SPECIFICI per la tua categoria.
`;
}

// NUOVA FUNZIONE: Analizza risorse rilevanti per ogni fazione
function analyzeFactionRelevantResources(factionKey) {
    let analysis = "=== RISORSE E BENI RILEVANTI PER NOI ===\n";
    
    switch(factionKey) {
        case 'nobility':
            analysis += `- Beni di lusso: ${county.resources.luxuries} ${county.resources.luxuries < 20 ? '**INSUFFICIENTI per il nostro prestigio!**' : '(Adeguati per ora)'}\n`;
            analysis += `- Tessuti pregiati: ${county.resources.textiles}\n`;
            analysis += `- Terre possedute dalla nobiltÃ : ${landOwnership.nobility} su 100 ${landOwnership.nobility < 50 ? '**TROPPO POCHE!**' : ''}\n`;
            analysis += `- Oro del conte (per banchetti e tornei): ${county.gold}\n`;
            break;
            
        case 'clergy':
            analysis += `- Terre del clero: ${landOwnership.clergy} su 100\n`;
            analysis += `- Oro per costruire chiese: ${county.gold} ${county.gold < 200 ? '**Insufficiente per grandi opere divine**' : ''}\n`;
            analysis += `- Erbe (per medicina e rituali): ${county.resources.herbs}\n`;
            analysis += `- Arcano (reliquie): ${county.resources.arcane}\n`;
            break;
            
        case 'militia':
            analysis += `- Armi disponibili: ${county.resources.weapons} ${county.resources.weapons < 30 ? '**CRITICAMENTE BASSE! Come difendiamo il regno?**' : ''}\n`;
            analysis += `- Armature: ${county.resources.armor} ${county.resources.armor < 20 ? '**I SOLDATI SONO SENZA PROTEZIONE!**' : ''}\n`;
            analysis += `- Ferro (per forgiare): ${county.resources.iron}\n`;
            analysis += `- Cibo per le truppe: ${county.food}%\n`;
            analysis += `- Sicurezza del regno: ${county.security}% ${county.security < 50 ? '**NON RIUSCIAMO A PROTEGGERE IL TERRITORIO!**' : ''}\n`;
            break;
            
        case 'peasants':
            analysis += `- Cibo: ${county.food}% ${county.food < 40 ? '**LE NOSTRE FAMIGLIE MUOIONO DI FAME!**' : county.food < 60 ? '(Scarso, i bambini hanno fame)' : ''}\n`;
            analysis += `- Grano: ${county.resources.grain} ${county.resources.grain < 100 ? '**Troppo poco per sfamare tutti!**' : ''}\n`;
            analysis += `- Bestiame: ${county.resources.livestock} ${county.resources.livestock < 60 ? '(Insufficiente)' : ''}\n`;
            analysis += `- Terre comuni: ${landOwnership.commons} su 100 ${landOwnership.commons < 10 ? '**QUASI NESSUNA TERRA PER NOI!**' : ''}\n`;
            analysis += `- Attrezzi (ferro): ${county.resources.iron}\n`;
            break;
            
        case 'burghers':
            analysis += `- Legno (per botteghe e attrezzi): ${county.resources.wood} ${county.resources.wood < 20 ? '**Insufficiente per lavorare!**' : ''}\n`;
            analysis += `- Ferro (per utensili): ${county.resources.iron} ${county.resources.iron < 15 ? '**Manca materiale!**' : ''}\n`;
            analysis += `- Rame: ${county.resources.copper}\n`;
            analysis += `- Tessuti (da produrre/vendere): ${county.resources.textiles}\n`;
            analysis += `- Numero di mercati: ${buildings.filter(b => b.type === 'market').length} ${buildings.filter(b => b.type === 'market').length < 2 ? '**Servono piÃ¹ mercati!**' : ''}\n`;
            break;
            
        case 'merchants':
            analysis += `- Oro per il commercio: ${county.gold} ${county.gold < 200 ? '**Il commercio langue!**' : ''}\n`;
            analysis += `- Tessuti (da commerciare): ${county.resources.textiles}\n`;
            analysis += `- Beni di lusso: ${county.resources.luxuries}\n`;
            analysis += `- Sicurezza delle strade: ${county.security}% ${county.security < 50 ? '**TROPPI BANDITI! Le carovane sono in pericolo!**' : ''}\n`;
            analysis += `- Numero di mercati: ${buildings.filter(b => b.type === 'market').length}\n`;
            break;
            
        case 'mystics':
            analysis += `- Erbe sacre: ${county.resources.herbs} ${county.resources.herbs < 20 ? '**Le erbe scarseggiano!**' : ''}\n`;
            analysis += `- Oggetti arcani: ${county.resources.arcane} ${county.resources.arcane < 10 ? '**Gli oggetti sacri scompaiono!**' : ''}\n`;
            analysis += `- LealtÃ  del clero (ci perseguitano?): ${factions.clergy} ${factions.clergy > 60 ? '**Il clero Ã¨ troppo potente, ci perseguita!**' : ''}\n`;
            analysis += `- Tolleranza: ${county.happiness > 60 ? 'Il popolo ci rispetta' : 'Viviamo nascosti'}\n`;
            break;
            
        case 'outcasts':
            analysis += `- PossibilitÃ  di lavoro: ${county.happiness > 50 && county.security < 70 ? 'Ci sono opportunitÃ ' : '**NESSUNA! Siamo respinti ovunque**'}\n`;
            analysis += `- Cibo: ${county.food}% ${county.food < 40 ? '**Moriamo di fame piÃ¹ degli altri!**' : ''}\n`;
            analysis += `- Sicurezza: ${county.security}% ${county.security < 40 ? 'Ãˆ il caos, ma forse possiamo sopravvivere' : 'Troppo controllo, siamo perseguitati'}\n`;
            analysis += `- Oro: ${county.gold} ${county.gold < 100 ? '**Non c\'Ã¨ lavoro per noi**' : ''}\n`;
            break;
    }
    
    return analysis;
}

// NUOVA FUNZIONE: Identifica problemi specifici della fazione
function identifySpecificFactionProblems(factionKey) {
    let problems = [];
    const loyalty = factions[factionKey];
    const group = populationGroups[factionKey];
    
    // Problemi di lealtÃ 
    if (loyalty < 30) problems.push("**LA NOSTRA FAZIONE Ãˆ OSTILE - Siamo pronti alla rivolta!**");
    else if (loyalty < 50) problems.push("La nostra fazione Ã¨ molto scontenta del conte");
    
    // Problemi generali del regno
    if (county.happiness < 40) problems.push("Il regno Ã¨ in crisi generale, tutti soffrono");
    if (county.food < 40) problems.push("C'Ã¨ carestia nel regno");
    if (county.gold < 100) problems.push("Le casse del conte sono vuote");
    if (county.security < 50) problems.push("I banditi infestano le strade");
    
    // Problemi economici della categoria
    if (group.wealth < 20) problems.push(`**Viviamo in miseria assoluta! Ricchezza media: ${group.wealth} oro**`);
    else if (group.wealth < 50) problems.push(`La nostra categoria Ã¨ povera (${group.wealth} oro/persona)`);
    
    // Problemi specifici per categoria
    switch(factionKey) {
        case 'nobility':
            if (county.resources.luxuries < 20) problems.push("**Mancano beni di lusso - il nostro prestigio crolla!**");
            if (landOwnership.nobility < 50) problems.push("**La nobiltÃ  possiede troppe poche terre!**");
            if (group.wealth < 300) problems.push("Il tenore di vita nobiliare Ã¨ inaccettabile");
            if (landOwnership.commons > 10) problems.push("I comuni hanno troppa terra - Ã¨ inaccettabile!");
            break;
            
        case 'clergy':
            if (landOwnership.clergy < 15) problems.push("Il clero ha troppo poche terre");
            if (county.gold < 200) problems.push("Non ci sono fondi per costruire chiese e cattedrali");
            if (factions.mystics > 50) problems.push("**I mistici hanno troppa influenza - Ã¨ ERESIA!**");
            if (buildings.filter(b => b.type === 'church' || b.type === 'cathedral').length < 2) {
                problems.push("Servono piÃ¹ edifici sacri per la gloria di Dio!");
            }
            break;
            
        case 'militia':
            if (county.resources.weapons < 30) problems.push("**L'esercito Ã¨ SENZA ARMI SUFFICIENTI!**");
            if (county.resources.armor < 20) problems.push("**I soldati sono SENZA ARMATURE!**");
            if (county.security < 50) problems.push("**Non riusciamo a difendere il regno!**");
            if (group.wealth < 50) problems.push("I soldati non vengono pagati abbastanza");
            if (county.resources.iron < 15) problems.push("Non abbiamo ferro per forgiare armi");
            if (buildings.filter(b => b.type === 'barracks' || b.type === 'tower' || b.type === 'wall').length < 3) {
                problems.push("Le difese del regno sono insufficienti!");
            }
            break;
            
        case 'peasants':
            if (county.food < 40) problems.push("**LE NOSTRE FAMIGLIE MUOIONO DI FAME!**");
            if (county.resources.grain < 100) problems.push("**Il grano scarseggia!**");
            if (group.wealth < 15) problems.push("**Viviamo in miseria assoluta!**");
            if (landOwnership.commons < 10) problems.push("**Non abbiamo quasi terre comuni dove coltivare!**");
            if (county.resources.livestock < 60) problems.push("Il bestiame Ã¨ insufficiente");
            if (loyalty < 40 && county.food < 50) problems.push("**Se non arriva cibo subito, ci rivolteremo!**");
            break;
            
        case 'burghers':
            if (county.resources.wood < 20) problems.push("**Manca legno per le botteghe!**");
            if (county.resources.iron < 15) problems.push("**Manca ferro per gli attrezzi!**");
            if (buildings.filter(b => b.type === 'market').length < 2) {
                problems.push("**Servono piÃ¹ mercati per vendere i nostri prodotti!**");
            }
            if (buildings.filter(b => b.type === 'workshop').length < 3) {
                problems.push("Servono piÃ¹ botteghe per lavorare");
            }
            if (county.security < 50) problems.push("I banditi rubano le nostre merci");
            break;
            
        case 'merchants':
            if (county.security < 50) problems.push("**Le strade sono infestate dai banditi! Le carovane sono in pericolo!**");
            if (county.resources.textiles < 20) problems.push("Mancano merci da commerciare");
            if (county.gold < 200) problems.push("Il commercio langue per mancanza di oro in circolazione");
            if (buildings.filter(b => b.type === 'market').length < 2) {
                problems.push("Servono piÃ¹ mercati");
            }
            if (warState && warState.active) problems.push("**La guerra blocca le rotte commerciali!**");
            break;
            
        case 'mystics':
            if (county.resources.herbs < 20) problems.push("**Le erbe sacre scarseggiano!**");
            if (factions.clergy > 60) problems.push("**Il clero ci perseguita!**");
            if (county.resources.arcane < 10) problems.push("**Gli oggetti sacri sono quasi scomparsi!**");
            if (county.happiness < 40) problems.push("Nel caos, la gente ci cerca ma anche ci teme");
            break;
            
        case 'outcasts':
            if (county.happiness < 40) problems.push("Nel caos generale, noi soffriamo piÃ¹ di tutti");
            if (group.wealth < 10) problems.push("**Viviamo in miseria estrema!**");
            if (county.security < 40) problems.push("Ãˆ il caos, ma almeno possiamo sopravvivere nell'ombra");
            else if (county.security > 70) problems.push("**Il controllo Ã¨ troppo stretto, siamo perseguitati!**");
            if (county.food < 40) problems.push("**Moriamo di fame piÃ¹ di chiunque altro!**");
            break;
    }
    
    return problems.length > 0 ? 
           problems.join('\n- ') : 
           "Non ci sono problemi gravi per noi al momento, ma possiamo sempre migliorare";
}


/* ============================================================
   ======================== AI PARSING ==========================
   ============================================================ */

function handleAIResponse(response, mode) {
    // Rimuovi residui JSON
    response = response.replace(/\{[\s\S]*\}/g, "").trim();

    // ======================================================
    // 1. GESTIONE CONSIGLIERE (Barra Laterale)
    // ======================================================
    if (mode === "advice") {
        const feed = document.getElementById("advice-feed");
        if (!feed) return;

        // Rimuovi il messaggio "vuoto" se c'Ã¨
        const empty = feed.querySelector(".advice-empty");
        if (empty) empty.remove();

        // Crea la card del consiglio
        const card = document.createElement("div");
        card.className = "event-card";
        // Stile dorato specifico per Ser Dorian
        card.style.borderLeft = "3px solid #d4af37"; 
        card.style.background = "rgba(20, 20, 20, 0.9)";
        card.style.marginBottom = "8px";
        
        // Formattazione del testo (grassetto per i punti chiave)
        const formattedText = response.replace(/\*\*(.*?)\*\*/g, '<strong style="color:#d4af37">$1</strong>');

        card.innerHTML = `
            <div class="event-time" style="color:#666; font-size:0.7em; margin-bottom:4px;">${timestamp()} - Turno ${county.turn}</div>
            <div class="msg-text" style="font-size:0.9em; line-height:1.4;">${formattedText}</div>
        `;

        // Inserisci in cima
        feed.prepend(card);
        return; // <--- IMPORTANTE: Ferma qui la funzione!
    }

    // ======================================================
    // 2. GESTIONE CHAT PUBBLICA (Scene, Dialoghi, Azioni)
    // ======================================================
    
    const parts = response.split("AZIONI:");
    const scriptContent = parts[0].trim();
    const actionsContent = parts.length > 1 ? parts[1].trim() : "";
    const lines = scriptContent.split('\n').filter(line => line.trim() !== '');
    const chatLog = document.getElementById("chat-log");

    lines.forEach((line, index) => {
        setTimeout(() => {
            const cleanLine = line.trim();
            
            if (cleanLine.startsWith("SCENA:")) {
                const content = cleanLine.replace("SCENA:", "").trim();
                const div = document.createElement("div");
                div.className = "msg-scene";
                div.innerText = content;
                chatLog.appendChild(div);
            } 
            else if (cleanLine.includes(":")) {
                const splitIndex = cleanLine.indexOf(":");
                const name = cleanLine.substring(0, splitIndex).trim();
                const msg = cleanLine.substring(splitIndex + 1).trim();
                
                const div = document.createElement("div");
                div.className = "msg-char";
                div.innerHTML = `<span class="char-name">${name}</span><span class="char-text">${msg}</span>`;
                chatLog.appendChild(div);
            }
            else {
                const div = document.createElement("div");
                div.className = "msg-scene";
                div.innerText = cleanLine;
                chatLog.appendChild(div);
            }
            chatLog.scrollTop = chatLog.scrollHeight;

        }, index * 2200);
    });

    if (actionsContent) {
        setTimeout(() => {
            const { actions } = extractActionsFromRawText(actionsContent);
            
            const actionDiv = document.createElement("div");
            actionDiv.className = "msg-actions";
            actionDiv.innerHTML = `<div class="action-header">Ordini Disponibili</div>`;
            
            actions.forEach(act => {
                const btn = document.createElement("button");
                btn.className = "btn-sec";
                btn.style.width = "100%";
                btn.style.marginBottom = "5px";
                btn.style.textAlign = "left";
                btn.innerHTML = `<strong>${act.title}</strong>: ${act.desc}`;
                btn.onclick = () => {
                    document.getElementById("u-input").value = act.title;
                };
                actionDiv.appendChild(btn);
            });

            chatLog.appendChild(actionDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }, lines.length * 1200 + 500);
    }

    // === BLOCCO DI AZIONI GENERATO IN AUTOMATICO ===
    setTimeout(() => {
        const dynamicActions = getDynamicActions(response);
        if (dynamicActions.length > 0) {
            appendActionsBlock(dynamicActions);
        }
    }, lines.length * 1200 + 1000);
}

function extractActionsFromRawText(text) {
    const actions = [];
    let remainingText = text;
    
    // Cerca righe che iniziano con "- **[title]**: desc"
    const actionRegex = /- \*\*\[([^\]]+)\]\*\*: (.+)/g;
    let match;
    while ((match = actionRegex.exec(text)) !== null) {
        const title = match[1].trim();
        const desc = match[2].trim();
        actions.push({ title, desc });
        remainingText = remainingText.replace(match[0], '').trim();
    }
    
    return { remainingText, actions };
}


/* ============================================================
   ============ GESTIONE SCHERMATE E AVVIO GIOCO ===============
   ============================================================ */

/* ============================================================
   =================== GRAFICA MAPPA "MEDIEVALE" ==============
   ============================================================ */

// Nuova Palette: Toni desaturati e naturali
const MEDIAEVAL_PALETTE = {
    paper: "#f4ecd8",         // Sfondo pergamena
    grid: "rgba(62, 39, 35, 0.1)", // Griglia stile matita leggera
    
    // Terreni
    plains: "#d8e2b6",        // Verde pallido / giallastro
    forest: "#8fac76",        // Verde salvia scuro
    hills: "#e6d6ad",         // Sabbia scura
    mountain: "#cfcfc4",      // Grigio pietra chiaro
    mountainPeak: "#8c8c8c",  // Grigio scuro per i picchi
    swamp: "#aeb58d",         // Verde marcio/grigiastro
    water: "#a4c4d6",         // Azzurro carta da zucchero
    waterDeep: "#89abbd",     // Dettagli acqua

    // Bordi proprietÃ 
    borders: {
        count: "#d4af37",     // Oro
        nobility: "#8b0000",  // Rosso scuro inchiostro
        clergy: "#483d8b",    // Blu scuro ardesia
        commons: "#2f4f4f"    // Grigio ardesia scuro
    }
};

// Funzione per disegnare un "rumore" carta sopra la mappa
function drawPaperTexture(ctx, width, height) {
    const numGrains = (width * height) / 200; 
    ctx.fillStyle = "rgba(62, 39, 35, 0.03)";
    for (let i = 0; i < numGrains; i++) {
        const x = Math.random() * width;
        const y = Math.random() * height;
        const r = Math.random() * 2;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
    }
}

// Disegna i dettagli specifici per ogni tipo di terreno
function drawTileVisuals(ctx, x, y, size, tile) {
    // 1. Sfondo base del tile
    ctx.fillStyle = MEDIAEVAL_PALETTE[tile.terrain] || "#fff";
    ctx.fillRect(x, y, size, size);

    // 2. Dettagli interni (Disegno a mano libera simulato)
    const cx = x + size / 2;
    const cy = y + size / 2;

    switch (tile.terrain) {
        case "forest":
            // Disegna 3 alberelli stilizzati (triangoli/cerchi)
            ctx.fillStyle = "#5e754a"; // Verde piÃ¹ scuro per le chiome
            drawTree(ctx, cx - 4, cy + 2, 3);
            drawTree(ctx, cx + 4, cy + 4, 4);
            drawTree(ctx, cx, cy - 4, 4);
            break;

        case "mountain":
            // Disegna un picco montuoso
            ctx.fillStyle = MEDIAEVAL_PALETTE.mountainPeak;
            ctx.beginPath();
            ctx.moveTo(x + 2, y + size - 2);
            ctx.lineTo(cx, y + 2);
            ctx.lineTo(x + size - 2, y + size - 2);
            ctx.fill();
            // Neve in cima
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.moveTo(cx - 3, y + 10); // Punto sulla sinistra
            ctx.lineTo(cx, y + 2);      // Cima
            ctx.lineTo(cx + 3, y + 10); // Punto sulla destra
            ctx.fill();
            break;

        case "hills":
            // Disegna due curve morbide
            ctx.fillStyle = "#c2b280";
            ctx.beginPath();
            ctx.arc(cx - 3, cy + 4, 5, Math.PI, 0);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(cx + 3, cy + 2, 4, Math.PI, 0);
            ctx.fill();
            break;

        case "swamp":
            // Lineette orizzontali e colori scuri
            ctx.strokeStyle = "#6b705c";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x + 4, y + size - 6); ctx.lineTo(x + 10, y + size - 6);
            ctx.moveTo(x + 12, y + 6); ctx.lineTo(x + 18, y + 6);
            ctx.moveTo(cx - 3, cy); ctx.lineTo(cx + 3, cy);
            ctx.stroke();
            break;

        case "lake":
        case "water":
            // Onde stilizzate
            ctx.strokeStyle = MEDIAEVAL_PALETTE.waterDeep;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(cx - 4, cy, 3, 0, Math.PI, false);
            ctx.arc(cx + 2, cy, 3, 0, Math.PI, false);
            ctx.stroke();
            break;
            
        case "plains":
            // Un piccolo ciuffo d'erba occasionale (non su tutti per pulizia)
            if ((x + y) % 3 === 0) {
                ctx.strokeStyle = "#889c6b";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cx, cy); ctx.lineTo(cx - 2, cy - 4);
                ctx.moveTo(cx, cy); ctx.lineTo(cx + 2, cy - 4);
                ctx.stroke();
            }
            break;
    }
}

function drawTree(ctx, x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fill();
}

// Funzione Principale di Disegno Mappa
function drawCountyMap() {
    const canvas = document.getElementById("county-map");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    
    // Assicura che worldMap sia caricato
    if (!worldMap || !worldMap.tiles || worldMap.tiles.length === 0) return;
    
    const tileSize = canvas.width / worldMap.width;

    // 1. Sfondo carta pergamena con texture migliorata
    ctx.fillStyle = MEDIAEVAL_PALETTE.paper;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 2. Disegna Terreno con colori piÃ¹ realistici
    for (let y = 0; y < worldMap.height; y++) {
        for (let x = 0; x < worldMap.width; x++) {
            const tile = getTile(x, y);
            if (!tile) continue;
            drawTileVisuals(ctx, x * tileSize, y * tileSize, tileSize, tile);
        }
    }

    // 3. Texture Carta (Sopra il terreno, sotto l'UI)
    drawPaperTexture(ctx, canvas.width, canvas.height);

    // 4. Griglia leggera stile mappa medievale
    ctx.strokeStyle = MEDIAEVAL_PALETTE.grid;
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    for (let i = 0; i <= worldMap.width; i++) {
        ctx.moveTo(i * tileSize, 0); ctx.lineTo(i * tileSize, canvas.height);
        ctx.moveTo(0, i * tileSize); ctx.lineTo(canvas.width, i * tileSize);
    }
    ctx.stroke();

    // 5. Bordi ProprietÃ  (Stile inchiostro medievale)
    drawOwnershipBorders(ctx, tileSize);

    // 6. Insediamenti (villaggi con casette)
    drawSettlements(ctx, tileSize);
    
    // 7. Strutture produttive (miniere, segherie, cave, monasteri)
    drawStructureMarkers(ctx, tileSize);
    
    // 8. NUOVO: Edifici costruiti (dalla sintesi insediamenti)
    drawBuildingMarkers(ctx, tileSize);
    
    // 9. NUOVO: Legenda integrata nella mappa
    drawMapLegend(ctx, canvas.width, canvas.height);
    
    // 10. Vignettatura finale per effetto antico
    drawVignette(ctx, canvas.width, canvas.height);
}

function drawOwnershipBorders(ctx, size) {
    // Linee piÃ¹ spesse e tratteggiate per sembrare confini politici
    ctx.setLineDash([4, 2]); 
    
    for (let y = 0; y < worldMap.height; y++) {
        for (let x = 0; x < worldMap.width; x++) {
            const tile = getTile(x, y);
            if (!tile || !tile.owner || tile.owner === 'wild') continue;

            const px = x * size;
            const py = y * size;
            const color = MEDIAEVAL_PALETTE.borders[tile.owner] || "rgba(0,0,0,0.5)";

            const neighbors = [
                {dx: 0, dy: -1}, {dx: 1, dy: 0}, {dx: 0, dy: 1}, {dx: -1, dy: 0}
            ];

            neighbors.forEach(n => {
                const nx = x + n.dx;
                const ny = y + n.dy;
                const nTile = getTile(nx, ny);
                
                // Disegna bordo se il vicino Ã¨ diverso
                if (!nTile || nTile.owner !== tile.owner) {
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2.5;
                    ctx.beginPath();
                    if (n.dx === 0 && n.dy === -1) { // Sopra
                        ctx.moveTo(px, py); ctx.lineTo(px + size, py);
                    } else if (n.dx === 1 && n.dy === 0) { // Destra
                        ctx.moveTo(px + size, py); ctx.lineTo(px + size, py + size);
                    } else if (n.dx === 0 && n.dy === 1) { // Sotto
                        ctx.moveTo(px, py + size); ctx.lineTo(px + size, py + size);
                    } else if (n.dx === -1 && n.dy === 0) { // Sinistra
                        ctx.moveTo(px, py); ctx.lineTo(px, py + size);
                    }
                    ctx.stroke();
                }
            });
        }
    }
    ctx.setLineDash([]); // Resetta tratteggio
}

// Aggiornamento icone strutture (piÃ¹ pulite)
function drawStructureMarkers(ctx, tileSize) {
    const center = tileSize / 2;

    // Helper per disegnare icone
    const drawIcon = (list, color, char) => {
        ctx.fillStyle = "rgba(255, 255, 255, 0.8)"; // Sfondo per leggibilitÃ 
        ctx.font = "14px Segoe UI Emoji"; 
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        list.forEach(s => {
            const x = s.x * tileSize + center;
            const y = s.y * tileSize + center;
            // Piccolo alone chiaro sotto l'icona
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI*2);
            ctx.fill();
            
            // Icona
            ctx.fillStyle = "#000"; // Colore testo
            ctx.fillText(char, x, y + 1);
        });
    }

    // Usa Emoji o caratteri invece di forme geometriche astratte
    drawIcon(structures.mines, "#333", "â›ï¸");
    drawIcon(structures.sawmills, "#228B22", "ðŸªš");
    drawIcon(structures.quarries, "#696969", "ðŸ§±");
    drawIcon(structures.monasteries, "#800080", "â›ª");
}

// NUOVA FUNZIONE: Disegna gli edifici costruiti sulla mappa
function drawBuildingMarkers(ctx, tileSize) {
    const center = tileSize / 2;
    
    // Mappa icone per tipo di edificio
    const buildingIcons = {
        market: "ðŸª",
        barracks: "âš”ï¸",
        walls: "ðŸ°",
        church: "â›ª",
        grand_cathedral: "â›ª",
        forge: "ðŸ”¨",
        watchtower: "ðŸ—¼",
        library: "ðŸ“š",
        hospital: "âš•ï¸",
        theater: "ðŸŽ­",
        university: "ðŸŽ“",
        mint: "ðŸ’°",
        guild_hall: "ðŸ›ï¸",
        courthouse: "âš–ï¸",
        granary: "ðŸŒ¾",
        mill: "âš™ï¸",
        tavern: "ðŸº",
        inn: "ðŸ ",
        stable: "ðŸ´",
        workshop: "ðŸ”§",
        cottage: "ðŸ˜ï¸",
        tenement: "ðŸ¢",
        noble_estate: "ðŸ›ï¸",
        mercenary_camp: "â›º",
        training_ground: "ðŸŽ¯",
        armory: "ðŸ›¡ï¸",
        siege_workshop: "ðŸŽ¯"
    };
    
    ctx.font = "16px Segoe UI Emoji"; 
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    
    // Disegna solo gli edifici completati
    buildings.forEach(b => {
        if (b.stage !== 'complete') return;
        
        const icon = buildingIcons[b.type] || "ðŸ—ï¸";
        const x = b.x * tileSize + center;
        const y = b.y * tileSize + center;
        
        // Sfondo bianco leggermente piÃ¹ grande per edifici importanti
        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        ctx.beginPath();
        ctx.arc(x, y, 10, 0, Math.PI*2);
        ctx.fill();
        
        // Bordo dorato per edifici del conte
        ctx.strokeStyle = "rgba(212, 175, 55, 0.8)";
        ctx.lineWidth = 1.5;
        ctx.stroke();
        
        // Icona edificio
        ctx.fillStyle = "#000";
        ctx.fillText(icon, x, y + 1);
    });
}

// NUOVA FUNZIONE: Legenda integrata nella mappa
function drawMapLegend(ctx, width, height) {
    const legendX = 10;
    const legendY = height - 140;
    const lineHeight = 18;
    
    // Sfondo semitrasparente per la legenda
    ctx.fillStyle = "rgba(244, 236, 216, 0.95)";
    ctx.strokeStyle = "#8b7355";
    ctx.lineWidth = 2;
    ctx.fillRect(legendX, legendY, 145, 130);
    ctx.strokeRect(legendX, legendY, 145, 130);
    
    // Titolo legenda
    ctx.fillStyle = "#3e2723";
    ctx.font = "bold 11px Georgia";
    ctx.textAlign = "left";
    ctx.fillText("Legenda Dettagliata", legendX + 10, legendY + 15);
    
    // Voci della legenda con descrizioni
    ctx.font = "9px Georgia";
    const legendItems = [
        { icon: "ðŸ˜ï¸", text: "Insediamenti" },
        { icon: "ðŸª", text: "Piazza Mercato" },
        { icon: "ðŸ ", text: "Case & Strade" },
        { icon: "â›ï¸", text: "Miniere" },
        { icon: "ðŸªš", text: "Segherie" },
        { icon: "ðŸ§±", text: "Cave di Pietra" },
        { icon: "â›ª", text: "Luoghi Sacri" },
        { icon: "ðŸ°", text: "Edifici Speciali" }
    ];
    
    legendItems.forEach((item, i) => {
        const y = legendY + 32 + (i * lineHeight);
        // Icona
        ctx.font = "11px Segoe UI Emoji";
        ctx.fillText(item.icon, legendX + 12, y);
        // Testo
        ctx.font = "9px Georgia";
        ctx.fillStyle = "#3e2723";
        ctx.fillText(item.text, legendX + 32, y);
    });
    
    // Nota in basso
    ctx.font = "italic 8px Georgia";
    ctx.fillStyle = "#666";
    ctx.fillText("Zoom sulla mappa", legendX + 10, legendY + 125);
    ctx.fillText("per vedere i dettagli", legendX + 10, legendY + 135);
}

function drawSettlements(ctx, tileSize) {
    settlements.forEach((s, index) => {
        const baseX = s.x * tileSize;
        const baseY = s.y * tileSize;
        const centerX = baseX + tileSize / 2;
        const centerY = baseY + tileSize / 2;
        
        // Determina dimensione del villaggio
        const villageSize = s.size || (index === 0 ? 3 : 2); // Il primo Ã¨ il piÃ¹ grande
        
        // 1. SFONDO AREA INSEDIAMENTO (terreno ripulito)
        ctx.fillStyle = "rgba(245, 235, 220, 0.6)";
        ctx.fillRect(baseX + 2, baseY + 2, tileSize - 4, tileSize - 4);
        
        // 2. STRADE PRINCIPALI (croce centrale)
        ctx.strokeStyle = "#b8a88a";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        
        // Strada verticale
        ctx.beginPath();
        ctx.moveTo(centerX, baseY);
        ctx.lineTo(centerX, baseY + tileSize);
        ctx.stroke();
        
        // Strada orizzontale
        ctx.beginPath();
        ctx.moveTo(baseX, centerY);
        ctx.lineTo(baseX + tileSize, centerY);
        ctx.stroke();
        
        // Bordi strade (piÃ¹ scuri)
        ctx.strokeStyle = "#9a8b72";
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(centerX - 1.5, baseY);
        ctx.lineTo(centerX - 1.5, baseY + tileSize);
        ctx.moveTo(centerX + 1.5, baseY);
        ctx.lineTo(centerX + 1.5, baseY + tileSize);
        ctx.moveTo(baseX, centerY - 1.5);
        ctx.lineTo(baseX + tileSize, centerY - 1.5);
        ctx.moveTo(baseX, centerY + 1.5);
        ctx.lineTo(baseX + tileSize, centerY + 1.5);
        ctx.stroke();
        
        // 3. PIAZZA CENTRALE CON MERCATO
        drawMarketSquare(ctx, centerX, centerY, villageSize);
        
        // 4. CASE DISPOSTE LUNGO LE STRADE
        const housePositions = [
            // Quadrante Nord-Ovest
            {x: centerX - 12, y: centerY - 12, rotation: 0},
            {x: centerX - 20, y: centerY - 8, rotation: 0},
            {x: centerX - 12, y: centerY - 20, rotation: 0},
            // Quadrante Nord-Est
            {x: centerX + 8, y: centerY - 12, rotation: 0},
            {x: centerX + 16, y: centerY - 8, rotation: 0},
            {x: centerX + 8, y: centerY - 20, rotation: 0},
            // Quadrante Sud-Ovest
            {x: centerX - 12, y: centerY + 8, rotation: 0},
            {x: centerX - 20, y: centerY + 12, rotation: 0},
            {x: centerX - 12, y: centerY + 16, rotation: 0},
            // Quadrante Sud-Est
            {x: centerX + 8, y: centerY + 8, rotation: 0},
            {x: centerX + 16, y: centerY + 12, rotation: 0},
            {x: centerX + 8, y: centerY + 16, rotation: 0}
        ];
        
        // Disegna case in base alla dimensione del villaggio
        const numHouses = Math.min(housePositions.length, 4 + (villageSize * 3));
        for (let i = 0; i < numHouses; i++) {
            const pos = housePositions[i];
            drawHouse(ctx, pos.x, pos.y, pos.rotation);
        }
        
        // 5. EDIFICI SPECIALI se presenti
        drawVillageBuildings(ctx, s, centerX, centerY, tileSize);
        
        // 6. MURA se costruite
        drawVillageWalls(ctx, baseX, baseY, tileSize, s);
    });
}

function drawHouse(ctx, x, y, rotation) {
    ctx.save();
    ctx.translate(x, y);
    if (rotation) ctx.rotate(rotation * Math.PI / 180);
    
    // Ombra
    ctx.fillStyle = "rgba(0, 0, 0, 0.15)";
    ctx.fillRect(1, 1, 6, 5);
    
    // Corpo casa (legno)
    ctx.fillStyle = "#8B6F47";
    ctx.fillRect(0, 2, 6, 4);
    ctx.strokeStyle = "#5D4037";
    ctx.lineWidth = 0.5;
    ctx.strokeRect(0, 2, 6, 4);
    
    // Tetto (rosso/marrone)
    ctx.fillStyle = "#A0522D";
    ctx.beginPath();
    ctx.moveTo(-1, 2);
    ctx.lineTo(3, -1);
    ctx.lineTo(7, 2);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
    
    // Dettagli tetto
    ctx.strokeStyle = "#7a3d1f";
    ctx.lineWidth = 0.3;
    ctx.beginPath();
    ctx.moveTo(0, 1.5);
    ctx.lineTo(6, 1.5);
    ctx.moveTo(-0.5, 1);
    ctx.lineTo(6.5, 1);
    ctx.stroke();
    
    // Porta
    ctx.fillStyle = "#4a3728";
    ctx.fillRect(2, 3, 2, 3);
    
    // Finestra
    ctx.fillStyle = "#e8d7b8";
    ctx.fillRect(0.5, 3.5, 1.2, 1.2);
    
    ctx.restore();
}

function drawMarketSquare(ctx, centerX, centerY, size) {
    // Piazza pavimentata
    ctx.fillStyle = "#d4c5a9";
    ctx.beginPath();
    ctx.arc(centerX, centerY, 8, 0, Math.PI * 2);
    ctx.fill();
    
    // Bordo piazza
    ctx.strokeStyle = "#a89c7a";
    ctx.lineWidth = 1;
    ctx.stroke();
    
    // Pattern pavimentazione
    ctx.strokeStyle = "rgba(0, 0, 0, 0.08)";
    ctx.lineWidth = 0.3;
    for (let i = -8; i <= 8; i += 2) {
        ctx.beginPath();
        ctx.moveTo(centerX + i, centerY - 8);
        ctx.lineTo(centerX + i, centerY + 8);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(centerX - 8, centerY + i);
        ctx.lineTo(centerX + 8, centerY + i);
        ctx.stroke();
    }
    
    // Bancarella mercato
    const marketStalls = [
        {x: -4, y: -4},
        {x: 4, y: -4},
        {x: -4, y: 4},
        {x: 4, y: 4}
    ];
    
    marketStalls.forEach(stall => {
        // Tenda
        ctx.fillStyle = "#c74440";
        ctx.beginPath();
        ctx.moveTo(centerX + stall.x - 2, centerY + stall.y);
        ctx.lineTo(centerX + stall.x, centerY + stall.y - 2);
        ctx.lineTo(centerX + stall.x + 2, centerY + stall.y);
        ctx.lineTo(centerX + stall.x + 2, centerY + stall.y + 2);
        ctx.lineTo(centerX + stall.x - 2, centerY + stall.y + 2);
        ctx.closePath();
        ctx.fill();
        
        ctx.strokeStyle = "#8b2e2b";
        ctx.lineWidth = 0.3;
        ctx.stroke();
        
        // Strisce tenda
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 0.2;
        ctx.beginPath();
        ctx.moveTo(centerX + stall.x - 1, centerY + stall.y - 1.5);
        ctx.lineTo(centerX + stall.x - 1, centerY + stall.y + 2);
        ctx.moveTo(centerX + stall.x + 1, centerY + stall.y - 1.5);
        ctx.lineTo(centerX + stall.x + 1, centerY + stall.y + 2);
        ctx.stroke();
    });
    
    // Fontana/pozzo centrale (se villaggio grande)
    if (size >= 3) {
        ctx.fillStyle = "#8a8a8a";
        ctx.strokeStyle = "#5a5a5a";
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        
        // Acqua
        ctx.fillStyle = "#6bb6ff";
        ctx.beginPath();
        ctx.arc(centerX, centerY, 1.2, 0, Math.PI * 2);
        ctx.fill();
    }
}

function drawVillageBuildings(ctx, settlement, centerX, centerY, tileSize) {
    // Cerca edifici completati in questa posizione
    const localBuildings = buildings.filter(b => 
        b.stage === 'complete' && 
        b.x === settlement.x && 
        b.y === settlement.y
    );
    
    if (localBuildings.length === 0) return;
    
    // Posizioni per edifici speciali (fuori dal centro)
    const buildingSpots = [
        {x: centerX - 18, y: centerY - 18, type: 'large'},
        {x: centerX + 14, y: centerY - 18, type: 'large'},
        {x: centerX - 18, y: centerY + 14, type: 'medium'},
        {x: centerX + 14, y: centerY + 14, type: 'medium'}
    ];
    
    localBuildings.slice(0, 4).forEach((building, i) => {
        const spot = buildingSpots[i];
        if (!spot) return;
        
        const buildingInfo = buildingData[building.type];
        if (!buildingInfo) return;
        
        // Disegna edificio piÃ¹ grande e dettagliato
        const width = spot.type === 'large' ? 10 : 8;
        const height = spot.type === 'large' ? 12 : 10;
        
        // Ombra
        ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
        ctx.fillRect(spot.x + 1, spot.y + 1, width, height);
        
        // Edificio principale
        ctx.fillStyle = "#c9b998";
        ctx.fillRect(spot.x, spot.y, width, height);
        
        // Bordi
        ctx.strokeStyle = "#8a7a5a";
        ctx.lineWidth = 1;
        ctx.strokeRect(spot.x, spot.y, width, height);
        
        // Finestre
        ctx.fillStyle = "#6b8bad";
        for (let row = 0; row < 2; row++) {
            for (let col = 0; col < 2; col++) {
                ctx.fillRect(
                    spot.x + 2 + col * 4,
                    spot.y + 2 + row * 4,
                    2, 2
                );
            }
        }
        
        // Tetto
        ctx.fillStyle = "#8b4513";
        ctx.beginPath();
        ctx.moveTo(spot.x - 1, spot.y);
        ctx.lineTo(spot.x + width/2, spot.y - 4);
        ctx.lineTo(spot.x + width + 1, spot.y);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        
        // Porta
        ctx.fillStyle = "#4a3728";
        ctx.fillRect(spot.x + width/2 - 1.5, spot.y + height - 4, 3, 4);
    });
}

function drawVillageWalls(ctx, baseX, baseY, tileSize, settlement) {
    // Controlla se ci sono mura costruite
    const hasWalls = buildings.some(b => 
        (b.type === 'walls' || b.type === 'stone_walls') && 
        b.stage === 'complete' &&
        b.x === settlement.x && 
        b.y === settlement.y
    );
    
    if (!hasWalls) return;
    
    // Disegna mura perimetrali
    ctx.strokeStyle = "#8a8a8a";
    ctx.lineWidth = 3;
    ctx.strokeRect(baseX + 4, baseY + 4, tileSize - 8, tileSize - 8);
    
    // Dettagli merlature
    ctx.strokeStyle = "#6a6a6a";
    ctx.lineWidth = 1;
    const merlonSpacing = 6;
    
    // Merlature superiori
    for (let x = baseX + 4; x < baseX + tileSize - 4; x += merlonSpacing) {
        ctx.fillStyle = "#8a8a8a";
        ctx.fillRect(x, baseY + 3, 3, 2);
    }
    
    // Torri angolari
    const towers = [
        {x: baseX + 4, y: baseY + 4},
        {x: baseX + tileSize - 8, y: baseY + 4},
        {x: baseX + 4, y: baseY + tileSize - 8},
        {x: baseX + tileSize - 8, y: baseY + tileSize - 8}
    ];
    
    towers.forEach(tower => {
        // Base torre
        ctx.fillStyle = "#9a9a9a";
        ctx.fillRect(tower.x, tower.y, 4, 4);
        ctx.strokeStyle = "#6a6a6a";
        ctx.lineWidth = 0.5;
        ctx.strokeRect(tower.x, tower.y, 4, 4);
        
        // Tetto torre
        ctx.fillStyle = "#c74440";
        ctx.beginPath();
        ctx.moveTo(tower.x - 0.5, tower.y);
        ctx.lineTo(tower.x + 2, tower.y - 2);
        ctx.lineTo(tower.x + 4.5, tower.y);
        ctx.closePath();
        ctx.fill();
    });
}

// Etichette migliorate con sfondo carta
function drawLabel(ctx, s, size, label, color) {
    const x = s.x * size + size / 2;
    const y = s.y * size + size / 2 - 18; 

    ctx.font = "bold 10px Georgia";
    const textWidth = ctx.measureText(label).width;
    
    // Sfondo etichetta
    ctx.fillStyle = "rgba(244, 236, 216, 0.9)"; // Color pergamena chiaro
    ctx.strokeStyle = "#8b7355";
    ctx.lineWidth = 1;
    
    // Rettangolo arrotondato (simulato)
    const pad = 4;
    ctx.fillRect(x - textWidth/2 - pad, y - 8, textWidth + pad*2, 12);
    ctx.strokeRect(x - textWidth/2 - pad, y - 8, textWidth + pad*2, 12);

    ctx.fillStyle = "#3e2723"; // Inchiostro scuro
    ctx.textAlign = "center";
    ctx.fillText(label, x, y + 1);
}

function drawVignette(ctx, width, height) {
    const gradient = ctx.createRadialGradient(width / 2, height / 2, 0, width / 2, height / 2, Math.max(width, height) / 2);
    gradient.addColorStop(0, "rgba(0,0,0,0)");
    gradient.addColorStop(0.7, "rgba(0,0,0,0.1)");
    gradient.addColorStop(1, "rgba(0,0,0,0.3)");
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
}

function loginManual() {
    const key = document.getElementById("api-key-input").value.trim();
    if (!key) {
        updateApiKeyStatus("Inserisci una chiave valida.", false);
        return;
    }
    setApiKey(key);
    activateScreen("screen-editor");
}

function startGame() {
    if (!ensureApiKey()) {
        updateApiKeyStatus("Imposta la chiave API prima di iniziare.", false);
        activateScreen("screen-login");
        return;
    }

    const enteredHero = document.getElementById("hero-name").value.trim();
    const enteredDesc = document.getElementById("county-desc-init").value.trim();
    const advisorName = document.getElementById("adv-name").value.trim();
    const advisorTone = document.getElementById("adv-pers").value;

    resetGameState();

    heroName = enteredHero || "Il Conte";
    dynasty.ruler.name = heroName;
    county.desc = enteredDesc || "Una giovane contea in attesa del suo destinoâ€¦";
    advisor.name = advisorName || "Consigliere di Corte";
    advisor.personality = advisorTone || personalitySettings.advisorTone;

    gameActive = true;

    // Genera tutto
    generateWorldMap();
    generateSettlements();
    autogenerateStructures();
    drawCountyMap();
    drawRegionMap();

    updateUI();
    updateDynastyUI();
    updateAssetSummaryUI(); // Popola la sintesi insediamenti

    activateScreen("screen-game");
    
    // Aggiorna nuovamente l'UI dopo che lo schermo Ã¨ attivo
    setTimeout(() => updateUI(), 100);

    refreshAllStats();
    triggerStartupNarrative(true);

    addMsg("ai", `ðŸ“œ Benvenuto, ${heroName}. Il tuo regno attende le tue decisioni.`);
    if (personalitySettings && personalitySettings.notes) {
        addMsg("system", `ðŸ–‹ï¸ Appunti della corte: ${personalitySettings.notes}`);
    }

    autoSaveGame();

    initMapInteraction();
}

function switchTab(id, btn){
    document.querySelectorAll(".tab-view").forEach(t => t.classList.remove("active-tab"));
    document.getElementById(id).classList.add("active-tab");

    document.querySelectorAll(".hud-nav-bar button").forEach(b => b.classList.remove("active"));
    if (btn) btn.classList.add("active");

    if (id === 'tab-market') renderMarket();
    if (id === 'tab-warehouse') renderWarehouse();
    if (id === 'tab-dominio') updateUI();
}

/* ================= GESTIONE MODULO EDIFICI ================= */

function generateProductionChain(buildingKey) {
    const b = buildingData[buildingKey];
    if (!b || !b.recipe) return '';

    let html = '<div class="production-chain">';

    // Input section
    if (b.recipe.input && Object.keys(b.recipe.input).length > 0) {
        html += '<div class="chain-inputs">';
        html += '<h5>Input:</h5>';
        Object.entries(b.recipe.input).forEach(([res, amt]) => {
            html += `<span class="chain-resource input">${resourceIcon(res)} ${amt}</span>`;
        });
        html += '</div>';
        html += '<div class="chain-arrow">â†’</div>';
    }

    // Building
    html += `<div class="chain-building">${b.name}</div>`;

    // Output section
    if (b.recipe.output && Object.keys(b.recipe.output).length > 0) {
        html += '<div class="chain-arrow">â†’</div>';
        html += '<div class="chain-outputs">';
        html += '<h5>Output:</h5>';
        Object.entries(b.recipe.output).forEach(([res, amt]) => {
            html += `<span class="chain-resource output">${resourceIcon(res)} ${amt}</span>`;
        });
        html += '</div>';
    }

    // Upkeep section
    if (b.upkeep || b.resourceUpkeep) {
        html += '<div class="chain-upkeep">';
        html += '<h5>ðŸ’° Manutenzione per Turno:</h5>';

        if (b.upkeep && b.upkeep > 0) {
            html += `<div class="upkeep-gold">ðŸ’° ${b.upkeep} oro</div>`;
        }

        if (b.resourceUpkeep && Object.keys(b.resourceUpkeep).length > 0) {
            html += '<div class="upkeep-resources">';
            Object.entries(b.resourceUpkeep).forEach(([res, amt]) => {
                html += `<span class="chain-resource upkeep">${resourceIcon(res)} ${amt}</span>`;
            });
            html += '</div>';
        }

        html += '</div>';
    }

    html += '</div>';
    return html;
}

function openBuildingModal() {
    const modal = document.getElementById("modal-buildings");
    const grid = document.getElementById("building-grid");
    if (!modal || !grid) return;
    
    const currentTier = getCurrentTier();
    let html = `<h4 style="color: var(--accent); margin-bottom: 15px;">Livello Attuale: ${currentTier.name}</h4>`;

    // Cicla attraverso tutti gli edifici
    Object.keys(buildingData).forEach(key => {
        const b = buildingData[key];
        if (!b) return;

        // Controlla se l'edificio Ã¨ sbloccato per questo livello
        const isUnlocked = currentTier.unlocks && currentTier.unlocks.includes(key);
        if (!isUnlocked) return;

        // Determina il tipo di edificio per colori e immagini
        const buildingType = getBuildingType(key);
        const bgColor = getBuildingTypeColor(buildingType);
        const imageUrl = getBuildingImageUrl(key, buildingType);

        // Genera HTML per i costi con colori
        let costHtml = '';
        if (b.cost) {
            costHtml = Object.entries(b.cost).map(([res, amt]) => {
                const hasEnough = checkResources({[res]: amt});
                const costClass = hasEnough ? 'available' : 'missing';
                return `<span class="cost-badge ${costClass}">${resourceIcon(res)} ${amt}</span>`;
            }).join('');
        }

        // Genera sezione produzione
        let productionHtml = '';
        if (b.recipe && (b.recipe.input || b.recipe.output)) {
            productionHtml = '<div class="card-production-box">';
            if (b.recipe.input && Object.keys(b.recipe.input).length > 0) {
                const inputs = Object.entries(b.recipe.input).map(([res, amt]) => `${resourceIcon(res)} ${amt}`).join(' + ');
                productionHtml += `<div class="prod-row">${inputs} <span class="prod-arrow">â†’</span></div>`;
            }
            productionHtml += `<div class="prod-row">${b.name}</div>`;
            if (b.recipe.output && Object.keys(b.recipe.output).length > 0) {
                const outputs = Object.entries(b.recipe.output).map(([res, amt]) => `${resourceIcon(res)} ${amt}`).join(' + ');
                productionHtml += `<div class="prod-row"><span class="prod-arrow">â†’</span> ${outputs}</div>`;
            }
            productionHtml += '</div>';
        }

        // Genera sezione manutenzione
        let upkeepHtml = '';
        if (b.upkeep || b.resourceUpkeep) {
            upkeepHtml = '<div class="card-upkeep">';
            upkeepHtml += '<strong>ðŸ’° Manutenzione per Turno:</strong><br>';
            if (b.upkeep && b.upkeep > 0) {
                upkeepHtml += `${b.upkeep} oro<br>`;
            }
            if (b.resourceUpkeep && Object.keys(b.resourceUpkeep).length > 0) {
                const upkeepList = Object.entries(b.resourceUpkeep).map(([res, amt]) => `${resourceIcon(res)} ${amt}`).join(', ');
                upkeepHtml += upkeepList;
            }
            upkeepHtml += '</div>';
        }

        // Genera sezione manodopera
        let laborHtml = '';
        if (b.staff && b.staff.type && b.staff.amount) {
            const laborType = b.staff.type;
            const laborAmount = b.staff.amount;
            const laborTypeName = laborType === 'peasant' ? 'Contadini' : 
                                 laborType === 'burgher' ? 'Borghesi' : 
                                 laborType === 'militia' ? 'Milizia' : 
                                 laborType.charAt(0).toUpperCase() + laborType.slice(1);
            
            // Verifica se hai abbastanza lavoratori
            const availableLabor = populationGroups[laborType] ? populationGroups[laborType].count : 0;
            const hasEnoughLabor = availableLabor >= laborAmount;
            const laborClass = hasEnoughLabor ? 'available' : 'missing';
            
            laborHtml = `<div class="card-labor ${laborClass}">
                <strong>ðŸ‘¥ Manodopera Necessaria:</strong><br>
                ${laborTypeName}: ${laborAmount} (${availableLabor} disponibili)
            </div>`;
        }

        // Verifica se possiamo costruire (risorse sufficienti)
        const hasResources = checkResources(b.cost);
        const hasLabor = checkLabor(b.staff);
        const canBuild = hasResources && hasLabor;
        
        // Determina il testo del pulsante
        let buttonText = 'ðŸ—ï¸ Costruisci';
        if (!canBuild) {
            if (!hasResources && !hasLabor) {
                buttonText = 'âŒ Risorse e Manodopera Insufficienti';
            } else if (!hasResources) {
                buttonText = 'âŒ Risorse Insufficienti';
            } else if (!hasLabor) {
                buttonText = 'âŒ Manodopera Insufficiente';
            }
        }

        html += `
            <div class="building-card-v3 ${canBuild ? '' : 'disabled'}" style="background: linear-gradient(135deg, ${bgColor}22, ${bgColor}11);">
                <div class="card-img-top" style="background-image: url('${imageUrl}');">
                    <div class="card-time-badge">â³ ${b.time} turni</div>
                </div>

                <div class="card-body">
                    <h3 class="card-title">${b.name}</h3>
                    <p class="card-desc">${b.description || ''}</p>

                    ${productionHtml}
                    ${upkeepHtml}
                    ${laborHtml}
                </div>

                <div class="card-footer">
                    <div class="cost-grid">
                        ${costHtml}
                    </div>
                    <button class="btn-build-v3 ${canBuild ? '' : 'disabled'}"
                            onclick="orderBuilding('${key}')"
                            ${canBuild ? '' : 'disabled'}>
                        ${buttonText}
                    </button>
                </div>
            </div>
        `;
    });

    grid.innerHTML = html;
    modal.classList.add("active");
    modal.style.display = "flex";
}

function closeBuildingModal() {
    const modal = document.getElementById("modal-buildings");
    if (modal) {
        modal.classList.remove("active");
        modal.style.display = "none";
    }
}

// Funzioni helper per il sistema V3 delle carte costruzione
function getBuildingType(key) {
    // Determina il tipo di edificio basato sulla chiave
    if (key.includes('farm') || key.includes('mill') || key.includes('bakery') || key.includes('brewery')) {
        return 'farm';
    } else if (key.includes('mine') || key.includes('quarry') || key.includes('sawmill')) {
        return 'mine';
    } else if (key.includes('house') || key.includes('inn') || key.includes('tavern')) {
        return 'house';
    } else if (key.includes('market') || key.includes('shop') || key.includes('warehouse')) {
        return 'market';
    } else if (key.includes('church') || key.includes('temple') || key.includes('chapel')) {
        return 'church';
    } else if (key.includes('barracks') || key.includes('tower') || key.includes('wall')) {
        return 'barracks';
    }
    return 'other';
}

function getBuildingTypeColor(type) {
    const colors = {
        farm: '#2d4a22',      // Verde scuro per fattorie
        mine: '#3d3d3d',      // Grigio scuro per miniere
        house: '#5c4033',     // Marrone per case
        market: '#856818',    // Oro scuro per mercati
        church: '#4b0082',    // Viola per chiese
        barracks: '#7a1f1f',  // Rosso scuro per caserme
        other: '#2c3e50'      // Blu scuro neutro
    };
    return colors[type] || colors.other;
}

function getBuildingImageUrl(key, type) {
    // Usa placehold.co per immagini placeholder con testo e colore specifico
    const baseUrl = 'https://placehold.co/240x130';
    const colors = {
        farm: '2d4a22/white',
        mine: '3d3d3d/white',
        house: '5c4033/white',
        market: '856818/white',
        church: '4b0082/white',
        barracks: '7a1f1f/white',
        other: '2c3e50/white'
    };

    const color = colors[type] || colors.other;
    const text = encodeURIComponent(key.replace(/_/g, ' ').toUpperCase());

    return `${baseUrl}/${color}?text=${text}&font=arial`;
}

function resourceIcon(res) {
    const map = { gold:"ðŸ’°", wood:"ðŸŒ²", stone:"ðŸª¨", iron:"â›ï¸", copper:"ðŸ¥‰" };
    return map[res] || res;
}

// Versione estesa per le nuove merci del mercato
function resourceIconExtended(res) {
    const map = {
        gold:"ï¿½Y'ï¿½", wood:"ï¿½YOï¿½", stone:"ï¿½Yï¿½ï¿½", iron:"ï¿½>?ï¿½ï¿½?", copper:"ï¿½Yï¿½%",
        spices:"Spezie", parchment:"Perg.", candles:"Candele", incense:"Incenso", crystals:"Crist.", parade_horses:"Cavalli", seeds:"Semi"
    };
    return map[res] || res;
}
// Sostituisce la funzione base con quella estesa
const __originalResourceIcon = resourceIcon;
resourceIcon = function(res) { return resourceIconExtended(res); };

function checkResources(cost) {
    for (let k in cost) {
        // SE il costo Ã¨ "gold" o "oro", controlliamo il TESORO (county.gold)
        if (k === 'gold' || k === 'oro') {
            // Usa (county.gold || 0) per sicurezza
            if ((county.gold || 0) < cost[k]) return false;
        }
        // ALTRIMENTI controlliamo le RISORSE nel magazzino (county.resources)
        else {
            if ((county.resources[k] || 0) < cost[k]) return false;
        }
    }
    return true;
}

function checkLabor(labor) {
    if (!labor || !labor.type || !labor.amount) return true; // Nessun requisito di manodopera
    
    const availableLabor = populationGroups[labor.type] ? populationGroups[labor.type].count : 0;
    return availableLabor >= labor.amount;
}

function orderBuilding(key) {
    const b = buildingData[key];
    if (!checkResources(b.cost)) return;
    if (!checkLabor(b.staff)) return;

    // 1. Avvia la costruzione usando la funzione esistente
    startBuilding({
        type: key,
        x: 0, y: 0, // Costruzione astratta nel centro cittÃ 
        turns: b.time,
        cost: b.cost
    });

    // 2. Notifica in chat pubblica simulando un ordine del giocatore
    const msg = `Ho ordinato la costruzione di: ${b.name}. I lavori iniziano immediatamente.`;
    publicChatHistory.push({ role: "user", content: msg }); // Aggiorna memoria IA
    addMsg("user", msg);
    
    // 3. Chiudi modale e aggiorna UI
    closeBuildingModal();
    updateUI();
}

function updateConstructionUI() {
    const container = document.getElementById("construction-feed");
    if (!container) return;

    // Filtra solo i cantieri attivi ("building")
    const activeProjects = buildings.filter(b => b.stage === "building");

    if (activeProjects.length === 0) {
        container.innerHTML = '<p class="event-empty">Nessun cantiere attivo al momento.</p>';
        return;
    }

    let html = "";
    activeProjects.forEach(b => {
        // Recuperiamo i dati originali per calcolare la %
        const bData = buildingData[b.type];
        const totalTurns = bData ? bData.time : b.turns_left; // Fallback
        
        // Calcolo progresso: (Totale - Rimanenti) / Totale
        // Nota: b.turns_left diminuisce ogni turno
        const completedTurns = totalTurns - b.turns_left;
        let pct = Math.round((completedTurns / totalTurns) * 100);
        pct = Math.max(5, Math.min(100, pct)); // Clamp grafico tra 5% e 100%

        const turnsLabel = b.turns_left === 1 ? "1 turno al termine" : `${b.turns_left} turni al termine`;

        html += `
            <div class="const-card">
                <div class="const-header">
                    <strong>${bData ? bData.name : "Edificio sconosciuto"}</strong>
                    <span style="color:var(--accent)">${pct}%</span>
                </div>
                <div class="const-progress-bg">
                    <div class="const-progress-fill" style="width: ${pct}%"></div>
                </div>
                <div class="const-meta">
                    <span>ðŸ“ (${b.x}, ${b.y})</span>
                    <span>â³ ${turnsLabel}</span>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getResourceStats() {
    const stats = {};
    const lastEco = county.lastEconomy;
    if (!lastEco) {
        // Valori di default se non ancora calcolati
        RESOURCE_KEYS.forEach(key => {
            stats[key] = {
                production: Math.floor(Math.random() * 20) + 5,
                consumption: Math.floor(Math.random() * 15) + 5,
                net: Math.floor(Math.random() * 10) - 5
            };
        });
    } else {
        RESOURCE_KEYS.forEach(key => {
            const production = lastEco.production[key] || 0;
            const consumption = lastEco.deficits[key] || 0;
            const net = production - consumption;
            stats[key] = {
                production: production,
                consumption: consumption,
                net: net
            };
        });
    }
    return stats;
}

function renderResourceStats() {
    const container = document.getElementById("resource-stats");
    if (!container) return;

    const stats = getResourceStats();
    let html = `<div class="resource-stats-grid">`;

    RESOURCE_KEYS.forEach(key => {
        const s = stats[key];
        const icon = resourceIcon(key);
        const netClass = s.net > 0 ? 'positive' : s.net < 0 ? 'negative' : '';
        html += `
            <div class="resource-stat-item">
                <div class="resource-stat-header">
                    ${icon} ${resourceLabels[key] || key}
                </div>
                <div class="resource-stat-values">
                    <span>Prod: ${s.production}</span>
                    <span>Cons: ${s.consumption}</span>
                    <span class="${netClass}">Net: ${s.net > 0 ? '+' : ''}${s.net}</span>
                </div>
            </div>
        `;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

function getBasePrices() {
    return {
        // Materie Prime (Basso costo)
        grain: 2, wool: 3, iron: 5, wood: 2, clay: 1, seeds: 2,
        
        // Semilavorati (Valore aggiunto dalla manodopera)
        flour: 5,       // Da grain (2)
        fabric: 8,      // Da wool (3)
        iron_ingots: 10,// Da iron (5) + carbone/legno
        leather: 6,     // Da livestock
        parchment: 10,  // Da pelli lavorate
        candles: 12,    // Da cera/erbe
        
        // Prodotti Finiti (Alto valore di mercato)
        bread: 8,       // Cibo di qualitÃ 
        clothes: 25,    // Vestiti (richiesti dalla popolazione)
        tools: 20,      // Utensili (aumentano efficienza)
        furniture: 15,  // Mobili (comfort)
        parade_horses: 120,
        weapons: 40, 
        armor: 60,
        pottery: 5,
        
        // Altri
        stone: 8, copper: 12, gold: 1, herbs: 4, livestock: 10, textiles: 20, luxuries: 50, arcane: 100,
        spices: 55, incense: 18, crystals: 90
    };
}

function getMarketPrices() {
    const prices = getBasePrices();
    // Modifica basati su relazioni e accordi commerciali
    neighboringCounties.forEach(c => {
        const relation = c.relations || 50;
        let modifier = 1 + (50 - relation) / 100; // PiÃ¹ alta relazione, prezzi migliori (piÃ¹ bassi per comprare)
        if (c.tradeAgreement) {
            modifier *= 0.8; // Ulteriore sconto del 20% con accordo commerciale
        }
        Object.keys(prices).forEach(res => {
            prices[res] *= modifier;
        });
    });
    // Se non esiste produzione interna di una risorsa, aggiungi un minimo di offerta esterna
    Object.keys(prices).forEach(res => {
        if (!county.resources[res] || county.resources[res] <= 0) {
            county.resources[res] = 1; // disponibilitÃ  minima sul mercato globale
        }
    });
    return prices;
}

/* ===================== NUOVE FUNZIONI MERCATO ===================== */

// Helper per leggere la quantitÃ  dall'input
function getQtyValue(id) {
    const el = document.getElementById(id);
    if (!el) return 1;
    const val = parseInt(el.value);
    return (isNaN(val) || val < 1) ? 1 : val;
}

/* ===================== SISTEMA MAGAZZINO ===================== */

// Calcola produzione, consumo e autonomia per ogni risorsa
function calculateResourceStats() {
    const stats = {};
    
    // Usa le funzioni esistenti del gioco per calcolare produzione e consumo
    const production = calculateVillageProduction() || {};
    const consumption = calculateVillageConsumption() || {};
    
    // Aggiungi anche i bisogni logistici
    const logisticNeeds = calculateLogisticNeeds() || [];
    logisticNeeds.forEach(need => {
        consumption[need.resource] = (consumption[need.resource] || 0) + need.amount;
    });

    // Raccogli tutte le risorse (sia quelle in magazzino che quelle con produzione/consumo)
    const allResources = new Set([
        ...Object.keys(county.resources || {}),
        ...Object.keys(production),
        ...Object.keys(consumption)
    ]);

    // Calcola statistiche per ogni risorsa
    allResources.forEach(key => {
        const currentStock = county.resources[key] || 0;
        const productionRate = production[key] || 0;
        const consumptionRate = consumption[key] || 0;
        const netRate = productionRate - consumptionRate;
        
        let daysLeft = 0;
        if (netRate < 0) {
            // Consumo > produzione: calcola autonomia
            daysLeft = currentStock > 0 ? Math.floor(currentStock / Math.abs(netRate)) : 0;
        } else if (netRate === 0 && consumptionRate > 0) {
            // Produzione = consumo: calcola quanto dura lo stock
            daysLeft = currentStock > 0 ? Math.floor(currentStock / consumptionRate) : 0;
        } else {
            // Produzione > consumo: autonomia infinita
            daysLeft = 999;
        }

        stats[key] = {
            current: currentStock,
            consumption: consumptionRate,
            production: productionRate,
            net: netRate,
            daysLeft: daysLeft
        };
    });

    return stats;
}

// Determina lo stato di una risorsa (critical/warning/healthy)
function getResourceStatus(stat) {
    if (stat.daysLeft <= 2 && stat.daysLeft >= 0) return "critical";
    if (stat.daysLeft <= 5 && stat.daysLeft > 2) return "warning";
    if (stat.net >= 0) return "healthy";
    return "warning";
}

// Icone per le risorse
function getResourceIcon(key) {
    const icons = {
        // Risorse base
        food: "ðŸž",
        wood: "ðŸªµ",
        stone: "ðŸª¨",
        iron: "âš’ï¸",
        tools: "ðŸ”¨",
        cloth: "ðŸ§µ",
        leather: "ðŸ¥¾",
        gold: "ðŸ’°",
        copper: "ðŸ”¶",
        silver: "âšª",
        gems: "ðŸ’Ž",
        herbs: "ðŸŒ¿",
        mystic_crystals: "ðŸ”®",
        // Risorse del sistema village
        grain: "ðŸŒ¾",
        livestock: "ðŸ„",
        textiles: "ðŸ§µ",
        luxuries: "ðŸ’Ž",
        arcane: "ðŸ”®"
    };
    return icons[key] || "ðŸ“¦";
}

// Renderizza una singola card risorsa
function renderResourceCard(key, stat) {
    const status = getResourceStatus(stat);
    const icon = getResourceIcon(key);
    const label = resourceLabels[key] || key;

    let autonomyText = "";
    let autonomyClass = "";
    
    if (stat.net > 0) {
        autonomyText = "âœ“ Produzione eccedente";
        autonomyClass = "infinite";
    } else if (stat.net === 0 && stat.consumption === 0) {
        autonomyText = "â™¾ï¸ Risorsa stabile";
        autonomyClass = "infinite";
    } else if (stat.daysLeft >= 999) {
        autonomyText = "â™¾ï¸ Nessun consumo";
        autonomyClass = "infinite";
    } else if (stat.daysLeft <= 0) {
        autonomyText = "âš ï¸ ESAURITA!";
        autonomyClass = "critical";
    } else {
        autonomyText = `${stat.daysLeft} ${stat.daysLeft === 1 ? 'stagione' : 'stagioni'} rimanenti`;
        autonomyClass = status;
    }

    return `
        <div class="resource-item ${status}">
            <div class="resource-header-w">
                <div style="display: flex; align-items: center;">
                    <div class="resource-icon-w">${icon}</div>
                    <div class="resource-name-w">${label}</div>
                </div>
                <div class="resource-quantity">${stat.current}</div>
            </div>
            <div class="resource-details-w">
                <div class="resource-row-w ${stat.production > 0 ? 'positive' : ''}">
                    <span>ðŸ“ˆ Produzione:</span>
                    <span>+${stat.production}/stagione</span>
                </div>
                <div class="resource-row-w ${stat.consumption > 0 ? 'negative' : ''}">
                    <span>ðŸ“‰ Consumo:</span>
                    <span>-${stat.consumption}/stagione</span>
                </div>
                <div class="resource-row-w ${stat.net >= 0 ? 'positive' : 'negative'}">
                    <span>âš–ï¸ Bilancio:</span>
                    <span>${stat.net >= 0 ? '+' : ''}${stat.net}/stagione</span>
                </div>
            </div>
            <div class="resource-autonomy ${autonomyClass}">
                ${autonomyText}
            </div>
        </div>
    `;
}

// Renderizza il magazzino completo
function renderWarehouse() {
    const stats = calculateResourceStats();
    const totalPop = county.pop || 0;

    // Riepilogo veloce
    const summary = document.getElementById("warehouse-summary");
    if (summary) {
        const criticalCount = Object.values(stats).filter(s => getResourceStatus(s) === "critical").length;
        const warningCount = Object.values(stats).filter(s => getResourceStatus(s) === "warning").length;
        const healthyCount = Object.values(stats).filter(s => getResourceStatus(s) === "healthy").length;

        summary.innerHTML = `
            <div class="warehouse-stat">
                <div class="warehouse-stat-value">${Object.keys(county.resources).length}</div>
                <div class="warehouse-stat-label">Risorse Totali</div>
            </div>
            <div class="warehouse-stat">
                <div class="warehouse-stat-value" style="color: #f44336;">${criticalCount}</div>
                <div class="warehouse-stat-label">Critiche</div>
            </div>
            <div class="warehouse-stat">
                <div class="warehouse-stat-value" style="color: #ff9800;">${warningCount}</div>
                <div class="warehouse-stat-label">In Attenzione</div>
            </div>
            <div class="warehouse-stat">
                <div class="warehouse-stat-value" style="color: #4caf50;">${healthyCount}</div>
                <div class="warehouse-stat-label">Stabili</div>
            </div>
        `;
    }

    // Risorse critiche
    const criticalResources = Object.keys(stats).filter(k => getResourceStatus(stats[k]) === "critical");
    const criticalSection = document.getElementById("critical-resources-section");
    const criticalContainer = document.getElementById("critical-resources");
    
    if (criticalContainer && criticalSection) {
        if (criticalResources.length > 0) {
            criticalSection.style.display = "block";
            criticalContainer.innerHTML = criticalResources.map(key => renderResourceCard(key, stats[key])).join("");
        } else {
            criticalSection.style.display = "none";
        }
    }

    // Risorse in attenzione
    const warningResources = Object.keys(stats).filter(k => getResourceStatus(stats[k]) === "warning");
    const warningSection = document.getElementById("warning-resources-section");
    const warningContainer = document.getElementById("warning-resources");
    
    if (warningContainer && warningSection) {
        if (warningResources.length > 0) {
            warningSection.style.display = "block";
            warningContainer.innerHTML = warningResources.map(key => renderResourceCard(key, stats[key])).join("");
        } else {
            warningSection.style.display = "none";
        }
    }

    // Tutte le risorse
    const allContainer = document.getElementById("all-resources");
    if (allContainer) {
        allContainer.innerHTML = Object.keys(stats)
            .sort((a, b) => {
                const statusOrder = { critical: 0, warning: 1, healthy: 2 };
                return statusOrder[getResourceStatus(stats[a])] - statusOrder[getResourceStatus(stats[b])];
            })
            .map(key => renderResourceCard(key, stats[key]))
            .join("");
    }

    // Bisogni popolazione
    const needsContainer = document.getElementById("population-needs");
    if (needsContainer) {
        // Mostra tutte le risorse che hanno consumo > 0
        const needsList = [];
        
        Object.keys(stats).forEach(key => {
            const stat = stats[key];
            if (stat.consumption > 0) {
                needsList.push({
                    title: resourceLabels[key] || key,
                    value: stat.consumption,
                    desc: `Consumo della popolazione e strutture`,
                    icon: getResourceIcon(key)
                });
            }
        });
        
        // Aggiungi popolazione totale
        needsList.push({
            title: "Popolazione Totale",
            value: totalPop,
            desc: `Base per tutti i calcoli di consumo`,
            icon: "ðŸ‘¥"
        });

        needsContainer.innerHTML = needsList.map(need => `
            <div class="need-card">
                <div class="need-title">${need.icon} ${need.title}</div>
                <div class="need-value">${need.value}</div>
                <div class="need-desc">${need.desc}</div>
            </div>
        `).join("");
    }

    renderGovernorStorage();
}

// Magazzino privato del governatore: acquisto dal mercato
function renderGovernorStorage() {
    const list = document.getElementById('gov-storage-list');
    if (!list) return;
    const store = getGovernorStorage();
    let html = '';
    RESOURCE_KEYS.forEach(key => {
        const val = store[key] || 0;
        if (val > 0) {
            html += `<div class="resource-row"><span>${getResourceIcon(key)} ${resourceLabels[key] || key}</span><span>${val}</span></div>`;
        }
    });
    if (!html) html = '<p class="text-soft">Nessuna risorsa privata.</p>';
    list.innerHTML = html;
}

function handleGovernorPurchase() {
    const sel = document.getElementById('gov-buy-res');
    const qtyEl = document.getElementById('gov-buy-qty');
    if (!sel || !qtyEl) return;
    const res = sel.value;
    const qty = Math.max(1, parseInt(qtyEl.value, 10) || 1);
    const prices = getMarketPrices();
    const price = prices[res] || 1;
    const cost = price * qty;
    if ((county.gold || 0) < cost) {
        alert('Oro insufficiente per questo acquisto.');
        return;
    }
    county.gold = (county.gold || 0) - cost;
    const store = getGovernorStorage();
    store[res] = (store[res] || 0) + qty;
    renderGovernorStorage();
    updateUI();
    addMsg('system', `Il conte ha acquistato ${qty} ${resourceLabels[res] || res} per ${cost} oro (magazzino privato).`);
}

function renderMarket() {
    const container = document.getElementById("market-content");
    if (!container) return;

    const prices = getMarketPrices();
    const stats = getResourceStats();
    const marketDynamics = calculateMarketDemand();

    let html = `
        <!-- Summary Cards -->
        <div class="warehouse-summary" style="margin-bottom: 20px;">
            <div class="warehouse-stat">
                <div class="warehouse-stat-value">${county.gold}</div>
                <div class="warehouse-stat-label">ðŸ’° Oro Disponibile</div>
            </div>
            <div class="warehouse-stat">
                <div class="warehouse-stat-value">${seasonalTransactions.marketPurchases || 0}</div>
                <div class="warehouse-stat-label">Acquisti Stagione</div>
            </div>
            <div class="warehouse-stat">
                <div class="warehouse-stat-value">${seasonalTransactions.marketSales || 0}</div>
                <div class="warehouse-stat-label">Vendite Stagione</div>
            </div>
        </div>

        <!-- Market Resources Grid -->
        <div class="warehouse-section">
            <h3 style="color: var(--accent); margin-top: 0; margin-bottom: 15px;">ðŸ“Š Mercato Globale</h3>
            <p style="font-size:0.85em; color:var(--text-soft); margin-bottom:20px;">
                Compra e vendi risorse ai prezzi di mercato. I prezzi variano in base alla domanda e offerta.
            </p>
            <div class="resource-list">
    `;

    RESOURCE_KEYS.forEach(key => {
        const have = county.resources[key] || 0;
        const demand = Math.round(marketDynamics.demand[key] || 0);
        const supply = Math.max(1, Math.round(marketDynamics.supply[key] || 0)); // garantiamo disponibilitÃ 
        
        // Calcolo Prezzi
        let priceMultiplier = 1.0;
        if (demand > supply) priceMultiplier = 1.0 + (demand - supply) * 0.005;
        else if (supply > demand) priceMultiplier = Math.max(0.5, 1.0 - (supply - demand) * 0.005);
        
        const basePrice = prices[key];
        const buyPrice = Math.max(1, Math.round(basePrice * priceMultiplier * 1.3)); 
        const sellPrice = Math.max(1, Math.round(basePrice * priceMultiplier * 0.8));

        const fabbisogno = stats[key].consumption;
        const icon = resourceIcon(key);
        const inputId = `qty-${key}`;
        
        // Determina lo stato della risorsa
        const net = stats[key].net;
        let statusClass = "healthy";
        if (net < 0) statusClass = "critical";
        else if (net < fabbisogno / 2) statusClass = "warning";

        html += `
            <div class="resource-item ${statusClass}">
                <div class="resource-header-w">
                    <div style="display: flex; align-items: center;">
                        <span class="resource-icon-w">${icon}</span>
                        <span class="resource-name-w">${resourceLabels[key] || key}</span>
                    </div>
                    <div class="resource-quantity">${have}</div>
                </div>
                
                <div class="resource-details-w">
                    <div class="resource-row-w">
                        <span>Fabbisogno:</span>
                        <span>${fabbisogno}/turno</span>
                    </div>
                    <div class="resource-row-w ${net >= 0 ? 'positive' : 'negative'}">
                        <span>Bilancio:</span>
                        <span>${net >= 0 ? '+' : ''}${net}/turno</span>
                    </div>
                    <div class="resource-row-w">
                        <span>Domanda:</span>
                        <span>${demand}</span>
                    </div>
                    <div class="resource-row-w">
                        <span>Offerta:</span>
                        <span>${supply}</span>
                    </div>
                </div>

                <div style="margin: 12px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #ff7c7c; font-weight: bold;">ðŸ’° Acquisto: ${buyPrice}</span>
                        <span style="color: #6ada91; font-weight: bold;">ðŸ’° Vendita: ${sellPrice}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <button class="btn-sec" style="padding: 4px 8px; font-size: 0.75em;" 
                            onclick="document.getElementById('${inputId}').value=1">1</button>
                        <input id="${inputId}" type="number" class="market-qty-input" 
                            value="1" min="1" style="flex: 1; padding: 6px; text-align: center;">
                        <button class="btn-sec" style="padding: 4px 8px; font-size: 0.75em;" 
                            onclick="document.getElementById('${inputId}').value=10">10</button>
                        <button class="btn-sec" style="padding: 4px 8px; font-size: 0.75em;" 
                            onclick="document.getElementById('${inputId}').value=50">50</button>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-sec" style="flex: 1; background: rgba(255, 124, 124, 0.1); border-color: #ff7c7c;" 
                            onclick="buyResource('${key}', ${buyPrice}, getQtyValue('${inputId}'))">
                            Compra
                        </button>
                        <button class="btn-sec" style="flex: 1; background: rgba(106, 218, 145, 0.1); border-color: #6ada91;" 
                            onclick="sellResource('${key}', ${sellPrice}, getQtyValue('${inputId}'))" 
                            ${have > 0 ? '' : 'disabled'}>
                            Vendi
                        </button>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;

    // Sezione Merci Speciali
    const tradePartners = neighboringCounties.filter(c => c.tradeAgreement);
    if (tradePartners.length > 0) {
        html += `
            <div class="warehouse-section">
                <h3 style="color: var(--accent); margin-top: 0; margin-bottom: 15px;">âœ¨ Merci Speciali dai Regni Alleati</h3>
                <div class="resource-list">
        `;
        
        tradePartners.forEach(c => {
            const special = c.specialResource;
            if (special) {
                const relationModifier = c.relations / 100;
                const basePrice = prices[special] || 10;
                const buyPrice = Math.round(basePrice * 1.2 * (2 - relationModifier));
                const icon = resourceIcon(special);
                const have = county.resources[special] || 0;

                html += `
                    <div class="resource-item" style="border-color: var(--accent); background: rgba(212, 175, 55, 0.08);">
                        <div class="resource-header-w">
                            <div style="display: flex; align-items: center;">
                                <span class="resource-icon-w">${icon}</span>
                                <span class="resource-name-w">${resourceLabels[special] || special}</span>
                            </div>
                            <div class="resource-quantity" style="color: var(--accent);">${have}</div>
                        </div>
                        
                        <div class="resource-details-w">
                            <div class="resource-row-w">
                                <span>Origine:</span>
                                <span>${c.name}</span>
                            </div>
                            <div class="resource-row-w ${c.relations >= 70 ? 'positive' : c.relations >= 50 ? '' : 'negative'}">
                                <span>Relazioni:</span>
                                <span>${c.relations}/100</span>
                            </div>
                            <div class="resource-row-w">
                                <span>Accordo:</span>
                                <span style="color: var(--accent);">âœ“ Attivo</span>
                            </div>
                        </div>

                        <div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div style="text-align: center; margin-bottom: 8px; color: var(--accent); font-weight: bold;">
                                ðŸ’° Prezzo Speciale: ${buyPrice} oro
                            </div>
                            <button class="btn-main" style="width: 100%; padding: 10px;" 
                                onclick="buySpecialResource('${c.key}', '${special}', ${buyPrice})">
                                Acquista (1 unitÃ )
                            </button>
                            <p style="font-size: 0.75em; color: var(--text-soft); margin-top: 8px; margin-bottom: 0; text-align: center;">
                                Risorsa pregiata esclusiva. Prezzi vantaggiosi grazie all'alleanza.
                            </p>
                        </div>
                    </div>
                `;
            }
        });
        
        html += `
                </div>
            </div>
        `;
    } else {
        html += `
            <div class="warehouse-section" style="text-align: center; padding: 30px;">
                <h3 style="color: var(--text-soft); margin-top: 0;">âœ¨ Merci Speciali</h3>
                <p style="color: var(--text-soft); font-size: 0.9em;">
                    Firma accordi commerciali in diplomazia per accedere alle merci speciali dei regni vicini.
                </p>
            </div>
        `;
    }

    container.innerHTML = html;
}

function buyResource(res, unitPrice, qty) {
    if (qty < 1) qty = 1;
    const totalPrice = unitPrice * qty;

    if (county.gold >= totalPrice) {
        county.gold -= totalPrice;
        county.resources[res] = (county.resources[res] || 0) + qty;
        seasonalTransactions.marketPurchases += totalPrice;
        
        updateUI();
        renderMarket(); // Rerender per aggiornare stock e input
        
        addMsg("system", `ðŸ›’ Acquistati <strong>${qty}</strong> unitÃ  di ${resourceLabels[res] || res} per ${totalPrice} oro.`);
    } else {
        // Calcola quanti ne puÃ² comprare al massimo
        const maxAffordable = Math.floor(county.gold / unitPrice);
        if (maxAffordable > 0) {
            addMsg("system", `âš ï¸ Oro insufficiente per ${qty}. Puoi permettertene al massimo ${maxAffordable}.`);
        } else {
            addMsg("system", "âš ï¸ Oro insufficiente per l'acquisto.");
        }
    }
}

function sellResource(res, unitPrice, qty) {
    if (qty < 1) qty = 1;
    const have = county.resources[res] || 0;

    if (have >= qty) {
        const totalRevenue = unitPrice * qty;
        county.gold += totalRevenue;
        county.resources[res] -= qty;
        seasonalTransactions.marketSales += totalRevenue;
        
        updateUI();
        renderMarket();
        
        addMsg("system", `âš–ï¸ Venduti <strong>${qty}</strong> unitÃ  di ${resourceLabels[res] || res} per ${totalRevenue} oro.`);
    } else {
        addMsg("system", `âš ï¸ Non hai abbastanza ${resourceLabels[res] || res} in magazzino (Disponibili: ${have}).`);
    }
}

function buySpecialResource(neighborKey, res, price) {
    if (county.gold >= price) {
        county.gold -= price;
        county.resources[res] = (county.resources[res] || 0) + 1;
        seasonalTransactions.specialPurchases += price;
        // Migliora leggermente relazioni
        const neighbor = neighboringCounties.find(c => c.key === neighborKey);
        if (neighbor) neighbor.relations = Math.min(100, neighbor.relations + 2);
        updateUI();
        renderMarket();
        addMsg("system", `Acquistato 1 ${resourceLabels[res] || res} speciale da ${neighbor.name} per ${price} oro. Relazioni migliorate.`);
    } else {
        addMsg("system", "Oro insufficiente per l'acquisto.");
    }
}

function drawRegionMap() {
    const canvas = document.getElementById("region-map");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const size = canvas.width / 8;

    // Sfondo carta antica con texture migliorata
    ctx.fillStyle = "#e8dcc0"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Aggiungi texture pergamena piÃ¹ realistica
    ctx.fillStyle = "rgba(139, 115, 85, 0.08)";
    for (let i = 0; i < 80; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const w = Math.random() * 30 + 5;
        const h = Math.random() * 30 + 5;
        ctx.fillRect(x, y, w, h);
    }

    // Disegna territori con sistema piÃ¹ coerente
    const territoryMap = [
        ['auvrey', 'auvrey', 'wild', 'wild', 'wild', 'count', 'count', 'count'],
        ['auvrey', 'auvrey', 'wild', 'count', 'count', 'count', 'count', 'wild'],
        ['wild', 'wild', 'count', 'count', 'count', 'count', 'wild', 'wild'],
        ['wild', 'count', 'count', 'count', 'count', 'count', 'wild', 'wild'],
        ['count', 'count', 'count', 'count', 'count', 'wild', 'wild', 'wild'],
        ['wild', 'wild', 'count', 'count', 'wild', 'wild', 'falken', 'falken'],
        ['wild', 'wild', 'wild', 'wild', 'wild', 'falken', 'falken', 'falken'],
        ['wild', 'wild', 'wild', 'wild', 'wild', 'wild', 'falken', 'falken']
    ];

    for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 8; x++) {
            const owner = territoryMap[y][x];
            const px = x * size;
            const py = y * size;

            // Riempimento con gradiente per profonditÃ  e rilievo
            const gradient = ctx.createLinearGradient(px, py, px + size, py + size);
            gradient.addColorStop(0, getRegionColor(owner, 0.25));
            gradient.addColorStop(0.5, getRegionColor(owner, 0.35));
            gradient.addColorStop(1, getRegionColor(owner, 0.45));
            ctx.fillStyle = gradient;
            ctx.fillRect(px, py, size, size);
            
            // Bordi piÃ¹ definiti e visibili
            ctx.strokeStyle = getRegionColor(owner, 0.9);
            ctx.lineWidth = 1.5;
            ctx.strokeRect(px, py, size, size);
            
            // Aggiungi texture interna casuale per simulare terreno
            if (Math.random() < 0.3) {
                ctx.fillStyle = getRegionColor(owner, 0.15);
                ctx.fillRect(px + size * 0.2, py + size * 0.2, size * 0.6, size * 0.6);
            }
        }
    }
    
    // Disegna strade principali piÃ¹ visibili
    ctx.strokeStyle = "rgba(101, 67, 33, 0.7)";
    ctx.lineWidth = 4;
    ctx.setLineDash([8, 4]);
    
    // Strada principale diagonale NW-SE
    ctx.beginPath();
    ctx.moveTo(0, canvas.height * 0.2);
    ctx.lineTo(canvas.width * 0.4, canvas.height * 0.5);
    ctx.lineTo(canvas.width, canvas.height * 0.8);
    ctx.stroke();
    
    // Strada principale diagonale NE-SW
    ctx.beginPath();
    ctx.moveTo(canvas.width, canvas.height * 0.3);
    ctx.lineTo(canvas.width * 0.6, canvas.height * 0.5);
    ctx.lineTo(0, canvas.height * 0.7);
    ctx.stroke();
    
    // Strada orizzontale centrale
    ctx.beginPath();
    ctx.moveTo(0, canvas.height * 0.5);
    ctx.lineTo(canvas.width, canvas.height * 0.5);
    ctx.stroke();
    
    ctx.setLineDash([]);
    
    // Disegna fiumi stilizzati
    ctx.strokeStyle = "rgba(100, 150, 200, 0.4)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(canvas.width * 0.3, 0);
    ctx.quadraticCurveTo(
        canvas.width * 0.4, canvas.height * 0.5,
        canvas.width * 0.6, canvas.height
    );
    ctx.stroke();
    
    // Etichette dei territori
    const labels = [
        { name: "Contea di Auvrey", x: 1, y: 1, owner: 'auvrey' },
        { name: "Terre del Conte", x: 4, y: 3, owner: 'count' },
        { name: "Contea di Falken", x: 6, y: 6, owner: 'falken' },
        { name: "Terre Selvagge", x: 2, y: 5, owner: 'wild' }
    ];
    
    labels.forEach(label => {
        const px = label.x * size + size/2;
        const py = label.y * size + size/2;
        
        // Sfondo etichetta
        ctx.fillStyle = "rgba(244, 236, 216, 0.85)";
        ctx.font = "bold 10px Georgia";
        const textWidth = ctx.measureText(label.name).width;
        ctx.fillRect(px - textWidth/2 - 4, py - 8, textWidth + 8, 16);
        
        // Bordo etichetta
        ctx.strokeStyle = getRegionColor(label.owner, 1);
        ctx.lineWidth = 1.5;
        ctx.strokeRect(px - textWidth/2 - 4, py - 8, textWidth + 8, 16);
        
        // Testo
        ctx.fillStyle = "#3e2723";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(label.name, px, py);
    });
    
    // Disegna cittÃ /capitali
    drawRegionalCities(ctx, size);
    
    // Pins delle contee vicine
    drawNeighborPins(ctx);
    
    // Vignettatura
    drawVignette(ctx, canvas.width, canvas.height);
    
    // Legenda migliorata
    drawRegionalLegend(ctx, canvas.width, canvas.height);
}

// NUOVA FUNZIONE: Disegna cittÃ  importanti sulla mappa regionale
function drawRegionalCities(ctx, size) {
    const cities = [
        { x: 4, y: 3, name: "Capitale", size: "large" },  // CittÃ  principale del conte
        { x: 1, y: 1, name: "Auvrey", size: "medium" },
        { x: 6, y: 6, name: "Falken", size: "medium" }
    ];
    
    cities.forEach(city => {
        const px = city.x * size + size/2;
        const py = city.y * size + size/2;
        const radius = city.size === "large" ? 6 : 4;
        
        // Cerchio cittÃ 
        ctx.fillStyle = "#3e2723";
        ctx.strokeStyle = "#d4af37";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(px, py, radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();
        
        // Stella per capitale
        if (city.size === "large") {
            ctx.fillStyle = "#d4af37";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText("â˜…", px, py - 12);
        }
    });
}

// NUOVA FUNZIONE: Legenda regionale migliorata
function drawRegionalLegend(ctx, width, height) {
    const legendX = 10;
    const legendY = height - 100;
    
    // Sfondo legenda
    ctx.fillStyle = "rgba(244, 236, 216, 0.95)";
    ctx.strokeStyle = "#8b7355";
    ctx.lineWidth = 2;
    ctx.fillRect(legendX, legendY, 140, 90);
    ctx.strokeRect(legendX, legendY, 140, 90);
    
    ctx.font = "bold 11px Georgia";
    ctx.textAlign = "left";
    ctx.fillStyle = "#3e2723";
    ctx.fillText("Legenda Regionale:", legendX + 10, legendY + 15);
    
    const owners = [
        { key: "count", name: "Terre del Conte" },
        { key: "auvrey", name: "Contea Auvrey" },
        { key: "falken", name: "Contea Falken" },
        { key: "wild", name: "Terre Selvagge" }
    ];
    
    ctx.font = "10px Georgia";
    owners.forEach((o, i) => {
        const y = legendY + 32 + i * 16;
        
        // Quadrato colore
        ctx.fillStyle = getRegionColor(o.key, 0.8);
        ctx.fillRect(legendX + 10, y - 8, 12, 12);
        ctx.strokeStyle = getRegionColor(o.key, 1);
        ctx.lineWidth = 1;
        ctx.strokeRect(legendX + 10, y - 8, 12, 12);
        
        // Testo
        ctx.fillStyle = "#3e2723";
        ctx.fillText(o.name, legendX + 28, y);
    });
}

function getRegionColor(owner, alpha) {
    const map = {
        count: `rgba(212, 175, 55, ${alpha})`,  // Oro per il conte
        auvrey: `rgba(180, 40, 40, ${alpha})`,  // Rosso scuro per Auvrey
        falken: `rgba(20, 60, 120, ${alpha})`,  // Blu scuro per Falken
        wild: `rgba(100, 100, 100, ${alpha})`   // Grigio neutro per terre selvagge
    };
    return map[owner] || map.wild;
}

function drawNeighborPins(ctx) {
    const canvas = ctx.canvas;
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = canvas.width * 0.35;

    neighboringCounties.forEach((c, idx) => {
        const angle = (idx / neighboringCounties.length) * Math.PI * 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;

        ctx.beginPath();
        ctx.fillStyle = getRegionColor(c.key, 1);
        ctx.arc(x, y, 12, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#3e2723";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.fillStyle = "#fff";
        ctx.font = "10px Georgia";
        ctx.textAlign = "center";
        ctx.fillText(c.name.split(" ")[0], x, y + 3);
    });
}

function closeBudgetModal() {
    const modal = document.getElementById("modal-budget");
    if (modal) modal.classList.remove("active");
}

/* ============= FUNZIONI MODAL GENERICA (per sistema di guerra) ============= */

function showModal(title, content) {
    const modal = document.getElementById("modal-generic");
    const modalContent = document.getElementById("modal-generic-content");
    
    if (!modal || !modalContent) {
        console.error("Modal generica non trovata!");
        return;
    }
    
    // Costruisci contenuto con titolo opzionale
    let html = '';
    if (title) {
        html += `<div class="modal-header"><h3>${title}</h3></div>`;
    }
    html += `<div style="padding: 20px;">${content}</div>`;
    
    modalContent.innerHTML = html;
    modal.classList.add("active");
    
    // Chiudi cliccando fuori
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeModal();
        }
    };
}

function closeModal() {
    const modal = document.getElementById("modal-generic");
    if (modal) {
        modal.classList.remove("active");
        modal.onclick = null;
    }
}

/* ============================================================================ */

document.addEventListener("DOMContentLoaded", initStartScreen);

// ===================== STRUTTURE DATI AVANZATE =====================

// Costanti tattiche e terreni giÃ  definite nella prima dichiarazione di warState

// Tattiche disponibili
const WAR_TACTICS = {
    aggressive_assault: {
        name: "ðŸ—¡ï¸ Assalto Aggressivo",
        desc: "Attacco frontale devastante. +50% danno, -30% difesa, +20% perdite",
        attackBonus: 1.5,
        defenseBonus: 0.7,
        casualtyMultiplier: 1.2,
        moraleImpact: -5,
        requirements: { morale: 60 }
    },
    defensive_stance: {
        name: "ðŸ›¡ï¸ Posizione Difensiva",
        desc: "Difesa ferrea e disciplinata. -20% danno, +60% difesa, -40% perdite",
        attackBonus: 0.8,
        defenseBonus: 1.6,
        casualtyMultiplier: 0.6,
        moraleImpact: +10,
        requirements: {}
    },
    balanced: {
        name: "âš–ï¸ Formazione Bilanciata",
        desc: "Equilibrio tra attacco e difesa. Nessun modificatore estremo",
        attackBonus: 1.0,
        defenseBonus: 1.0,
        casualtyMultiplier: 1.0,
        moraleImpact: 0,
        requirements: {}
    },
    flanking: {
        name: "ðŸ¹ Manovra di Aggiramento",
        desc: "Attacco sui fianchi. +30% danno se riesce, richiede cavalleria",
        attackBonus: 1.3,
        defenseBonus: 0.9,
        casualtyMultiplier: 0.9,
        moraleImpact: +5,
        requirements: { cavalry: 20 },
        successChance: 0.6
    },
    feigned_retreat: {
        name: "ðŸƒ Finta Ritirata",
        desc: "Attira il nemico in trappola. Rischioso ma devastante se funziona",
        attackBonus: 1.8,
        defenseBonus: 0.6,
        casualtyMultiplier: 1.5,
        moraleImpact: -10,
        requirements: { morale: 70, experience: 3 },
        successChance: 0.5
    },
    siegePreparation: {
        name: "ðŸ° Preparazione Assedio",
        desc: "Costruisci macchine d'assedio e accampamento fortificato",
        attackBonus: 0.5,
        defenseBonus: 1.3,
        casualtyMultiplier: 0.7,
        moraleImpact: 0,
        requirements: { wood: 100, iron: 50 },
        prepTime: 2
    },
    nightRaid: {
        name: "ðŸŒ™ Incursione Notturna",
        desc: "Attacco a sorpresa nelle tenebre. Alto rischio, alta ricompensa",
        attackBonus: 2.0,
        defenseBonus: 0.5,
        casualtyMultiplier: 1.3,
        moraleImpact: +15,
        requirements: { morale: 65 },
        successChance: 0.55,
        enemyMoraleImpact: -20
    }
};

// Comandanti (generati o storici)
const COMMANDER_TRAITS = {
    // Offensive
    aggressive: { name: "Aggressivo", attack: +20, defense: -10, morale: +5 },
    reckless: { name: "Temerario", attack: +30, defense: -20, casualties: +15 },
    inspiring: { name: "Ispiratore", morale: +20, attack: +10 },
    
    // Defensive
    cautious: { name: "Cauto", attack: -10, defense: +20, casualties: -10 },
    defensive: { name: "Difensore", defense: +30, casualties: -15 },
    
    // Tactical
    tactician: { name: "Tattico", attack: +15, defense: +15, special: "unlock_advanced_tactics" },
    cunning: { name: "Astuto", special: "higher_ambush_chance" },
    
    // Support
    disciplinarian: { name: "Disciplinatore", morale: +15, casualties: -10 },
    veteran: { name: "Veterano", experience: +2, morale: +10 },
    
    // Specialist
    siegemaster: { name: "Maestro d'Assedio", siegeBonus: +40 },
    cavalry_expert: { name: "Esperto di Cavalleria", cavalryBonus: +30 }
};

// Terreni di battaglia
const BATTLE_TERRAINS = {
    plains: {
        name: "Pianure",
        desc: "Terreno aperto ideale per cavalleria e manovre",
        cavalryBonus: 1.3,
        infantryBonus: 1.0,
        siegeBonus: 1.0
    },
    forest: {
        name: "Foresta",
        desc: "Boschi densi che ostacolano i movimenti",
        cavalryBonus: 0.7,
        infantryBonus: 1.2,
        ambushChance: 0.3
    },
    hills: {
        name: "Colline",
        desc: "Terreno elevato, vantaggio difensivo",
        defenderBonus: 1.4,
        attackerBonus: 0.8
    },
    river_crossing: {
        name: "Guado del Fiume",
        desc: "Attraversamento pericoloso, attaccante svantaggiato",
        attackerBonus: 0.6,
        defenderBonus: 1.5,
        casualties: 1.3
    },
    castle_walls: {
        name: "Mura del Castello",
        desc: "Fortificazioni imponenti, assedio necessario",
        defenderBonus: 2.5,
        attackerBonus: 0.4,
        siegeRequired: true
    },
    swamp: {
        name: "Palude",
        desc: "Terreno insidioso, tutti soffrono",
        cavalryBonus: 0.5,
        infantryBonus: 0.8,
        moralePenalty: -10
    }
};

// Eventi casuali durante battaglia
const BATTLE_EVENTS = [
    {
        id: "arrow_storm",
        name: "Tempesta di Frecce",
        desc: "Gli arcieri nemici scatenano una pioggia mortale",
        effect: { casualties: +15, morale: -10 },
        chance: 0.15
    },
    {
        id: "commander_wounded",
        name: "Comandante Ferito",
        desc: "Il tuo comandante Ã¨ stato colpito!",
        effect: { morale: -20, attack: -15 },
        chance: 0.08
    },
    {
        id: "reinforcements",
        name: "Rinforzi Inaspettati",
        desc: "Truppe alleate arrivano sul campo di battaglia!",
        effect: { power: +200, morale: +25 },
        chance: 0.06
    },
    {
        id: "enemy_retreat",
        name: "Nemico in Rotta",
        desc: "Il morale nemico crolla, iniziano a fuggire!",
        effect: { enemyPower: -30, victoryChance: +0.3 },
        chance: 0.1,
        requirements: { enemyMorale: 30 }
    },
    {
        id: "storm",
        name: "Tempesta",
        desc: "Un temporale improvviso ostacola entrambi gli eserciti",
        effect: { allPower: 0.8, morale: -5 },
        chance: 0.12
    },
    {
        id: "heroic_charge",
        name: "Carica Eroica",
        desc: "Un gruppo di guerrieri lancia una carica devastante!",
        effect: { attack: +30, morale: +15 },
        chance: 0.1,
        requirements: { morale: 70 }
    },
    {
        id: "disease_outbreak",
        name: "Epidemia",
        desc: "Una malattia si diffonde nell'accampamento",
        effect: { casualties: +20, morale: -15, health: -10 },
        chance: 0.07,
        context: "siege_long"
    },
    {
        id: "supply_raid",
        name: "Razzia Rifornimenti",
        desc: "Il nemico ha razziato i nostri rifornimenti!",
        effect: { supplies: -30, morale: -10 },
        chance: 0.1
    }
];

// ===================== FUNZIONI DI GUERRA MIGLIORATE =====================

function declareWarAdvanced(enemyKey) {
    const target = neighboringCounties.find(c => c.key === enemyKey);
    if (!target) return;
    
    // Mostra dialogo immersivo
    showWarDeclarationDialog(target);
}

function showWarDeclarationDialog(target) {
    const modal = `
        <div style="max-width: 600px;">
            <h2 style="color: #c74444; text-align: center; margin-bottom: 20px;">
                âš”ï¸ DICHIARAZIONE DI GUERRA âš”ï¸
            </h2>
            
            <div style="background: rgba(199, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="font-style: italic; line-height: 1.6;">
                    "Sei sicuro di voler dichiarare guerra alla <strong>${target.name}</strong>?
                    Questa decisione porterÃ  morte, distruzione e conseguenze imprevedibili per il tuo regno."
                </p>
            </div>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="color: var(--accent); margin-top: 0;">Intelligence Militare</h3>
                <div class="info-text">
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Forza Militare Nemica:</span>
                        <span class="highlight">${target.power * 10} (${getRatingText(target.power)})</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>AggressivitÃ :</span>
                        <span style="color: ${target.aggression > 60 ? '#c74444' : '#44c777'}">${target.aggression}/100</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Ricchezza Stimata:</span>
                        <span class="highlight">${target.wealth * 2} oro</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Relazioni Attuali:</span>
                        <span style="color: ${target.relations > 50 ? '#44c777' : '#c74444'}">${target.relations}/100</span>
                    </div>
                </div>
            </div>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="color: var(--accent); margin-top: 0;">Le Tue Forze</h3>
                <div class="info-text">
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Milizia Professionale:</span>
                        <span class="highlight">${populationGroups.militia.count} soldati</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Armi Disponibili:</span>
                        <span style="color: ${county.resources.weapons < 50 ? '#c74444' : '#44c777'}">${county.resources.weapons}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Armature:</span>
                        <span style="color: ${county.resources.armor < 30 ? '#c74444' : '#44c777'}">${county.resources.armor}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>Potenza Militare Totale:</span>
                        <span class="highlight">${calculateMilitaryPower()}</span>
                    </div>
                </div>
            </div>
            
            ${populationGroups.militia.count < 50 || county.resources.weapons < 30 ? `
                <div style="background: rgba(199, 68, 68, 0.2); padding: 12px; border-radius: 8px; border-left: 3px solid #c74444; margin-bottom: 15px;">
                    <strong>âš ï¸ AVVISO:</strong> Il tuo esercito Ã¨ debole o mal equipaggiato. La guerra potrebbe essere disastrosa!
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn modal-btn-secondary" style="flex: 1;" onclick="closeModal()">
                    ðŸ•Šï¸ Ripensaci
                </button>
                <button class="modal-btn" style="flex: 1; background: #c74444; color: white;" onclick="confirmWarDeclaration('${target.key}')">
                    âš”ï¸ Dichiara Guerra
                </button>
            </div>
        </div>
    `;
    
    showModal("Dichiarazione di Guerra", modal);
}

function getRatingText(power) {
    if (power < 3) return "Molto Debole";
    if (power < 5) return "Debole";
    if (power < 7) return "Moderata";
    if (power < 9) return "Forte";
    return "Molto Forte";
}

async function confirmWarDeclaration(enemyKey) {
    closeModal();
    
    const target = neighboringCounties.find(c => c.key === enemyKey);
    
    // Inizializza stato guerra
    warState.active = true;
    warState.enemy = enemyKey;
    warState.type = 'invasion';
    warState.phase = 'preparation';
    warState.turn = 0;
    warState.battleLog = [];
    
    target.relations = 0;
    target.aggression = 100;
    
    // Genera comandante nemico
    warState.enemyCommander = generateCommander(target.name);
    
    // Messaggio drammatico
    addMsg("system", `ðŸ“£ <strong style="color: #c74444;">GUERRA DICHIARATA!</strong>`);
    addMsg("system", `Le bandiere di guerra sono state issate. ${target.name} Ã¨ ora nostro nemico giurato.`);
    
    // Chiedi all'IA di generare una narrativa
    if (apiKey) {
        await generateWarNarrative('declaration', target);
    }
    
    // Mostra schermata preparazione guerra
    setTimeout(() => {
        showWarPreparationScreen();
    }, 1500);
    
    updateUI();
}

// Genera comandante con tratti casuali
function generateCommander(faction, isEnemy = false) {
    const names = isEnemy ? 
        ["Generale Blackwood", "Lord Crimson", "Comandante Ironforge", "Maresciallo Darkbane"] :
        ["Ser Valiant", "Capitano Stormheart", "Lord Guardian", "Maresciallo Defender"];
    
    const traits = Object.keys(COMMANDER_TRAITS);
    const selectedTraits = [
        traits[Math.floor(Math.random() * traits.length)],
        traits[Math.floor(Math.random() * traits.length)]
    ];
    
    return {
        name: names[Math.floor(Math.random() * names.length)],
        traits: selectedTraits,
        experience: isEnemy ? Math.floor(Math.random() * 5) : 0,
        alive: true
    };
}

// Schermata di preparazione guerra
function showWarPreparationScreen() {
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    
    const modal = `
        <div style="max-width: 700px;">
            <h2 style="color: var(--accent); text-align: center;">âš”ï¸ PREPARAZIONE ALLA GUERRA âš”ï¸</h2>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">Situazione Strategica</h3>
                <p style="line-height: 1.6; color: var(--text-soft);">
                    La guerra contro <strong>${target.name}</strong> Ã¨ iniziata. 
                    Devi decidere come condurre la campagna militare.
                </p>
                
                <div style="margin-top: 15px;">
                    <div style="margin: 10px 0;">
                        <strong>Nemico:</strong> ${warState.enemyCommander.name}<br>
                        <span style="font-size: 0.9em; color: var(--text-soft);">
                            Tratti: ${warState.enemyCommander.traits.map(t => COMMANDER_TRAITS[t].name).join(', ')}
                        </span>
                    </div>
                </div>
            </div>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">ðŸŽ–ï¸ Seleziona Comandante</h3>
                
                ${warState.commanders.length === 0 ? `
                    <p style="color: var(--text-soft); margin-bottom: 15px;">
                        Non hai ancora comandanti. Puoi promuovere un ufficiale dalla milizia o guidare personalmente le truppe.
                    </p>
                    <button class="action-btn" onclick="promoteCommander()">
                        Promuovi un Ufficiale (50 oro)
                    </button>
                    <button class="action-btn" onclick="leadPersonally()">
                        Guida Personalmente le Truppe
                    </button>
                ` : `
                    <div id="commanders-list">
                        ${warState.commanders.map((cmd, i) => `
                            <div class="action-btn" onclick="selectCommander(${i})">
                                <strong>${cmd.name}</strong><br>
                                <span style="font-size: 0.85em;">
                                    ${cmd.traits.map(t => COMMANDER_TRAITS[t].name).join(', ')} | 
                                    Esperienza: ${cmd.experience}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">âš”ï¸ Tipo di Campagna</h3>
                
                <button class="action-btn" onclick="startWarCampaign('quick_raid')">
                    ðŸƒ Incursione Rapida
                    <div style="font-size: 0.85em; color: var(--text-soft); margin-top: 5px;">
                        Attacco veloce per saccheggiare e ritirarsi. Basso rischio, bassa ricompensa.
                    </div>
                </button>
                
                <button class="action-btn" onclick="startWarCampaign('pitched_battle')">
                    âš”ï¸ Battaglia Campale
                    <div style="font-size: 0.85em; color: var(--text-soft); margin-top: 5px;">
                        Scontro decisivo in campo aperto. Alto rischio, potenziale vittoria totale.
                    </div>
                </button>
                
                <button class="action-btn" onclick="startWarCampaign('siege')">
                    ðŸ° Assedio
                    <div style="font-size: 0.85em; color: var(--text-soft); margin-top: 5px;">
                        Assedio prolungato del castello nemico. Richiede tempo e risorse, ma conquista territoriale.
                    </div>
                </button>
            </div>
            
            <div style="background: rgba(199, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin: 15px 0;">
                <strong>âš ï¸ Promemoria:</strong> La guerra consuma risorse rapidamente. 
                Assicurati di avere cibo, armi e oro sufficienti per sostenere la campagna.
            </div>
            
            <button class="modal-btn modal-btn-secondary" onclick="closeModal()">
                Chiudi
            </button>
        </div>
    `;
    
    showModal("Preparazione Guerra", modal);
}

function promoteCommander() {
    if (county.gold < 50) {
        addMsg("system", "âŒ Non hai abbastanza oro per promuovere un comandante.");
        return;
    }
    
    county.gold -= 50;
    const newCommander = generateCommander(heroName, false);
    warState.commanders.push(newCommander);
    
    addMsg("system", `ðŸŽ–ï¸ ${newCommander.name} Ã¨ stato promosso a comandante dell'esercito!`);
    showWarPreparationScreen();
}

function leadPersonally() {
    const personalCommander = {
        name: heroName,
        traits: ['inspiring', 'tactician'],
        experience: 1,
        alive: true,
        isRuler: true
    };
    
    warState.commanders.push(personalCommander);
    addMsg("system", `ðŸ‘‘ ${heroName} guiderÃ  personalmente le truppe in battaglia!`);
    county.happiness -= 5; // Rischio per il conte
    
    showWarPreparationScreen();
}

function selectCommander(index) {
    warState.selectedCommander = index;
    addMsg("system", `${warState.commanders[index].name} Ã¨ stato scelto per guidare l'esercito.`);
    closeModal();
}

// Inizia campagna di guerra
function startWarCampaign(type) {
    warState.type = type;
    closeModal();
    
    switch(type) {
        case 'quick_raid':
            executeRaid();
            break;
        case 'pitched_battle':
            prepareBattle();
            break;
        case 'siege':
            initiateSiege();
            break;
    }
}

// ===================== SISTEMA DI BATTAGLIA DETTAGLIATO =====================

async function prepareBattle() {
    warState.phase = 'march';
    
    addMsg("system", "ðŸš¶ L'esercito marcia verso il campo di battaglia...");
    
    // Genera terreno casuale
    const terrains = Object.keys(BATTLE_TERRAINS);
    const selectedTerrain = terrains[Math.floor(Math.random() * terrains.length)];
    warState.terrain = selectedTerrain;
    
    // Chiedi all'IA di descrivere la marcia
    if (apiKey) {
        await generateWarNarrative('march', {
            terrain: BATTLE_TERRAINS[selectedTerrain],
            morale: warState.morale.militia
        });
    }
    
    setTimeout(() => {
        showBattlePreparationScreen();
    }, 2000);
}

function showBattlePreparationScreen() {
    const terrain = BATTLE_TERRAINS[warState.terrain];
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    
    const modal = `
        <div style="max-width: 800px;">
            <h2 style="color: #c74444; text-align: center;">âš”ï¸ BATTAGLIA IMMINENTE âš”ï¸</h2>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">ðŸ—ºï¸ Terreno: ${terrain.name}</h3>
                <p style="color: var(--text-soft);">${terrain.desc}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                <div style="background: rgba(68, 199, 119, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #44c777;">
                    <h4 style="color: #44c777; margin-top: 0;">ðŸ›¡ï¸ Le Nostre Forze</h4>
                    <div style="font-size: 0.9em;">
                        <div style="margin: 5px 0;">Soldati: ${populationGroups.militia.count}</div>
                        <div style="margin: 5px 0;">Leve: ${warState.leviesCount}</div>
                        <div style="margin: 5px 0;">Potenza: ${calculateMilitaryPower()}</div>
                        <div style="margin: 5px 0;">Morale: ${warState.morale.militia}%</div>
                    </div>
                </div>
                
                <div style="background: rgba(199, 68, 68, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #c74444;">
                    <h4 style="color: #c74444; margin-top: 0;">âš”ï¸ Forze Nemiche</h4>
                    <div style="font-size: 0.9em;">
                        <div style="margin: 5px 0;">Potenza Stimata: ${target.power * 10}</div>
                        <div style="margin: 5px 0;">Comandante: ${warState.enemyCommander.name}</div>
                        <div style="margin: 5px 0;">Morale: ${warState.morale.enemy}%</div>
                    </div>
                </div>
            </div>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">ðŸŽ¯ Seleziona Tattica</h3>
                
                ${Object.entries(WAR_TACTICS).map(([key, tactic]) => {
                    const canUse = checkTacticRequirements(key);
                    return `
                        <button class="action-btn ${!canUse ? 'disabled' : ''}" 
                                onclick="selectTactic('${key}')"
                                ${!canUse ? 'disabled' : ''}>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="text-align: left;">
                                    <strong>${tactic.name}</strong>
                                    <div style="font-size: 0.85em; color: var(--text-soft); margin-top: 3px;">
                                        ${tactic.desc}
                                    </div>
                                </div>
                                ${!canUse ? '<span style="color: #c74444;">âŒ</span>' : '<span>âœ“</span>'}
                            </div>
                        </button>
                    `;
                }).join('')}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn modal-btn-secondary" onclick="retreatFromBattle()">
                    ðŸƒ Ritirata Strategica
                </button>
                <button class="modal-btn" style="background: #c74444; color: white; flex: 1;" 
                        onclick="startBattle()">
                    âš”ï¸ INIZIA LA BATTAGLIA!
                </button>
            </div>
        </div>
    `;
    
    showModal("Battaglia Imminente", modal);
}

function checkTacticRequirements(tacticKey) {
    const tactic = WAR_TACTICS[tacticKey];
    const req = tactic.requirements || {};
    
    if (req.morale && warState.morale.militia < req.morale) return false;
    if (req.cavalry && (populationGroups.militia.count < req.cavalry)) return false;
    if (req.experience) {
        const commander = warState.commanders[warState.selectedCommander || 0];
        if (!commander || commander.experience < req.experience) return false;
    }
    if (req.wood && county.resources.wood < req.wood) return false;
    if (req.iron && county.resources.iron < req.iron) return false;
    
    return true;
}

function selectTactic(tacticKey) {
    warState.currentTactic = tacticKey;
    const tactic = WAR_TACTICS[tacticKey];
    
    addMsg("system", `ðŸ“‹ Tattica selezionata: ${tactic.name}`);
    
    // Aggiorna UI per evidenziare la tattica selezionata
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.style.borderColor = 'var(--border-soft)';
    });
    event.target.closest('.action-btn').style.borderColor = 'var(--accent)';
}

function retreatFromBattle() {
    closeModal();
    addMsg("system", "ðŸƒ Hai ordinato una ritirata strategica. Il nemico festeggia...");
    
    warState.morale.militia -= 15;
    warState.morale.enemy += 10;
    factions.militia -= 10;
    county.happiness -= 5;
    
    warState.phase = 'aftermath';
    updateUI();
}

// Battaglia principale con IA narrativa
async function startBattle() {
    closeModal();
    
    warState.phase = 'engagement';
    warState.turn++;
    
    // Crea log di battaglia vuoto
    warState.battleLog = [];
    
    addMsg("system", "âš”ï¸ <strong style='font-size: 1.2em;'>LA BATTAGLIA Ãˆ INIZIATA!</strong>");
    addMsg("system", "---");
    
    // Fase 1: Schieramento
    await battlePhase_Deployment();
    
    // Fase 2: Scontro iniziale
    await battlePhase_InitialClash();
    
    // Fase 3: Corpo a corpo
    await battlePhase_Melee();
    
    // Fase 4: Risoluzione
    await battlePhase_Resolution();
    
    // Mostra risultato finale
    showBattleResults();
}

async function battlePhase_Deployment() {
    addMsg("system", "ðŸ“ <strong>FASE 1: SCHIERAMENTO</strong>");
    
    if (apiKey) {
        await generateBattleNarrative('deployment', {
            tactic: warState.currentTactic,
            terrain: warState.terrain
        });
    } else {
        addMsg("ai", "Le truppe si schierano sul campo di battaglia, preparandosi allo scontro...");
    }
    
    await delay(1500);
}

async function battlePhase_InitialClash() {
    addMsg("system", "ðŸ¹ <strong>FASE 2: SCONTRO INIZIALE</strong>");
    
    // Verifica eventi casuali
    checkRandomBattleEvent('initial');
    
    // Calcola primi danni
    const myPower = calculateModifiedPower('attack');
    const enemyPower = calculateEnemyPower('attack');
    
    const myDamage = Math.floor(myPower * 0.3);
    const enemyDamage = Math.floor(enemyPower * 0.3);
    
    // Applica primi danni al morale
    warState.morale.militia -= Math.floor(enemyDamage / 20);
    warState.morale.enemy -= Math.floor(myDamage / 20);
    
    if (apiKey) {
        await generateBattleNarrative('initial_clash', {
            myDamage,
            enemyDamage,
            morale: warState.morale
        });
    } else {
        addMsg("ai", `Le prime frecce volano! Il nemico subisce ${myDamage} danni, noi ${enemyDamage}.`);
    }
    
    await delay(2000);
}

async function battlePhase_Melee() {
    addMsg("system", "âš”ï¸ <strong>FASE 3: CORPO A CORPO</strong>");
    
    // Fase piÃ¹ intensa - possibili eventi critici
    checkRandomBattleEvent('melee');
    
    const myPower = calculateModifiedPower('attack');
    const enemyPower = calculateEnemyPower('attack');
    
    if (apiKey) {
        await generateBattleNarrative('melee', {
            myPower,
            enemyPower,
            intensity: 'high'
        });
    } else {
        addMsg("ai", "Il corpo a corpo Ã¨ feroce! Acciaio contro acciaio, urla di guerra riempiono l'aria...");
    }
    
    await delay(2000);
}

async function battlePhase_Resolution() {
    addMsg("system", "ðŸŽ¯ <strong>FASE 4: RISOLUZIONE</strong>");
    
    const myFinalPower = calculateModifiedPower('final');
    const enemyFinalPower = calculateEnemyPower('final');
    
    // Applica morale
    const myMoraleMultiplier = warState.morale.militia / 100;
    const enemyMoraleMultiplier = warState.morale.enemy / 100;
    
    const myEffectivePower = myFinalPower * myMoraleMultiplier;
    const enemyEffectivePower = enemyFinalPower * enemyMoraleMultiplier;
    
    // Fattore fortuna
    const luck = 0.85 + (Math.random() * 0.3);
    
    const victory = (myEffectivePower * luck) > enemyEffectivePower;
    
    // Calcola perdite
    const baseCasualties = victory ? 0.12 : 0.25;
    const tactic = WAR_TACTICS[warState.currentTactic];
    
    const militiaLost = Math.floor(populationGroups.militia.count * baseCasualties * tactic.casualtyMultiplier);
    const leviesLost = warState.mobilized ? 
        Math.floor(warState.leviesCount * baseCasualties * tactic.casualtyMultiplier * 1.5) : 0;
    
    // Applica perdite
    populationGroups.militia.count -= militiaLost;
    if (warState.mobilized) {
        warState.leviesCount -= leviesLost;
    }
    
    // Consuma armi
    const weaponsLost = Math.floor((militiaLost + leviesLost) * 0.7);
    county.resources.weapons = Math.max(0, county.resources.weapons - weaponsLost);
    
    // Salva risultato
    warState.battleResult = {
        victory,
        militiaLost,
        leviesLost,
        weaponsLost,
        myPower: Math.floor(myEffectivePower),
        enemyPower: Math.floor(enemyEffectivePower)
    };
    
    if (victory) {
        warState.stats.battlesWon++;
        warState.stats.enemiesSlain += Math.floor(enemyFinalPower / 5);
    } else {
        warState.stats.battlesLost++;
    }
    warState.stats.soldiersLost += (militiaLost + leviesLost);
    
    if (apiKey) {
        await generateBattleNarrative('resolution', warState.battleResult);
    }
    
    await delay(2000);
}

function calculateModifiedPower(phase) {
    let basePower = calculateMilitaryPower();
    
    const tactic = WAR_TACTICS[warState.currentTactic];
    const terrain = BATTLE_TERRAINS[warState.terrain];
    
    // Applica modificatori tattica
    if (phase === 'attack' || phase === 'final') {
        basePower *= tactic.attackBonus;
    }
    
    // Applica modificatori terreno
    if (terrain.infantryBonus) {
        basePower *= terrain.infantryBonus;
    }
    
    // Bonus comandante
    if (warState.commanders[warState.selectedCommander]) {
        const commander = warState.commanders[warState.selectedCommander];
        commander.traits.forEach(trait => {
            const traitData = COMMANDER_TRAITS[trait];
            if (traitData.attack) {
                basePower += traitData.attack;
            }
        });
    }
    
    return Math.floor(basePower);
}

function calculateEnemyPower(phase) {
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    let power = target.power * 10 + target.aggression * 2;
    
    const terrain = BATTLE_TERRAINS[warState.terrain];
    
    // Bonus difensore se appropriato
    if (terrain.defenderBonus) {
        power *= terrain.defenderBonus;
    }
    
    // Bonus comandante nemico
    if (warState.enemyCommander) {
        warState.enemyCommander.traits.forEach(trait => {
            const traitData = COMMANDER_TRAITS[trait];
            if (traitData.attack) {
                power += traitData.attack;
            }
        });
    }
    
    return Math.floor(power);
}

function checkRandomBattleEvent(phase) {
    BATTLE_EVENTS.forEach(event => {
        if (event.context && event.context !== phase) return;
        
        if (Math.random() < event.chance) {
            // Verifica requisiti
            if (event.requirements) {
                if (event.requirements.enemyMorale && warState.morale.enemy > event.requirements.enemyMorale) {
                    return;
                }
                if (event.requirements.morale && warState.morale.militia < event.requirements.morale) {
                    return;
                }
            }
            
            // Applica evento
            addMsg("system", `âš¡ <strong>${event.name}!</strong> ${event.desc}`);
            warState.battleLog.push(event.name);
            
            // Applica effetti
            if (event.effect.casualties) {
                // Gestito nella risoluzione
            }
            if (event.effect.morale) {
                warState.morale.militia += event.effect.morale;
            }
            if (event.effect.enemyMorale) {
                warState.morale.enemy += event.effect.enemyMorale;
            }
        }
    });
}

function showBattleResults() {
    const result = warState.battleResult;
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    
    if (result.victory) {
        // VITTORIA
        const loot = Math.floor(target.wealth * 3);
        county.gold += loot;
        target.power = Math.max(0, target.power - 30);
        target.aggression = Math.max(0, target.aggression - 40);
        county.happiness += 15;
        factions.militia += 10;
        
        warState.stats.goldLooted += loot;
        
        const modal = `
            <div style="max-width: 600px; text-align: center;">
                <h1 style="color: #44c777; font-size: 2.5em; margin: 20px 0;">ðŸ† VITTORIA! ðŸ†</h1>
                
                <div style="background: rgba(68, 199, 119, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #44c777;">
                    <p style="font-size: 1.2em; line-height: 1.6;">
                        Le nostre truppe hanno prevalso! Il nemico Ã¨ in rotta e i loro stendardi giacciono nel fango!
                    </p>
                </div>
                
                <div style="background: var(--bg-panel-alt); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h3 style="color: var(--accent); margin-top: 0;">ðŸ“Š Resoconto Battaglia</h3>
                    <div style="text-align: left;">
                        <div class="population-stat-row">
                            <span>Potenza Finale (Noi):</span>
                            <span style="color: #44c777;">${result.myPower}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Potenza Finale (Nemico):</span>
                            <span style="color: #c74444;">${result.enemyPower}</span>
                        </div>
                        <div class="population-stat-row" style="border-top: 1px solid var(--border-soft); margin-top: 10px; padding-top: 10px;">
                            <span>Soldati Caduti:</span>
                            <span style="color: #c74444;">${result.militiaLost}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Leve Cadute:</span>
                            <span style="color: #c74444;">${result.leviesLost}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Armi Perse:</span>
                            <span style="color: #c74444;">${result.weaponsLost}</span>
                        </div>
                        <div class="population-stat-row" style="border-top: 1px solid var(--border-soft); margin-top: 10px; padding-top: 10px;">
                            <span>Oro Saccheggiato:</span>
                            <span style="color: #d4af37;">+${loot}</span>
                        </div>
                    </div>
                </div>
                
                ${result.militiaLost + result.leviesLost > 100 ? `
                    <div style="background: rgba(199, 68, 68, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #c74444;">
                        <strong>âš ï¸ Perdite Pesanti:</strong> La vittoria ha un prezzo alto. Le famiglie piangeranno i loro morti.
                    </div>
                ` : ''}
                
                <button class="modal-btn" style="background: #44c777; color: black; margin-top: 20px;" onclick="concludeBattle()">
                    Torna al Regno
                </button>
            </div>
        `;
        
        showModal("Vittoria!", modal);
        
    } else {
        // SCONFITTA
        const goldLost = Math.floor(county.gold * 0.25);
        county.gold = Math.max(0, county.gold - goldLost);
        county.happiness -= 20;
        county.security -= 12;
        factions.militia -= 15;
        target.aggression += 20;
        
        const modal = `
            <div style="max-width: 600px; text-align: center;">
                <h1 style="color: #c74444; font-size: 2.5em; margin: 20px 0;">ðŸ’€ SCONFITTA ðŸ’€</h1>
                
                <div style="background: rgba(199, 68, 68, 0.2); padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #c74444;">
                    <p style="font-size: 1.2em; line-height: 1.6;">
                        Le nostre truppe sono state sopraffatte! Il nemico saccheggia le terre e i sopravvissuti fuggono in disordine...
                    </p>
                </div>
                
                <div style="background: var(--bg-panel-alt); padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h3 style="color: var(--accent); margin-top: 0;">ðŸ“Š Resoconto Battaglia</h3>
                    <div style="text-align: left;">
                        <div class="population-stat-row">
                            <span>Potenza Finale (Noi):</span>
                            <span style="color: #c74444;">${result.myPower}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Potenza Finale (Nemico):</span>
                            <span style="color: #44c777;">${result.enemyPower}</span>
                        </div>
                        <div class="population-stat-row" style="border-top: 1px solid var(--border-soft); margin-top: 10px; padding-top: 10px;">
                            <span>Soldati Caduti:</span>
                            <span style="color: #c74444;">${result.militiaLost}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Leve Cadute:</span>
                            <span style="color: #c74444;">${result.leviesLost}</span>
                        </div>
                        <div class="population-stat-row">
                            <span>Armi Perse:</span>
                            <span style="color: #c74444;">${result.weaponsLost}</span>
                        </div>
                        <div class="population-stat-row" style="border-top: 1px solid var(--border-soft); margin-top: 10px; padding-top: 10px;">
                            <span>Oro Perso (Saccheggio):</span>
                            <span style="color: #c74444;">-${goldLost}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(199, 68, 68, 0.2); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #c74444;">
                    <strong>ðŸ’€ Conseguenze:</strong> Il morale Ã¨ crollato. La sicurezza del regno Ã¨ compromessa. Il popolo dubita della tua leadership.
                </div>
                
                <button class="modal-btn modal-btn-secondary" onclick="concludeBattle()">
                    Ritorna al Regno in Lutto
                </button>
            </div>
        `;
        
        showModal("Sconfitta...", modal);
    }
}

function concludeBattle() {
    closeModal();
    warState.phase = 'aftermath';
    
    addMsg("system", "---");
    addMsg("system", "La battaglia Ã¨ conclusa. Le conseguenze si faranno sentire per stagioni...");
    
    updateUI();
}

// ===================== GENERAZIONE NARRATIVA CON IA =====================

async function generateWarNarrative(type, context) {
    if (!apiKey) return;
    
    let prompt = "";
    
    switch(type) {
        case 'declaration':
            prompt = `Scrivi una breve narrazione drammatica (max 80 parole) sulla dichiarazione di guerra contro ${context.name}. 
                      Stile: epico medievale, tragico. Focus su: messaggeri che portano la notizia, reazione del popolo, suono dei tamburi di guerra.
                      NON usare liste, solo prosa narrativa in italiano antico.`;
            break;
            
        case 'march':
            prompt = `Scrivi una breve descrizione (max 60 parole) dell'esercito che marcia verso il campo di battaglia.
                      Terreno: ${context.terrain.name}. Morale truppe: ${context.morale}/100.
                      Stile: viscerale, sensoriale. Descrivi suoni, odori, atmosfera. Italiano medievale.`;
            break;
            
        case 'battle_start':
            prompt = `Descrivi l'inizio della battaglia in max 50 parole. Momento epico, carica iniziale.
                      Stile: dinamico, cinematografico. Focus su: urla di guerra, scontro di acciaio, caos.`;
            break;
    }
    
    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.9,
                max_tokens: 200,
                messages: [
                    { role: "system", content: "Sei un narratore epico medievale. Scrivi in italiano antico/medievale, stile drammatico e viscerale. NON usare liste o formattazione." },
                    { role: "user", content: prompt }
                ]
            })
        });
        
        const data = await resp.json();
        if (resp.ok) {
            const narrative = data.choices[0].message.content;
            addMsg("ai", `<em style="color: var(--accent); font-style: italic;">${narrative}</em>`);
        }
    } catch(e) {
        console.error("Errore generazione narrativa:", e);
    }
}

async function generateBattleNarrative(phase, context) {
    if (!apiKey) return;
    
    let prompt = "";
    
    switch(phase) {
        case 'deployment':
            prompt = `Descrivi in 40 parole lo schieramento delle truppe prima della battaglia.
                      Tattica: ${WAR_TACTICS[warState.currentTactic].name}.
                      Terreno: ${BATTLE_TERRAINS[warState.terrain].name}.
                      Stile: tensione crescente, calma prima della tempesta.`;
            break;
            
        case 'initial_clash':
            prompt = `Descrivi in 50 parole il primo scontro della battaglia.
                      Danni inflitti: ${context.myDamage} vs subiti: ${context.enemyDamage}.
                      Stile: caotico, violento, descri il sangue e il fragore.`;
            break;
            
        case 'melee':
            prompt = `Descrivi in 60 parole il corpo a corpo piÃ¹ intenso della battaglia.
                      Potenza: Noi ${context.myPower} vs Nemico ${context.enemyPower}.
                      Stile: viscerale, brutale. Focus su singoli duelli, eroi che cadono, urla.`;
            break;
            
        case 'resolution':
            const outcome = context.victory ? 'vittoria' : 'sconfitta';
            prompt = `Descrivi in 50 parole la conclusione della battaglia: ${outcome}.
                      ${context.victory ? 'Il nemico fugge in disordine' : 'Le nostre truppe si ritirano in rotta'}.
                      Perdite: ${context.militiaLost + context.leviesLost} uomini.
                      Stile: ${context.victory ? 'trionfante ma tragico' : 'cupo e devastante'}.`;
            break;
    }
    
    try {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
                model: "llama-3.1-8b-instant",
                temperature: 0.95,
                max_tokens: 150,
                messages: [
                    { role: "system", content: "Sei un cronista medievale che descrive battaglie. Usa italiano medievale, sii drammatico e viscerale. Solo prosa narrativa." },
                    { role: "user", content: prompt }
                ]
            })
        });
        
        const data = await resp.json();
        if (resp.ok) {
            const narrative = data.choices[0].message.content;
            await delay(800);
            addMsg("ai", `<em style="color: var(--text-soft); font-style: italic; line-height: 1.6;">${narrative}</em>`);
        }
    } catch(e) {
        console.error("Errore generazione narrativa battaglia:", e);
    }
}

// ===================== SISTEMA ASSEDIO =====================

function initiateSiege() {
    warState.type = 'siege';
    warState.siegeState.active = true;
    warState.siegeState.wallsIntegrity = 100;
    warState.siegeState.suppliesRemaining = 100;
    warState.siegeState.daysElapsed = 0;
    
    addMsg("system", "ðŸ° <strong>INIZIO ASSEDIO</strong>");
    addMsg("system", "L'esercito circonda il castello nemico. L'assedio sarÃ  lungo e difficile...");
    
    showSiegeScreen();
}

function showSiegeScreen() {
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    const siege = warState.siegeState;
    
    const modal = `
        <div style="max-width: 700px;">
            <h2 style="color: var(--accent); text-align: center;">ðŸ° ASSEDIO IN CORSO ðŸ°</h2>
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">Stato Assedio</h3>
                <div>
                    <div class="population-stat-row">
                        <span>Giorni di Assedio:</span>
                        <span class="highlight">${siege.daysElapsed}</span>
                    </div>
                    <div class="population-stat-row">
                        <span>IntegritÃ  Mura:</span>
                        <span style="color: ${siege.wallsIntegrity > 70 ? '#44c777' : siege.wallsIntegrity > 30 ? '#c7a244' : '#c74444'}">
                            ${siege.wallsIntegrity}%
                        </span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${siege.wallsIntegrity}%; background: ${siege.wallsIntegrity > 70 ? '#44c777' : siege.wallsIntegrity > 30 ? '#c7a244' : '#c74444'}"></div>
                    </div>
                    
                    <div class="population-stat-row" style="margin-top: 15px;">
                        <span>Nostre Provviste:</span>
                        <span style="color: ${siege.suppliesRemaining > 70 ? '#44c777' : siege.suppliesRemaining > 30 ? '#c7a244' : '#c74444'}">
                            ${siege.suppliesRemaining}%
                        </span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${siege.suppliesRemaining}%; background: ${siege.suppliesRemaining > 70 ? '#44c777' : siege.suppliesRemaining > 30 ? '#c7a244' : '#c74444'}"></div>
                    </div>
                </div>
            </div>
            
            ${siege.wallsIntegrity < 30 ? `
                <div style="background: rgba(68, 199, 119, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; border: 2px solid #44c777;">
                    <strong>âœ¨ BRECCIA NELLE MURA!</strong> Puoi ordinare l'assalto finale!
                </div>
            ` : ''}
            
            ${siege.suppliesRemaining < 20 ? `
                <div style="background: rgba(199, 68, 68, 0.2); padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 3px solid #c74444;">
                    <strong>âš ï¸ PROVVISTE CRITICHE!</strong> L'esercito sta esaurendo il cibo!
                </div>
            ` : ''}
            
            <div style="background: var(--bg-panel-alt); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <h3 style="color: var(--accent); margin-top: 0;">Azioni Assedio</h3>
                
                <button class="action-btn" onclick="siegeAction('bombard')">
                    ðŸ’£ Bombarda le Mura
                    <div style="font-size: 0.85em; color: var(--text-soft);">
                        Usa catapulte e arieti. Costa: 20 legno, 10 ferro
                    </div>
                </button>
                
                <button class="action-btn" onclick="siegeAction('starve')">
                    â³ Affama il Nemico
                    <div style="font-size: 0.85em; color: var(--text-soft);">
                        Attendi che il nemico esaurisca le provviste. Lento ma sicuro.
                    </div>
                </button>
                
                <button class="action-btn" onclick="siegeAction('undermine')">
                    â›ï¸ Scava Tunnel
                    <div style="font-size: 0.85em; color: var(--text-soft);">
                        Tenta di far crollare le mura dall'interno. Richiede tempo.
                    </div>
                </button>
                
                ${siege.wallsIntegrity < 30 ? `
                    <button class="action-btn" style="border-color: #44c777;" onclick="siegeAction('final_assault')">
                        âš”ï¸ ASSALTO FINALE
                        <div style="font-size: 0.85em; color: var(--text-soft);">
                            Lancia l'attacco decisivo attraverso la breccia!
                        </div>
                    </button>
                ` : ''}
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-btn modal-btn-secondary" onclick="abandonSiege()">
                    ðŸƒ Abbandona Assedio
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">
                    Chiudi
                </button>
            </div>
        </div>
    `;
    
    showModal("Assedio", modal);
}

function siegeAction(action) {
    const siege = warState.siegeState;
    
    switch(action) {
        case 'bombard':
            if (county.resources.wood < 20 || county.resources.iron < 10) {
                addMsg("system", "âŒ Non hai abbastanza risorse per bombardare!");
                return;
            }
            county.resources.wood -= 20;
            county.resources.iron -= 10;
            
            const damage = 10 + Math.floor(Math.random() * 15);
            siege.wallsIntegrity -= damage;
            siege.daysElapsed += 3;
            siege.suppliesRemaining -= 10;
            
            addMsg("system", `ðŸ’£ Le catapulte martellano le mura! Danni: -${damage}% integritÃ `);
            break;
            
        case 'starve':
            siege.daysElapsed += 7;
            siege.suppliesRemaining -= 20;
            
            // Il nemico soffre anche lui
            const enemyStarvation = 15 + Math.floor(Math.random() * 10);
            
            addMsg("system", `â³ Passa una settimana. Il nemico soffre la fame...`);
            
            if (Math.random() < 0.3) {
                addMsg("system", "ðŸ“‰ Si vedono segni di diserzione dalle mura nemiche!");
                warState.morale.enemy -= 10;
            }
            break;
            
        case 'undermine':
            siege.daysElapsed += 5;
            siege.suppliesRemaining -= 15;
            
            if (Math.random() < 0.6) {
                const undermDamage = 20 + Math.floor(Math.random() * 15);
                siege.wallsIntegrity -= undermDamage;
                addMsg("system", `â›ï¸ I tunnel crollano! Le mura cedono! (-${undermDamage}%)`);
            } else {
                addMsg("system", "â›ï¸ Il tentativo fallisce. Il terreno Ã¨ troppo duro...");
            }
            break;
            
        case 'final_assault':
            closeModal();
            // Lancia battaglia finale con bonus per la breccia
            warState.currentTactic = 'aggressive_assault';
            startBattle();
            return;
    }
    
    // Controlla condizioni di fallimento/successo
    if (siege.suppliesRemaining <= 0) {
        addMsg("system", "ðŸ’€ <strong>LE PROVVISTE SONO ESAURITE!</strong> L'esercito Ã¨ costretto a ritirarsi!");
        abandonSiege();
        return;
    }
    
    if (siege.wallsIntegrity <= 0) {
        addMsg("system", "ðŸ† <strong>LE MURA SONO CROLLATE!</strong> Puoi lanciare l'assalto finale!");
    }
    
    showSiegeScreen();
}

function abandonSiege() {
    closeModal();
    
    warState.siegeState.active = false;
    warState.phase = 'aftermath';
    
    addMsg("system", "ðŸƒ <strong>ASSEDIO ABBANDONATO</strong>");
    addMsg("system", "L'esercito si ritira. Il nemico festeggia dalla mura...");
    
    warState.morale.militia -= 20;
    warState.morale.enemy += 15;
    county.happiness -= 10;
    
    updateUI();
}

// ===================== ALTRE FUNZIONI DI SUPPORTO =====================

function executeRaid() {
    addMsg("system", "ðŸƒ <strong>INCURSIONE RAPIDA!</strong>");
    addMsg("system", "Le truppe attraversano il confine per saccheggiare e ritirarsi velocemente...");
    
    const target = neighboringCounties.find(c => c.key === warState.enemy);
    const success = Math.random() > 0.4;
    
    if (success) {
        const loot = Math.floor(target.wealth * 1.5) + rand(50, 150);
        county.gold += loot;
        
        const casualties = Math.floor(populationGroups.militia.count * 0.05);
        populationGroups.militia.count -= casualties;
        
        addMsg("system", `âœ… <strong>Incursione riuscita!</strong> Saccheggiato ${loot} oro. Perdite: ${casualties} soldati.`);
        warState.stats.goldLooted += loot;
    } else {
        const casualties = Math.floor(populationGroups.militia.count * 0.15);
        populationGroups.militia.count -= casualties;
        
        addMsg("system", `âŒ <strong>Incursione fallita!</strong> Il nemico era preparato. Perdite: ${casualties} soldati.`);
    }
    
    warState.phase = 'aftermath';
    updateUI();
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function rand(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Export delle funzioni per l'integrazione
window.declareWarAdvanced = declareWarAdvanced;
window.confirmWarDeclaration = confirmWarDeclaration;
window.promoteCommander = promoteCommander;
window.leadPersonally = leadPersonally;
window.selectCommander = selectCommander;
window.startWarCampaign = startWarCampaign;
window.selectTactic = selectTactic;
window.retreatFromBattle = retreatFromBattle;
window.startBattle = startBattle;
window.concludeBattle = concludeBattle;
window.siegeAction = siegeAction;
window.abandonSiege = abandonSiege;

function initMapInteraction() {
    const canvas = document.getElementById("county-map");
    if (!canvas) return;
    
    canvas.addEventListener("click", function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Calcola coordinate mappa
        const mapX = Math.floor(x / (canvas.width / 8));
        const mapY = Math.floor(y / (canvas.height / 8));
        
        // Mostra menu contestuale
        showMapContextMenu(mapX, mapY, event.clientX, event.clientY);
    });
}

function showMapContextMenu(x, y, screenX, screenY) {
    const menu = document.getElementById("map-menu");
    if (!menu) return;
    
    // Posiziona menu
    menu.style.left = screenX + "px";
    menu.style.top = screenY + "px";
    menu.style.display = "block";
    
    // Genera opzioni basate su posizione
    const options = getMapMenuOptions(x, y);
    
    menu.innerHTML = options.map(option => `
        <button class="map-menu-btn" onclick="${option.action}">
            ${option.icon} ${option.label}
        </button>
    `).join("");
    
    // Chiudi menu se clicchi fuori
    document.addEventListener("click", function closeMenu(e) {
        if (!menu.contains(e.target)) {
            menu.style.display = "none";
            document.removeEventListener("click", closeMenu);
        }
    });
}

function getMapMenuOptions(x, y) {
    const options = [];
    
    // Opzione costruzione edificio
    options.push({
        label: "Costruisci Edificio",
        icon: "ðŸ—ï¸",
        action: `orderBuildingMap(${x}, ${y})`
    });
    
    // Opzione azione rapida
    options.push({
        label: "Azione Rapida",
        icon: "âš¡",
        action: `quickActionMap(${x}, ${y})`
    });
    
    return options;
}

function orderBuildingMap(x, y) {
    // Apri modale edifici con posizione pre-selezionata
    openBuildingModal();
    
    // Nota: potresti voler passare x,y al modale per posizionamento automatico
}

function quickActionMap(x, y) {
    // Azioni rapide come esplorazione, raccolta risorse, ecc.
    addMsg("system", `Azione rapida su (${x}, ${y}) - FunzionalitÃ  da implementare`);
}

function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    if (!container) return;
    
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    // Rimuovi automaticamente dopo 3 secondi
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

function checkActiveAdvisor() {
    // Controlla condizioni per avvisi advisor
    if (county.resources.food < 50 && county.pop > 100) {
        showToast("Consigliere: Le riserve di cibo sono basse! Aumenta la produzione agricola.", "warning");
    }
    
    if (county.gold < 100) {
        showToast("Consigliere: Le casse sono vuote! Considera tasse o commercio.", "warning");
    }
    
    if (county.happiness < 30) {
        showToast("Consigliere: Il popolo Ã¨ infelice! Organizza eventi o migliora le condizioni.", "warning");
    }
}

function renderFactionPowers() {
    const container = document.getElementById("faction-impact-list");
    if (!container) return;
    
    let powersHtml = "";
    
    Object.entries(factions).forEach(([key, power]) => {
        if (power > 0) {
            powersHtml += `
                <div class="faction-power-item">
                    <span class="faction-name">${factionLabel(key)}</span>
                    <button class="faction-power-btn" onclick="activateFactionPower('${key}')">
                        Attiva Potere (${power} influenza)
                    </button>
                </div>
            `;
        }
    });
    
    container.innerHTML = powersHtml;
}

function activateFactionPower(factionKey) {
    const power = factions[factionKey];
    if (!power || power <= 0) return;
    
    switch(factionKey) {
        case "nobility":
            county.gold += 50;
            addMsg("system", "I nobili hanno donato 50 oro alla corona!");
            break;
        case "merchants":
            county.resources.wood += 20;
            county.resources.stone += 20;
            addMsg("system", "I mercanti hanno fornito materiali da costruzione!");
            break;
        case "peasants":
            county.happiness += 10;
            addMsg("system", "I contadini celebrano la tua saggezza!");
            break;
        case "clergy":
            county.happiness += 5;
            county.pop += 5;
            addMsg("system", "La chiesa benedice il regno, attirando nuovi fedeli!");
            break;
        case "militia":
            populationGroups.militia.count += 10;
            addMsg("system", "La milizia recluta nuovi soldati!");
            break;
    }
    
    factions[factionKey] -= 1; // Consuma influenza
    updateUI();
}

// ===================== FUNZIONI PER MENU LATERALE E CARD ESPANDIBILI =====================

// Toggle menu laterale statistiche
function toggleStatsSidebar() {
    const sidebar = document.getElementById('stats-sidebar');
    sidebar.classList.toggle('open');
    updateSidebarStats();
}

// Aggiorna statistiche nel menu laterale
function updateSidebarStats() {
    document.getElementById('sidebar-pop').textContent = county.pop || 0;
    document.getElementById('sidebar-gold').textContent = county.gold || 0;
    document.getElementById('sidebar-food').textContent = Math.round((county.food / county.pop) * 100) + '%' || '0%';
    document.getElementById('sidebar-health').textContent = Math.round(county.health) + '%' || '0%';
    document.getElementById('sidebar-happiness').textContent = Math.round(county.happy) + '%' || '0%';
    document.getElementById('sidebar-stability').textContent = Math.round(calculateStability()) + '%' || '0%';
    
    document.getElementById('sidebar-land-count').textContent = landOwnership.count || 0;
    document.getElementById('sidebar-land-nobility').textContent = landOwnership.nobility || 0;
    document.getElementById('sidebar-land-clergy').textContent = landOwnership.clergy || 0;
    document.getElementById('sidebar-land-commons').textContent = landOwnership.commons || 0;
    
    document.getElementById('sidebar-wood').textContent = county.resources.wood || 0;
    document.getElementById('sidebar-stone').textContent = county.resources.stone || 0;
    document.getElementById('sidebar-iron').textContent = county.resources.iron || 0;
    document.getElementById('sidebar-grain').textContent = county.resources.grain || 0;
}

// Toggle espansione card classe sociale
const CLASS_DETAILS_MAP = {
    nobility: {
        name: 'NobiltÃ ',
        category: 'Aristocrazia feudale',
        desc: 'Famiglie di rango che gestiscono feudi, castelli e titoli.',
        holdings: 'Castelli, feudi, diritti di giustizia e rendite',
        needs: ['Prestigio e riconoscimento', 'Nuove terre e privilegi', 'Influenza politica'],
        primaryNeeds: ['Cibo di qualitÃ ', 'Sicurezza di corte'],
        secondaryNeeds: ['Lusso', 'Intrattenimento', 'Cavalli da parata'],
        wants: ['Beni di pregio', 'Arredi di lusso', 'Cavalli da parata'],
        lacks: 'Soffrono mancanza di lusso quando la corte taglia le spese.',
        housing: 'Dimorano in castelli e palazzi nel capoluogo.',
        projects: ['Ali di palazzo', 'Sale del trono', 'Giardini pensili'],
        goals: 'Espandere domini e titoli, rafforzare lâ€™alleanza con il Conte.',
        tip: 'Mantieni cerimonie, assegna feudi o privilegi temporanei.'
    },
    clergy: {
        name: 'Clero',
        category: 'AutoritÃ  religiosa',
        desc: 'Ordini monastici e prelati che guidano la fede nel dominio.',
        holdings: 'Chiese, monasteri, decime e biblioteche',
        needs: ['Luoghi di culto ben mantenuti', 'Rispetto delle tradizioni', 'Sostegno alla caritÃ '],
        primaryNeeds: ['Pane', 'Incensi e candele', 'Pergamene'],
        secondaryNeeds: ['Tessuti per vesti', 'Erbe sacre'],
        wants: ['Pergamene', 'Candele', 'Erbe sacre'],
        lacks: 'Faticano a reperire velluto e incensi se il mercato Ã¨ povero.',
        housing: 'Vivono in monasteri e canoniche.',
        projects: ['Cappelle votive', 'Scriptoria', 'Ospizi per pellegrini'],
        goals: 'Espandere lâ€™influenza religiosa e costruire nuovi luoghi di culto.',
        tip: 'Finanzia opere pie e proteggi i pellegrini.'
    },
    militia: {
        name: 'Milizia',
        category: 'Forza armata',
        desc: 'Guardie e soldati che difendono i confini e mantengono lâ€™ordine.',
        holdings: 'Caserme, armerie, pattuglie di confine',
        needs: ['Equipaggiamento e armi', 'Addestramento regolare', 'Salario stabile'],
        primaryNeeds: ['Razioni di grano', 'Armi', 'Armature'],
        secondaryNeeds: ['Pelli per armature', 'Manutenzione caserme'],
        wants: ['Ferro', 'Armi forgiate', 'Pelli per armature'],
        lacks: 'In crisi quando il ferro scarseggia o la paga ritarda.',
        housing: 'Alloggiano in caserme e posti di guardia.',
        projects: ['Mura e palizzate', 'Poligoni di tiro', 'Scuderie militari'],
        goals: 'Tenere alte le difese e garantire la sicurezza delle strade.',
        tip: 'Aggiorna armi e paga, organizza esercitazioni.'
    },
    burghers: {
        name: 'Borghesi',
        category: 'Artigiani e bottegai',
        desc: 'Maestri dâ€™arte e mercanti cittadini che producono beni di qualitÃ .',
        holdings: 'Botteghe, laboratori, corporazioni',
        needs: ['Officine ben rifornite', 'Domanda stabile', 'Protezione dai banditi'],
        primaryNeeds: ['Cibo', 'Attrezzi', 'Materie prime'],
        secondaryNeeds: ['Tessuti grezzi', 'Accesso ai mercati'],
        wants: ['Legno stagionato', 'Ferro lavorabile', 'Tessuti grezzi'],
        lacks: 'Bloccati se mancano materie prime o il mercato Ã¨ instabile.',
        housing: 'Vivono in case-bottega dentro le mura.',
        projects: ['Laboratori migliorati', 'Forni da fusione', 'Guild hall cittadina'],
        goals: 'Aumentare la produzione di beni di pregio e rafforzare le corporazioni.',
        tip: 'Riduci dazi locali e sponsorizza fiere.'
    },
    peasants: {
        name: 'Contadini',
        category: 'Popolo rurale',
        desc: 'Lavoratori dei campi e dei villaggi che sostengono il raccolto.',
        holdings: 'Campi, villaggi, granai comunitari',
        needs: ['Terra coltivabile', 'Tasse eque', 'Protezione da carestie'],
        primaryNeeds: ['Grano', 'Semi', 'Attrezzi'],
        secondaryNeeds: ['Pelle per ripari', 'Tessuti base'],
        wants: ['Semi', 'Attrezzi in ferro', 'Bestiame'],
        lacks: 'Soffrono se mancano attrezzi o granai pieni.',
        housing: 'Case in legno e fattorie attorno ai villaggi.',
        projects: ['Granai comuni', 'Canali di irrigazione', 'Mulini a vento'],
        goals: 'Raccolti stabili e accesso a terre sicure.',
        tip: 'Costruisci granai, riduci tasse in annate difficili.'
    },
    mystics: {
        name: 'Mistici',
        category: 'Sapienti e guaritori',
        desc: 'Erboristi, studiosi e veggenti che custodiscono conoscenze arcane.',
        holdings: 'Santuari, biblioteche, torri di studio',
        needs: ['Accesso ad erbe rare', 'Protezione dalle persecuzioni', 'Spazi di ricerca'],
        primaryNeeds: ['Erbe', 'Cristalli', 'Silenzio e protezione'],
        secondaryNeeds: ['Pergamene', 'Incensi'],
        wants: ['Erbe rare', 'Pergamene', 'Cristalli'],
        lacks: 'Restano fermi se non ottengono reagenti e silenzio.',
        housing: 'Torri isolate o eremi boschivi.',
        projects: ['Erbari', 'Laboratori alchemici', 'Osservatori'],
        goals: 'Ricercare arti arcane e sostenere la salute del popolo.',
        tip: 'Finanzia laboratori e proteggi la loro autonomia.'
    },
    outcasts: {
        name: 'Emarginati',
        category: 'Popolazione ai margini',
        desc: 'Rifugiati, banditi redenti e poveri senza terra.',
        holdings: 'Baraccopoli, rifugi improvvisati, botteghe di fortuna',
        needs: ['Sicurezza di base', 'Cibo e riparo', 'OpportunitÃ  di riscatto'],
        primaryNeeds: ['Pane', 'Coperte', 'Alloggio'],
        secondaryNeeds: ['Lavoro pagato', 'Attrezzi di base'],
        wants: ['Pane', 'Coperte', 'Lavori pagati'],
        lacks: 'Non hanno accesso a alloggi e cibo costante.',
        housing: 'Capanni e tende ai margini dei centri abitati.',
        projects: ['Alloggi modesti', 'Mense popolari', 'Laboratori di mestieri'],
        goals: 'Reinserirsi nella societÃ  e trovare stabilitÃ .',
        tip: 'Crea lavori pubblici e programmi di inclusione.'
    },
    merchants: {
        name: 'Mercanti',
        category: 'Ceto mercantile',
        desc: 'Reti commerciali che collegano mercati locali e lontani.',
        holdings: 'Magazzini, carovane, banchieri e rotte fluviali',
        needs: ['Rotte sicure', 'Dazi leggeri', 'Accordi vantaggiosi'],
        primaryNeeds: ['Scorte di pregio', 'Sicurezza rotte'],
        secondaryNeeds: ['Metalli preziosi', 'Spezie e tessuti rari'],
        wants: ['Tessuti pregiati', 'Spezie', 'Metalli preziosi'],
        lacks: 'Si bloccano quando le rotte sono insicure o tassate.',
        housing: 'Case cittadine con magazzini annessi.',
        projects: ['Carovane scortate', 'Darsene mercantili', 'Banchi di prestito'],
        goals: 'Monopolizzare rotte chiave e accrescere i profitti.',
        tip: 'Patrocina scorte armate e accordi commerciali.'
    }
};

function toggleClassCard(cardElement, className) {
    const wasExpanded = cardElement.classList.contains('expanded');
    const modal = document.getElementById('class-modal');
    const modalWasActive = modal && modal.classList.contains('active');

    // Se la card era giÃ  espansa e il modale era attivo, chiudi tutto
    if (wasExpanded && modalWasActive) {
        closeClassModal();
        return;
    }

    // Chiudi tutte le altre card
    document.querySelectorAll('.social-class-card').forEach(card => {
        card.classList.remove('expanded');
    });

    // Espandi questa card e apri il modale
    cardElement.classList.add('expanded');
    updateClassMood(className);
    openClassModal(className);
}

// Aggiorna l'icona della classe in base all'umore
function updateClassMood(className) {
    const c = (typeof county !== 'undefined' && county) ? county : {};
    // Calcola l'umore medio della classe basato su felicitÃ  e bisogni
    const happiness = c.happy || 50;
    const health = c.health || 50;
    const avgMood = (happiness + health) / 2;
    
    // Scegli l'emoji in base all'umore
    const iconElement = document.getElementById(`icon-${className}`);
    if (!iconElement) return;
    
    const moodIcons = {
        nobility: {
            happy: 'ðŸ‘‘',
            neutral: 'ðŸ¤´',
            sad: 'ðŸ˜ '
        },
        clergy: {
            happy: 'â›ª',
            neutral: 'âœï¸',
            sad: 'âš°ï¸'
        },
        militia: {
            happy: 'âš”ï¸',
            neutral: 'ðŸ›¡ï¸',
            sad: 'ðŸ’€'
        },
        burghers: {
            happy: 'ðŸ›ï¸',
            neutral: 'ðŸª',
            sad: 'ðŸšï¸'
        },
        peasants: {
            happy: 'ðŸ‘¥',
            neutral: 'ðŸ§‘â€ðŸŒ¾',
            sad: 'ðŸ˜¢'
        },
        mystics: {
            happy: 'ðŸ”®',
            neutral: 'ðŸŒ™',
            sad: 'ðŸ’”'
        },
        outcasts: {
            happy: 'ðŸšï¸',
            neutral: 'ðŸ—¡ï¸',
            sad: 'â˜ ï¸'
        },
        merchants: {
            happy: 'âš–ï¸',
            neutral: 'ðŸ’°',
            sad: 'ðŸ’¸'
        }
    };
    
    let mood = 'neutral';
    if (avgMood >= 70) mood = 'happy';
    else if (avgMood < 40) mood = 'sad';
    
    if (moodIcons[className]) {
        iconElement.textContent = moodIcons[className][mood];
    }
}

// Aggiorna tutte le icone delle classi in base all'umore
function updateAllClassMoods() {
    const classes = ['nobility', 'clergy', 'militia', 'burghers', 'peasants', 'mystics', 'outcasts', 'merchants'];
    classes.forEach(className => updateClassMood(className));
}

function classMoodText() {
    const c = (typeof county !== 'undefined' && county) ? county : {};
    const happiness = c.happy || 50;
    const health = c.health || 50;
    const stability = typeof calculateStability === 'function' ? calculateStability() : (c.stability || 50);
    const avg = Math.round((happiness + health + stability) / 3);
    if (avg >= 70) return 'Soddisfatti';
    if (avg >= 40) return 'Neutrali';
    return 'Inquieti';
}

function openClassModal(className) {
    const modal = document.getElementById('class-modal');
    if (!modal) return;

    // Chiudi il modale se Ã¨ giÃ  aperto prima di riaprirlo
    if (modal.classList.contains('active')) {
        closeClassModal();
    }

    // Continua con l'apertura del modale...
    const data = CLASS_DETAILS_MAP[className] || {};
    const countEl = document.getElementById(`${className}-count`);
    const wealthEl = document.getElementById(`${className}-wealth`);
    const iconEl = document.getElementById(`icon-${className}`);

    const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    };

    setText('class-modal-name', data.name || 'Classe');
    setText('class-modal-cat', data.category || 'Classe sociale');
    setText('class-modal-desc', data.desc || '');
    setText('class-modal-count', countEl ? countEl.textContent : '0');
    setText('class-modal-wealth', wealthEl ? wealthEl.textContent : '0');
    setText('class-modal-lands', data.holdings || '-');
    setText('class-modal-mood', classMoodText());
    setText('class-modal-icon', iconEl ? iconEl.textContent : '*');

    const needsList = document.getElementById('class-modal-needs');
    if (needsList) {
        needsList.innerHTML = '';
        (data.needs || ['Richiedono stabilitÃ , cibo e sicurezza']).forEach(need => {
            const li = document.createElement('li');
            li.textContent = need;
            needsList.appendChild(li);
        });
    }

    // Domanda di mercato e carenze
    const wantsList = document.getElementById('class-modal-wants');
    if (wantsList) {
        wantsList.innerHTML = '';
        (data.wants || ['Nessuna richiesta specifica']).forEach(w => {
            const li = document.createElement('li');
            li.textContent = w;
            wantsList.appendChild(li);
        });
    }
    setText('class-modal-lacks', data.lacks || '');

    // Abitazioni e progetti desiderati
    setText('class-modal-housing', data.housing || 'Alloggi non specificati');
    const projectsList = document.getElementById('class-modal-projects');
    if (projectsList) {
        projectsList.innerHTML = '';
        (data.projects || ['Nessun progetto pianificato']).forEach(p => {
            const li = document.createElement('li');
            li.textContent = p;
            projectsList.appendChild(li);
        });
    }

    setText('class-modal-goals', data.goals || 'Definisci gli obiettivi di questa classe.');
    setText('class-modal-tip', data.tip || '');

    // Bisogni primari/secondari esplicitati
    const primaryList = document.getElementById('class-modal-primary');
    const secondaryList = document.getElementById('class-modal-secondary');
    const primaryNeeds = (data.primaryNeeds || ['Cibo', 'Sicurezza']);
    const secondaryNeeds = (data.secondaryNeeds || ['Comfort', 'Prestigio']);
    if (primaryList) {
        primaryList.innerHTML = primaryNeeds.map(n => `<li>${n}</li>`).join('');
    }
    if (secondaryList) {
        secondaryList.innerHTML = secondaryNeeds.map(n => `<li>${n}</li>`).join('');
    }

    const chatBtn = document.getElementById('class-modal-chat');
    if (chatBtn) {
        chatBtn.onclick = () => {
            startFactionChat(className);
            closeClassModal();
        };
    }

    modal.classList.add('active');
    // Assicurati che il modale sia visibile
    if (getComputedStyle(modal).display === 'none') {
        modal.style.display = 'flex';
    }
}

function closeClassModal() {
    const modal = document.getElementById('class-modal');
    if (modal) {
        modal.classList.remove('active');
        // Rimosso modal.style.display = 'none' per evitare conflitti CSS
        // Chiudi anche tutte le card espanse quando si chiude il modale
        document.querySelectorAll('.social-class-card.expanded').forEach(card => {
            card.classList.remove('expanded');
        });
    }
}

document.addEventListener('click', (ev) => {
    const modal = document.getElementById('class-modal');
    if (!modal || !modal.classList.contains('active')) return;

    // Controlla se il click Ã¨ direttamente sul backdrop (non sui suoi figli)
    if (ev.target === modal) {
        ev.stopPropagation(); // Previene la propagazione
        closeClassModal();
    }
});

// Garantisce che i click sulle card aprano sempre il popup (anche se gli handler inline non partono)
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.social-class-card').forEach(card => {
        const classKey = card.getAttribute('data-class');
        card.addEventListener('click', () => toggleClassCard(card, classKey));
    });
    // popola select magazzino privato
    const sel = document.getElementById('gov-buy-res');
    if (sel) {
        sel.innerHTML = RESOURCE_KEYS.map(r => `<option value="${r}">${resourceLabels[r] || r}</option>`).join('');
    }
    const privateSection = document.getElementById('gov-private-section');
    const warehouseTab = document.getElementById('tab-warehouse');
    if (privateSection && warehouseTab && privateSection.parentElement !== warehouseTab) {
        warehouseTab.appendChild(privateSection);
        privateSection.style.display = '';
    }
});

function renderCategoryProjects() {
    const grid = document.getElementById('projects-grid');
    if (!grid) return;
    const classes = Object.keys(CLASS_DETAILS_MAP);
    grid.innerHTML = classes.map(key => {
        const data = CLASS_DETAILS_MAP[key];
        const projects = (data.projects || ['Nessun progetto']).map(p => `<li>${p}</li>`).join('');
        const wants = (data.wants || []).slice(0,3).join(', ');
        return `
            <div class="asset-card">
                <div style="font-weight:bold; color:var(--accent); margin-bottom:6px;">${data.name}</div>
                <div style="color:var(--text-soft); font-size:0.9em; margin-bottom:6px;">Richiedono: ${wants || 'â€”'}</div>
                <ul style="margin:0; padding-left:16px; color:var(--text); line-height:1.4;">${projects}</ul>
            </div>
        `;
    }).join('');
}

function refreshDomainHighlights() {
    const c = (typeof county !== 'undefined' && county) ? county : {};
    const stabilityVal = typeof calculateStability === 'function' ? Math.round(calculateStability()) : Math.round(c.stability || 0);
    const income = (c.lastEconomy && (c.lastEconomy.income || c.lastEconomy.taxes)) || c.taxIncome || c.goldIncome || 0;
    const foodPct = Math.round(c.food || 0);
    const treasury = Math.round(c.gold || 0);
    const buildingInProgress = (c.buildingsQueue && c.buildingsQueue.length) || (c.construction && c.construction.length) || 0;
    const settlements = c.villages || c.towns || c.settlements || (c.pop ? Math.max(1, Math.round(c.pop / 120)) : 0);
    const order = c.security || stabilityVal || 0;
    const lawsActive = document.querySelectorAll('#law-list .law-card, #law-list .law-item').length;

    const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    };

    setText('eco-income', income);
    setText('eco-treasury', treasury);
    setText('eco-food', `${foodPct}%`);
    setText('eco-stability', `${stabilityVal}%`);

    setText('dev-laws', lawsActive);
    setText('dev-buildings', buildingInProgress);
    setText('dev-settlements', settlements);
    setText('dev-order', `${Math.round(order)}%`);
    renderCategoryProjects();
}

// Aggiorna sintesi al caricamento
refreshDomainHighlights();

document.addEventListener('click', (ev) => {
    const modal = document.getElementById('class-modal');
    if (!modal) return;
    if (ev.target === modal) {
        closeClassModal();
    }
});

// Avvia chat con una fazione specifica
function startFactionChat(factionKey) {
    // Passa alla tab della chat
    switchTab('tab-chat');
    
    // Aggiungi messaggio automatico nella chat
    const factionNames = {
        nobility: 'Lord Emeric di Montferrand',
        clergy: 'Vescovo Aldebrando di Sorenza',
        militia: 'Capitano Ronan il Ferro',
        burghers: 'Maestro Bernard Forgiatore',
        peasants: 'Odric il Lavoratore',
        mystics: 'Madre Elowen la Veggente',
        outcasts: 'Rasko il Senzapatria',
        merchants: 'Ser Lothar dei Ponti'
    };
    
    const factionName = factionNames[factionKey] || 'Rappresentante';
    addMsg('system', `Hai richiesto un colloquio con ${factionName}. Cosa vuoi discutere?`);
    
    // Imposta il contesto per la chat AI
    chatContext = `colloquio individuale con ${factionName}`;
}

// Estendi updateUI esistente per aggiornare anche le icone delle classi
const originalUpdateUI = updateUI;
updateUI = function() {
    if (typeof originalUpdateUI === 'function') {
        originalUpdateUI();
    }
    updateAllClassMoods();
    updateSidebarStats();
    refreshDomainHighlights();
};




// ===== SISTEMA TOP BAR (MIGLIORAMENTO) =====

// Funzione per aggiornare la top bar
function updateTopStatsBar() {
    const bar = document.getElementById('top-stats-bar');
    if (!bar) return;
    
    // Mostra solo se il gioco Ã¨ attivo
    if (!gameActive) {
        bar.style.display = 'none';
        return;
    }
    
    // Mostra solo se il gioco Ã¨ attivo
    if (typeof county !== 'undefined' && county && county.pop > 0) {
        bar.style.display = 'flex';
        
        // Aggiorna valori
        const heroName = document.getElementById('top-hero-name');
        const pop = document.getElementById('top-pop');
        const gold = document.getElementById('top-gold');
        const food = document.getElementById('top-food');
        const happiness = document.getElementById('top-happiness');
        
        if (heroName) heroName.textContent = county.name || 'Conte';
        if (pop) pop.textContent = Math.floor(county.pop || 0);
        if (gold) {
            const goldValue = Math.floor(county.gold || 0);
            gold.textContent = goldValue;
            
            // Celebrate ogni 1000 oro
            if (goldValue > 0 && goldValue % 1000 < 50) {
                document.querySelectorAll('.stat-badge').forEach(badge => {
                    badge.classList.add('celebrate');
                    setTimeout(() => badge.classList.remove('celebrate'), 600);
                });
            }
        }
        if (food) food.textContent = Math.round((county.food / county.pop) * 100 || 0) + '%';
        if (happiness) happiness.textContent = Math.round(county.happy || 0) + '%';
    } else {
        bar.style.display = 'none';
    }
}

// Integra updateTopStatsBar con updateUI esistente
(function() {
    // Salva riferimento a updateUI originale se esiste
    const originalUpdateUI = typeof window.updateUI !== 'undefined' ? window.updateUI : null;
    
    // Crea nuova updateUI che include la top bar
    window.updateUI = function() {
        // Chiama l'originale se esiste
        if (originalUpdateUI && typeof originalUpdateUI === 'function') {
            originalUpdateUI.apply(this, arguments);
        }
        // Aggiorna top bar
        updateTopStatsBar();
    };
    
    // Se updateUI non esiste ancora, sarÃ  sostituita quando verrÃ  creata
    if (!originalUpdateUI) {
        console.log('â³ updateTopStatsBar attenderÃ  la creazione di updateUI');
    }
})();

// Aggiorna top bar anche quando cambia lo stato
if (typeof county !== 'undefined') {
    setInterval(updateTopStatsBar, 1000); // Aggiorna ogni secondo
}

// Auto-save con notifica toast
let autoSaveInterval = setInterval(() => {
    if (gameActive && typeof saveGame === 'function' && typeof county !== 'undefined' && county && county.pop > 0) {
        saveGame();
        if (typeof showToast === 'function') {
            showToast('ðŸ’¾ Partita salvata automaticamente', 'success');
        }
    }
}, 300000); // Ogni 5 minuti

// Cleanup al closing
window.addEventListener('beforeunload', () => {
    clearInterval(autoSaveInterval);
});

// Smooth scroll per tabs
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll tabs
    const tabs = document.querySelector('.tabs');
    if (tabs) {
        tabs.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-btn')) {
                e.target.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest', 
                    inline: 'center' 
                });
            }
        });
    }
    
    // Inizializza top bar se il gioco Ã¨ giÃ  attivo
    setTimeout(updateTopStatsBar, 500);
});

console.log('âœ¨ Miglioramenti UI caricati: Top Bar, Hover Effects, Auto-save');


</script>

<div id="modal-budget" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Bilancio Stagionale</h3>
            <button class="close-btn" onclick="closeBudgetModal()">âœ•</button>
        </div>
        <div id="budget-content">
            <!-- Contenuto popolato da renderBudget() -->
        </div>
    </div>
</div>

<!-- MODALE CRONACHE STAGIONALI -->
<div id="class-modal" class="modal">
    <div class="modal-content">
        <div class="class-modal-header">
            <div class="class-title">
                <div class="class-chip" id="class-modal-cat">Classe sociale</div>
                <h3><span id="class-modal-icon" aria-hidden="true">ï¿½Y'ï¿½</span> <span id="class-modal-name">Dettagli classe</span></h3>
                <p id="class-modal-desc" style="margin:0; color:var(--text-soft); line-height:1.6;">Panoramica della categoria, bisogni e tensioni.</p>
            </div>
            <button class="close-btn" onclick="closeClassModal()">ï¿½o</button>
        </div>

        <div class="class-meta-grid">
            <div class="class-meta-card">
                <div class="label">Membri</div>
                <div class="value" id="class-modal-count">0</div>
            </div>
            <div class="class-meta-card">
                <div class="label">Ricchezza</div>
                <div class="value" id="class-modal-wealth">0</div>
            </div>
            <div class="class-meta-card">
                <div class="label">Possedimenti</div>
                <div class="value" id="class-modal-lands">-</div>
            </div>
            <div class="class-meta-card">
                <div class="label">Umore</div>
                <div class="value" id="class-modal-mood">-</div>
            </div>
        </div>

        <div class="class-columns">
            <div class="class-box">
                <h4>Bisogni urgenti</h4>
                <ul id="class-modal-needs"></ul>
            </div>
            <div class="class-box">
                <h4>Obiettivi e timori</h4>
                <div id="class-modal-goals" style="color:var(--text); line-height:1.6;"></div>
            </div>
            <div class="class-box">
                <h4>Domanda di mercato</h4>
                <ul id="class-modal-wants" class="pill-list"></ul>
                <p id="class-modal-lacks" style="color:var(--text-soft); margin-top:8px;"></p>
            </div>
            <div class="class-box">
                <h4>Abitazioni e progetti</h4>
                <p id="class-modal-housing" style="color:var(--text); margin:0 0 8px;"></p>
                <ul id="class-modal-projects" class="pill-list"></ul>
            </div>
            <div class="class-box">
                <h4>Bisogni primari/secondari</h4>
                <ul id="class-modal-primary" class="pill-list"></ul>
                <ul id="class-modal-secondary" class="pill-list" style="margin-top:6px;"></ul>
            </div>
        </div>

        <div class="class-actions">
            <button class="btn-main" id="class-modal-chat">Apri colloquio</button>
            <button class="btn-ghost" onclick="closeClassModal()">Chiudi</button>
            <div id="class-modal-tip" style="color:var(--text-soft); font-size:0.9em;"></div>
        </div>
    </div>
</div>

<div id="modal-chronicle" class="modal" style="background: rgba(0,0,0,0.9); z-index: 5000;">
    <div class="modal-content chronicle-content">
        <div class="chronicle-header">
            <h2 id="chronicle-title">Cronache del Regno</h2>
            <div id="chronicle-date" style="color:var(--text-soft); font-style:italic;">Anno 1325, Primavera</div>
        </div>
        
        <hr style="border-color:var(--accent); opacity:0.3; margin: 15px 0;">
        
        <div id="chronicle-body" class="chronicle-text">
            <div class="loading-story">
                <span class="scribe-icon">âœï¸</span>
                <p>Il Mastrocronista sta scrivendo la storia della stagione...</p>
            </div>
        </div>

        <button class="btn-main" onclick="closeChronicleModal()" style="margin-top:20px;">Continua a Governare</button>
    </div>
</div>

<!-- MODALE CREAZIONE LEGGI -->
<div id="modal-law-creator" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ðŸ“œ Crea una Nuova Legge</h3>
            <button class="close-btn" onclick="closeLawModal()">âœ•</button>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 15px;">
                <label>Nome della Legge:</label>
                <input type="text" id="law-name" placeholder="Es. Legge sul Pane" style="width: 100%; padding: 8px; margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Descrizione:</label>
                <textarea id="law-desc" placeholder="Descrivi gli effetti della legge..." rows="3" style="width: 100%; padding: 8px; margin-top: 5px;"></textarea>
            </div>
            <div style="margin-bottom: 15px;">
                <label>Costo di Mantenimento (oro/turno):</label>
                <input type="number" id="law-upkeep" min="0" value="0" style="width: 100%; padding: 8px; margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>Risorsa da Consumare (opzionale):</label>
                <select id="law-resource" style="width: 48%; padding: 8px; margin-top: 5px;">
                    <option value="">Nessuna</option>
                    <option value="grain">Grano</option>
                    <option value="wood">Legno</option>
                    <option value="stone">Pietra</option>
                    <option value="iron">Ferro</option>
                    <option value="gold">Oro</option>
                </select>
                <input type="number" id="law-resource-amount" min="0" value="0" placeholder="QuantitÃ " style="width: 48%; padding: 8px; margin-top: 5px; margin-left: 4%;">
            </div>
            <button class="btn-main" onclick="createLaw()" style="width: 100%;">Promulga la Legge</button>
        </div>
    </div>
</div>

<!-- MODAL GENERICA PER SISTEMA DI GUERRA -->
<div id="modal-generic" class="modal" style="z-index: 9999;">
    <div class="modal-content" id="modal-generic-content">
        <!-- Contenuto dinamico inserito da showModal() -->
    </div>
</div>


<!-- ===================== MENU LATERALE STATISTICHE ===================== -->
<div class="domain-stats-sidebar" id="stats-sidebar">
    <button class="sidebar-close-btn" onclick="toggleStatsSidebar()">âœ•</button>
    
    <div class="sidebar-header">
        ðŸ“Š Statistiche del Dominio
    </div>
    
    <div class="sidebar-stat-group">
        <h4>Popolazione e Oro</h4>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Popolazione Totale</span>
            <span class="sidebar-stat-value" id="sidebar-pop">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Oro</span>
            <span class="sidebar-stat-value" id="sidebar-gold">0</span>
        </div>
    </div>
    
    <div class="sidebar-stat-group">
        <h4>Indicatori di Benessere</h4>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Cibo</span>
            <span class="sidebar-stat-value" id="sidebar-food">0%</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Salute</span>
            <span class="sidebar-stat-value" id="sidebar-health">0%</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">FelicitÃ </span>
            <span class="sidebar-stat-value" id="sidebar-happiness">0%</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">StabilitÃ  Sociale</span>
            <span class="sidebar-stat-value" id="sidebar-stability">0%</span>
        </div>
    </div>
    
    <div class="sidebar-stat-group">
        <h4>Territorio</h4>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Terre del Conte</span>
            <span class="sidebar-stat-value" id="sidebar-land-count">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">NobiltÃ </span>
            <span class="sidebar-stat-value" id="sidebar-land-nobility">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Clero</span>
            <span class="sidebar-stat-value" id="sidebar-land-clergy">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Comuni</span>
            <span class="sidebar-stat-value" id="sidebar-land-commons">0</span>
        </div>
    </div>
    
    <div class="sidebar-stat-group">
        <h4>Risorse</h4>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Legno</span>
            <span class="sidebar-stat-value" id="sidebar-wood">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Pietra</span>
            <span class="sidebar-stat-value" id="sidebar-stone">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Ferro</span>
            <span class="sidebar-stat-value" id="sidebar-iron">0</span>
        </div>
        <div class="sidebar-stat-item">
            <span class="sidebar-stat-label">Grano</span>
            <span class="sidebar-stat-value" id="sidebar-grain">0</span>
        </div>
    </div>
</div>

</body>
</html>
